<VirtualHost *:80>
    ServerName reconciliation.intouchgroup.net

    # Redirection permanente vers HTTPS
    Redirect permanent / https://reconciliation.intouchgroup.net/
</VirtualHost>

<VirtualHost *:443>
    ServerName reconciliation.intouchgroup.net

    SSLEngine on
    SSLCertificateFile "C:/Apache24/conf/ssl/reconciliation.intouchgroup.net.fullchain.pem"
    SSLCertificateKeyFile "C:/Apache24/conf/ssl/reconciliation.intouchgroup.net.key"

    # Sécurité SSL
    SSLProtocol TLSv1.2 TLSv1.3
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLHonorCipherOrder off
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Frame-Options DENY
    Header always set X-Content-Type-Options nosniff
    Header always set X-XSS-Protection "1; mode=block"

    # En-têtes CORS pour l'API (si nécessaire)
    Header always set Access-Control-Allow-Origin "https://reconciliation.intouchgroup.net"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    Header always set Access-Control-Allow-Credentials "true"

    # Compression (mod_deflate requis)
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript
        AddOutputFilterByType DEFLATE application/javascript application/json application/xml
        AddOutputFilterByType DEFLATE application/rss+xml application/xhtml+xml
    </IfModule>

    # Fichiers statiques Angular
    DocumentRoot "C:/reconciliation-app/frontend/dist/csv-reconciliation"
    <Directory "C:/reconciliation-app/frontend/dist/csv-reconciliation">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Support du routing Angular (fallback vers index.html)
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # UTF-8 explicite pour les fichiers HTML et texte
    AddDefaultCharset UTF-8
    AddCharset UTF-8 .html .css .js .xml .json .txt

    # Cache navigateur pour les assets statiques
    <LocationMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </LocationMatch>

    # Pas de cache pour index.html (pour forcer les mises à jour)
    <FilesMatch "index\.html$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires 0
    </FilesMatch>

    # Reverse proxy vers Spring Boot
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Health check endpoint
    ProxyPass "/health" "http://localhost:8080/actuator/health"
    ProxyPassReverse "/health" "http://localhost:8080/actuator/health"
    
    # API endpoints
    ProxyPass "/api/" "http://localhost:8080/api/"
    ProxyPassReverse "/api/" "http://localhost:8080/api/"

    # Timeouts pour les gros fichiers (30 minutes pour permettre le traitement de très gros fichiers)
    ProxyTimeout 1800
    Timeout 1800
    ProxyBadHeader Ignore
    ProxyErrorOverride Off

    # Uploads volumineux (500 MB)
    LimitRequestBody 524288000
    ClientMaxBodySize 500M

    # Logs
    ErrorLog "logs/reconciliation-ssl-error.log"
    CustomLog "logs/reconciliation-ssl-access.log" combined
    LogLevel warn
</VirtualHost>

