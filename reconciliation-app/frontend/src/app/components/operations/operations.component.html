<div class="operations-container">
    <!-- En-t√™te am√©lior√© -->
    <div class="header">
        <div class="header-content">
            <h1>Gestion des Op√©rations</h1>
            <div class="header-stats">
                <div class="quick-stat">
                    <span class="stat-number">{{ totalOperations }}</span>
                    <span class="stat-label">Op√©rations</span>
                </div>
                <div class="quick-stat">
                    <span class="stat-number">{{ operationsValidees }}</span>
                    <span class="stat-label">Valid√©es</span>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn-secondary" (click)="refreshData()" title="Actualiser les donn√©es">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn-primary" (click)="showAddForm = true" *ngIf="!showAddForm && !showEditForm">
                <i class="fas fa-plus"></i> Ajouter une op√©ration
            </button>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="stats-section">
        <div *ngIf="isLoadingStats" class="loading-stats">
            <i class="fas fa-spinner fa-spin"></i> Chargement des statistiques...
        </div>
        
        <div *ngIf="!isLoadingStats && statsByType" class="stats-by-type">
            <div class="stats-header">
                <h3>Statistiques par Type d'Op√©ration</h3>
                
                <!-- Filtres -->
                <div class="stats-filters">
                    <div class="filter-group">
                        <label>Pays:</label>
                        <select [(ngModel)]="selectedPays" (change)="onFilterChange()" class="modern-select">
                            <option value="">Tous les pays</option>
                            <option *ngFor="let pays of paysList" [value]="pays">{{ pays }}</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Code propri√©taire:</label>
                        <select [(ngModel)]="selectedCodeProprietaire" (change)="onFilterChange()" class="modern-select">
                            <option value="">Tous les codes propri√©taires</option>
                            <option *ngFor="let code of codeProprietaireList" [value]="code">{{ code }}</option>
                        </select>
                    </div>
                    
                    <button class="btn-secondary" (click)="clearStatsFilters()">
                        <i class="fas fa-times"></i> Effacer les filtres
                    </button>
                </div>
            </div>
            
            <div *ngIf="getOperationTypes().length === 0" class="no-stats-message">
                <i class="fas fa-info-circle"></i>
                <p>Aucune op√©ration trouv√©e avec les filtres actuels.</p>
                <p>Les types d'op√©rations disponibles incluent : Total Cash-in, Total Paiement, Appro_client, Appro_fournisseur, Ajustement, Compense_client, Compense_fournisseur, Nivellement, R√©gularisation Solde, et Frais Transaction.</p>
            </div>
            
            <div *ngIf="getOperationTypes().length > 0" class="stats-grid">
                <div *ngFor="let type of getPagedOperationTypes()" 
                     class="stat-type-card" 
                     [class.empty]="!statsByType[type] || (statsByType[type]?.count === 0 && statsByType[type]?.totalAmount === 0)">
                    <div class="stat-type-header">
                        <h4>{{ getTypeDisplayName(type) }}</h4>
                    </div>
                    <div class="stat-type-content">
                        <div class="stat-item">
                            <span class="stat-label" *ngIf="type === 'total_cashin' || type === 'total_paiement'; else nombreLabel">Nombre AG:</span>
                            <ng-template #nombreLabel><span class="stat-label">Nombre:</span></ng-template>
                            <span class="stat-value">{{ statsByType[type]?.count || 0 }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Montant Total:</span>
                            <span class="stat-value">{{ (statsByType[type]?.totalAmount || 0) | number:'1.0-2' }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pagination des cartes de statistiques -->
            <div *ngIf="totalStatsPages > 1" class="stats-pagination">
                <button class="btn-pagination" 
                        [disabled]="currentStatsPage === 1"
                        (click)="prevStatsPage()">
                    <i class="fas fa-chevron-left"></i> Pr√©c√©dent
                </button>
                
                <div class="pagination-indicators">
                    <span *ngFor="let page of getVisibleStatsPages()" 
                          class="page-indicator"
                          [class.active]="currentStatsPage === page"
                          (click)="goToStatsPage(page)">
                        {{ page }}
                    </span>
                </div>
                
                <button class="btn-pagination" 
                        [disabled]="currentStatsPage === totalStatsPages"
                        (click)="nextStatsPage()">
                    Suivant <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Formulaire d'ajout -->
    <!-- Modal d'ajout d'op√©ration -->
    <div *ngIf="showAddForm" class="modal-overlay" (click)="closeAddModal($event)">
        <div class="modal-container" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Ajouter une nouvelle op√©ration</h3>
                <button type="button" class="modal-close" (click)="cancelAdd()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <form [formGroup]="addForm" (ngSubmit)="addOperation()" class="add-form">
                    <!-- Informations de base -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-info-circle"></i> Informations de base
                        </h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <mat-form-field appearance="fill">
                                    <mat-label>Type d'op√©ration *</mat-label>
                                    <mat-select formControlName="typeOperation">
                                        <mat-option value="">S√©lectionner un type...</mat-option>
                                        <mat-option *ngFor="let type of typeOperations" [value]="type">
                                            {{ type }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                                <div *ngIf="addForm.get('typeOperation')?.invalid && addForm.get('typeOperation')?.touched" class="error-message">
                                    <i class="fas fa-exclamation-circle"></i>
                                    Le type d'op√©ration est requis
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Date d'op√©ration *</label>
                                <div class="date-input-wrapper">
                                    <input type="date" formControlName="dateOperation" [max]="maxDate" class="date-input">
                                    <i class="fas fa-calendar-alt date-icon"></i>
                                </div>
                                <div *ngIf="addForm.get('dateOperation')?.invalid && addForm.get('dateOperation')?.touched" class="error-message">
                                    <i class="fas fa-exclamation-circle"></i>
                                    La date d'op√©ration est requise
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <mat-form-field appearance="fill">
                                    <mat-label>Code propri√©taire *</mat-label>
                                    <mat-select formControlName="codeProprietaire">
                                        <mat-option value="">S√©lectionner un code propri√©taire...</mat-option>
                                        <mat-option *ngFor="let code of codeProprietaireList" [value]="code">
                                            {{ code }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                                <div *ngIf="codeProprietaireList.length === 0" class="info-message">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    Chargement des codes propri√©taire...
                                </div>
                                <div *ngIf="addForm.get('codeProprietaire')?.invalid && addForm.get('codeProprietaire')?.touched" class="error-message">
                                    <i class="fas fa-exclamation-circle"></i>
                                    Le code propri√©taire est requis
                                </div>
                            </div>
                            <div class="form-group">
                                <mat-form-field appearance="fill">
                                    <mat-label>Service</mat-label>
                                    <mat-select formControlName="service">
                                        <mat-option value="">S√©lectionner un service...</mat-option>
                                        <mat-option *ngFor="let service of serviceList" [value]="service">
                                            {{ service }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Banque</label>
                                <input type="text" formControlName="banque" 
                                    placeholder="Ex: MTN, Orange, SYSTEM, etc." class="text-input">
                                <div class="help-text">Vous pouvez saisir librement le nom de la banque</div>
                            </div>
                            <div class="form-group">
                                <label>Nom du bordereau</label>
                                <input type="text" formControlName="nomBordereau" 
                                    placeholder="Ex: 19S50zsyf252050003/1753" class="text-input">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>R√©f√©rence</label>
                                <input type="text" formControlName="reference" 
                                    placeholder="Ex: REF-2024-001" class="text-input">
                            </div>
                        </div>
                    </div>



                    <!-- D√©tails financiers -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-calculator"></i> D√©tails financiers
                        </h4>
                        
                        <div class="financial-preview">
                            <div class="preview-card">
                                <div class="preview-header">
                                    <h5>Aper√ßu de l'impact</h5>
                                </div>
                                <div class="preview-content">
                                    <div class="impact-item">
                                        <span class="impact-label">Solde avant:</span>
                                        <span class="impact-value">{{ addForm.get('soldeAvant')?.value | currency:'XAF':'symbol':'1.0-0' }}</span>
                                    </div>
                                    <div class="impact-item">
                                        <span class="impact-label">Montant:</span>
                                        <span class="impact-value" [class.positive]="getAddImpactDirection() === 'positive'" 
                                            [class.negative]="getAddImpactDirection() === 'negative'">
                                            {{ getAddImpactDirection() === 'positive' ? '+' : '' }}{{ addForm.get('montant')?.value | currency:'XAF':'symbol':'1.0-0' }}
                                        </span>
                                    </div>
                                    <div class="impact-item total">
                                        <span class="impact-label">Solde apr√®s:</span>
                                        <span class="impact-value">{{ calculateAddSoldeApres() | currency:'XAF':'symbol':'1.0-0' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Montant * <span class="help-text">(Utilisez des valeurs n√©gatives pour les ajustements)</span></label>
                                <div class="amount-input-wrapper">
                                    <input type="number" formControlName="montant" 
                                        placeholder="0.00" step="0.01" class="amount-input"
                                        (input)="onAddMontantChange()">
                                    <span class="currency-symbol">XAF</span>
                                </div>
                                <div *ngIf="addForm.get('montant')?.invalid && addForm.get('montant')?.touched" class="error-message">
                                    <i class="fas fa-exclamation-circle"></i>
                                    Le montant est requis
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Pays (automatique)</label>
                                <div class="readonly-field">
                                    <span>{{ addForm.get('pays')?.value || 'Non d√©fini' }}</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Solde avant (automatique)</label>
                                <div class="readonly-field">
                                    <span>{{ addForm.get('soldeAvant')?.value | currency:'XAF':'symbol':'1.0-0' }}</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Solde apr√®s (calcul√© automatiquement)</label>
                                <div class="readonly-field">
                                    <span>{{ calculateAddSoldeApres() | currency:'XAF':'symbol':'1.0-0' }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="warning-section" *ngIf="showAddWarningMessage()">
                            <div class="warning-card">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div class="warning-content">
                                    <h6>Attention</h6>
                                    <p>{{ getAddWarningMessage() }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" (click)="cancelAdd()">
                        <i class="fas fa-times"></i>
                        Annuler
                    </button>
                    <button type="submit" class="btn-primary" 
                        [disabled]="!addForm.valid || isAdding"
                        (click)="addOperation()">
                        <i class="fas fa-plus"></i>
                        {{ isAdding ? 'Ajout en cours...' : 'Ajouter l\'op√©ration' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de modification d'op√©ration -->
    <div *ngIf="showEditForm && editingOperation" class="modal-overlay" (click)="closeEditModal($event)">
        <div class="modal-container edit-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Modifier l'op√©ration #{{ editingOperation.id }}</h3>
                <div class="operation-status">
                    <span class="status-badge" [class]="'status-' + editingOperation.statut.toLowerCase()">
                        {{ editingOperation.statut }}
                    </span>
                </div>
                <button type="button" class="modal-close" (click)="cancelEdit()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
        <!-- Navigation par √©tapes -->
        <div class="step-navigation">
            <div class="step-item" [class.active]="currentEditStep === 1" (click)="setEditStep(1)">
                <div class="step-number">1</div>
                <span class="step-label">Informations de base</span>
            </div>
            <div class="step-item" [class.active]="currentEditStep === 2" (click)="setEditStep(2)">
                <div class="step-number">2</div>
                <span class="step-label">D√©tails financiers</span>
            </div>
            <div class="step-item" [class.active]="currentEditStep === 3" (click)="setEditStep(3)">
                <div class="step-number">3</div>
                <span class="step-label">Validation</span>
            </div>
        </div>

                <form [formGroup]="editForm" (ngSubmit)="updateOperation()" class="edit-form">
            <!-- √âtape 1: Informations de base -->
            <div *ngIf="currentEditStep === 1" class="form-step">
                <div class="step-content">
                            <h4><i class="fas fa-info-circle"></i> Informations de base</h4>
                    
                    <!-- Informations en lecture seule -->
                    <div class="readonly-info">
                        <div class="info-card">
                            <div class="info-item">
                                <label>Code propri√©taire</label>
                                <div class="readonly-value">{{ editingOperation.codeProprietaire }}</div>
                            </div>
                            <div class="info-item">
                                <label>Pays</label>
                                <div class="readonly-value">{{ editingOperation.pays }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Champs √©ditables -->
                    <div class="form-row">
                        <div class="form-group">
                            <mat-form-field appearance="fill">
                                <mat-label>Type d'op√©ration *</mat-label>
                                <mat-select formControlName="typeOperation">
                                    <mat-option value="">S√©lectionner un type d'op√©ration...</mat-option>
                                    <mat-option *ngFor="let type of typeOperations" [value]="type">
                                        {{ type }}
                                    </mat-option>
                                </mat-select>
                                    </mat-form-field>
                                <div *ngIf="editForm.get('typeOperation')?.invalid && editForm.get('typeOperation')?.touched" 
                                    class="error-message">
                                    <i class="fas fa-exclamation-circle"></i>
                                    Le type d'op√©ration est requis
                                </div>
                        </div>
                        <div class="form-group">
                            <label>Date d'op√©ration *</label>
                            <div class="date-input-wrapper">
                                <input type="date" formControlName="dateOperation" 
                                    [max]="maxDate" class="date-input">
                                <i class="fas fa-calendar-alt date-icon"></i>
                            </div>
                            <div *ngIf="editForm.get('dateOperation')?.invalid && editForm.get('dateOperation')?.touched" 
                                class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                La date d'op√©ration est requise
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Banque</label>
                            <input type="text" formControlName="banque" 
                                placeholder="Ex: MTN, Orange, SYSTEM, etc." class="text-input">
                            <div class="help-text">Vous pouvez saisir librement le nom de la banque</div>
                        </div>
                        <div class="form-group">
                            <mat-form-field appearance="fill">
                                <mat-label>Service</mat-label>
                                <mat-select formControlName="service">
                                    <mat-option value="">S√©lectionner un service...</mat-option>
                                    <mat-option *ngFor="let service of serviceList" [value]="service">
                                        {{ service }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Nom du bordereau</label>
                            <input type="text" formControlName="nomBordereau" 
                                placeholder="Ex: 19S50zsyf252050003/1753" class="text-input">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>R√©f√©rence</label>
                            <input type="text" formControlName="reference" 
                                placeholder="Ex: REF-2024-001" class="text-input">
                        </div>
                    </div>
                </div>
            </div>

            <!-- √âtape 2: D√©tails financiers -->
            <div *ngIf="currentEditStep === 2" class="form-step">
                <div class="step-content">
                            <h4><i class="fas fa-calculator"></i> D√©tails financiers</h4>
                    
                    <div class="financial-preview">
                        <div class="preview-card">
                            <div class="preview-header">
                                <h5>Aper√ßu de l'impact</h5>
                            </div>
                            <div class="preview-content">
                                <div class="impact-item">
                                    <span class="impact-label">Solde avant:</span>
                                    <span class="impact-value">{{ editingOperation.soldeAvant | currency:'XAF':'symbol':'1.0-0' }}</span>
                                </div>
                                <div class="impact-item">
                                    <span class="impact-label">Montant:</span>
                                    <span class="impact-value" [class.positive]="getImpactDirection() === 'positive'" 
                                        [class.negative]="getImpactDirection() === 'negative'">
                                        {{ getImpactDirection() === 'positive' ? '+' : '' }}{{ editForm.get('montant')?.value | currency:'XAF':'symbol':'1.0-0' }}
                                    </span>
                                </div>
                                <div class="impact-item total">
                                    <span class="impact-label">Solde apr√®s:</span>
                                    <span class="impact-value">{{ calculateNewSoldeApres() | currency:'XAF':'symbol':'1.0-0' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Montant * <span class="help-text">(Utilisez des valeurs n√©gatives pour les ajustements)</span></label>
                            <div class="amount-input-wrapper">
                                <input type="number" formControlName="montant" 
                                    placeholder="0.00" step="0.01" class="amount-input"
                                    (input)="onMontantChange()">
                                <span class="currency-symbol">XAF</span>
                            </div>
                            <div *ngIf="editForm.get('montant')?.invalid && editForm.get('montant')?.touched" 
                                class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                Le montant est requis
                            </div>
                        </div>
                    </div>

                    <div class="warning-section" *ngIf="showWarningMessage()">
                        <div class="warning-card">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div class="warning-content">
                                <h6>Attention</h6>
                                <p>{{ getWarningMessage() }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- √âtape 3: Validation -->
            <div *ngIf="currentEditStep === 3" class="form-step">
                <div class="step-content">
                            <h4><i class="fas fa-check-circle"></i> Validation des modifications</h4>
                    
                    <div class="validation-summary">
                        <div class="summary-card">
                            <h5>R√©capitulatif des modifications</h5>
                            <div class="summary-content">
                                <div class="summary-item">
                                    <span class="summary-label">Type d'op√©ration:</span>
                                    <span class="summary-value">{{ getTypeDisplayName(editForm.get('typeOperation')?.value) }}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Date d'op√©ration:</span>
                                    <span class="summary-value">{{ editForm.get('dateOperation')?.value | date:'dd/MM/yyyy' }}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Montant:</span>
                                    <span class="summary-value">{{ editForm.get('montant')?.value | currency:'XAF':'symbol':'1.0-0' }}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Banque:</span>
                                    <span class="summary-value">{{ editForm.get('banque')?.value || 'Non sp√©cifi√©' }}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Service:</span>
                                    <span class="summary-value">{{ editForm.get('service')?.value || 'Non sp√©cifi√©' }}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Bordereau:</span>
                                    <span class="summary-value">{{ editForm.get('nomBordereau')?.value || 'Non sp√©cifi√©' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="confirmation-section">
                        <div class="confirmation-card">
                            <i class="fas fa-info-circle"></i>
                            <div class="confirmation-content">
                                <h6>Confirmation</h6>
                                <p>En confirmant cette modification, toutes les op√©rations suivantes seront recalcul√©es automatiquement.</p>
                            </div>
                        </div>
                    </div>
                </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <div class="modal-actions">
            <!-- Navigation des √©tapes -->
            <div class="step-navigation-actions">
                <button type="button" class="btn-secondary" 
                    (click)="previousEditStep()" 
                    [disabled]="currentEditStep === 1">
                    <i class="fas fa-arrow-left"></i>
                    Pr√©c√©dent
                </button>
                        
                        <button type="button" class="btn-secondary" (click)="cancelEdit()">
                            <i class="fas fa-times"></i>
                            Annuler
                </button>
                
                <div class="step-indicators">
                    <span class="step-dot" [class.active]="currentEditStep === 1"></span>
                    <span class="step-dot" [class.active]="currentEditStep === 2"></span>
                    <span class="step-dot" [class.active]="currentEditStep === 3"></span>
                </div>

                <button type="button" class="btn-primary" 
                    (click)="nextEditStep()" 
                    [disabled]="!canProceedToNextStep()"
                    *ngIf="currentEditStep < 3">
                    Suivant
                    <i class="fas fa-arrow-right"></i>
                </button>
                
                <button type="submit" class="btn-success" 
                            [disabled]="!editForm.valid || currentEditStep !== 3 || isUpdating"
                            (click)="updateOperation()"
                    *ngIf="currentEditStep === 3">
                    <i class="fas fa-check"></i>
                            {{ isUpdating ? 'Mise √† jour...' : 'Mettre √† jour' }}
                </button>
            </div>
            </div>
            </div>
        </div>
    </div>



    <!-- Filtres am√©lior√©s -->
    <div class="filters-section">
        <div class="filters-header">
            <h3>Filtres</h3>
            <div class="filters-summary" *ngIf="hasActiveFilters()">
                <span class="active-filters-count">{{ getActiveFiltersCount() }} filtre(s) actif(s)</span>
                <button type="button" class="btn-clear-all" (click)="clearFilters()">
                    <i class="fas fa-times"></i> Tout effacer
                </button>
            </div>
        </div>
        
        <form [formGroup]="filterForm" (ngSubmit)="applyFilters()" class="form-grid">
            <div class="form-field">
                <mat-form-field appearance="fill" class="filter-select">
                    <mat-label>Type d'op√©ration</mat-label>
                                    <mat-select #typeOperationSelect formControlName="typeOperation" multiple (selectionChange)="onFilterChange()">
                        <mat-option>
                            <ngx-mat-select-search [formControl]="typeOperationSearchCtrl" placeholderLabel="Rechercher un type..." noEntriesFoundLabel="Aucun type trouv√©"></ngx-mat-select-search>
                        </mat-option>
                        <mat-option *ngFor="let type of filteredTypeOperationList" [value]="type.value">
                            {{ type.label }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            <div class="form-field">
                <mat-form-field appearance="fill" class="filter-select">
                    <mat-label>Service</mat-label>
                                    <mat-select #serviceSelect formControlName="service" multiple (selectionChange)="onFilterChange()">
                        <mat-option>
                            <ngx-mat-select-search [formControl]="serviceSearchCtrl" placeholderLabel="Rechercher un service..." noEntriesFoundLabel="Aucun service trouv√©"></ngx-mat-select-search>
                        </mat-option>
                        <mat-option *ngFor="let service of filteredServiceList" [value]="service">
                            {{ service }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            <div class="form-field">
                <mat-form-field appearance="fill" class="filter-select">
                    <mat-label>Statut</mat-label>
                                    <mat-select #statutSelect formControlName="statut" multiple (selectionChange)="onFilterChange()">
                        <mat-option>
                            <ngx-mat-select-search [formControl]="statutSearchCtrl" placeholderLabel="Rechercher un statut..." noEntriesFoundLabel="Aucun statut trouv√©"></ngx-mat-select-search>
                        </mat-option>
                        <mat-option *ngFor="let statut of filteredStatutList" [value]="statut">
                            {{ statut }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            <div class="form-field">
                <mat-form-field appearance="fill" class="filter-select">
                    <mat-label>R√©f√©rence</mat-label>
                                    <mat-select #referenceSelect formControlName="reference" multiple (selectionChange)="onFilterChange()">
                        <mat-option>
                            <ngx-mat-select-search [formControl]="referenceSearchCtrl" placeholderLabel="Rechercher une r√©f√©rence..." noEntriesFoundLabel="Aucune r√©f√©rence trouv√©e"></ngx-mat-select-search>
                        </mat-option>
                        <mat-option *ngFor="let reference of filteredReferenceList" [value]="reference">
                            {{ reference }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            <div class="form-field">
                <mat-form-field appearance="fill" class="filter-select">
                    <mat-label>Pays</mat-label>
                                    <mat-select #paysSelect formControlName="pays" multiple (selectionChange)="onFilterChange()">
                        <mat-option>
                            <ngx-mat-select-search [formControl]="paysSearchCtrl" placeholderLabel="Rechercher un pays..." noEntriesFoundLabel="Aucun pays trouv√©"></ngx-mat-select-search>
                        </mat-option>
                        <mat-option *ngFor="let pays of filteredPaysList" [value]="pays">
                            {{ pays }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            <div class="form-field">
                <mat-form-field appearance="fill" class="filter-select">
                    <mat-label>Code Propri√©taire</mat-label>
                                    <mat-select #codeProprietaireSelect formControlName="codeProprietaire" multiple (selectionChange)="onFilterChange()">
                        <mat-option>
                            <ngx-mat-select-search [formControl]="codeProprietaireSearchCtrl" placeholderLabel="Rechercher un code..." noEntriesFoundLabel="Aucun code trouv√©"></ngx-mat-select-search>
                        </mat-option>
                        <mat-option *ngFor="let code of filteredCodeProprietaireList" [value]="code">
                            {{ code }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            <div class="form-field">
                <label for="dateDebut">Date de d√©but</label>
                <input id="dateDebut" type="date" formControlName="dateDebut">
            </div>
            <div class="form-field">
                <label for="dateFin">Date de fin</label>
                <input id="dateFin" type="date" formControlName="dateFin">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn primary">Filtrer</button>
                <button type="button" (click)="clearFilters()" class="btn">R√©initialiser</button>
            </div>
        </form>
    </div>

    <!-- Indicateur d'affichage automatique des frais -->
    <div *ngIf="showFraisAutomatically" class="frais-auto-indicator">
        <div class="indicator-content">
            <i class="fas fa-info-circle"></i>
            <span>Les frais de transaction sont automatiquement affich√©s pour les types d'op√©rations s√©lectionn√©s</span>
        </div>
    </div>

    <!-- Liste des op√©rations am√©lior√©e -->
    <div class="operations-list">
        <div class="list-header">
            <div class="list-header-content">
                <h3>Liste des Op√©rations</h3>
                <div class="list-summary">
                    <span class="results-count">
                        {{ filteredOperations.length }} op√©ration(s) trouv√©e(s)
                    </span>
                    <span class="page-info" *ngIf="totalPages > 1">
                        Page {{ currentPage }} sur {{ totalPages }}
                    </span>
                </div>
            </div>
            <div class="list-actions">
                <button class="btn-secondary" (click)="refreshData()" title="Actualiser">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="btn-secondary" (click)="exportOperations()" [disabled]="isExporting" title="Exporter Excel">
                    <i class="fas fa-file-excel"></i>
                    {{ isExporting ? 'Export...' : 'Excel' }}
                </button>
            </div>
        </div>

        <!-- √âtat de chargement am√©lior√© -->
        <div *ngIf="isLoading" class="loading-state">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <p>Chargement des op√©rations...</p>
        </div>

        <!-- √âtat vide am√©lior√© -->
        <div *ngIf="!isLoading && pagedOperations.length === 0" class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-search"></i>
            </div>
            <h4>Aucune op√©ration trouv√©e</h4>
            <p>Aucune op√©ration ne correspond aux crit√®res de recherche actuels.</p>
            <button class="btn-primary" (click)="clearFilters()">
                <i class="fas fa-times"></i> Effacer les filtres
            </button>
        </div>

        <!-- Tableau des op√©rations -->
        <div *ngIf="!isLoading && pagedOperations.length > 0" class="table-container">
            <table class="operations-table">
                <thead>
                    <tr>
                        <th class="sortable" (click)="sortBy('dateOperation')">
                            <i class="fas fa-calendar"></i> Date
                            <i class="fas fa-sort" *ngIf="sortField !== 'dateOperation'"></i>
                            <i class="fas fa-sort-up" *ngIf="sortField === 'dateOperation' && sortDirection === 'asc'"></i>
                            <i class="fas fa-sort-down" *ngIf="sortField === 'dateOperation' && sortDirection === 'desc'"></i>
                        </th>
                        <th class="sortable" (click)="sortBy('typeOperation')">
                            <i class="fas fa-tag"></i> Type
                            <i class="fas fa-sort" *ngIf="sortField !== 'typeOperation'"></i>
                            <i class="fas fa-sort-up" *ngIf="sortField === 'typeOperation' && sortDirection === 'asc'"></i>
                            <i class="fas fa-sort-down" *ngIf="sortField === 'typeOperation' && sortDirection === 'desc'"></i>
                        </th>
                        <th class="sortable" (click)="sortBy('codeProprietaire')">
                            <i class="fas fa-user"></i> Code propri√©taire
                            <i class="fas fa-sort" *ngIf="sortField !== 'codeProprietaire'"></i>
                            <i class="fas fa-sort-up" *ngIf="sortField === 'codeProprietaire' && sortDirection === 'asc'"></i>
                            <i class="fas fa-sort-down" *ngIf="sortField === 'codeProprietaire' && sortDirection === 'desc'"></i>
                        </th>
                        <th>
                            <i class="fas fa-cogs"></i> Service
                        </th>
                        <th class="sortable amount-column" (click)="sortBy('montant')">
                            <i class="fas fa-minus"></i> D√©bit
                            <i class="fas fa-sort" *ngIf="sortField !== 'montant'"></i>
                            <i class="fas fa-sort-up" *ngIf="sortField === 'montant' && sortDirection === 'asc'"></i>
                            <i class="fas fa-sort-down" *ngIf="sortField === 'montant' && sortDirection === 'desc'"></i>
                        </th>
                        <th class="sortable amount-column" (click)="sortBy('montant')">
                            <i class="fas fa-plus"></i> Cr√©dit
                            <i class="fas fa-sort" *ngIf="sortField !== 'montant'"></i>
                            <i class="fas fa-sort-up" *ngIf="sortField === 'montant' && sortDirection === 'asc'"></i>
                            <i class="fas fa-sort-down" *ngIf="sortField === 'montant' && sortDirection === 'desc'"></i>
                        </th>
                        <th class="amount-column">
                            <i class="fas fa-balance-scale"></i> Solde Avant
                        </th>
                        <th class="amount-column">
                            <i class="fas fa-balance-scale"></i> Solde Apr√®s
                        </th>
                        <th>
                            <i class="fas fa-check-circle"></i> Statut
                        </th>
                        <th>
                            <i class="fas fa-globe"></i> Pays
                        </th>
                        <th>
                            <i class="fas fa-university"></i> Banque
                        </th>
                        <th>
                            <i class="fas fa-file"></i> Bordereau
                        </th>
                        <th>
                            <i class="fas fa-hashtag"></i> R√©f√©rence
                        </th>
                        <th class="actions-column">
                            <i class="fas fa-cogs"></i> Actions
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let op of pagedOperations; trackBy: trackByOperation" 
                        [ngClass]="getStatutClassForOperation(op.statut || 'EN_ATTENTE')"
                        [class.frais-row]="op.typeOperation === 'FRAIS_TRANSACTION'"
                        [class.has-frais]="op.typeOperation !== 'FRAIS_TRANSACTION' && hasAssociatedFrais(op)"
                        (click)="selectOperation(op)"
                        [class.selected]="selectedOperation?.id === op.id">
                        
                        <td class="date-cell">
                            <div class="date-content">
                                <span class="date-day">{{ op.dateOperation | date:'dd' }}</span>
                                <span class="date-month">{{ op.dateOperation | date:'MMM' }}</span>
                                <span class="date-time">{{ op.dateOperation | date:'HH:mm' }}</span>
                            </div>
                        </td>
                        
                        <td class="type-cell">
                            <span class="badge type-{{ op.typeOperation.replace(' ', '_') | lowercase }}">
                                {{ getTypeDisplayName(op.typeOperation) }}
                            </span>
                        </td>
                        
                        <td class="code-cell">
                            <span class="code-value">{{ op.codeProprietaire }}</span>
                        </td>
                        
                        <td class="service-cell">
                            <span class="service-name" [title]="op.service || '-'">
                                {{ op.service || '-' }}
                            </span>
                        </td>
                        
                        <td class="amount-cell debit">
                            <span class="amount-value" [ngClass]="getDebitCreditForOperation(op).debit > 0 ? 'montant-negatif' : 'montant-positif'">
                                {{ getDebitCreditForOperation(op).debit > 0 ? (getDebitCreditForOperation(op).debit | number:'1.2-2') : '-' }}
                            </span>
                        </td>
                        
                        <td class="amount-cell credit">
                            <span class="amount-value" [ngClass]="getDebitCreditForOperation(op).credit > 0 ? 'montant-positif' : 'montant-negatif'">
                                {{ getDebitCreditForOperation(op).credit > 0 ? (getDebitCreditForOperation(op).credit | number:'1.2-2') : '-' }}
                            </span>
                        </td>
                        
                        <td class="amount-cell">
                            <span class="amount-value">{{ op.soldeAvant | number:'1.2-2' }}</span>
                        </td>
                        
                        <td class="amount-cell">
                            <span *ngIf="op.statut === 'Valid√©e'; else notCalculated" class="amount-value">
                                {{ op.soldeApres | number:'1.2-2' }}
                            </span>
                            <ng-template #notCalculated>
                                <span class="non-calcule">Non calcul√©</span>
                            </ng-template>
                        </td>
                        
                        <td class="status-cell">
                            <span class="statut-badge"
                                  [ngClass]="getStatutClassForOperation(op.statut || 'EN_ATTENTE')">
                                {{ getStatutDisplayName(op.statut || 'EN_ATTENTE') }}
                            </span>
                        </td>
                        
                        <td class="country-cell">
                            <span class="country-flag">üåç</span>
                            <span class="country-code">{{ op.pays }}</span>
                        </td>
                        
                        <td class="bank-cell">
                            <span class="bank-name">{{ op.banque }}</span>
                        </td>
                        
                        <td class="bordereau-cell">
                            <span class="bordereau-name" [title]="op.nomBordereau">
                                {{ op.nomBordereau || '-' }}
                            </span>
                        </td>
                        
                        <td class="reference-cell">
                            <span class="reference-value">{{ op.reference || '-' }}</span>
                        </td>
                        
                        <td class="actions-cell">
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-success" 
                                        (click)="editOperation(op); $event.stopPropagation()" 
                                        title="Modifier l'op√©ration">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" 
                                        (click)="annulerOperation(op.id!); $event.stopPropagation()" 
                                        title="Annuler l'op√©ration">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" 
                                        (click)="deleteOperation(op.id!); $event.stopPropagation()" 
                                        title="Supprimer l'op√©ration">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-info" 
                                        (click)="viewOperationDetails(op); $event.stopPropagation()" 
                                        title="Voir les d√©tails">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination am√©lior√©e -->
        <div class="pagination" *ngIf="totalPages > 1">
            <div class="pagination-info">
                <span>Affichage {{ (currentPage - 1) * pageSize + 1 }} - {{ getMin(currentPage * pageSize, filteredOperations.length) }} sur {{ filteredOperations.length }}</span>
            </div>
            
            <div class="pagination-controls">
                <button (click)="prevPage()" [disabled]="currentPage === 1" class="btn-pagination">
                    <i class="fas fa-chevron-left"></i> Pr√©c√©dent
                </button>
                
                <div class="pagination-indicators">
                    <span *ngFor="let page of getVisiblePages()" 
                          class="page-indicator"
                          [class.active]="currentPage === page"
                          (click)="goToPage(page)">
                        {{ page }}
                    </span>
                </div>
                
                <button (click)="nextPage()" [disabled]="currentPage === totalPages" class="btn-pagination">
                    Suivant <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div> 

<!-- R√©sum√© global et par type en bas de la page -->
<style>
  .operations-resume {
    margin-top: 32px;
    background: #f8fafc;
    border-radius: 10px;
    box-shadow: 0 2px 8px #0001;
    padding: 24px 16px 8px 16px;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
  }
  .resume-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 1.05em;
  }
  .resume-table th, .resume-table td {
    padding: 10px 8px;
    text-align: right;
  }
  .resume-table th {
    background: #e3f2fd;
    color: #1976d2;
    font-weight: 600;
    border-bottom: 2px solid #bbdefb;
    text-align: right;
  }
  .resume-table th:first-child, .resume-table td:first-child {
    text-align: left;
  }
  .resume-table tr.global-row {
    background: #e3f2fd;
    font-weight: bold;
    color: #1976d2;
  }
  .resume-table tr.type-row {
    background: #f5fafd;
    color: #333;
    border-bottom: 1px solid #e0e0e0;
  }
</style>
<div class="operations-resume">
  <table class="resume-table">
    <thead>
      <tr>
        <th>R√©sum√©</th>
        <th>Nombre d'op√©rations</th>
        <th>Total D√©bit</th>
        <th>Total Cr√©dit</th>
      </tr>
    </thead>
    <tbody>
      <tr class="global-row">
        <td>Global</td>
        <td>{{ resumeGlobal.count }}</td>
        <td>{{ resumeGlobal.totalDebit | number:'1.2-2' }}</td>
        <td>{{ resumeGlobal.totalCredit | number:'1.2-2' }}</td>
      </tr>
      <tr *ngFor="let type of (resumeByType | keyvalue)" class="type-row">
        <td>{{ type.key }}</td>
        <td>-</td>
        <td>{{ type.value.debit | number:'1.2-2' }}</td>
        <td>{{ type.value.credit | number:'1.2-2' }}</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Ajout du sous-menu Log utilisateur dans les param√®tres -->
<nav class="settings-menu">
  <ul>
    <li><a routerLink="/settings/profile">Profil</a></li>
    <li><a routerLink="/settings/security">S√©curit√©</a></li>
    <li><a routerLink="/settings/log-utilisateur">Log utilisateur</a></li>
  </ul>
</nav> 

<!-- Modal pour les d√©tails d'op√©ration -->
<div *ngIf="showOperationDetailsModal" class="modal-overlay">
  <div class="modal-content operation-details-modal">
    <div class="modal-header">
      <h4>D√©tails de l'Op√©ration</h4>
      <button type="button" class="close-btn" (click)="closeOperationDetailsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body" *ngIf="modalSelectedOperation">
      <!-- Informations g√©n√©rales -->
      <div class="detail-section">
        <h5>Informations G√©n√©rales</h5>
        <div class="detail-grid">
          <div class="detail-item">
            <label>ID :</label>
            <span>{{ modalSelectedOperation.id }}</span>
          </div>
          <div class="detail-item">
            <label>Type d'Op√©ration :</label>
            <span class="type-operation">{{ modalSelectedOperation.typeOperation }}</span>
          </div>
          <div class="detail-item">
            <label>Date d'Op√©ration :</label>
            <span>{{ formatDate(modalSelectedOperation.dateOperation || '') }}</span>
          </div>
          <div class="detail-item">
            <label>Statut :</label>
            <span class="status-badge" [ngClass]="getStatusClass(modalSelectedOperation.statut || '')">
              {{ modalSelectedOperation.statut }}
            </span>
          </div>
        </div>
      </div>

      <!-- Informations financi√®res -->
      <div class="detail-section">
        <h5>Informations Financi√®res</h5>
        <div class="detail-grid">
          <div class="detail-item">
            <label>Montant :</label>
            <span class="amount" [ngClass]="getAmountClass(modalSelectedOperation.montant || 0)">
              {{ modalSelectedOperation.montant | number:'1.2-2' }}
            </span>
          </div>
          <div class="detail-item">
            <label>Solde Avant :</label>
            <span class="amount">{{ modalSelectedOperation.soldeAvant | number:'1.2-2' }}</span>
          </div>
          <div class="detail-item">
            <label>Solde Apr√®s :</label>
            <span class="amount">{{ modalSelectedOperation.soldeApres | number:'1.2-2' }}</span>
          </div>
          <div class="detail-item">
            <label>Variation de Solde :</label>
            <span class="amount" [ngClass]="getVariationClass((modalSelectedOperation.soldeApres || 0) - (modalSelectedOperation.soldeAvant || 0))">
              {{ ((modalSelectedOperation.soldeApres || 0) - (modalSelectedOperation.soldeAvant || 0)) | number:'1.2-2' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Informations de r√©f√©rence -->
      <div class="detail-section">
        <h5>Informations de R√©f√©rence</h5>
        <div class="detail-grid">
                     <div class="detail-item">
             <label>Code Propri√©taire :</label>
             <span>{{ modalSelectedOperation.codeProprietaire }}</span>
           </div>
           <div class="detail-item">
             <label>Pays :</label>
             <span>{{ modalSelectedOperation.pays }}</span>
           </div>
           <div class="detail-item">
             <label>Service :</label>
             <span>{{ modalSelectedOperation.service || 'Non sp√©cifi√©' }}</span>
           </div>
           <div class="detail-item">
             <label>Banque :</label>
             <span>{{ modalSelectedOperation.banque || 'Non sp√©cifi√©e' }}</span>
           </div>
           <div class="detail-item">
             <label>Nom Bordereau :</label>
             <span>{{ modalSelectedOperation.nomBordereau || 'Non sp√©cifi√©' }}</span>
           </div>
           <div class="detail-item">
             <label>R√©f√©rence :</label>
             <span>{{ modalSelectedOperation.reference || 'Non sp√©cifi√©e' }}</span>
           </div>
        </div>
      </div>

             <!-- Informations de liaison -->
       <div class="detail-section" *ngIf="modalSelectedOperation.compteId || modalSelectedOperation.parentOperationId">
         <h5>Informations de Liaison</h5>
         <div class="detail-grid">
           <div class="detail-item" *ngIf="modalSelectedOperation.compteId">
             <label>ID Compte :</label>
             <span>{{ modalSelectedOperation.compteId }}</span>
           </div>
           <div class="detail-item" *ngIf="modalSelectedOperation.parentOperationId">
             <label>ID Op√©ration Parent :</label>
             <span>{{ modalSelectedOperation.parentOperationId }}</span>
           </div>
         </div>
       </div>

       <!-- Analyse de l'op√©ration -->
       <div class="detail-section">
         <h5>Analyse de l'Op√©ration</h5>
         <div class="operation-analysis">
           <div class="analysis-item" [ngClass]="getOperationTypeClass(modalSelectedOperation.typeOperation || '')">
             <i class="fas" [ngClass]="getOperationTypeIcon(modalSelectedOperation.typeOperation || '')"></i>
             <div class="analysis-content">
               <h6>{{ getOperationTypeLabel(modalSelectedOperation.typeOperation || '') }}</h6>
               <p>{{ getOperationTypeDescription(modalSelectedOperation.typeOperation || '') }}</p>
             </div>
           </div>
           
                        <div class="analysis-item" *ngIf="modalSelectedOperation.montant !== 0">
                           <i class="fas" [ngClass]="(modalSelectedOperation.montant || 0) > 0 ? 'fa-arrow-up text-success' : 'fa-arrow-down text-danger'"></i>
             <div class="analysis-content">
               <h6>{{ (modalSelectedOperation.montant || 0) > 0 ? 'Op√©ration Cr√©dit' : 'Op√©ration D√©bit' }}</h6>
               <p>Impact sur le solde : {{ (modalSelectedOperation.montant || 0) > 0 ? 'Augmentation' : 'Diminution' }}</p>
             </div>
           </div>
         </div>
       </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeOperationDetailsModal()">
        <i class="fas fa-times"></i> Fermer
      </button>
      <button type="button" class="btn btn-primary" (click)="editOperation(modalSelectedOperation!)" *ngIf="modalSelectedOperation">
        <i class="fas fa-edit"></i> Modifier
      </button>
      <button type="button" class="btn btn-info" (click)="exportOperationDetails(modalSelectedOperation!)" *ngIf="modalSelectedOperation">
        <i class="fas fa-file-excel"></i> Exporter
      </button>
    </div>
  </div>
</div> 