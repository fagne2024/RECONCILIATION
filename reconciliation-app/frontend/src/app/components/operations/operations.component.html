<div class="operations-container">
    <!-- En-tête -->
    <div class="header">
        <h1>Gestion des Opérations</h1>
        <button class="btn-primary" (click)="showAddForm = true" *ngIf="!showAddForm && !showEditForm">
            <i class="fas fa-plus"></i> Ajouter une opération
        </button>
    </div>

    <!-- Statistiques -->
    <div class="stats-section">
        <div *ngIf="isLoadingStats" class="loading-stats">
            <i class="fas fa-spinner fa-spin"></i> Chargement des statistiques...
        </div>
        
        <div *ngIf="!isLoadingStats && statsByType" class="stats-by-type">
            <div class="stats-header">
                <h3>Statistiques par Type d'Opération</h3>
                
                <!-- Filtres -->
                <div class="stats-filters">
                    <div class="filter-group">
                        <app-autocomplete-input
                            [options]="paysList"
                            [(ngModel)]="selectedPays"
                            placeholder="Saisir un pays..."
                            label="Pays:">
                        </app-autocomplete-input>
                    </div>
                    
                    <div class="filter-group">
                        <app-autocomplete-input
                            [options]="codeProprietaireList"
                            formControlName="codeProprietaire"
                            placeholder="Saisir un code propriétaire..."
                            label="Code propriétaire:">
                        </app-autocomplete-input>
                    </div>
                    
                    <button class="btn-secondary" (click)="clearStatsFilters()">
                        <i class="fas fa-times"></i> Effacer les filtres
                    </button>
                </div>
            </div>
            
            <div *ngIf="getOperationTypes().length === 0" class="no-stats-message">
                <i class="fas fa-info-circle"></i>
                <p>Aucune opération trouvée avec les filtres actuels.</p>
                <p>Les types d'opérations disponibles incluent : Total Cash-in, Total Paiement, Approvisionnement, Ajustement, Compense, et Frais Transaction.</p>
            </div>
            
            <div *ngIf="getOperationTypes().length > 0" class="stats-grid">
                <div *ngFor="let type of getPagedOperationTypes()" 
                     class="stat-type-card" 
                     [class.empty]="!statsByType[type] || (statsByType[type]?.count === 0 && statsByType[type]?.totalAmount === 0)">
                    <div class="stat-type-header">
                        <h4>{{ getTypeDisplayName(type) }}</h4>
                    </div>
                    <div class="stat-type-content">
                        <div class="stat-item">
                            <span class="stat-label" *ngIf="type === 'total_cashin' || type === 'total_paiement'; else nombreLabel">Nombre AG:</span>
                            <ng-template #nombreLabel><span class="stat-label">Nombre:</span></ng-template>
                            <span class="stat-value">{{ statsByType[type]?.count || 0 }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Montant Total:</span>
                            <span class="stat-value">{{ (statsByType[type]?.totalAmount || 0) | number:'1.0-2' }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pagination des cartes de statistiques -->
            <div *ngIf="totalStatsPages > 1" class="stats-pagination">
                <button class="btn-pagination" 
                        [disabled]="currentStatsPage === 1"
                        (click)="prevStatsPage()">
                    <i class="fas fa-chevron-left"></i> Précédent
                </button>
                
                <div class="pagination-indicators">
                    <span *ngFor="let page of getVisibleStatsPages()" 
                          class="page-indicator"
                          [class.active]="currentStatsPage === page"
                          (click)="goToStatsPage(page)">
                        {{ page }}
                    </span>
                </div>
                
                <button class="btn-pagination" 
                        [disabled]="currentStatsPage === totalStatsPages"
                        (click)="nextStatsPage()">
                    Suivant <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Formulaire d'ajout -->
    <!-- Modal d'ajout d'opération -->
    <div *ngIf="showAddForm" class="modal-overlay" (click)="closeAddModal($event)">
        <div class="modal-container" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Ajouter une nouvelle opération</h3>
                <button type="button" class="modal-close" (click)="cancelAdd()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <form [formGroup]="addForm" (ngSubmit)="addOperation()" class="add-form">
                    <!-- Informations de base -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-info-circle"></i> Informations de base
                        </h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <app-autocomplete-input
                                    [options]="typeOperations"
                                    formControlName="typeOperation"
                                    placeholder="Saisir ou sélectionner un type..."
                                    label="Type d'opération *">
                                </app-autocomplete-input>
                                <div *ngIf="addForm.get('typeOperation')?.invalid && addForm.get('typeOperation')?.touched" class="error-message">
                                    <i class="fas fa-exclamation-circle"></i>
                                    Le type d'opération est requis
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Date d'opération *</label>
                                <div class="date-input-wrapper">
                                    <input type="date" formControlName="dateOperation" [max]="maxDate" class="date-input">
                                    <i class="fas fa-calendar-alt date-icon"></i>
                                </div>
                                <div *ngIf="addForm.get('dateOperation')?.invalid && addForm.get('dateOperation')?.touched" class="error-message">
                                    <i class="fas fa-exclamation-circle"></i>
                                    La date d'opération est requise
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <app-autocomplete-input
                                    [options]="codeProprietaireList"
                                    formControlName="codeProprietaire"
                                    placeholder="Saisir ou sélectionner un code propriétaire..."
                                    label="Code propriétaire *">
                                </app-autocomplete-input>
                                <div *ngIf="codeProprietaireList.length === 0" class="info-message">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    Chargement des codes propriétaire...
                                </div>
                                <div *ngIf="addForm.get('codeProprietaire')?.invalid && addForm.get('codeProprietaire')?.touched" class="error-message">
                                    <i class="fas fa-exclamation-circle"></i>
                                    Le code propriétaire est requis
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Service</label>
                                <app-autocomplete-input
                                    [options]="serviceList"
                                    formControlName="service"
                                    placeholder="Ex: CASHIN, PAIEMENT..."
                                    label="Service">
                                </app-autocomplete-input>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Banque</label>
                                <app-autocomplete-input
                                    [options]="banqueList"
                                    formControlName="banque"
                                    placeholder="Ex: ECOBANK CM, BNP Paribas..."
                                    label="Banque">
                                </app-autocomplete-input>
                            </div>
                            <div class="form-group">
                                <label>Nom du bordereau</label>
                                <input type="text" formControlName="nomBordereau" 
                                    placeholder="Ex: 19S50zsyf252050003/1753" class="text-input">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Référence</label>
                                <input type="text" formControlName="reference" 
                                    placeholder="Ex: REF-2024-001" class="text-input">
                            </div>
                        </div>
                    </div>



                    <!-- Détails financiers -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-calculator"></i> Détails financiers
                        </h4>
                        
                        <div class="financial-preview">
                            <div class="preview-card">
                                <div class="preview-header">
                                    <h5>Aperçu de l'impact</h5>
                                </div>
                                <div class="preview-content">
                                    <div class="impact-item">
                                        <span class="impact-label">Solde avant:</span>
                                        <span class="impact-value">{{ addForm.get('soldeAvant')?.value | currency:'XAF':'symbol':'1.0-0' }}</span>
                                    </div>
                                    <div class="impact-item">
                                        <span class="impact-label">Montant:</span>
                                        <span class="impact-value" [class.positive]="getAddImpactDirection() === 'positive'" 
                                            [class.negative]="getAddImpactDirection() === 'negative'">
                                            {{ getAddImpactDirection() === 'positive' ? '+' : '' }}{{ addForm.get('montant')?.value | currency:'XAF':'symbol':'1.0-0' }}
                                        </span>
                                    </div>
                                    <div class="impact-item total">
                                        <span class="impact-label">Solde après:</span>
                                        <span class="impact-value">{{ calculateAddSoldeApres() | currency:'XAF':'symbol':'1.0-0' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Montant * <span class="help-text">(Utilisez des valeurs négatives pour les ajustements)</span></label>
                                <div class="amount-input-wrapper">
                                    <input type="number" formControlName="montant" 
                                        placeholder="0.00" step="0.01" class="amount-input"
                                        (input)="onAddMontantChange()">
                                    <span class="currency-symbol">XAF</span>
                                </div>
                                <div *ngIf="addForm.get('montant')?.invalid && addForm.get('montant')?.touched" class="error-message">
                                    <i class="fas fa-exclamation-circle"></i>
                                    Le montant est requis
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Pays (automatique)</label>
                                <div class="readonly-field">
                                    <span>{{ addForm.get('pays')?.value || 'Non défini' }}</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Solde avant (automatique)</label>
                                <div class="readonly-field">
                                    <span>{{ addForm.get('soldeAvant')?.value | currency:'XAF':'symbol':'1.0-0' }}</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Solde après (calculé automatiquement)</label>
                                <div class="readonly-field">
                                    <span>{{ calculateAddSoldeApres() | currency:'XAF':'symbol':'1.0-0' }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="warning-section" *ngIf="showAddWarningMessage()">
                            <div class="warning-card">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div class="warning-content">
                                    <h6>Attention</h6>
                                    <p>{{ getAddWarningMessage() }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" (click)="cancelAdd()">
                        <i class="fas fa-times"></i>
                        Annuler
                    </button>
                    <button type="submit" class="btn-primary" 
                        [disabled]="!addForm.valid || isAdding"
                        (click)="addOperation()">
                        <i class="fas fa-plus"></i>
                        {{ isAdding ? 'Ajout en cours...' : 'Ajouter l\'opération' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire de modification -->
    <div *ngIf="showEditForm && editingOperation" class="edit-form-section">
        <!-- Navigation par étapes -->
        <div class="step-navigation">
            <div class="step-item" [class.active]="currentEditStep === 1" (click)="setEditStep(1)">
                <div class="step-number">1</div>
                <span class="step-label">Informations de base</span>
            </div>
            <div class="step-item" [class.active]="currentEditStep === 2" (click)="setEditStep(2)">
                <div class="step-number">2</div>
                <span class="step-label">Détails financiers</span>
            </div>
            <div class="step-item" [class.active]="currentEditStep === 3" (click)="setEditStep(3)">
                <div class="step-number">3</div>
                <span class="step-label">Validation</span>
            </div>
        </div>

        <div class="form-header">
            <h3>Modifier l'opération #{{ editingOperation.id }}</h3>
            <div class="operation-status">
                <span class="status-badge" [class]="'status-' + editingOperation.statut.toLowerCase()">
                    {{ editingOperation.statut }}
                </span>
            </div>
        </div>

        <form [formGroup]="editForm" (ngSubmit)="updateOperation()" class="form">
            <!-- Étape 1: Informations de base -->
            <div *ngIf="currentEditStep === 1" class="form-step">
                <div class="step-content">
                    <h4>Informations de base</h4>
                    
                    <!-- Informations en lecture seule -->
                    <div class="readonly-info">
                        <div class="info-card">
                            <div class="info-item">
                                <label>Code propriétaire</label>
                                <div class="readonly-value">{{ editingOperation.codeProprietaire }}</div>
                            </div>
                            <div class="info-item">
                                <label>Pays</label>
                                <div class="readonly-value">{{ editingOperation.pays }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Champs éditables -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Type d'opération *</label>
                            <app-autocomplete-input
                                [options]="typeOperations"
                                formControlName="typeOperation"
                                placeholder="Sélectionner un type d'opération..."
                                label="Type d'opération">
                            </app-autocomplete-input>
                            <div *ngIf="editForm.get('typeOperation')?.invalid && editForm.get('typeOperation')?.touched" 
                                class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                Le type d'opération est requis
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Date d'opération *</label>
                            <div class="date-input-wrapper">
                                <input type="date" formControlName="dateOperation" 
                                    [max]="maxDate" class="date-input">
                                <i class="fas fa-calendar-alt date-icon"></i>
                            </div>
                            <div *ngIf="editForm.get('dateOperation')?.invalid && editForm.get('dateOperation')?.touched" 
                                class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                La date d'opération est requise
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Banque</label>
                            <app-autocomplete-input
                                [options]="banqueList"
                                formControlName="banque"
                                placeholder="Ex: ECOBANK CM, BNP Paribas..."
                                label="Banque">
                            </app-autocomplete-input>
                        </div>
                        <div class="form-group">
                            <label>Service</label>
                            <app-autocomplete-input
                                [options]="serviceList"
                                formControlName="service"
                                placeholder="Ex: CASHIN, PAIEMENT..."
                                label="Service">
                            </app-autocomplete-input>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Nom du bordereau</label>
                            <input type="text" formControlName="nomBordereau" 
                                placeholder="Ex: 19S50zsyf252050003/1753" class="text-input">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Référence</label>
                            <input type="text" formControlName="reference" 
                                placeholder="Ex: REF-2024-001" class="text-input">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Étape 2: Détails financiers -->
            <div *ngIf="currentEditStep === 2" class="form-step">
                <div class="step-content">
                    <h4>Détails financiers</h4>
                    
                    <div class="financial-preview">
                        <div class="preview-card">
                            <div class="preview-header">
                                <h5>Aperçu de l'impact</h5>
                            </div>
                            <div class="preview-content">
                                <div class="impact-item">
                                    <span class="impact-label">Solde avant:</span>
                                    <span class="impact-value">{{ editingOperation.soldeAvant | currency:'XAF':'symbol':'1.0-0' }}</span>
                                </div>
                                <div class="impact-item">
                                    <span class="impact-label">Montant:</span>
                                    <span class="impact-value" [class.positive]="getImpactDirection() === 'positive'" 
                                        [class.negative]="getImpactDirection() === 'negative'">
                                        {{ getImpactDirection() === 'positive' ? '+' : '' }}{{ editForm.get('montant')?.value | currency:'XAF':'symbol':'1.0-0' }}
                                    </span>
                                </div>
                                <div class="impact-item total">
                                    <span class="impact-label">Solde après:</span>
                                    <span class="impact-value">{{ calculateNewSoldeApres() | currency:'XAF':'symbol':'1.0-0' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Montant * <span class="help-text">(Utilisez des valeurs négatives pour les ajustements)</span></label>
                            <div class="amount-input-wrapper">
                                <input type="number" formControlName="montant" 
                                    placeholder="0.00" step="0.01" class="amount-input"
                                    (input)="onMontantChange()">
                                <span class="currency-symbol">XAF</span>
                            </div>
                            <div *ngIf="editForm.get('montant')?.invalid && editForm.get('montant')?.touched" 
                                class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                Le montant est requis
                            </div>
                        </div>
                    </div>

                    <div class="warning-section" *ngIf="showWarningMessage()">
                        <div class="warning-card">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div class="warning-content">
                                <h6>Attention</h6>
                                <p>{{ getWarningMessage() }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Étape 3: Validation -->
            <div *ngIf="currentEditStep === 3" class="form-step">
                <div class="step-content">
                    <h4>Validation des modifications</h4>
                    
                    <div class="validation-summary">
                        <div class="summary-card">
                            <h5>Récapitulatif des modifications</h5>
                            <div class="summary-content">
                                <div class="summary-item">
                                    <span class="summary-label">Type d'opération:</span>
                                    <span class="summary-value">{{ getTypeDisplayName(editForm.get('typeOperation')?.value) }}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Date d'opération:</span>
                                    <span class="summary-value">{{ editForm.get('dateOperation')?.value | date:'dd/MM/yyyy' }}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Montant:</span>
                                    <span class="summary-value">{{ editForm.get('montant')?.value | currency:'XAF':'symbol':'1.0-0' }}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Banque:</span>
                                    <span class="summary-value">{{ editForm.get('banque')?.value || 'Non spécifié' }}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Service:</span>
                                    <span class="summary-value">{{ editForm.get('service')?.value || 'Non spécifié' }}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Bordereau:</span>
                                    <span class="summary-value">{{ editForm.get('nomBordereau')?.value || 'Non spécifié' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="confirmation-section">
                        <div class="confirmation-card">
                            <i class="fas fa-info-circle"></i>
                            <div class="confirmation-content">
                                <h6>Confirmation</h6>
                                <p>En confirmant cette modification, toutes les opérations suivantes seront recalculées automatiquement.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation des étapes -->
            <div class="step-navigation-actions">
                <button type="button" class="btn-secondary" 
                    (click)="previousEditStep()" 
                    [disabled]="currentEditStep === 1">
                    <i class="fas fa-arrow-left"></i>
                    Précédent
                </button>
                
                <div class="step-indicators">
                    <span class="step-dot" [class.active]="currentEditStep === 1"></span>
                    <span class="step-dot" [class.active]="currentEditStep === 2"></span>
                    <span class="step-dot" [class.active]="currentEditStep === 3"></span>
                </div>

                <button type="button" class="btn-primary" 
                    (click)="nextEditStep()" 
                    [disabled]="!canProceedToNextStep()"
                    *ngIf="currentEditStep < 3">
                    Suivant
                    <i class="fas fa-arrow-right"></i>
                </button>
                
                <button type="submit" class="btn-success" 
                    [disabled]="!editForm.valid || currentEditStep !== 3"
                    *ngIf="currentEditStep === 3">
                    <i class="fas fa-check"></i>
                    Mettre à jour
                </button>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-cancel" (click)="cancelEdit()">
                    <i class="fas fa-times"></i>
                    Annuler
                </button>
            </div>
        </form>
    </div>



    <!-- Filtres -->
    <div class="filters-section">
        <h3>Filtres</h3>
        <form [formGroup]="filterForm" (ngSubmit)="applyFilters()" class="filters-form">
            <div class="form-row">
                <div class="form-group">
                    <mat-form-field appearance="fill" class="filter-select">
                        <mat-label>Type d'opération</mat-label>
                        <mat-select #typeOperationSelect formControlName="typeOperation" multiple (selectionChange)="onFilterChange()">
                            <ngx-mat-select-search [formControl]="typeOperationSearchCtrl" placeholderLabel="Rechercher un type..." noEntriesFoundLabel="Aucun type trouvé"></ngx-mat-select-search>
                            <mat-option *ngFor="let opt of filteredTypeOperationList" [value]="opt.value">{{ opt.label }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div class="form-group">
                    <mat-form-field appearance="fill" class="filter-select">
                        <mat-label>Pays</mat-label>
                        <mat-select #paysSelect formControlName="pays" multiple (selectionChange)="onFilterChange()">
                            <ngx-mat-select-search [formControl]="paysSearchCtrl" placeholderLabel="Rechercher un pays..." noEntriesFoundLabel="Aucun pays trouvé"></ngx-mat-select-search>
                            <mat-option *ngFor="let pays of filteredPaysList" [value]="pays">{{ pays }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div class="form-group">
                    <mat-form-field appearance="fill" class="filter-select">
                        <mat-label>Statut</mat-label>
                        <mat-select #statutSelect formControlName="statut" multiple (selectionChange)="onFilterChange()">
                            <ngx-mat-select-search [formControl]="statutSearchCtrl" placeholderLabel="Rechercher un statut..." noEntriesFoundLabel="Aucun statut trouvé"></ngx-mat-select-search>
                            <mat-option *ngFor="let statut of filteredStatutList" [value]="statut">{{ statut }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div class="form-group">
                    <mat-form-field appearance="fill" class="filter-select">
                        <mat-label>Banque</mat-label>
                        <mat-select #banqueSelect formControlName="banque" multiple (selectionChange)="onFilterChange()">
                            <ngx-mat-select-search [formControl]="banqueSearchCtrl" placeholderLabel="Rechercher une banque..." noEntriesFoundLabel="Aucune banque trouvée"></ngx-mat-select-search>
                            <mat-option *ngFor="let banque of filteredBanqueList" [value]="banque">{{ banque }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <mat-form-field appearance="fill" class="filter-select">
                        <mat-label>Code propriétaire</mat-label>
                        <mat-select #codeProprietaireSelect formControlName="codeProprietaire" multiple (selectionChange)="onFilterChange()">
                            <ngx-mat-select-search [formControl]="codeProprietaireSearchCtrl" placeholderLabel="Rechercher un code propriétaire..." noEntriesFoundLabel="Aucun code trouvé"></ngx-mat-select-search>
                            <mat-option *ngFor="let code of filteredCodeProprietaireList" [value]="code">{{ code }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div class="form-group">
                    <mat-form-field appearance="fill" class="filter-select">
                        <mat-label>Service</mat-label>
                        <mat-select #serviceSelect formControlName="service" multiple (selectionChange)="onFilterChange()">
                            <ngx-mat-select-search [formControl]="serviceSearchCtrl" placeholderLabel="Rechercher un service..." noEntriesFoundLabel="Aucun service trouvé"></ngx-mat-select-search>
                            <mat-option *ngFor="let service of filteredServiceList" [value]="service">{{ service }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div class="form-group">
                    <mat-form-field appearance="fill" class="filter-select">
                        <mat-label>Référence</mat-label>
                        <mat-select #referenceSelect formControlName="reference" multiple (selectionChange)="onFilterChange()">
                            <ngx-mat-select-search [formControl]="referenceSearchCtrl" placeholderLabel="Rechercher une référence..." noEntriesFoundLabel="Aucune référence trouvée"></ngx-mat-select-search>
                            <mat-option *ngFor="let reference of filteredReferenceList" [value]="reference">{{ reference }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div class="form-group">
                    <label>Période rapide</label>
                    <select (change)="applyDatePreset($event)">
                        <option value="">-- Choisir --</option>
                        <option value="today">Aujourd'hui</option>
                        <option value="7days">7 derniers jours</option>
                        <option value="30days">30 derniers jours</option>
                        <option value="month">Ce mois</option>
                        <option value="thisYear">Cette année</option>
                        <option value="lastYear">Année dernière</option>
                        <option value="custom">Personnalisé</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date début</label>
                    <input type="date" formControlName="dateDebut">
                </div>
                <div class="form-group">
                    <label>Date fin</label>
                    <input type="date" formControlName="dateFin">
                </div>
            </div>
            <div class="form-actions">
                <button type="button" (click)="clearFilters()">Effacer les filtres</button>
                <button type="submit" class="apply-btn">Appliquer les filtres</button>
            </div>
        </form>
    </div>

    <!-- Indicateur d'affichage automatique des frais -->
    <div *ngIf="showFraisAutomatically" class="frais-auto-indicator">
        <div class="indicator-content">
            <i class="fas fa-info-circle"></i>
            <span>Les frais de transaction sont automatiquement affichés pour les types d'opérations sélectionnés</span>
        </div>
    </div>

    <!-- Liste des opérations -->
    <div class="operations-list">
        <div class="list-header">
            <h3>Liste des Opérations</h3>
            <button class="btn-secondary" (click)="exportOperations()" [disabled]="isExporting">
                {{ isExporting ? 'Export en cours...' : 'Exporter Excel' }}
            </button>
        </div>

        <div *ngIf="isLoading" class="loading">
            <p>Chargement des opérations...</p>
        </div>

        <div *ngIf="!isLoading && pagedOperations.length === 0" class="no-data">
            <p>Aucune opération trouvée</p>
        </div>

        <div *ngIf="!isLoading && pagedOperations.length > 0" class="table-container">
            <table class="operations-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Code propriétaire</th>
                        <th>Service</th>
                        <th>Débit</th>
                        <th>Crédit</th>
                        <th>Solde Avant</th>
                        <th>Solde Après</th>
                        <th>Statut</th>
                        <th>Pays</th>
                        <th>Banque</th>
                        <th>Bordereau</th>
                        <th>Référence</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let op of pagedOperations" 
                        [class.frais-row]="op.typeOperation === 'FRAIS_TRANSACTION'"
                        [class.has-frais]="op.typeOperation !== 'FRAIS_TRANSACTION' && hasAssociatedFrais(op)">
                        <td>{{ op.dateOperation | date:'dd/MM/yyyy HH:mm' }}</td>
                        <td>
                            <span class="badge type-{{ op.typeOperation.replace(' ', '_') | lowercase }}">
                                {{ op.typeOperation | uppercase }}
                            </span>
                        </td>
                        <td>{{ op.codeProprietaire }}</td>
                        <td>{{ op.service || '-' }}</td>
                        <td>
                          {{ getDebitCreditForOperation(op).debit ? (getDebitCreditForOperation(op).debit | number:'1.2-2') : '' }}
                        </td>
                        <td>
                          {{ getDebitCreditForOperation(op).credit ? (getDebitCreditForOperation(op).credit | number:'1.2-2') : '' }}
                        </td>
                        <td>{{ op.soldeAvant | number:'1.2-2' }}</td>
                        <td>
                            <span *ngIf="op.statut === 'Validée'; else notCalculated">
                                {{ op.soldeApres | number:'1.2-2' }}
                            </span>
                            <ng-template #notCalculated>
                                <span class="non-calcule">Non calculé</span>
                            </ng-template>
                        </td>
                        <td>
                            <span class="badge status-{{ op.statut.replace(' ', '_') | lowercase }}">
                                {{ op.statut }}
                            </span>
                        </td>
                        <td>{{ op.pays }}</td>
                        <td>{{ op.banque }}</td>
                        <td>{{ op.nomBordereau }}</td>
                        <td>{{ op.reference || '-' }}</td>
                        <td class="actions">
                            <button (click)="editOperation(op)" class="btn icon-btn edit" title="Modifier">
                                <i class="fas fa-edit" style="color: green;"></i>
                            </button>
                            <button class="btn-icon btn-validate" 
                                    (click)="validateOperation(op.id!)" 
                                    [disabled]="op.statut === 'Validée'"
                                    [class.disabled]="op.statut === 'Validée'"
                                    *ngIf="op.id">
                                <i class="fas fa-check"></i>
                            </button>
                            <button (click)="annulerOperation(op.id!)" [disabled]="isLoading" title="Annuler" class="btn icon-btn delete">
                                <i class="fas fa-ban" style="color: orange;"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination" *ngIf="totalPages > 1">
            <button (click)="prevPage()" [disabled]="currentPage === 1">
                <i class="fas fa-chevron-left"></i> Précédent
            </button>
            
            <div class="pagination-indicators">
                <span *ngFor="let page of getVisiblePages()" 
                      class="page-indicator"
                      [class.active]="currentPage === page"
                      (click)="goToPage(page)">
                    {{ page }}
                </span>
            </div>
            
            <button (click)="nextPage()" [disabled]="currentPage === totalPages">
                Suivant <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div> 

<!-- Résumé global et par type en bas de la page -->
<style>
  .operations-resume {
    margin-top: 32px;
    background: #f8fafc;
    border-radius: 10px;
    box-shadow: 0 2px 8px #0001;
    padding: 24px 16px 8px 16px;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
  }
  .resume-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 1.05em;
  }
  .resume-table th, .resume-table td {
    padding: 10px 8px;
    text-align: right;
  }
  .resume-table th {
    background: #e3f2fd;
    color: #1976d2;
    font-weight: 600;
    border-bottom: 2px solid #bbdefb;
    text-align: right;
  }
  .resume-table th:first-child, .resume-table td:first-child {
    text-align: left;
  }
  .resume-table tr.global-row {
    background: #e3f2fd;
    font-weight: bold;
    color: #1976d2;
  }
  .resume-table tr.type-row {
    background: #f5fafd;
    color: #333;
    border-bottom: 1px solid #e0e0e0;
  }
</style>
<div class="operations-resume">
  <table class="resume-table">
    <thead>
      <tr>
        <th>Résumé</th>
        <th>Nombre d'opérations</th>
        <th>Total Débit</th>
        <th>Total Crédit</th>
      </tr>
    </thead>
    <tbody>
      <tr class="global-row">
        <td>Global</td>
        <td>{{ resumeGlobal.count }}</td>
        <td>{{ resumeGlobal.totalDebit | number:'1.2-2' }}</td>
        <td>{{ resumeGlobal.totalCredit | number:'1.2-2' }}</td>
      </tr>
      <tr *ngFor="let type of (resumeByType | keyvalue)" class="type-row">
        <td>{{ type.key }}</td>
        <td>-</td>
        <td>{{ type.value.debit | number:'1.2-2' }}</td>
        <td>{{ type.value.credit | number:'1.2-2' }}</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Ajout du sous-menu Log utilisateur dans les paramètres -->
<nav class="settings-menu">
  <ul>
    <li><a routerLink="/settings/profile">Profil</a></li>
    <li><a routerLink="/settings/security">Sécurité</a></li>
    <li><a routerLink="/settings/log-utilisateur">Log utilisateur</a></li>
  </ul>
</nav> 