<div class="trx-sf-container">
  <div class="header">
    <h2>Gestion des Transactions SF (TRX SF)</h2>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="refreshData()" [disabled]="isLoading">
        <i class="fas fa-sync-alt"></i> Actualiser
      </button>
      <button class="btn btn-success" (click)="exportTrxSfData()" [disabled]="filteredTrxSfData.length === 0 || isLoading">
        <i class="fas fa-file-excel"></i> Exporter
      </button>
    </div>
  </div>

  <!-- Section Statistiques -->
  <div class="stats-section">
    <div class="stats-grid">
      <div class="stat-card stat-total">
        <div class="stat-value">{{ filteredTrxSfData.length }}</div>
        <div class="stat-label">TOTAL</div>
      </div>
      <div class="stat-card stat-en-attente">
        <div class="stat-value">{{ getStatutCount('EN_ATTENTE') }}</div>
        <div class="stat-label">EN ATTENTE</div>
      </div>
      <div class="stat-card stat-traite">
        <div class="stat-value">{{ getStatutCount('TRAITE') }}</div>
        <div class="stat-label">TRAITÉ</div>
      </div>
      <div class="stat-card stat-erreur">
        <div class="stat-value">{{ getStatutCount('ERREUR') }}</div>
        <div class="stat-label">ERREUR</div>
      </div>
      <div class="stat-card stat-montant">
        <div class="stat-value">{{ formatMontantTotal() }}</div>
        <div class="stat-label">MONTANT TOTAL</div>
      </div>
      <div class="stat-card stat-frais">
        <div class="stat-value">{{ formatFraisTotal() }}</div>
        <div class="stat-label">FRAIS TOTAL</div>
      </div>
    </div>
  </div>

  <!-- Section Upload -->
  <div class="upload-section">
    <h3>Import de fichier (CSV, XLS, XLSX)</h3>
    <div class="upload-form">
      <div class="file-input-group">
        <input 
          type="file" 
          class="file-input" 
          (change)="onFileSelected($event)"
          accept=".csv,.xlsx,.xls"
          #fileInput>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="validateFile()"
          [disabled]="!selectedFile || isUploading">
          <i class="fas fa-check"></i> Valider
        </button>
        <button 
          type="button" 
          class="btn btn-success" 
          (click)="uploadFile()"
          [disabled]="!selectedFile || isUploading">
          <i class="fas fa-upload"></i> 
          {{ isUploading ? 'Upload en cours...' : 'Uploader' }}
        </button>
      </div>
      
      <div class="upload-messages" *ngIf="uploadMessage">
        <div class="alert" [ngClass]="uploadMessage.type === 'success' ? 'alert-success' : 'alert-danger'">
          {{ uploadMessage.text }}
        </div>
      </div>
      
      <div class="validation-info" *ngIf="validationResult">
        <div class="alert" [ngClass]="validationResult.hasErrors ? 'alert-warning' : 'alert-info'">
          <h6>Résultat de la validation :</h6>
          <ul>
            <li>Lignes valides : {{ validationResult.validLines }}</li>
            <li>Lignes avec erreurs : {{ validationResult.errorLines }}</li>
            <li>Doublons détectés : {{ validationResult.duplicates }}</li>
            <li>Nouveaux enregistrements : {{ validationResult.newRecords }}</li>
          </ul>
        </div>
      </div>
      
      <div class="upload-info">
        <small class="text-muted">
          Formats acceptés : CSV, XLS, XLSX. La première ligne doit contenir les en-têtes.
        </small>
      </div>
    </div>
  </div>

  <!-- Section Gestion des Doublons -->
  <div class="duplicates-section">
    <h3>Gestion des Doublons</h3>
    <div class="duplicates-controls">
      <button class="btn btn-warning" (click)="loadDuplicates()" [disabled]="isLoadingDuplicates">
        <i class="fas fa-search"></i> 
        {{ isLoadingDuplicates ? 'Recherche...' : 'Rechercher les doublons' }}
      </button>
      <button class="btn btn-danger" (click)="removeDuplicates()" [disabled]="duplicates.length === 0 || isRemovingDuplicates">
        <i class="fas fa-trash"></i> 
        {{ isRemovingDuplicates ? 'Suppression...' : 'Supprimer les doublons' }}
      </button>
    </div>
    
    <div class="duplicates-info" *ngIf="duplicates.length > 0">
      <div class="alert alert-warning">
        <strong>{{ duplicates.length }} doublon(s) trouvé(s)</strong>
        <p>Les doublons sont basés sur la combinaison : ID Transaction + Agence + Date Transaction</p>
      </div>
    </div>
    
    <div class="duplicates-table" *ngIf="duplicates.length > 0">
      <table class="data-table">
        <thead>
          <tr>
            <th>ID Transaction</th>
            <th>Agence</th>
            <th>Date Transaction</th>
            <th>Service</th>
            <th>Montant</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let duplicate of duplicates" class="duplicate-row">
            <td>{{ duplicate.idTransaction }}</td>
            <td>{{ duplicate.agence }}</td>
            <td>{{ formatDate(duplicate.dateTransaction) }}</td>
            <td>{{ duplicate.service }}</td>
            <td class="amount">{{ formatMontant(duplicate.montant) }}</td>
            <td>
              <span class="status-badge" [ngClass]="getStatutClass(duplicate.statut || '')">
                {{ duplicate.statut || 'EN_ATTENTE' }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Filtres -->
  <div class="filters-section">
    <h3>Filtres</h3>
    <form [formGroup]="filterForm" class="filter-form">
      <div class="filter-row">
        <div class="filter-group">
          <label>Agence:</label>
          <select formControlName="agence" class="form-control">
            <option value="">Toutes les agences</option>
            <option *ngFor="let agence of getUniqueAgences()" [value]="agence">{{ agence }}</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>Service:</label>
          <select formControlName="service" class="form-control">
            <option value="">Tous les services</option>
            <option *ngFor="let service of getUniqueServices()" [value]="service">{{ service }}</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>Pays:</label>
          <select formControlName="pays" class="form-control">
            <option value="">Tous les pays</option>
            <option *ngFor="let pays of getUniquePays()" [value]="pays">{{ pays }}</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>Statut:</label>
          <select formControlName="statut" class="form-control">
            <option value="">Tous les statuts</option>
            <option *ngFor="let statut of statuts" [value]="statut">{{ statut }}</option>
          </select>
        </div>
      </div>
      
      <div class="filter-row">
        <div class="filter-group">
          <label>Date début:</label>
          <input type="datetime-local" formControlName="dateDebut" class="form-control">
        </div>
        
        <div class="filter-group">
          <label>Date fin:</label>
          <input type="datetime-local" formControlName="dateFin" class="form-control">
        </div>
        
        <div class="filter-actions">
          <button type="button" class="btn btn-secondary" (click)="clearFilters()">
            <i class="fas fa-times"></i> Effacer
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Tableau des données -->
  <div class="table-section">
    <div class="table-header">
      <h3>Transactions SF ({{ filteredTrxSfData.length }} enregistrements)</h3>
      <div class="table-info">
        Affichage des transactions SF filtrées
      </div>
      
      <!-- Contrôles de sélection multiple -->
      <div class="selection-controls" *ngIf="isSelectionMode">
        <div class="selection-info">
          <span class="selected-count">{{ getSelectedCount() }} sélectionné(s)</span>
        </div>
        <div class="selection-actions">
          <select [(ngModel)]="selectedStatut" class="form-control status-select">
            <option value="EN_ATTENTE">⏳ En attente</option>
            <option value="TRAITE">✅ Traité</option>
            <option value="ERREUR">❌ Erreur</option>
          </select>
          <button class="btn btn-primary" 
                  (click)="updateMultipleStatuts()" 
                  [disabled]="getSelectedCount() === 0 || isUpdatingMultipleStatuts">
            <i class="fas fa-save"></i>
            {{ isUpdatingMultipleStatuts ? 'Mise à jour...' : 'Mettre à jour' }}
          </button>
        </div>
      </div>
      
      <div class="table-actions">
        <button class="btn btn-secondary" (click)="toggleSelectionMode()" [class.active]="isSelectionMode">
          <i class="fas fa-check-square"></i>
          {{ isSelectionMode ? 'Mode sélection' : 'Sélection multiple' }}
        </button>
      </div>
    </div>

    <div class="table-container" *ngIf="!isLoading">
      <table class="data-table">
        <thead>
          <tr>
            <th *ngIf="isSelectionMode" class="checkbox-header">
              <input type="checkbox" 
                     [checked]="isSelectAll" 
                     (change)="toggleSelectAll()"
                     class="select-all-checkbox">
            </th>
            <th>ID Transaction</th>
            <th>Téléphone Client</th>
            <th>Montant</th>
            <th>Service</th>
            <th>Agence</th>
            <th>Date Transaction</th>
            <th>Numéro Trans GU</th>
            <th>Pays</th>
            <th>Statut</th>
            <th>Frais</th>
            <th>Commentaire</th>
            <th>Date Import</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of getPaginatedData()" class="data-row" [class.selected]="isItemSelected(item)">
            <td *ngIf="isSelectionMode" class="checkbox-cell">
              <input type="checkbox" 
                     [checked]="isItemSelected(item)" 
                     (change)="toggleItemSelection(item)"
                     class="item-checkbox">
            </td>
            <td>{{ item.idTransaction }}</td>
            <td>{{ item.telephoneClient || '-' }}</td>
            <td class="amount">{{ formatMontant(item.montant) }}</td>
            <td>{{ item.service || '-' }}</td>
            <td>{{ item.agence || '-' }}</td>
            <td>{{ formatDate(item.dateTransaction) }}</td>
            <td>{{ item.numeroTransGu || '-' }}</td>
            <td>{{ item.pays || '-' }}</td>
            <td>
              <span class="status-badge" [ngClass]="getStatutClass(item.statut || '')">
                {{ item.statut || 'EN_ATTENTE' }}
              </span>
            </td>
            <td class="frais-cell">
              <div class="frais-info">
                <span class="frais-amount">{{ formatMontantFrais(item.frais) }}</span>
              </div>
            </td>
            <td class="commentaire-cell">
              <div *ngIf="item.commentaire" class="commentaire-content">
                <span class="commentaire-text">{{ item.commentaire }}</span>
              </div>
              <div *ngIf="!item.commentaire" class="no-commentaire">
                <span class="no-commentaire-text">Aucun commentaire</span>
              </div>
            </td>
            <td>{{ formatDate(item.dateImport || '') }}</td>
            <td class="actions">
              <div class="action-buttons">
                <div class="status-change-container">
                  <label class="status-label">Statut:</label>
                  <select (change)="onStatutChange(item, $event)" 
                          [value]="item.statut || 'EN_ATTENTE'"
                          class="status-select"
                          [ngClass]="getStatutClass(item.statut || '')">
                    <option value="EN_ATTENTE">⏳ En attente</option>
                    <option value="TRAITE">✅ Traité</option>
                    <option value="ERREUR">❌ Erreur</option>
                  </select>
                </div>
                
                <button class="btn btn-danger btn-sm" 
                        (click)="deleteTrxSf(item.id!)"
                        title="Supprimer">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-container" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>Chargement des données TRX SF...</p>
    </div>

    <!-- Message si aucune donnée -->
    <div class="no-data" *ngIf="!isLoading && filteredTrxSfData.length === 0">
      <i class="fas fa-info-circle"></i>
      <p>Aucune donnée TRX SF trouvée avec les filtres actuels.</p>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination-section" *ngIf="totalPages > 1 && !isLoading">
    <div class="pagination-controls">
      <button 
        class="btn pagination-btn" 
        [disabled]="currentPage === 1"
        (click)="onPageChange(currentPage - 1)">
        <i class="fas fa-chevron-left"></i> Précédent
      </button>
      
      <div class="page-numbers">
        <button 
          *ngFor="let page of getVisiblePages()"
          class="btn page-btn"
          [class.active]="currentPage === page"
          (click)="onPageChange(page)">
          {{ page }}
        </button>
      </div>
      
      <button 
        class="btn pagination-btn" 
        [disabled]="currentPage === totalPages"
        (click)="onPageChange(currentPage + 1)">
        Suivant <i class="fas fa-chevron-right"></i>
      </button>
    </div>
    
    <div class="pagination-info">
      Page {{ currentPage }} sur {{ totalPages }} 
      ({{ filteredTrxSfData.length }} éléments au total)
    </div>
  </div>
</div>
