<div class="two-factor-auth-container">
  <div class="header">
    <h1>
      <mat-icon>security</mat-icon>
      Authentification à Deux Facteurs (2FA)
    </h1>
    <p class="subtitle">Sécurisez votre compte avec Google Authenticator</p>
  </div>


  <!-- Statut actuel du 2FA -->
  <div class="status-card" *ngIf="!showQRCode">
    <div class="status-header">
      <mat-icon [class.enabled]="is2FAEnabled" [class.disabled]="!is2FAEnabled">
        {{ is2FAEnabled ? 'verified_user' : 'lock_open' }}
      </mat-icon>
      <div class="status-info">
        <h2>Statut : {{ is2FAEnabled ? 'Activé' : 'Désactivé' }}</h2>
        <p *ngIf="is2FAEnabled" class="status-description">
          Votre compte est protégé par l'authentification à deux facteurs. 
          Vous devrez entrer un code depuis Google Authenticator à chaque connexion.
        </p>
        <p *ngIf="!is2FAEnabled" class="status-description">
          L'authentification à deux facteurs n'est pas activée. 
          Activez-la pour renforcer la sécurité de votre compte.
        </p>
      </div>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button 
        *ngIf="!is2FAEnabled" 
        mat-raised-button 
        color="primary" 
        (click)="setup2FA()" 
        [disabled]="loading"
        class="action-button">
        <mat-icon>security</mat-icon>
        Activer le 2FA
      </button>

      <button 
        *ngIf="is2FAEnabled" 
        mat-raised-button 
        color="warn" 
        (click)="disable2FA()" 
        [disabled]="loading"
        class="action-button">
        <mat-icon>lock_open</mat-icon>
        Désactiver le 2FA
      </button>

      <button 
        *ngIf="is2FAEnabled && hasSecret" 
        mat-button 
        color="primary" 
        (click)="setup2FA()" 
        [disabled]="loading"
        class="action-button secondary">
        <mat-icon>refresh</mat-icon>
        Régénérer la clé
      </button>
    </div>
  </div>

  <!-- Étape 1 : Affichage du QR Code et de la clé secrète -->
  <div class="setup-card" *ngIf="showQRCode">
    <h2>
      <mat-icon>qr_code_scanner</mat-icon>
      Configuration du 2FA
    </h2>

    <div class="instructions">
      <ol>
        <li>Téléchargez et installez <strong>Google Authenticator</strong> sur votre téléphone</li>
        <li>Ouvrez Google Authenticator et cliquez sur <strong>"+"</strong> > <strong>"Scanner un code QR"</strong></li>
        <li>Scannez le QR code ci-dessous avec votre téléphone</li>
        <li>Entrez le code à 6 chiffres affiché dans Google Authenticator pour activer le 2FA</li>
      </ol>
    </div>

    <!-- QR Code -->
    <div class="qr-code-container" *ngIf="qrCodeBase64">
      <img [src]="qrCodeBase64" alt="QR Code 2FA" class="qr-code-image">
      <p class="qr-code-hint">Scannez ce code avec Google Authenticator</p>
    </div>

    <!-- Clé secrète et URL OTP (pour saisie manuelle) -->
    <div class="secret-info" *ngIf="secret && otpAuthUrl">
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>info</mat-icon>
            Saisie manuelle (si le scan ne fonctionne pas)
          </mat-panel-title>
        </mat-expansion-panel-header>
        
        <div class="secret-details">
          <div class="secret-item">
            <label>Clé secrète :</label>
            <div class="secret-value">
              <code>{{ secret }}</code>
              <button mat-icon-button (click)="copySecret()" matTooltip="Copier la clé">
                <mat-icon>content_copy</mat-icon>
              </button>
            </div>
          </div>

          <div class="secret-item">
            <label>URL OTP Auth :</label>
            <div class="secret-value">
              <code class="url-code">{{ otpAuthUrl }}</code>
              <button mat-icon-button (click)="copyOtpAuthUrl()" matTooltip="Copier l'URL">
                <mat-icon>content_copy</mat-icon>
              </button>
            </div>
            <p class="hint">
              Dans Google Authenticator : "+" > "Saisir une clé" > 
              Nom: "Reconciliation App - {{ username }}" > 
              Clé: copiez la clé secrète ci-dessus
            </p>
          </div>
        </div>
      </mat-expansion-panel>
    </div>
  </div>

  <!-- Étape 2 : Validation avec code -->
  <div class="validation-card" *ngIf="showValidationForm">
    <h2>
      <mat-icon>vpn_key</mat-icon>
      Valider l'activation
    </h2>

    <p class="validation-instructions">
      Ouvrez Google Authenticator et entrez le code à 6 chiffres actuellement affiché.
    </p>

    <form [formGroup]="validationForm" (ngSubmit)="enable2FA()">
      <mat-form-field appearance="outline" class="code-field">
        <mat-label>Code d'authentification</mat-label>
        <input 
          matInput 
          formControlName="code" 
          placeholder="000000"
          maxlength="6"
          pattern="[0-9]{6}"
          autocomplete="off"
          required>
        <mat-icon matSuffix>vpn_key</mat-icon>
        <mat-hint>Entrez le code à 6 chiffres depuis Google Authenticator</mat-hint>
        <mat-error *ngIf="validationForm.get('code')?.hasError('required')">
          Le code est requis
        </mat-error>
        <mat-error *ngIf="validationForm.get('code')?.hasError('pattern')">
          Le code doit contenir exactement 6 chiffres
        </mat-error>
      </mat-form-field>

      <div class="validation-actions">
        <button 
          mat-raised-button 
          color="primary" 
          type="submit" 
          [disabled]="validationForm.invalid || loading"
          class="validate-button">
          <mat-icon *ngIf="!loading">verified_user</mat-icon>
          <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
          {{ loading ? 'Activation...' : 'Activer le 2FA' }}
        </button>

        <button 
          mat-button 
          type="button" 
          (click)="cancelSetup()" 
          [disabled]="loading"
          class="cancel-button">
          <mat-icon>cancel</mat-icon>
          Annuler
        </button>
      </div>
    </form>
  </div>

  <!-- Informations supplémentaires -->
  <mat-card class="info-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>help_outline</mat-icon>
        Informations
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <ul>
        <li>
          <strong>Qu'est-ce que le 2FA ?</strong><br>
          L'authentification à deux facteurs ajoute une couche de sécurité supplémentaire à votre compte.
          En plus de votre mot de passe, vous devrez entrer un code depuis Google Authenticator.
        </li>
        <li>
          <strong>Pourquoi utiliser le 2FA ?</strong><br>
          Même si quelqu'un obtient votre mot de passe, il ne pourra pas accéder à votre compte sans votre téléphone.
        </li>
        <li>
          <strong>Que faire si je perds mon téléphone ?</strong><br>
          Contactez un administrateur pour désactiver le 2FA, puis réactivez-le avec un nouveau téléphone.
          Vous pouvez aussi sauvegarder la clé secrète en lieu sûr pour la réimporter.
        </li>
        <li>
          <strong>Les codes changent-ils ?</strong><br>
          Oui, les codes changent toutes les 30 secondes pour plus de sécurité.
        </li>
      </ul>
    </mat-card-content>
  </mat-card>
</div>

