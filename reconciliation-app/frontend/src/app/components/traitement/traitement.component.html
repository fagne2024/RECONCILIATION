<div class="traitement-container">
  <button type="button" style="float:right;margin-bottom:16px; background:#1976d2; color:white;" (click)="newTraitement()">+ Nouveau traitement</button>
  <h2>Traitement de fichiers (CSV, XLS, XLSX)</h2>
  
  <!-- Barre de progression pour les fichiers volumineux -->
  <div *ngIf="isProcessing" class="processing-overlay">
    <div class="processing-container">
      <div class="processing-header">
        <div class="processing-icon">üîÑ</div>
        <h3>Traitement en cours...</h3>
        <p>{{ processingMessage }}</p>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="processingProgress"></div>
        </div>
        <div class="progress-text">{{ processingProgress.toFixed(1) }}%</div>
      </div>
      <div class="processing-info">
        <p>Fichier {{ currentFileIndex }}/{{ totalFilesToProcess }}</p>
        <p class="processing-tip">Veuillez patienter, le traitement peut prendre quelques minutes pour les fichiers volumineux...</p>
      </div>
    </div>
  </div>
  
  <div class="upload-area" (drop)="onDrop($event)" (dragover)="onDragOver($event)">
    <p>Glissez-d√©posez vos fichiers (CSV, XLS, XLSX) ici ou</p>
    <input type="file" multiple accept=".csv,.xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" (change)="onFileSelected($event)" id="fileInput" hidden />
    <button type="button" (click)="triggerFileInput()" [disabled]="isProcessing">S√©lectionner des fichiers (CSV, XLS, XLSX)</button>
    <div *ngIf="errorMsg.upload" class="error-msg">{{ errorMsg.upload }}</div>
  </div>
  <div *ngIf="successMsg.upload" class="success-msg" [innerHTML]="successMsg.upload"></div>
  
  <!-- Pr√©visualisation CSV -->
  <div *ngIf="showCsvPreview && csvPreviewData.length > 0" class="csv-preview-section">
    <h4>üìã Pr√©visualisation du fichier CSV</h4>
    <div class="preview-info">
      <p><strong>S√©parateur d√©tect√© :</strong> <code>{{ detectedDelimiter }}</code></p>
      <p><strong>Colonnes :</strong> {{ csvPreviewColumns.length }}</p>
      <p><strong>Aper√ßu :</strong> {{ csvPreviewData.length }} lignes</p>
    </div>
    
    <div class="csv-preview-table">
      <table>
        <thead>
          <tr>
            <th *ngFor="let col of csvPreviewColumns">{{ col }}</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of csvPreviewData">
            <td *ngFor="let col of csvPreviewColumns">{{ row[col] || '' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <div class="preview-actions">
      <button type="button" (click)="confirmCsvImport()" class="confirm-btn">
        ‚úÖ Confirmer l'import
      </button>
      <button type="button" (click)="cancelCsvPreview()" class="cancel-btn">
        ‚ùå Annuler
      </button>
    </div>
  </div>
  
  <div *ngIf="selectedFiles.length > 0" class="file-list">
    <h4>Fichiers s√©lectionn√©s :</h4>
    <ul>
      <li *ngFor="let file of selectedFiles">{{ file.name }}</li>
    </ul>
  </div>
  
  <!-- Indication Orange Money -->
  <div *ngIf="isOrangeMoneyFile" class="orange-money-indicator">
    <div class="orange-money-badge">
      <i class="fas fa-mobile-alt"></i>
      <span>Fichier Orange Money d√©tect√©</span>
      <small>Les lignes au-dessus de la premi√®re colonne "N¬∞" seront ignor√©es</small>
    </div>
  </div>
  
  <div *ngIf="allColumns.length > 0" class="select-cols-section">
    <h4>S√©lection des colonnes √† conserver</h4>
    <div class="select-cols">
      <label>
        <input type="checkbox"
               [checked]="selectedCols.length === allColumns.length && allColumns.length > 0"
               (change)="toggleSelectAllCols($event)">
        Tous
      </label>
      <!-- Colonnes individuelles -->
      <label *ngFor="let col of allColumns">
        <input type="checkbox" [value]="col" [checked]="selectedCols.includes(col)" (change)="onSelectColChange($event)">
        {{ col }}
      </label>
    </div>
    <button type="button" (click)="applyColumnSelection()" [disabled]="selectedCols.length === 0">Appliquer la s√©lection</button>
    <button type="button" (click)="resetColumnSelection()" style="margin-left:12px;">R√©initialiser la s√©lection</button>
    <div *ngIf="successMsg.select" class="success-msg">{{ successMsg.select }}</div>
    <div *ngIf="errorMsg.select" class="error-msg">{{ errorMsg.select }}</div>
  </div>
  <div *ngIf="columns.length > 0" class="extract-section">
    <h4>Extraction de donn√©es</h4>
    <label>Colonne √† extraire :</label>
    <select [(ngModel)]="extractCol">
      <option *ngFor="let col of columns" [value]="col">{{ col }}</option>
    </select>
    <label>Type d'extraction :</label>
    <select [(ngModel)]="extractType">
      <option value="emailDomain">Domaine email</option>
      <option value="firstChars">Gauche (n caract√®res)</option>
      <option value="lastChars">Droite (n caract√®res)</option>
    </select>
    <label>Nom de la nouvelle colonne :</label>
    <input type="text" [(ngModel)]="extractKey" placeholder="Nom de la colonne" style="width:180px; margin-left:8px;">
    <label *ngIf="extractType === 'firstChars' || extractType === 'lastChars'">Position de d√©part :</label>
    <input *ngIf="extractType === 'firstChars' || extractType === 'lastChars'" type="number" [(ngModel)]="extractStart" min="1" style="width:60px;">
    <label *ngIf="extractType === 'firstChars' || extractType === 'lastChars'">Nombre de caract√®res :</label>
    <input *ngIf="extractType === 'firstChars' || extractType === 'lastChars'" type="number" [(ngModel)]="extractCount" min="1" style="width:60px;">
    <button type="button" (click)="applyExtraction()" [disabled]="!extractCol || !extractType || (extractType !== 'emailDomain' && !extractCount)">Extraire</button>
    <div *ngIf="successMsg.extract" class="success-msg">{{ successMsg.extract }}</div>
    <div *ngIf="errorMsg.extract" class="error-msg">{{ errorMsg.extract }}</div>
  </div>
  <div *ngIf="columns.length > 0 && combinedRows.length > 0" class="filtre-section" style="margin-bottom: 24px;">
    <h4>Filtrer les lignes</h4>
    <div class="filter-controls">
      <div class="filter-group">
        <label>Colonne :</label>
        <select [(ngModel)]="selectedFilterColumn" (change)="onFilterColumnChange()">
          <option value="">-- Choisir une colonne --</option>
          <option *ngFor="let col of columns" [value]="col">{{ col }}</option>
        </select>
      </div>
      <div class="filter-group" *ngIf="selectedFilterColumn">
        <label>Valeur √† garder :</label>
        <mat-form-field appearance="fill" class="filter-select">
          <mat-label>S√©lectionner des valeurs</mat-label>
          <mat-select #filterValueSelect [(ngModel)]="selectedFilterValues" multiple>
            <ngx-mat-select-search [formControl]="filterValueSearchCtrl" placeholderLabel="Rechercher une valeur..." noEntriesFoundLabel="Aucune valeur trouv√©e"></ngx-mat-select-search>
            <mat-option value="__TOUS__" (click)="selectAllFilterValues()">
              <strong>üìã Tous</strong>
            </mat-option>
            <mat-option *ngFor="let val of filteredFilterValues" [value]="val">
              {{ val || '(vide)' }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="filter-actions">
        <button (click)="applyFilter()" [disabled]="!selectedFilterColumn || !selectedFilterValues.length" class="apply-btn">Appliquer le filtre</button>
        <button (click)="resetFilter()" [disabled]="!selectedFilterColumn && !selectedFilterValues.length" class="reset-btn">R√©initialiser</button>
      </div>
    </div>
    <div *ngIf="successMsg.filter" class="success-msg">{{ successMsg.filter }}</div>
    <div *ngIf="errorMsg.filter" class="error-msg">{{ errorMsg.filter }}</div>
  </div>
  <div *ngIf="columns.length > 1" class="concat-section" style="margin-bottom: 24px;">
    <h4>Concat√©ner plusieurs colonnes</h4>
    <div class="filter-controls">
      <div class="filter-group">
        <label>Colonnes √† concat√©ner :</label>
        <mat-form-field appearance="fill" class="filter-select">
          <mat-label>S√©lectionner des colonnes</mat-label>
          <mat-select [(ngModel)]="concatCols" multiple>
            <mat-option *ngFor="let col of columns" [value]="col">
              {{ col }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="filter-group">
        <label>Nom de la nouvelle colonne :</label>
        <input type="text" [(ngModel)]="concatNewCol" placeholder="Nom de la colonne" class="filter-input">
      </div>
      <div class="filter-group">
        <label>S√©parateur :</label>
        <input type="text" [(ngModel)]="concatSeparator" placeholder="ex: espace, -, /" class="filter-input">
      </div>
      <div class="filter-actions">
        <button (click)="applyConcat()" [disabled]="!concatCols.length || !concatNewCol" class="apply-btn">Concat√©ner</button>
      </div>
    </div>
    <div *ngIf="successMsg.concat" class="success-msg">{{ successMsg.concat }}</div>
    <div *ngIf="errorMsg.concat" class="error-msg">{{ errorMsg.concat }}</div>
  </div>
  <!-- Messages de performance -->
  <div *ngIf="successMsg.performance" class="success-msg performance-msg">
    <span class="performance-icon">‚ö°</span>
    {{ successMsg.performance }}
  </div>
  
  <div *ngIf="columns.length > 0 && combinedRows.length > 0" class="export-by-type-section">
    <h4>Export par type</h4>
    <div class="filter-controls">
      <div class="filter-group">
        <label>Colonne de tri :</label>
        <mat-form-field appearance="fill" class="filter-select">
          <mat-label>S√©lectionner une colonne</mat-label>
          <mat-select [(ngModel)]="exportTypeCol" (selectionChange)="onExportTypeColChange()">
            <mat-option *ngFor="let col of columns" [value]="col">
              {{ col }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="filter-group" *ngIf="exportTypeCol && exportTypeValues.length > 0">
        <label>Valeurs √† exporter :</label>
        <div class="export-type-values">
          <div class="export-type-controls">
            <button type="button" (click)="selectAllExportTypes()" class="select-all-btn">Tout s√©lectionner</button>
            <button type="button" (click)="deselectAllExportTypes()" class="deselect-all-btn">Tout d√©s√©lectionner</button>
          </div>
          <div class="checkbox-group">
            <label *ngFor="let val of exportTypeValues" class="checkbox-item">
              <input type="checkbox" [value]="val" [checked]="exportTypeSelected.includes(val)" (change)="onExportTypeValueChange($event)">
              {{ val || '(vide)' }}
            </label>
          </div>
        </div>
      </div>
      <div class="filter-group">
        <label>Suffixe du fichier :</label>
        <select [(ngModel)]="exportTypeSuffix" class="filter-input">
          <option value="">(aucun)</option>
          <option value="BO">BO</option>
          <option value="PART">PART</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Description :</label>
        <input type="text" [(ngModel)]="exportTypeDescription" placeholder="Description" class="filter-input">
      </div>
      <div class="filter-actions">
        <button type="button" (click)="exportByType()" [disabled]="!exportTypeCol || exportTypeSelected.length === 0" class="apply-btn">Exporter par type</button>
      </div>
    </div>
    <div *ngIf="successMsg.exportType" class="success-msg">{{ successMsg.exportType }}</div>
    <div *ngIf="errorMsg.exportType" class="error-msg">{{ errorMsg.exportType }}</div>
  </div>
  <div *ngIf="columns.length > 0" class="dedup-section">
    <h4>Suppression de doublons</h4>
    <label>S√©lectionnez les colonnes √† utiliser :</label>
    <div class="dedup-cols">
      <label *ngFor="let col of columns">
        <input type="checkbox" [value]="col" (change)="onDedupColChange($event)">
        {{ col }}
      </label>
    </div>
    <button type="button" (click)="deduplicate()" [disabled]="dedupCols.length === 0">Supprimer les doublons</button>
    <div *ngIf="successMsg.dedup" class="success-msg">{{ successMsg.dedup }}</div>
    <div *ngIf="errorMsg.dedup" class="error-msg">{{ errorMsg.dedup }}</div>
  </div>
  <div *ngIf="columns.length > 0" class="format-section">
    <h4>Formatage automatique</h4>
    <div class="format-options">
      <!-- Option : Supprimer les espaces inutiles -->
      <label>
        <input type="checkbox" [(ngModel)]="formatOptions['trimSpaces']"> Supprimer les espaces inutiles
      </label>
      <div *ngIf="formatOptions['trimSpaces']" class="format-columns">
        <label>Colonnes √† traiter :</label>
        <select multiple [(ngModel)]="formatSelections['trimSpaces']">
          <option *ngFor="let col of columns" [value]="col">{{ col }}</option>
        </select>
        <button type="button" disabled>Appliquer</button>
      </div>
      <!-- Option : Tout en minuscules -->
      <label>
        <input type="checkbox" [(ngModel)]="formatOptions['toLowerCase']"> Tout en minuscules
      </label>
      <div *ngIf="formatOptions['toLowerCase']" class="format-columns">
        <label>Colonnes √† traiter :</label>
        <select multiple [(ngModel)]="formatSelections['toLowerCase']">
          <option *ngFor="let col of columns" [value]="col">{{ col }}</option>
        </select>
        <button type="button" disabled>Appliquer</button>
      </div>
      <!-- Option : Tout en MAJUSCULES -->
      <label>
        <input type="checkbox" [(ngModel)]="formatOptions['toUpperCase']"> Tout en MAJUSCULES
      </label>
      <div *ngIf="formatOptions['toUpperCase']" class="format-columns">
        <label>Colonnes √† traiter :</label>
        <select multiple [(ngModel)]="formatSelections['toUpperCase']">
          <option *ngFor="let col of columns" [value]="col">{{ col }}</option>
        </select>
        <button type="button" disabled>Appliquer</button>
      </div>
      <!-- Option : Supprimer les tirets et virgules -->
      <label>
        <input type="checkbox" [(ngModel)]="formatOptions['removeDashesAndCommas']"> Supprimer les tirets et virgules
      </label>
      <div *ngIf="formatOptions['removeDashesAndCommas']" class="format-columns">
        <label>Colonnes √† traiter :</label>
        <select multiple [(ngModel)]="formatSelections['removeDashesAndCommas']">
          <option *ngFor="let col of columns" [value]="col">{{ col }}</option>
        </select>
        <button type="button" disabled>Appliquer</button>
      </div>
      <!-- Option : Supprimer les s√©parateurs (virgules) -->
      <label>
        <input type="checkbox" [(ngModel)]="formatOptions['removeSeparators']"> Supprimer les s√©parateurs (virgules)
      </label>
      <div *ngIf="formatOptions['removeSeparators']" class="format-columns">
        <label>Colonnes √† traiter :</label>
        <select multiple [(ngModel)]="formatSelections['removeSeparators']">
          <option *ngFor="let col of columns" [value]="col">{{ col }}</option>
        </select>
        <button type="button" disabled>Appliquer</button>
      </div>
      <!-- Option : Remplacer les points par des virgules -->
      <label>
        <input type="checkbox" [(ngModel)]="formatOptions['dotToComma']"> Remplacer les points par des virgules
      </label>
      <div *ngIf="formatOptions['dotToComma']" class="format-columns">
        <label>Colonnes √† traiter :</label>
        <select multiple [(ngModel)]="formatSelections['dotToComma']">
          <option *ngFor="let col of columns" [value]="col">{{ col }}</option>
        </select>
        <button type="button" disabled>Appliquer</button>
      </div>
      <!-- Option : Convertir les dates (format ISO) -->
      <label>
        <input type="checkbox" [(ngModel)]="formatOptions['normalizeDates']"> Convertir les dates (format ISO)
      </label>
      <div *ngIf="formatOptions['normalizeDates']" class="format-columns">
        <label>Colonnes √† traiter :</label>
        <select multiple [(ngModel)]="formatSelections['normalizeDates']">
          <option *ngFor="let col of columns" [value]="col">{{ col }}</option>
        </select>
        <button type="button" disabled>Appliquer</button>
      </div>
      <!-- Option : Convertir les montants (nombres) -->
      <label>
        <input type="checkbox" [(ngModel)]="formatOptions['normalizeNumbers']"> Convertir les montants (nombres)
      </label>
      <div *ngIf="formatOptions['normalizeNumbers']" class="format-columns">
        <label>Colonnes √† traiter :</label>
        <select multiple [(ngModel)]="formatSelections['normalizeNumbers']">
          <option *ngFor="let col of columns" [value]="col">{{ col }}</option>
        </select>
        <button type="button" disabled>Appliquer</button>
      </div>
      <!-- Option : Convertir en valeur absolue -->
      <label>
        <input type="checkbox" [(ngModel)]="formatOptions['absoluteValue']"> Convertir en valeur absolue
      </label>
      <div *ngIf="formatOptions['absoluteValue']" class="format-columns">
        <label>Colonnes √† traiter :</label>
        <select multiple [(ngModel)]="formatSelections['absoluteValue']">
          <option *ngFor="let col of columns" [value]="col">{{ col }}</option>
        </select>
        <button type="button" (click)="applyAbsoluteValueFormatting()" [disabled]="!formatSelections['absoluteValue'].length">Appliquer</button>
      </div>
      <!-- Option : Supprimer des caract√®res -->
      <label>
        <input type="checkbox" [(ngModel)]="formatOptions['removeCharacters']"> Supprimer des caract√®res
      </label>
      <div *ngIf="formatOptions['removeCharacters']" class="format-columns">
        <label>Colonnes √† traiter :</label>
        <select multiple [(ngModel)]="formatSelections['removeCharacters']">
          <option *ngFor="let col of columns" [value]="col">{{ col }}</option>
        </select>
        <div class="remove-char-options">
          <div class="option-group">
            <label>Position :</label>
            <select [(ngModel)]="removeCharPosition">
              <option value="start">Depuis le d√©but</option>
              <option value="end">Depuis la fin</option>
              <option value="specific">Position sp√©cifique</option>
            </select>
          </div>
          <div class="option-group" *ngIf="removeCharPosition === 'specific'">
            <label>Position (1-based) :</label>
            <input type="number" [(ngModel)]="removeCharSpecificPosition" min="1" style="width: 80px;">
          </div>
          <div class="option-group">
            <label>Nombre de caract√®res :</label>
            <input type="number" [(ngModel)]="removeCharCount" min="1" style="width: 80px;">
          </div>
        </div>
        <button type="button" (click)="applyRemoveCharactersFormatting()" [disabled]="!formatSelections['removeCharacters'].length">Appliquer</button>
      </div>
      
      <!-- Option : Supprimer des caract√®res sp√©cifiques -->
      <label>
        <input type="checkbox" [(ngModel)]="formatOptions['removeSpecificCharacters']"> Supprimer des cha√Ænes de caract√®res
      </label>
      <div *ngIf="formatOptions['removeSpecificCharacters']" class="format-columns">
        <label>Colonnes √† traiter :</label>
        <select multiple [(ngModel)]="formatSelections['removeSpecificCharacters']">
          <option *ngFor="let col of columns" [value]="col">{{ col }}</option>
        </select>
        <div class="remove-specific-char-options">
          <div class="option-group">
            <label>Cha√Æne √† supprimer :</label>
            <input type="text" [(ngModel)]="specificCharactersToRemove" 
                   placeholder="Ex: _CM ou abc123" 
                   style="width: 200px;"
                   title="Tapez la cha√Æne de caract√®res que vous voulez supprimer">
          </div>
          <div class="option-group">
            <label>
              <input type="checkbox" [(ngModel)]="removeSpecificCharactersCaseSensitive">
              Sensible √† la casse
            </label>
          </div>
          
          <!-- Filtrage par valeur exacte -->
          <div class="option-group">
            <label>
              <input type="checkbox" [(ngModel)]="filterByExactValue">
              üîç Appliquer seulement sur les lignes avec une valeur exacte
            </label>
          </div>
          
          <div *ngIf="filterByExactValue" class="exact-value-filter">
            <div class="filter-row">
              <label>Colonne √† v√©rifier :</label>
              <select [(ngModel)]="exactValueColumn" style="width: 200px;">
                <option value="">-- Choisir une colonne --</option>
                <option *ngFor="let col of allColumns" [value]="col">{{ col }}</option>
              </select>
            </div>
            <div class="filter-row">
              <label>Valeur exacte :</label>
              <input type="text" [(ngModel)]="exactValueToFilter" 
                     placeholder="Ex: _CM" 
                     style="width: 200px;"
                     title="Tapez la valeur exacte que doit contenir la colonne">
            </div>
            <div class="help-text">
              <small>
                üí° Exemple : Si vous tapez "_CM" et s√©lectionnez la colonne "Code", 
                <br>la suppression se fera seulement sur les lignes o√π "Code" = "_CM"
              </small>
            </div>
          </div>
          
                                            <div class="option-group">
               <small class="help-text">
                 üí° Suppression de cha√Ænes sp√©cifiques autoris√©es : 
                 <br>‚Ä¢ Seules les cha√Ænes suivantes sont autoris√©es : _CM, _ML, _GN, _CI, _BF, _KE, _SN, _KN, _BJ, _GB
                 <br>‚Ä¢ Exemple : "_CM" supprimera "_CM" dans "ID_CM_123" ‚Üí "ID_123"
                 <br>‚Ä¢ Exemple : "_ML" supprimera "_ML" dans "REF_ML_456" ‚Üí "REF_456"
                 <br>‚ö†Ô∏è Note : Les caract√®res individuels (C, M, P, etc.) ne sont pas autoris√©s
               </small>
             </div>
        </div>
        <button type="button" (click)="applyRemoveSpecificCharactersFormatting()" 
                [disabled]="!formatSelections['removeSpecificCharacters'].length || !specificCharactersToRemove.trim()">
          Appliquer
        </button>
      </div>
      
      <!-- Option : Nettoyer les montants -->
      <label>
        <input type="checkbox" [(ngModel)]="formatOptions['cleanAmounts']"> Nettoyer les montants (enlever espaces et ,00)
      </label>
      <div *ngIf="formatOptions['cleanAmounts']" class="format-columns">
        <label>Colonnes √† traiter :</label>
        <select multiple [(ngModel)]="formatSelections['cleanAmounts']">
          <option *ngFor="let col of columns" [value]="col">{{ col }}</option>
        </select>
        <div class="clean-amounts-help">
          <small class="help-text">
            üí° Cette option va :
            <br>‚Ä¢ Enlever tous les espaces (ex: "100 000,00" ‚Üí "100000,00")
            <br>‚Ä¢ Enlever ",00" √† la fin (ex: "100000,00" ‚Üí "100000")
            <br>‚Ä¢ Enlever ",0" √† la fin (ex: "100000,0" ‚Üí "100000")
            <br>‚Ä¢ Convertir les nombres entiers (ex: 100000.0 ‚Üí 100000)
          </small>
        </div>
        <button type="button" (click)="applyCleanAmountsFormatting()" 
                [disabled]="!formatSelections['cleanAmounts'].length">
          Appliquer
        </button>
      </div>
      
      <!-- Option : Ins√©rer des caract√®res -->
      <label>
        <input type="checkbox" [(ngModel)]="formatOptions['insertCharacters']"> Ins√©rer des caract√®res
      </label>
      <div *ngIf="formatOptions['insertCharacters']" class="format-columns">
        <label>Colonnes √† traiter :</label>
        <select multiple [(ngModel)]="formatSelections['insertCharacters']">
          <option *ngFor="let col of columns" [value]="col">{{ col }}</option>
        </select>
        <div class="insert-char-options">
          <div class="option-group">
            <label>Caract√®res √† ins√©rer :</label>
            <input type="text" [(ngModel)]="charactersToInsert" 
                   placeholder="Ex: _CM ou 123" 
                   style="width: 200px;"
                   title="Tapez les caract√®res que vous voulez ins√©rer">
          </div>
          <div class="option-group">
            <label>Position :</label>
            <select [(ngModel)]="insertPosition">
              <option value="start">Au d√©but</option>
              <option value="end">√Ä la fin</option>
              <option value="specific">Position sp√©cifique</option>
            </select>
          </div>
          <div class="option-group" *ngIf="insertPosition === 'specific'">
            <label>Position (1-based) :</label>
            <input type="number" [(ngModel)]="insertSpecificPosition" min="1" style="width: 80px;">
          </div>
          <div class="option-group">
            <small class="help-text">
              üí° Exemples d'insertion :
              <br>‚Ä¢ Au d√©but : "ABC" + "123" = "ABC123"
              <br>‚Ä¢ √Ä la fin : "123" + "XYZ" = "123XYZ"
              <br>‚Ä¢ Position 2 : "123" ‚Üí "1ABC23" (position 2)
              <br>‚Ä¢ Position 1 : "123" ‚Üí "ABC123" (position 1)
              <br><strong>üõ°Ô∏è Protection anti-doublons :</strong> Les caract√®res ne sont ajout√©s qu'une seule fois
            </small>
          </div>
        </div>
        <button type="button" (click)="applyInsertCharactersFormatting()" 
                [disabled]="!formatSelections['insertCharacters'].length || !charactersToInsert.trim()">
          Appliquer
        </button>
      </div>
    </div>
    <div *ngIf="successMsg.format" class="success-msg">{{ successMsg.format }}</div>
    <div *ngIf="errorMsg.format" class="error-msg">{{ errorMsg.format }}</div>
  </div>
  <!-- Tableau d'aper√ßu d√©plac√© en bas -->
  <div *ngIf="combinedRows.length > 0" class="preview-table" style="margin-top: 32px;">
    <h4>Aper√ßu des donn√©es combin√©es :</h4>
    
    <!-- Contr√¥les de r√©organisation des colonnes -->
    <div class="column-reorder-controls" style="margin-bottom: 16px;">
      <div class="reorder-controls">
        <button type="button" 
                (click)="toggleColumnReorderMode()" 
                [class.active]="isColumnReorderMode"
                class="reorder-btn">
          {{ isColumnReorderMode ? 'üîÑ Mode r√©organisation actif' : 'üìã R√©organiser les colonnes' }}
        </button>
        
        <div *ngIf="isColumnReorderMode" class="reorder-actions">
          <button type="button" (click)="applyColumnReorder()" class="apply-btn">‚úÖ Appliquer</button>
          <button type="button" (click)="cancelColumnReorder()" class="cancel-btn">‚ùå Annuler</button>
        </div>
      </div>
      
      <div *ngIf="isColumnReorderMode" class="reorder-instructions">
        <span class="instruction-text">üí° Glissez-d√©posez les colonnes pour les r√©organiser ou utilisez les boutons ‚Üë‚Üì</span>
      </div>
    </div>
    
    <!-- Informations sur le fichier -->
    <div class="file-info-panel" *ngIf="combinedRows.length > 1000">
      <div class="file-stats">
        <div class="stat-item">
          <span class="stat-label">üìä Total lignes :</span>
          <span class="stat-value">{{ combinedRows.length.toLocaleString() }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">üìã Colonnes :</span>
          <span class="stat-value">{{ columns.length }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">üíæ Taille estim√©e :</span>
          <span class="stat-value">{{ getFileStats().fileSize }}</span>
        </div>
      </div>
      <div class="performance-tips" *ngIf="getFileStats().isLargeFile">
        <div class="tip-icon">üí°</div>
        <div class="tip-content">
          <strong>Conseils pour les gros fichiers :</strong>
          <ul>
            <li>Utilisez les filtres pour r√©duire la quantit√© de donn√©es affich√©es</li>
            <li>S√©lectionnez uniquement les colonnes n√©cessaires</li>
            <li>Utilisez la pagination pour naviguer efficacement</li>
            <li>√âvitez d'afficher toutes les lignes pour de meilleures performances</li>
          </ul>
        </div>
      </div>
    </div>
    <!-- Contr√¥les d'affichage -->
    <div class="display-controls" *ngIf="combinedRows.length > 20">
      <div class="control-group">
        <label>Lignes par page :</label>
        <select [(ngModel)]="rowsPerPage" (change)="onRowsPerPageChange()" [disabled]="showAllRows">
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="200">200</option>
          <option value="500">500</option>
          <option value="1000">1000</option>
        </select>
      </div>
      <div class="control-group">
        <label>
          <input type="checkbox" [(ngModel)]="showAllRows" (change)="toggleShowAllRows()">
          Afficher toutes les lignes ({{ combinedRows.length }})
        </label>
      </div>
      <div class="control-group" *ngIf="!showAllRows">
        <span class="info-text">
          Affichage des lignes {{ startRow }} √† {{ endRow }} sur {{ combinedRows.length }} total
        </span>
      </div>
    </div>
    <div class="table-responsive">
      <div class="export-csv-bar" style="margin-bottom: 8px; display: flex; align-items: center; gap: 16px;">
        <div class="export-controls" style="display: flex; align-items: center; gap: 8px;">
          <label for="exportFileName" style="font-weight: 500; color: #333;">Nom du fichier:</label>
          <input 
            type="text" 
            id="exportFileName"
            [(ngModel)]="exportFileName" 
            placeholder="resultat.csv"
            style="padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; min-width: 150px;"
            title="Entrez le nom du fichier CSV (l'extension .csv sera ajout√©e automatiquement si n√©cessaire)">
        </div>
        <button type="button" (click)="exportCSV()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Exporter en CSV</button>
        <div *ngIf="successMsg.export" class="success-msg">{{ successMsg.export }}</div>
        <div *ngIf="errorMsg.export" class="error-msg">{{ errorMsg.export }}</div>
        <div *ngIf="successMsg.reorder" class="success-msg">{{ successMsg.reorder }}</div>
      </div>
      <table>
        <thead>
          <tr>
            <th *ngFor="let col of getDisplayColumns(); let i = index"
                [draggable]="isColumnReorderMode"
                (dragstart)="onColumnDragStart($event, col)"
                (dragover)="onColumnDragOver($event, col)"
                (drop)="onColumnDrop($event, col)"
                (dragend)="onColumnDragEnd()"
                [class.dragging]="isColumnDragging(col)"
                [class.drag-over]="isColumnDragOver(col)"
                [class.reorder-mode]="isColumnReorderMode"
                class="column-header">
              
              <div class="column-content">
                <span class="column-title">{{ col }}</span>
                
                <div *ngIf="isColumnReorderMode" class="column-controls">
                  <button type="button" 
                          (click)="moveColumnUp(col)" 
                          [disabled]="i === 0"
                          class="move-btn move-up"
                          title="D√©placer vers le haut">
                    ‚Üë
                  </button>
                  <button type="button" 
                          (click)="moveColumnDown(col)" 
                          [disabled]="i === getDisplayColumns().length - 1"
                          class="move-btn move-down"
                          title="D√©placer vers le bas">
                    ‚Üì
                  </button>
                </div>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of displayedRows">
            <td *ngFor="let col of getDisplayColumns()">{{ row[col] }}</td>
          </tr>
        </tbody>
      </table>
      <!-- Pagination -->
      <div class="pagination" *ngIf="!showAllRows && totalPages > 1">
        <div class="pagination-info">
          Page {{ currentPage }} sur {{ totalPages }}
        </div>
        <div class="pagination-controls">
          <button 
            type="button" 
            (click)="onPageChange(1)" 
            [disabled]="currentPage === 1"
            class="pagination-btn">
            ¬´ Premi√®re
          </button>
          <button 
            type="button" 
            (click)="onPageChange(currentPage - 1)" 
            [disabled]="currentPage === 1"
            class="pagination-btn">
            ‚Äπ Pr√©c√©dente
          </button>
          <span class="page-numbers">
            <ng-container *ngFor="let page of getPageNumbers()">
              <span *ngIf="page === -1" class="page-ellipsis">...</span>
              <button 
                *ngIf="page !== -1"
                type="button" 
                (click)="onPageChange(page)" 
                [class.active]="page === currentPage"
                class="pagination-btn page-number">
                {{ page }}
              </button>
            </ng-container>
          </span>
          <button 
            type="button" 
            (click)="onPageChange(currentPage + 1)" 
            [disabled]="currentPage === totalPages"
            class="pagination-btn">
            Suivante ‚Ä∫
          </button>
          <button 
            type="button" 
            (click)="onPageChange(totalPages)" 
            [disabled]="currentPage === totalPages"
            class="pagination-btn">Derni√®re ¬ª</button>
        </div>
      </div>
      <!-- Message d'information pour les gros fichiers -->
      <div *ngIf="combinedRows.length > 10000" class="large-file-info">
        <div class="info-box">
          <strong>Fichier volumineux d√©tect√© :</strong> {{ combinedRows.length.toLocaleString() }} lignes
          <br>
          <small>
            üí° Conseil : Utilisez les filtres ou la s√©lection de colonnes pour r√©duire la taille des donn√©es affich√©es.
          </small>
        </div>
      </div>
    </div>
  </div>
</div> 