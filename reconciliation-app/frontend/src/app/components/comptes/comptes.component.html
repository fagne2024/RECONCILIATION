<div class="comptes-container">
    <div class="header">
        <h1>Gestion des Comptes</h1>
        <div class="actions">
            <button (click)="showAddForm = !showAddForm" class="btn add-btn">
                <i class="fas fa-plus"></i> Nouveau Compte
            </button>
            <button (click)="goToServiceBalance()" class="btn service-balance-btn">
                <i class="fas fa-layer-group"></i> Fusion Service
            </button>
            <button (click)="exportComptes()" class="btn export-btn" [disabled]="isExporting">
                <i class="fas fa-file-excel"></i> {{ isExporting ? 'Exportation...' : 'Exporter en Excel' }}
            </button>
        </div>
    </div>

    <!-- Modal d'ajout de compte -->
    <div *ngIf="showAddForm" class="modal-overlay" (click)="closeAddModal($event)">
        <div class="modal-container" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Ajouter un nouveau compte</h3>
                <button type="button" class="modal-close" (click)="cancelAdd()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form [formGroup]="addForm" (ngSubmit)="addCompte()" class="add-form">
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Numéro de Compte *</label>
                                <input type="text" formControlName="numeroCompte" placeholder="Ex: 123456789" class="text-input">
                                <div *ngIf="addForm.get('numeroCompte')?.invalid && addForm.get('numeroCompte')?.touched" class="error-message">
                                    Le numéro de compte est requis.
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Solde Initial *</label>
                                <input type="number" formControlName="solde" placeholder="0.00" class="text-input">
                                <div *ngIf="addForm.get('solde')?.invalid && addForm.get('solde')?.touched" class="error-message">
                                    Le solde est requis.
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Pays *</label>
                                <app-autocomplete-input
                                    [options]="paysList"
                                    formControlName="pays"
                                    placeholder="Saisir un pays..."
                                    label="Pays">
                                </app-autocomplete-input>
                                <div *ngIf="addForm.get('pays')?.invalid && addForm.get('pays')?.touched" class="error-message">
                                    Le pays est requis.
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Type de Compte *</label>
                                <select formControlName="type" class="modern-select">
                                    <option value="" disabled>Sélectionner un type</option>
                                    <option *ngFor="let t of compteTypes" [value]="t">{{ t }}</option>
                                </select>
                                <div *ngIf="addForm.get('type')?.invalid && addForm.get('type')?.touched" class="error-message">
                                    Le type de compte est requis.
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Catégorie *</label>
                                <select formControlName="categorie" class="modern-select">
                                    <option value="" disabled>Sélectionner une catégorie</option>
                                    <option *ngFor="let c of compteCategories" [value]="c">{{ c }}</option>
                                </select>
                                <div *ngIf="addForm.get('categorie')?.invalid && addForm.get('categorie')?.touched" class="error-message">
                                    La catégorie est requise.
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Code Propriétaire</label>
                                <input type="text" formControlName="codeProprietaire" placeholder="Ex: PROP001" class="text-input">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" (click)="cancelAdd()">
                        <i class="fas fa-times"></i>
                        Annuler
                    </button>
                    <button type="submit" class="btn-primary" [disabled]="!addForm.valid || isAdding" (click)="addCompte()">
                        <i class="fas fa-plus"></i>
                        {{ isAdding ? 'Ajout...' : 'Ajouter' }}
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Fin modal d'ajout de compte -->

    <!-- Modal de modification de compte -->
    <div *ngIf="showEditForm" class="modal-overlay" (click)="closeEditModal($event)">
        <div class="modal-container" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Modifier le compte</h3>
                <button type="button" class="modal-close" (click)="cancelEdit()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form [formGroup]="editForm" (ngSubmit)="updateCompte()" class="edit-form">
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Numéro de Compte *</label>
                                <input type="text" formControlName="numeroCompte" placeholder="Ex: 123456789" class="text-input">
                                <div *ngIf="editForm.get('numeroCompte')?.invalid && editForm.get('numeroCompte')?.touched" class="error-message">
                                    Le numéro de compte est requis.
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Solde *</label>
                                <input type="number" formControlName="solde" placeholder="0.00" class="text-input">
                                <div *ngIf="editForm.get('solde')?.invalid && editForm.get('solde')?.touched" class="error-message">
                                    Le solde est requis.
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Pays *</label>
                                <app-autocomplete-input
                                    [options]="paysList"
                                    formControlName="pays"
                                    placeholder="Saisir un pays..."
                                    label="Pays">
                                </app-autocomplete-input>
                                <div *ngIf="editForm.get('pays')?.invalid && editForm.get('pays')?.touched" class="error-message">
                                    Le pays est requis.
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Type de Compte *</label>
                                <select formControlName="type" class="modern-select">
                                    <option value="" disabled>Sélectionner un type</option>
                                    <option *ngFor="let t of compteTypes" [value]="t">{{ t }}</option>
                                </select>
                                <div *ngIf="editForm.get('type')?.invalid && editForm.get('type')?.touched" class="error-message">
                                    Le type de compte est requis.
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Catégorie *</label>
                                <select formControlName="categorie" class="modern-select">
                                    <option value="" disabled>Sélectionner une catégorie</option>
                                    <option *ngFor="let c of compteCategories" [value]="c">{{ c }}</option>
                                </select>
                                <div *ngIf="editForm.get('categorie')?.invalid && editForm.get('categorie')?.touched" class="error-message">
                                    La catégorie est requise.
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Code Propriétaire</label>
                                <input type="text" formControlName="codeProprietaire" placeholder="Ex: PROP001" class="text-input">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" (click)="cancelEdit()">
                        <i class="fas fa-times"></i>
                        Annuler
                    </button>
                    <button type="submit" class="btn-primary" [disabled]="!editForm.valid || isEditing" (click)="updateCompte()">
                        <i class="fas fa-save"></i>
                        {{ isEditing ? 'Mise à jour...' : 'Mettre à jour' }}
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Filtres et Statistiques -->
    <div class="filters-stats-container">
        <div class="card filters">
            <h2>Filtres</h2>
            <form [formGroup]="filterForm" (ngSubmit)="applyFilters()" class="form-grid">
                <div class="form-field">
                    <mat-form-field appearance="fill" class="filter-select">
                        <mat-label>Pays</mat-label>
                        <mat-select #paysSelect formControlName="pays" multiple (selectionChange)="onPaysChange($event)">
                            <mat-option>
                                <ngx-mat-select-search [formControl]="paysSearchCtrl" placeholderLabel="Rechercher un pays..." noEntriesFoundLabel="Aucun pays trouvé"></ngx-mat-select-search>
                            </mat-option>
                            <mat-option *ngFor="let pays of filteredPaysList" [value]="pays">
                                {{ pays }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div class="form-field">
                    <mat-form-field appearance="fill" class="filter-select">
                        <mat-label>Code Propriétaire</mat-label>
                        <mat-select #codeProprietaireSelect formControlName="codeProprietaire" multiple (selectionChange)="onCodeProprietaireChange($event)">
                            <mat-option>
                                <ngx-mat-select-search [formControl]="codeProprietaireSearchCtrl" placeholderLabel="Rechercher un code..." noEntriesFoundLabel="Aucun code trouvé"></ngx-mat-select-search>
                            </mat-option>
                            <mat-option *ngFor="let code of filteredCodeProprietaireList" [value]="code">
                                {{ code }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div class="form-field">
                    <mat-form-field appearance="fill" class="filter-select">
                        <mat-label>Catégorie</mat-label>
                        <mat-select #categorieSelect formControlName="categorie" multiple (selectionChange)="onCategorieChange($event)">
                            <mat-option>
                                <ngx-mat-select-search [formControl]="categorieSearchCtrl" placeholderLabel="Rechercher une catégorie..." noEntriesFoundLabel="Aucune catégorie trouvée"></ngx-mat-select-search>
                            </mat-option>
                            <mat-option *ngFor="let categorie of filteredCategorieList" [value]="categorie">
                                <span class="categorie-badge" [ngClass]="getCategorieClass(categorie)">
                                    {{ categorie }}
                                </span>
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div class="form-field">
                    <mat-form-field appearance="fill" class="filter-select">
                        <mat-label>Type</mat-label>
                        <mat-select #typeSelect formControlName="type" multiple (selectionChange)="onTypeChange($event)">
                            <mat-option>
                                <ngx-mat-select-search [formControl]="typeSearchCtrl" placeholderLabel="Rechercher un type..." noEntriesFoundLabel="Aucun type trouvé"></ngx-mat-select-search>
                            </mat-option>
                            <mat-option *ngFor="let type of filteredTypeList" [value]="type">
                                {{ type }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                 <div class="form-field">
                    <label for="dateDebut">Date de début</label>
                    <input id="dateDebut" type="date" formControlName="dateDebut" >
                </div>
                 <div class="form-field">
                    <label for="dateFin">Date de fin</label>
                    <input id="dateFin" type="date" formControlName="dateFin" >
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn primary">Filtrer</button>
                    <button type="button" (click)="clearFilters()" class="btn">Réinitialiser</button>
                </div>
            </form>
        </div>
        <div class="card stats">
            <div class="stats-header">
            <h2>Soldes Critiques</h2>
                <button (click)="exportSoldesCritiques()" class="btn export-btn" [disabled]="isExporting || comptesCritiques.length === 0">
                    <i class="fas fa-file-excel"></i> {{ isExporting ? 'Exportation...' : 'Exporter Critiques' }}
                </button>
            </div>
            <div class="config-periode">
                <label for="periodeJours">Période :</label>
                <select id="periodeJours" [(ngModel)]="periodeJours" (ngModelChange)="onPeriodeJoursChange()" style="width:130px; margin-left:8px;">
                    <option *ngFor="let opt of periodeOptions" [value]="opt.value">{{ opt.label }}</option>
                </select>
            </div>
            <div *ngIf="comptesCritiques.length === 0" class="no-critical">
                Aucun solde critique détecté.
            </div>
            <div *ngIf="comptesCritiques.length > 0" class="critical-cards-container">
                <button class="arrow-btn left" (click)="prevCriticalPage()" [disabled]="criticalPage === 1">&#8592;</button>
                <div class="critical-cards-list">
                    <div class="critical-card" *ngFor="let item of pagedComptesCritiques">
                        <div class="card-header">{{ item.compte.codeProprietaire || item.compte.numeroCompte }}</div>
                        <div class="card-solde">
                            <span>Solde :</span>
                            <span class="solde-value">{{ item.compte.solde | number:'1.2-2' }}</span>
                        </div>
                        <div class="card-moyenne">
                            <span>Moyenne {{periodeJours}}j :</span>
                            <span class="moyenne-value">{{ item.moyenneVolume | number:'1.2-2' }}</span>
                        </div>
                        <div class="card-ratio">
                            <span>Ratio :</span>
                            <span class="ratio-value" [class.critical]="(item.compte.solde / item.moyenneVolume) < 0.5" [class.warning]="(item.compte.solde / item.moyenneVolume) >= 0.5 && (item.compte.solde / item.moyenneVolume) < 0.8">
                                {{ (item.compte.solde / item.moyenneVolume) | number:'1.2-2' }}
                            </span>
                        </div>
                        <div class="card-label">Solde &lt; moyenne volume</div>
                    </div>
                </div>
                <button class="arrow-btn right" (click)="nextCriticalPage()" [disabled]="criticalPage === totalCriticalPages">&#8594;</button>
            </div>
            <div *ngIf="comptesCritiques.length > criticalPageSize" class="critical-pagination-indicator">
                Page {{criticalPage}} / {{totalCriticalPages}}
            </div>
        </div>
    </div>

    <!-- Tableau des comptes -->
    <div class="card table-container">
        <div *ngIf="isLoading" class="loading-overlay">
            <div class="spinner"></div> <span>Chargement des données...</span>
        </div>
        <table *ngIf="!isLoading && comptes.length > 0">
            <thead>
                <tr>
                    <th>Numéro de Compte</th>
                    <th>Solde</th>
                    <th>Date Dernière MAJ</th>
                    <th>Pays</th>
                    <th>Code Propriétaire</th>
                    <th>Type</th>
                    <th>Catégorie</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let compte of pagedComptes">
                    <td>{{ compte.numeroCompte }}</td>
                    <td class="solde">{{ compte.solde | number:'1.2-2' }}</td>
                    <td>{{ formatDate(compte.dateDerniereMaj) }}</td>
                    <td>{{ compte.pays }}</td>
                    <td>{{ compte.codeProprietaire || '-' }}</td>
                    <td>{{ compte.type || '-' }}</td>
                    <td>
                        <span class="categorie-badge" [ngClass]="getCategorieClass(compte.categorie)">
                            {{ compte.categorie || '-' }}
                        </span>
                    </td>
                    <td class="actions-cell">
                        <button (click)="viewReleve(compte)" class="btn icon-btn" title="Voir le relevé">
                            <i class="fas fa-file-alt" style="color: blue;"></i>
                        </button>
                        <button (click)="editCompte(compte)" class="btn icon-btn" title="Modifier">
                            <i class="fas fa-edit" style="color: green;"></i>
                        </button>
                        <button (click)="deleteCompte(compte.id!)" class="btn icon-btn delete" *ngIf="compte.id" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button (click)="openSoldeBoModal(compte)" class="btn icon-btn" title="Solde BO">
                            <i class="fas fa-balance-scale" style="color: orange;"></i>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
        <div *ngIf="!isLoading && comptes.length === 0" class="no-data">
            Aucun compte trouvé.
        </div>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
        <button (click)="prevPage()" [disabled]="currentPage === 1">
            <i class="fas fa-chevron-left"></i> Précédent
        </button>
        
        <div class="pagination-indicators">
            <span *ngFor="let page of getVisiblePages()" 
                  class="page-indicator"
                  [class.active]="currentPage === page"
                  (click)="goToPage(page)">
                {{ page }}
            </span>
        </div>
        
        <button (click)="nextPage()" [disabled]="currentPage === totalPages">
            Suivant <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

<!-- Modal de relevé de compte -->
<div *ngIf="showReleveModal" class="modal-overlay">
    <div class="modal-content releve-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>Relevé de compte - {{ selectedCompte?.numeroCompte }}</h2>
            <button class="modal-close" (click)="closeReleveModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <!-- Informations du compte -->
            <div class="compte-info">
                <div class="info-row">
                    <span class="info-label">Numéro de compte:</span>
                    <span class="info-value">{{ selectedCompte?.numeroCompte }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Solde actuel:</span>
                    <span class="info-value solde-actuel">{{ selectedCompte?.solde | number:'1.2-2' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Pays:</span>
                    <span class="info-value">{{ selectedCompte?.pays }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Code propriétaire:</span>
                    <span class="info-value">{{ selectedCompte?.codeProprietaire || '-' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Dernière mise à jour:</span>
                    <span class="info-value">{{ formatDate(selectedCompte?.dateDerniereMaj || '') }}</span>
                </div>
            </div>

            <!-- Onglets -->
            <div class="tabs-container">
                <div class="tabs-header">
                    <button class="tab-button" 
                            [class.active]="activeTab === 'operations'"
                            (click)="switchTab('operations')">
                        <i class="fas fa-list"></i>
                        Opérations
                    </button>
                    <button class="tab-button" 
                            [class.active]="activeTab === 'ecart-solde'"
                            (click)="switchTab('ecart-solde')"
                            *ngIf="showEcartSoldeTab">
                        <i class="fas fa-exclamation-triangle"></i>
                        Écarts de Solde
                    </button>
                    <button class="tab-button" 
                            [class.active]="activeTab === 'impact-op'"
                            (click)="switchTab('impact-op')"
                            *ngIf="showImpactOPTab">
                        <i class="fas fa-chart-line"></i>
                        Ecart régularisé
                    </button>
                    <button class="tab-button" 
                            [class.active]="activeTab === 'revenu-journalier'"
                            (click)="switchTab('revenu-journalier')"
                            *ngIf="showRevenuJournalierTab">
                        <i class="fas fa-money-bill-wave"></i>
                        Revenu Journalier
                    </button>
                    <button class="tab-button" 
                            [class.active]="activeTab === 'control-revenu'"
                            (click)="switchTab('control-revenu')"
                            *ngIf="showControlRevenuTab">
                        <i class="fas fa-chart-bar"></i>
                        Control Revenu
                    </button>
                    <button class="tab-button" 
                            [class.active]="activeTab === 'ecart-frais'"
                            (click)="switchTab('ecart-frais')"
                            *ngIf="showEcartFraisTab">
                        <i class="fas fa-receipt"></i>
                        Écart Frais
                    </button>
                </div>

                <!-- Contenu de l'onglet Opérations -->
                <div class="tab-content" *ngIf="activeTab === 'operations'">
                    <!-- Filtres pour l'historique -->
                    <div class="releve-filters">
                        <div class="filter-group">
                            <label>Période:</label>
                            <select [(ngModel)]="releveDateDebut" (change)="onRelevePeriodChange()">
                                <option value="">Toutes les opérations</option>
                                <option value="7">7 derniers jours</option>
                                <option value="30">30 derniers jours</option>
                                <option value="90">3 derniers mois</option>
                                <option value="custom">Période personnalisée</option>
                            </select>
                        </div>
                        
                        <!-- Filtres de date personnalisés -->
                        <div class="filter-group custom-date-filters" *ngIf="releveDateDebut === 'custom'">
                            <div class="date-input-group">
                                <label>Date début:</label>
                                <input type="date" [(ngModel)]="releveDateDebutCustom" (change)="loadReleveOperations()">
                            </div>
                            <div class="date-input-group">
                                <label>Date fin:</label>
                                <input type="date" [(ngModel)]="releveDateFinCustom" (change)="loadReleveOperations()">
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <label>Type d'opération:</label>
                            <select [(ngModel)]="releveTypeOperation" (change)="loadReleveOperations()">
                                <option value="">-- Sélectionner un type --</option>
                                <option *ngFor="let type of operationTypes" [value]="type">{{ type }}</option>
                            </select>
                        </div>
                         <button class="btn view-toggle-btn" (click)="toggleReleveView()">
                            <i class="fas" [ngClass]="showSoldesSeulement ? 'fa-list-alt' : 'fa-coins'"></i> 
                            {{ showSoldesSeulement ? 'Afficher Opérations' : 'Afficher Soldes Seuls' }}
                        </button>
                        <button class="btn export-btn" (click)="exportReleve()" [disabled]="isExporting">
                            <i class="fas fa-file-excel"></i> Exporter le relevé
                        </button>
                    </div>

                    <!-- Historique des opérations -->
                    <div class="releve-operations">
                        <h3>{{ showSoldesSeulement ? 'Soldes Journaliers' : 'Historique des opérations' }}</h3>
                        
                        <!-- Indicateur pour l'affichage automatique des frais -->
                        <div *ngIf="showFraisAutomaticallyReleve && !showSoldesSeulement" class="frais-auto-indicator">
                            <div class="indicator-content">
                                <i class="fas fa-info-circle"></i>
                                <span>Les frais de transaction sont automatiquement affichés pour le type d'opération sélectionné</span>
                            </div>
                        </div>
                        <div *ngIf="isLoadingReleve" class="loading-releve">
                            <i class="fas fa-spinner fa-spin"></i> Chargement de l'historique...
                        </div>
                        
                        <div *ngIf="!isLoadingReleve && releveOperations.length === 0" class="no-operations">
                            Aucune opération trouvée pour ce compte.
                        </div>
                        
                        <!-- Vue détaillée des opérations -->
                        <div *ngIf="!isLoadingReleve && releveOperations.length > 0 && !showSoldesSeulement" class="operations-table">
                            <div class="operations-summary">
                                <span>Total: {{ releveOperations.length }} opération(s)</span>
                                <span *ngIf="releveOperations.length > relevePageSize">
                                    Affichage: {{ (releveCurrentPage - 1) * relevePageSize + 1 }} - {{ Math.min(releveCurrentPage * relevePageSize, releveOperations.length) }} sur {{ releveOperations.length }}
                                </span>
                            </div>
                            <table class="table table-bordered table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Débit</th>
                                        <th>Crédit</th>
                                        <th>Solde avant</th>
                                        <th>Solde après</th>
                                        <th>Service</th>
                                        <th>Banque</th>
                                        <th>Bordereau</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="8" style="text-align: left; font-weight: bold; color: #1976d2;">
                                            Solde d'ouverture global ({{ getGlobalOpeningBalanceDate() }}): {{ getGlobalOpeningBalance() | number:'1.2-2' }}
                                        </td>
                                    </tr>
                                    <ng-container *ngFor="let operation of pagedReleveOperations; let i = index">
                                        <tr *ngIf="shouldShowOpeningBalance(operation, i)" class="solde-ouverture">
                                            <td colspan="3"><b style="color: #1976d2;">Solde d'ouverture ({{ getOpDate(operation) }})</b></td>
                                            <td></td>
                                            <td><b style="color: #1976d2;">{{ getDailyBalances(releveOperations)[getOpDate(operation)].opening | number:'1.2-2' }}</b></td>
                                            <td colspan="4"></td>
                                        </tr>
                                        <tr [class.frais-row]="operation.typeOperation === 'FRAIS_TRANSACTION'"
                                            [class.has-frais]="operation.typeOperation !== 'FRAIS_TRANSACTION' && hasAssociatedFraisReleve(operation)">
                                            <td>{{ formatDate(operation.dateOperation) }}</td>
                                            <td>
                                                <span class="operation-type" [class]="getOperationTypeClass(operation.typeOperation)">
                                                    {{ getOperationTypeLabel(operation.typeOperation) }}
                                                </span>
                                            </td>
                                            <td>
                                              <!-- Affichage correct Débit/Crédit avec logique d'annulation -->
                                              <ng-container *ngIf="operation.typeOperation.startsWith('annulation_'); else nonAnnulationDebit">
                                                {{ isAnnulationDebit(operation) ? (operation.montant | number:'1.2-2') : '' }}
                                              </ng-container>
                                              <ng-template #nonAnnulationDebit>
                                                <ng-container *ngIf="operation.typeOperation === 'FRAIS_TRANSACTION'; else autreDebit">
                                                  {{ isFraisTransactionDebit(operation) ? (operation.montant | number:'1.2-2') : '' }}
                                                </ng-container>
                                                <ng-template #autreDebit>
                                                  {{ isDebitOperation(operation.typeOperation, operation.service, operation.montant) ? (operation.montant | number:'1.2-2') : '' }}
                                                </ng-template>
                                              </ng-template>
                                            </td>
                                            <td>
                                              <ng-container *ngIf="operation.typeOperation.startsWith('annulation_'); else nonAnnulationCredit">
                                                {{ isAnnulationCredit(operation) ? (operation.montant | number:'1.2-2') : '' }}
                                              </ng-container>
                                              <ng-template #nonAnnulationCredit>
                                                <ng-container *ngIf="operation.typeOperation === 'FRAIS_TRANSACTION'; else autreCredit">
                                                  {{ isFraisTransactionCredit(operation) ? (operation.montant | number:'1.2-2') : '' }}
                                                </ng-container>
                                                <ng-template #autreCredit>
                                                  {{ isCreditOperation(operation.typeOperation, operation.service, operation.montant) ? (operation.montant | number:'1.2-2') : '' }}
                                                </ng-template>
                                              </ng-template>
                                            </td>
                                            <td>{{ operation.soldeAvant | number:'1.2-2' }}</td>
                                            <td>{{ operation.soldeApres | number:'1.2-2' }}</td>
                                            <td>{{ operation.service || '-' }}</td>
                                            <td>{{ operation.banque || '-' }}</td>
                                            <td>{{ operation.nomBordereau || '-' }}</td>
                                        </tr>
                                        <tr *ngIf="shouldShowClosingBalance(operation, i)" class="solde-cloture">
                                            <td colspan="8" style="text-align: right;"><b style="color: #388e3c;">Solde de clôture ({{ getOpDate(operation) }}) : {{ getDailyBalances(releveOperations)[getOpDate(operation)].closing | number:'1.2-2' }}</b></td>
                                        </tr>
                                    </ng-container>
                                </tbody>
                            </table>
                         </div>

                        <!-- Vue des soldes journaliers -->
                        <div *ngIf="!isLoadingReleve && releveSoldesJournaliers.length > 0 && showSoldesSeulement" class="operations-table">
                            <div class="operations-summary">
                                <span>Total: {{ releveSoldesJournaliers.length }} jour(s)</span>
                                <span *ngIf="releveSoldesJournaliers.length > relevePageSize">
                                    Affichage: {{ (releveCurrentPage - 1) * relevePageSize + 1 }} - {{ Math.min(releveCurrentPage * relevePageSize, releveSoldesJournaliers.length) }} sur {{ releveSoldesJournaliers.length }}
                                </span>
                            </div>
                            <table class="table table-bordered table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Solde d'Ouverture</th>
                                        <th>Solde de Clôture</th>
                                        <th>Variation Journalière</th>
                                        <th>Solde de Clôture BO</th>
                                        <th>Ecart de solde</th>
                                        <th>Ecart régularisé</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let solde of pagedReleveSoldes; let i = index">
                                        <td>{{ formatDate(solde.date).split(' ')[0] }}</td>
                                        <td class="solde-ouverture-val">{{ solde.opening | number:'1.2-2' }}</td>
                                        <td class="solde-cloture-val"
                                            [ngClass]="solde.closingBo !== undefined && (round2(solde.closingBo) === round2(solde.closing)) ? 'solde-green' : ''">
                                            {{ solde.closing | number:'1.2-2' }}
                                        </td>
                                        <td [ngClass]="(solde.closing - solde.opening) >= 0 ? 'variation-positive' : 'variation-negative'">
                                            {{ (solde.closing - solde.opening) | number:'1.2-2' }}
                                        </td>
                                        <td>
                                            <span [ngClass]="
                                                solde.closingBo !== undefined && (round2(solde.closingBo) === round2(solde.closing))
                                                    ? 'solde-green'
                                                    : (solde.closingBo !== undefined && (round2(solde.closingBo) !== round2(solde.closing)) ? 'solde-red' : '')
                                              ">
                                                {{ solde.closingBo !== undefined ? (solde.closingBo | number:'1.2-2') : '-' }}
                                            </span>
                                        </td>
                                        <td [ngClass]="getEcartClass(solde)" 
                                            (click)="navigateToEcartSolde(solde)"
                                            style="cursor: pointer; text-decoration: underline; font-weight: bold;"
                                            title="Cliquer pour voir les écarts de solde correspondants">
                                            {{ getEcartValue(solde) | number:'1.2-2' }}
                                        </td>
                                        <td [ngClass]="getImpactOPClass(solde)" 
                                            (click)="navigateToImpactOP(solde)"
                                            style="cursor: pointer; text-decoration: underline; font-weight: bold;"
                                            title="Cliquer pour voir les écarts régularisés correspondants">
                                            {{ getImpactOPValue(solde) | number:'1.2-2' }}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                            
                        <!-- Pagination pour les opérations -->
                        <div class="releve-pagination" *ngIf="releveTotalPages > 1">
                            <button (click)="prevRelevePage()" [disabled]="releveCurrentPage === 1" class="btn pagination-btn">
                                <i class="fas fa-chevron-left"></i> Précédent
                            </button>
                            
                            <div class="pagination-indicators">
                                <span *ngFor="let page of getVisibleRelevePages()" 
                                        class="page-indicator"
                                        [class.active]="releveCurrentPage === page"
                                        (click)="goToRelevePage(page)">
                                    {{ page }}
                                </span>
                            </div>
                            
                            <button (click)="nextRelevePage()" [disabled]="releveCurrentPage === releveTotalPages" class="btn pagination-btn">
                                Suivant <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div style="text-align: right; font-weight: bold; color: #388e3c; margin-top: 8px;">
                        Solde de clôture global ({{ getGlobalClosingBalanceDate() }}): {{ getGlobalClosingBalance() | number:'1.2-2' }}
                    </div>
                </div>

                <!-- Contenu de l'onglet Écarts de Solde -->
                <div class="tab-content" *ngIf="activeTab === 'ecart-solde'">
                    <app-ecart-solde-tab 
                        [agence]="ecartSoldeAgence"
                        [dateTransaction]="ecartSoldeDateTransaction">
                    </app-ecart-solde-tab>
                </div>

                <!-- Contenu de l'onglet Ecart régularisé -->
                <div class="tab-content" *ngIf="activeTab === 'impact-op'">
                    <app-impact-op-tab 
                        [agence]="impactOPAgence"
                        [dateTransaction]="impactOPDateTransaction">
                    </app-impact-op-tab>
                </div>

                <!-- Contenu de l'onglet Revenu Journalier -->
                <div class="tab-content" *ngIf="activeTab === 'revenu-journalier'">
                    <div class="revenu-journalier-container">
                        <h3>Revenu Journalier - {{ selectedCompte?.numeroCompte }}</h3>
                        
                        <!-- Filtres pour le revenu journalier -->
                        <div class="revenu-filters" *ngIf="!isLoadingRevenuJournalier && revenuJournalierData.length > 0">
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label for="revenuDateDebut">Date début :</label>
                                    <input 
                                        type="date" 
                                        id="revenuDateDebut"
                                        [(ngModel)]="revenuJournalierDateDebut" 
                                        (change)="onRevenuJournalierFiltersChange()"
                                        class="filter-input">
                                </div>
                                <div class="filter-group">
                                    <label for="revenuDateFin">Date fin :</label>
                                    <input 
                                        type="date" 
                                        id="revenuDateFin"
                                        [(ngModel)]="revenuJournalierDateFin" 
                                        (change)="onRevenuJournalierFiltersChange()"
                                        class="filter-input">
                                </div>
                                <div class="filter-group">
                                    <label for="revenuTypeRevenu">Type de revenu :</label>
                                    <select 
                                        id="revenuTypeRevenu"
                                        [(ngModel)]="revenuJournalierTypeRevenu" 
                                        (change)="onRevenuJournalierFiltersChange()"
                                        class="filter-select">
                                        <option value="">Tous les revenus</option>
                                        <option value="cashin">Frais Cashin</option>
                                        <option value="paiement">Frais Paiement</option>
                                        <option value="total">Revenu Total</option>
                                    </select>
                                </div>
                            </div>
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label for="revenuMontantMin">Montant min :</label>
                                    <input 
                                        type="number" 
                                        id="revenuMontantMin"
                                        [(ngModel)]="revenuJournalierMontantMin" 
                                        (input)="onRevenuJournalierFiltersChange()"
                                        placeholder="0.00"
                                        step="0.01"
                                        min="0"
                                        class="filter-input">
                                </div>
                                <div class="filter-group">
                                    <label for="revenuMontantMax">Montant max :</label>
                                    <input 
                                        type="number" 
                                        id="revenuMontantMax"
                                        [(ngModel)]="revenuJournalierMontantMax" 
                                        (input)="onRevenuJournalierFiltersChange()"
                                        placeholder="0.00"
                                        step="0.01"
                                        min="0"
                                        class="filter-input">
                                </div>
                                <div class="filter-group filter-actions">
                                    <button 
                                        class="btn filter-clear-btn" 
                                        (click)="clearRevenuJournalierFilters()"
                                        title="Réinitialiser les filtres">
                                        <i class="fas fa-times"></i> Réinitialiser
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div *ngIf="isLoadingRevenuJournalier" class="loading-releve">
                            <i class="fas fa-spinner fa-spin"></i> Chargement des revenus journaliers...
                        </div>
                        
                        <div *ngIf="!isLoadingRevenuJournalier && revenuJournalierData.length === 0" class="no-operations">
                            Aucune donnée de revenu trouvée pour ce compte.
                        </div>
                        
                        <div *ngIf="!isLoadingRevenuJournalier && revenuJournalierData.length > 0 && revenuJournalierDataFiltered.length === 0" class="no-operations">
                            Aucune donnée ne correspond aux filtres sélectionnés.
                        </div>
                        
                        <div *ngIf="!isLoadingRevenuJournalier && revenuJournalierData.length > 0 && revenuJournalierDataFiltered.length > 0" class="revenu-journalier-content">
                            <!-- Résumé des totaux -->
                            <div class="revenu-summary">
                                <div class="summary-card">
                                    <div class="summary-title">Total Cashin</div>
                                    <div class="summary-value">{{ getTotalCashinJournalier() | number:'1.2-2' }}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-title">Total Paiement</div>
                                    <div class="summary-value">{{ getTotalPaiementJournalier() | number:'1.2-2' }}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-title">Frais Cashin</div>
                                    <div class="summary-value">{{ getTotalFraisCashinJournalier() | number:'1.2-2' }}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-title">Frais Paiement</div>
                                    <div class="summary-value">{{ getTotalFraisPaiementJournalier() | number:'1.2-2' }}</div>
                                </div>
                                <div class="summary-card total-revenu">
                                    <div class="summary-title">Revenu attendu</div>
                                    <div class="summary-value">{{ getTotalRevenuJournalier() | number:'1.2-2' }}</div>
                                </div>
                                <div class="summary-card ecart-frais">
                                    <div class="summary-title">Ecart frais</div>
                                    <div class="summary-value">{{ getTotalEcartFraisJournalier() | number:'1.2-2' }}</div>
                                </div>
                            </div>

                            <!-- Informations de débogage -->
                            <div class="debug-info" *ngIf="revenuJournalierDebugInfo" style="background: #f0f8ff; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 12px; color: #666;">
                                <strong>Informations de débogage :</strong> {{ revenuJournalierDebugInfo }}
                            </div>

                            <!-- Tableau des revenus journaliers -->
                            <div class="revenu-table-container">
                                <div class="operations-summary">
                                    <span><strong>Total:</strong> {{ revenuJournalierDataFiltered.length }} jour(s)</span>
                                    <span *ngIf="revenuJournalierDataFiltered.length > revenuJournalierPageSize">
                                        <strong>Affichage:</strong> {{ (revenuJournalierCurrentPage - 1) * revenuJournalierPageSize + 1 }} - {{ Math.min(revenuJournalierCurrentPage * revenuJournalierPageSize, revenuJournalierDataFiltered.length) }} sur {{ revenuJournalierDataFiltered.length }}
                                    </span>
                                </div>
                                <table class="table table-bordered table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Total Cashin</th>
                                            <th>Total Paiement</th>
                                            <th>Frais Cashin</th>
                                            <th>Frais Paiement</th>
                                            <th>Revenu attendu</th>
                                            <th>Ecart frais</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let revenu of pagedRevenuJournalierData">
                                            <td>{{ formatDate(revenu.date) }}</td>
                                            <td class="cashin-amount">{{ revenu.totalCashin | number:'1.2-2' }}</td>
                                            <td class="paiement-amount">{{ revenu.totalPaiement | number:'1.2-2' }}</td>
                                            <td class="frais-cashin">{{ revenu.fraisCashin | number:'1.2-2' }}</td>
                                            <td class="frais-paiement">{{ revenu.fraisPaiement | number:'1.2-2' }}</td>
                                            <td class="revenu-total">{{ revenu.revenuTotal | number:'1.2-2' }}</td>
                                            <td class="ecart-frais" [ngClass]="{'negative': revenu.ecartFrais < 0, 'positive': revenu.ecartFrais > 0}">
                                                <a href="#" (click)="$event.preventDefault(); navigateToEcartFrais(revenu.date)" title="Voir Écart Frais (onglet)">
                                                    {{ revenu.ecartFrais | number:'1.2-2' }}
                                                </a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination pour le revenu journalier -->
                            <div class="releve-pagination" *ngIf="revenuJournalierTotalPages > 1">
                                <button (click)="prevRevenuJournalierPage()" [disabled]="revenuJournalierCurrentPage === 1" class="btn pagination-btn">
                                    <i class="fas fa-chevron-left"></i> Précédent
                                </button>
                                
                                <div class="pagination-indicators">
                                    <span *ngFor="let page of getVisibleRevenuJournalierPages()" 
                                            class="page-indicator"
                                            [class.active]="revenuJournalierCurrentPage === page"
                                            (click)="goToRevenuJournalierPage(page)">
                                        {{ page }}
                                    </span>
                                </div>
                                
                                <button (click)="nextRevenuJournalierPage()" [disabled]="revenuJournalierCurrentPage === revenuJournalierTotalPages" class="btn pagination-btn">
                                    Suivant <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Onglet Écart Frais (TRX SF par date/agence) - STYLE IMPACT OP -->
                <div class="tab-content" *ngIf="activeTab === 'ecart-frais'">
                  <div class="ecart-frais-container-impact">
                    <!-- En-tête -->
                    <div class="header">
                      <h2>Détail des Frais de Transaction - {{ ecartFraisAgence }} - {{ formatDate(ecartFraisDate).split(' ')[0] }}</h2>
                      <div class="header-actions">
                        <button class="btn btn-success" (click)="exportEcartFrais()" [disabled]="ecartFraisItems.length === 0">
                          <i class="fas fa-download"></i> Exporter
                        </button>
                      </div>
                    </div>

                    <!-- Statistiques -->
                    <div class="stats-section" *ngIf="!isLoadingEcartFrais && ecartFraisItems.length > 0">
                      <div class="stats-grid">
                        <div class="stat-card">
                          <div class="stat-value">{{ ecartFraisItems.length }}</div>
                          <div class="stat-label">Total transactions</div>
                        </div>
                        <div class="stat-card stat-montant">
                          <div class="stat-value">{{ getTotalMontantEcartTrxSf() | number:'1.2-2' }}</div>
                          <div class="stat-label">Montant total</div>
                        </div>
                        <div class="stat-card stat-frais">
                          <div class="stat-value">{{ getTotalFraisEcartTrxSf() | number:'1.2-2' }}</div>
                          <div class="stat-label">Total frais</div>
                        </div>
                        <div class="stat-card stat-services">
                          <div class="stat-value">{{ getUniqueServicesCount() }}</div>
                          <div class="stat-label">Services uniques</div>
                        </div>
                      </div>
                    </div>

                    <!-- Tableau des frais -->
                    <div class="table-section">
                      <div class="table-header">
                        <h3>Liste des Transactions</h3>
                        <div class="table-info">
                          Affichage {{ (ecartFraisCurrentPage - 1) * ecartFraisPageSize + 1 }} - {{ Math.min(ecartFraisCurrentPage * ecartFraisPageSize, ecartFraisItems.length) }} 
                          sur {{ ecartFraisItems.length }} transactions
                        </div>
                        <div class="page-size-controls">
                          <label>Affichage:</label>
                          <select [(ngModel)]="ecartFraisPageSize" (change)="onChangeEcartFraisPageSize(ecartFraisPageSize)" class="form-control page-size-select">
                            <option [ngValue]="10">10</option>
                            <option [ngValue]="20">20</option>
                            <option [ngValue]="50">50</option>
                            <option [ngValue]="100">100</option>
                          </select>
                        </div>
                      </div>

                      <div class="table-container" *ngIf="!isLoadingEcartFrais">
                        <table class="ecart-frais-table">
                          <thead>
                            <tr>
                              <th><i class="fas fa-hashtag"></i> ID Transaction</th>
                              <th><i class="fas fa-cog"></i> Service</th>
                              <th><i class="fas fa-building"></i> Agence</th>
                              <th><i class="fas fa-calendar"></i> Date</th>
                              <th><i class="fas fa-barcode"></i> Numéro Trans GU</th>
                              <th><i class="fas fa-globe"></i> Pays</th>
                              <th><i class="fas fa-coins"></i> Montant</th>
                              <th><i class="fas fa-receipt"></i> Frais</th>
                              <th><i class="fas fa-info-circle"></i> Statut</th>
                              <th><i class="fas fa-comment"></i> Commentaire</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let it of pagedEcartFraisItems"
                                [ngClass]="{
                                  'statut-en-attente': it.statut==='EN_ATTENTE',
                                  'statut-traite': it.statut==='TRAITE',
                                  'statut-erreur': it.statut==='ERREUR'
                                }">
                              <td>{{ it.idTransaction }}</td>
                              <td>{{ it.service }}</td>
                              <td>{{ it.agence }}</td>
                              <td>{{ formatDate(it.dateTransaction) }}</td>
                              <td>{{ it.numeroTransGu }}</td>
                              <td>{{ it.pays }}</td>
                              <td class="montant-positif">{{ it.montant | number:'1.2-2' }}</td>
                              <td class="frais-value">{{ it.frais | number:'1.2-2' }}</td>
                              <td>
                                <span class="status-badge" 
                                      [ngClass]="{
                                        'status-en-attente': it.statut === 'EN_ATTENTE',
                                        'status-traite': it.statut === 'TRAITE',
                                        'status-erreur': it.statut === 'ERREUR'
                                      }">
                                  <i class="fas" 
                                     [ngClass]="{
                                       'fa-clock': it.statut === 'EN_ATTENTE',
                                       'fa-check-circle': it.statut === 'TRAITE',
                                       'fa-times-circle': it.statut === 'ERREUR'
                                     }"></i>
                                  {{ it.statut }}
                                </span>
                              </td>
                              <td>{{ it.commentaire || '-' }}</td>
                            </tr>
                          </tbody>
                          <tfoot>
                            <tr>
                              <td colspan="6" style="text-align: right; font-weight: bold;">
                                <i class="fas fa-calculator"></i> TOTAL
                              </td>
                              <td class="montant-positif" style="font-weight: bold;">
                                <i class="fas fa-coins"></i> {{ getTotalMontantEcartTrxSf() | number:'1.2-2' }}
                              </td>
                              <td class="frais-value" style="font-weight: bold;">
                                <i class="fas fa-receipt"></i> {{ getTotalFraisEcartTrxSf() | number:'1.2-2' }}
                              </td>
                              <td colspan="2"></td>
                            </tr>
                          </tfoot>
                        </table>
                      </div>

                      <!-- Loading -->
                      <div class="loading-container" *ngIf="isLoadingEcartFrais">
                        <div class="loading-spinner">
                          <i class="fas fa-spinner fa-spin"></i>
                          <span>Chargement en cours...</span>
                        </div>
                      </div>

                      <!-- Pagination -->
                      <div class="pagination" *ngIf="ecartFraisTotalPages > 1">
                        <button (click)="prevEcartFraisPage()" [disabled]="ecartFraisCurrentPage === 1" class="btn pagination-btn">
                          <i class="fas fa-chevron-left"></i> Précédent
                        </button>
                        
                        <div class="pagination-indicators">
                          <span *ngFor="let page of getVisibleEcartFraisPages()" 
                                class="page-indicator"
                                [class.active]="ecartFraisCurrentPage === page"
                                (click)="goToEcartFraisPage(page)">
                            {{ page }}
                          </span>
                        </div>
                        
                        <button (click)="nextEcartFraisPage()" [disabled]="ecartFraisCurrentPage === ecartFraisTotalPages" class="btn pagination-btn">
                          Suivant <i class="fas fa-chevron-right"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Contenu de l'onglet Control Revenu -->
                <div class="tab-content" *ngIf="activeTab === 'control-revenu'">
                    <div class="control-revenu-container">
                        <h3>Control Revenu{{ selectedCompte ? ' - ' + selectedCompte.numeroCompte : '' }}</h3>
                        
                        <!-- Filtres pour le control revenu -->
                        <div class="control-revenu-filters" *ngIf="!isLoadingControlRevenu && controlRevenuData.length > 0">
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label for="controlRevenuDateDebut">Date début :</label>
                                    <input 
                                        type="date" 
                                        id="controlRevenuDateDebut"
                                        [(ngModel)]="controlRevenuDateDebut" 
                                        (change)="onControlRevenuFiltersChange()"
                                        class="filter-input">
                                </div>
                                <div class="filter-group">
                                    <label for="controlRevenuDateFin">Date fin :</label>
                                    <input 
                                        type="date" 
                                        id="controlRevenuDateFin"
                                        [(ngModel)]="controlRevenuDateFin" 
                                        (change)="onControlRevenuFiltersChange()"
                                        class="filter-input">
                                </div>
                                <div class="filter-group">
                                    <label for="controlRevenuService">Service :</label>
                                    <select 
                                        id="controlRevenuService"
                                        [(ngModel)]="controlRevenuService" 
                                        (change)="onControlRevenuFiltersChange()"
                                        class="filter-select">
                                        <option value="">Tous les services</option>
                                        <option *ngFor="let service of getUniqueServicesControlRevenu()" [value]="service">
                                            {{ service }}
                                        </option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="controlRevenuType">Type de contrôle :</label>
                                    <select 
                                        id="controlRevenuType"
                                        [(ngModel)]="controlRevenuType" 
                                        (change)="onControlRevenuFiltersChange()"
                                        class="filter-select">
                                        <option value="">Tous les contrôles</option>
                                        <option value="anomalie">Anomalies détectées</option>
                                        <option value="normal">Contrôles normaux</option>
                                        <option value="critique">Contrôles critiques</option>
                                    </select>
                                </div>
                            </div>
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label for="controlRevenuSeuil">Seuil d'alerte :</label>
                                    <input 
                                        type="number" 
                                        id="controlRevenuSeuil"
                                        [(ngModel)]="controlRevenuSeuil" 
                                        (input)="onControlRevenuFiltersChange()"
                                        placeholder="0.00"
                                        step="0.01"
                                        min="0"
                                        class="filter-input">
                                </div>
                                <div class="filter-group filter-actions">
                                    <button 
                                        class="btn filter-clear-btn" 
                                        (click)="clearControlRevenuFilters()"
                                        title="Réinitialiser les filtres">
                                        <i class="fas fa-times"></i> Réinitialiser
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div *ngIf="isLoadingControlRevenu" class="loading-releve">
                            <i class="fas fa-spinner fa-spin"></i> Chargement du contrôle revenu...
                        </div>
                        
                        <div *ngIf="!isLoadingControlRevenu && controlRevenuData.length === 0" class="no-operations">
                            Aucune donnée de contrôle revenu trouvée pour ce compte.
                        </div>
                        
                        <div *ngIf="!isLoadingControlRevenu && controlRevenuData.length > 0 && controlRevenuDataFiltered.length === 0" class="no-operations">
                            Aucune donnée ne correspond aux filtres sélectionnés.
                        </div>
                        
                        <div *ngIf="!isLoadingControlRevenu && controlRevenuData.length > 0 && controlRevenuDataFiltered.length > 0" class="control-revenu-content">
                            <!-- Résumé des contrôles -->
                            <div class="control-revenu-summary">
                                <div class="summary-card">
                                    <div class="summary-title">Total Contrôles</div>
                                    <div class="summary-value">{{ getTotalControlRevenu() }}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-title">Volume Total</div>
                                    <div class="summary-value volume">{{ getTotalVolumeControlRevenu() | number:'1.2-2' }}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-title">Total Transactions</div>
                                    <div class="summary-value nombre-trx">{{ getTotalNombreTrxControlRevenu() | number:'1.0-0' }}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-title">Anomalies</div>
                                    <div class="summary-value anomaly">{{ getTotalAnomaliesControlRevenu() }}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-title">Contrôles Normaux</div>
                                    <div class="summary-value normal">{{ getTotalNormauxControlRevenu() }}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-title">Contrôles Critiques</div>
                                    <div class="summary-value critical">{{ getTotalCritiquesControlRevenu() }}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-title">Taux de Conformité</div>
                                    <div class="summary-value compliance">{{ getTauxConformiteControlRevenu() | number:'1.1-1' }}%</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-title">MàG Moyen</div>
                                    <div class="summary-value mag">{{ getMoyenneMagPercentageControlRevenu() | number:'1.2-2' }}%</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-title">Total Revenu Réel</div>
                                    <div class="summary-value revenu-reel">{{ getTotalRevenuReelControlRevenu() | number:'1.2-2' }}</div>
                                </div>
                            </div>

                            <!-- Tableau des contrôles revenu -->
                            <div class="control-revenu-table-container">
                                <div class="operations-summary">
                                    <span><strong>Total:</strong> {{ controlRevenuDataFiltered.length }} ligne(s)</span>
                                    <span *ngIf="controlRevenuDataFiltered.length > controlRevenuPageSize">
                                        <strong>Affichage:</strong> {{ (controlRevenuCurrentPage - 1) * controlRevenuPageSize + 1 }} - {{ Math.min(controlRevenuCurrentPage * controlRevenuPageSize, controlRevenuDataFiltered.length) }} sur {{ controlRevenuDataFiltered.length }}
                                    </span>
                                </div>
                                <table class="table table-bordered table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Service</th>
                                            <th>Type de Contrôle</th>
                                            <th>Volume</th>
                                            <th>Nombre de Trx</th>
                                            <th>Revenu Attendu</th>
                                            <th>Frais TRX SF</th>
                                            <th>Revenu Réel</th>
                                            <th>MàG</th>
                                            <th>Statut</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let controle of pagedControlRevenuData" 
                                            [ngClass]="getControlRevenuRowClass(controle)">
                                            <td>{{ formatDate(controle.date) }}</td>
                                            <td class="service">{{ controle.service }}</td>
                                            <td>{{ controle.typeControle }}</td>
                                            <td class="volume">{{ controle.volume | number:'1.2-2' }}</td>
                                            <td class="nombre-trx">{{ controle.nombreTrx | number:'1.0-0' }}</td>
                                            <td class="revenu-attendu">{{ controle.revenuAttendu | number:'1.2-2' }}</td>
                                            <td class="frais-trx-sf">{{ controle.totalFraisTrxSf | number:'1.2-2' }}</td>
                                            <td class="revenu-reel">{{ controle.revenuReel | number:'1.2-2' }}</td>
                                            <td class="mag" [ngClass]="{'negative': controle.ecart < 0, 'positive': controle.ecart > 0}">
                                                {{ getMagPercentage(controle) | number:'1.2-2' }}%
                                            </td>
                                            <td>
                                                <span class="status-badge" [ngClass]="getControlRevenuStatusClass(controle)">
                                                    {{ getControlRevenuStatusLabel(controle) }}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-info" (click)="viewControlRevenuDetails(controle)" title="Voir les détails">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-warning" (click)="exportControlRevenu(controle)" title="Exporter">
                                                    <i class="fas fa-file-excel"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Actions pour le control revenu -->
                            <div class="control-revenu-actions">
                                <button class="btn btn-success" (click)="exportControlRevenuData()" [disabled]="controlRevenuDataFiltered.length === 0">
                                    <i class="fas fa-file-excel"></i> Exporter Control Revenu
                                </button>
                            </div>

                            <!-- Pagination pour le control revenu -->
                            <div class="releve-pagination" *ngIf="controlRevenuTotalPages > 1">
                                <button (click)="prevControlRevenuPage()" [disabled]="controlRevenuCurrentPage === 1" class="btn pagination-btn">
                                    <i class="fas fa-chevron-left"></i> Précédent
                                </button>
                                
                                <div class="pagination-indicators">
                                    <span *ngFor="let page of getVisibleControlRevenuPages()" 
                                            class="page-indicator"
                                            [class.active]="controlRevenuCurrentPage === page"
                                            (click)="goToControlRevenuPage(page)">
                                        {{ page }}
                                    </span>
                                </div>
                                
                                <button (click)="nextControlRevenuPage()" [disabled]="controlRevenuCurrentPage === controlRevenuTotalPages" class="btn pagination-btn">
                                    Suivant <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modale Solde BO -->
<div class="modal-overlay" *ngIf="showSoldeBoModal">
  <div class="modal-content">
    <h2>Solde BO pour {{ selectedCompteForBo?.numeroCompte }}</h2>
    <label>Date du solde :</label>
    <input type="date" [(ngModel)]="dateSoldeBo" (change)="onDateSoldeBoChange()" style="margin-bottom: 0.7rem;" />
    <div *ngIf="dernierSoldeBo !== null">
      <p>Solde BO enregistré pour cette date : <b>{{ dernierSoldeBo | number:'1.2-2' }}</b></p>
    </div>
    <div *ngIf="dernierSoldeBo === null">
      <p>Aucun solde BO enregistré pour cette date.</p>
    </div>
    <label>Nouveau solde BO :</label>
    <input type="number" [(ngModel)]="dernierSoldeBo" />
    <button (click)="saveSoldeBo()">Enregistrer</button>
    <button (click)="closeSoldeBoModal()">Fermer</button>
  </div>
</div>

<style>
  .comptes-resume {
    margin-top: 32px;
    background: #f8fafc;
    border-radius: 10px;
    box-shadow: 0 2px 8px #0001;
    padding: 24px 16px 8px 16px;
    max-width: 700px;
    margin-left: auto;
    margin-right: auto;
  }
  .resume-table-comptes {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 1.08em;
  }
  .resume-table-comptes th, .resume-table-comptes td {
    padding: 10px 8px;
    text-align: right;
  }
  .resume-table-comptes th {
    background: #e3f2fd;
    color: #1976d2;
    font-weight: 600;
    border-bottom: 2px solid #bbdefb;
    text-align: right;
  }
  .resume-table-comptes th:first-child, .resume-table-comptes td:first-child {
    text-align: left;
  }
  .resume-table-comptes tr.global-row {
    background: #e3f2fd;
    font-weight: bold;
    color: #1976d2;
  }

  /* Styles pour les filtres du revenu journalier */
  .revenu-filters {
    background: #f8fafc;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 20px;
    border: 1px solid #e2e8f0;
  }

  .filter-row {
    display: flex;
    gap: 16px;
    margin-bottom: 12px;
    align-items: end;
    flex-wrap: wrap;
  }

  .filter-row:last-child {
    margin-bottom: 0;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
  }

  .filter-group label {
    font-size: 12px;
    font-weight: 600;
    color: #64748b;
    margin-bottom: 4px;
  }

  .filter-input, .filter-select {
    padding: 8px 12px;
    border: 1px solid #cbd5e1;
    border-radius: 4px;
    font-size: 14px;
    background: white;
    transition: border-color 0.2s;
  }

  .filter-input:focus, .filter-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .filter-actions {
    justify-content: center;
  }

  .filter-clear-btn {
    background: #ef4444;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background-color 0.2s;
  }

  .filter-clear-btn:hover {
    background: #dc2626;
  }

  .filter-clear-btn i {
    font-size: 12px;
  }
</style>
<div class="comptes-resume">
  <table class="resume-table-comptes">
    <thead>
      <tr>
        <th>Résumé</th>
        <th>Nombre de comptes</th>
        <th>Solde global</th>
      </tr>
    </thead>
    <tbody>
      <tr class="global-row">
        <td>Global</td>
        <td>{{ resumeGlobal.count }}</td>
        <td>{{ resumeGlobal.totalSolde | number:'1.2-2' }}</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Modal pour les détails du contrôle revenu -->
<div *ngIf="showControlRevenuModal" class="modal-overlay">
  <div class="modal-content control-revenu-modal">
    <div class="modal-header">
      <h4>Détails du Contrôle Revenu</h4>
      <button type="button" class="close-btn" (click)="closeControlRevenuModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body" *ngIf="selectedControlRevenu">
      <div class="detail-section">
        <h5>Informations Générales</h5>
        <div class="detail-grid">
          <div class="detail-item">
            <label>Date :</label>
            <span>{{ formatDate(selectedControlRevenu.date) }}</span>
          </div>
          <div class="detail-item">
            <label>Service :</label>
            <span>{{ selectedControlRevenu.service }}</span>
          </div>
          <div class="detail-item">
            <label>Type de Contrôle :</label>
            <span>{{ selectedControlRevenu.typeControle }}</span>
          </div>
          <div class="detail-item">
            <label>Statut :</label>
            <span class="status-badge" [ngClass]="getControlRevenuStatusClass(selectedControlRevenu)">
              {{ getControlRevenuStatusLabel(selectedControlRevenu) }}
            </span>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h5>Données Financières</h5>
        <div class="detail-grid">
          <div class="detail-item">
            <label>Volume :</label>
            <span class="amount">{{ selectedControlRevenu.volume | number:'1.2-2' }}</span>
          </div>
          <div class="detail-item">
            <label>Nombre de Transactions :</label>
            <span>{{ selectedControlRevenu.nombreTrx | number:'1.0-0' }}</span>
          </div>
          <div class="detail-item">
            <label>Revenu Attendu :</label>
            <span class="amount revenu-attendu">{{ selectedControlRevenu.revenuAttendu | number:'1.2-2' }}</span>
          </div>
          <div class="detail-item">
            <label>Frais TRX SF :</label>
            <span class="amount frais-trx-sf">{{ (selectedControlRevenu.totalFraisTrxSf || 0) | number:'1.2-2' }}</span>
          </div>
          <div class="detail-item">
            <label>Revenu Réel :</label>
            <span class="amount revenu-reel">{{ selectedControlRevenu.revenuReel | number:'1.2-2' }}</span>
          </div>
          <div class="detail-item">
            <label>MàG :</label>
            <span class="amount mag" [ngClass]="{'negative': selectedControlRevenu.ecart < 0, 'positive': selectedControlRevenu.ecart > 0}">
              {{ getMagPercentage(selectedControlRevenu) | number:'1.2-2' }}%
            </span>
          </div>
        </div>
      </div>

      <div class="detail-section" *ngIf="selectedControlRevenu.ecart !== 0">
        <h5>Analyse de l'Écart</h5>
        <div class="ecart-analysis">
          <div class="ecart-info" [ngClass]="{'negative': selectedControlRevenu.ecart < 0, 'positive': selectedControlRevenu.ecart > 0}">
            <i class="fas" [ngClass]="selectedControlRevenu.ecart < 0 ? 'fa-arrow-down' : 'fa-arrow-up'"></i>
            <span>
              {{ selectedControlRevenu.ecart < 0 ? 'Écart négatif' : 'Écart positif' }} de 
              {{ getAbsValue(selectedControlRevenu.ecart) | number:'1.2-2' }}
              ({{ getEcartPercentage(selectedControlRevenu.ecart, selectedControlRevenu.revenuAttendu) | number:'1.1-1' }}% du revenu attendu)
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeControlRevenuModal()">
        <i class="fas fa-times"></i> Fermer
      </button>
      <button type="button" class="btn btn-primary" (click)="openDateViewModal(selectedControlRevenu.date)" *ngIf="selectedControlRevenu">
        <i class="fas fa-calendar-alt"></i> Voir par Date
      </button>
      <button type="button" class="btn btn-info" (click)="exportControlRevenu(selectedControlRevenu)" *ngIf="selectedControlRevenu">
        <i class="fas fa-file-excel"></i> Exporter
      </button>
    </div>
  </div>
</div>

<!-- Modal pour la visualisation par date -->
<div *ngIf="showDateViewModal" class="modal-overlay">
  <div class="modal-content date-view-modal">
    <div class="modal-header">
      <h4>Visualisation par Date - {{ formatDate(selectedDate) }}</h4>
      <button type="button" class="close-btn" (click)="closeDateViewModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <!-- Résumé de la date -->
      <div class="date-summary" *ngIf="!isLoadingDateView && dateViewData.length > 0">
        <div class="summary-grid">
          <div class="summary-item">
            <label>Services</label>
            <span>{{ dateViewData.length }}</span>
          </div>
          <div class="summary-item">
            <label>Volume Total</label>
            <span>{{ getDateViewTotalVolume() | number:'1.2-2' }}</span>
          </div>
          <div class="summary-item">
            <label>Revenu Attendu</label>
            <span class="revenu-attendu">{{ getDateViewTotalRevenuAttendu() | number:'1.2-2' }}</span>
          </div>
          <div class="summary-item">
            <label>Revenu Réel</label>
            <span class="revenu-reel">{{ getDateViewTotalRevenuReel() | number:'1.2-2' }}</span>
          </div>
          <div class="summary-item">
            <label>Frais TRX SF</label>
            <span class="frais-trx-sf">{{ getDateViewTotalFraisTrxSf() | number:'1.2-2' }}</span>
          </div>
          <div class="summary-item">
            <label>MàG Moyen</label>
            <span class="mag" [ngClass]="{'negative': getDateViewTotalEcart() < 0, 'positive': getDateViewTotalEcart() > 0}">
              {{ getDateViewMagPercentage() | number:'1.2-2' }}%
            </span>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div *ngIf="isLoadingDateView" class="loading-container">
        <i class="fas fa-spinner fa-spin"></i>
        <span>Chargement des données...</span>
      </div>

      <!-- Aucune donnée -->
      <div *ngIf="!isLoadingDateView && dateViewData.length === 0" class="no-data">
        <i class="fas fa-info-circle"></i>
        <span>Aucune donnée trouvée pour cette date.</span>
      </div>

      <!-- Tableau des services -->
      <div *ngIf="!isLoadingDateView && dateViewData.length > 0" class="services-table-container">
        <h5>Détail par Service</h5>
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead>
              <tr>
                <th>Service</th>
                <th>Volume</th>
                <th>Nombre Trx</th>
                <th>Revenu Attendu</th>
                <th>Frais TRX SF</th>
                <th>Revenu Réel</th>
                <th>MàG</th>
                <th>Statut</th>
                <th>Contrôles</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let service of dateViewData" [ngClass]="getServiceRowClass(service)">
                <td class="service-name">{{ service.service }}</td>
                <td class="volume">{{ service.volume | number:'1.2-2' }}</td>
                <td class="nombre-trx">{{ service.nombreTrx | number:'1.0-0' }}</td>
                <td class="revenu-attendu">{{ service.revenuAttendu | number:'1.2-2' }}</td>
                <td class="frais-trx-sf">{{ service.fraisTrxSf | number:'1.2-2' }}</td>
                <td class="revenu-reel">{{ service.revenuReel | number:'1.2-2' }}</td>
                <td class="mag" [ngClass]="{'negative': service.ecart < 0, 'positive': service.ecart > 0}">
                  {{ getMagPercentageFromService(service) | number:'1.2-2' }}%
                </td>
                <td>
                  <span class="status-badge" [ngClass]="getControlRevenuStatusClass(service)">
                    {{ getControlRevenuStatusLabel(service) }}
                  </span>
                </td>
                <td class="nombre-controles">{{ service.nombreControles }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeDateViewModal()">
        <i class="fas fa-times"></i> Fermer
      </button>
      <button type="button" class="btn btn-success" (click)="exportDateViewData()" *ngIf="dateViewData.length > 0">
        <i class="fas fa-file-excel"></i> Exporter
      </button>
    </div>
  </div>
</div>
