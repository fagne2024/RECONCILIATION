<div class="frais-container">
    <!-- En-t√™te -->
    <div class="header">
        <h1>Gestion des Frais de Transaction</h1>
        <button class="btn-primary" (click)="showAddForm = true" *ngIf="!showAddForm && !showEditForm">
            <i class="fas fa-plus"></i> Ajouter un frais
        </button>
    </div>

    <!-- Modal d'ajout de frais de transaction -->
    <div *ngIf="showAddForm" class="modal-overlay" (click)="closeAddModal($event)">
        <div class="modal-container" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Ajouter un nouveau frais de transaction</h3>
                <button type="button" class="modal-close" (click)="cancelAdd()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <form [formGroup]="addForm" (ngSubmit)="addFraisTransaction()" class="add-form">
                    <!-- Informations de base -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-info-circle"></i> Informations de base
                        </h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Service *</label>
                                <input type="text" formControlName="service" 
                                    placeholder="Saisir le nom du service..." class="text-input">
                                <div *ngIf="addForm.get('service')?.invalid && addForm.get('service')?.touched" class="error-message">
                                    <i class="fas fa-exclamation-circle"></i>
                                    Le service est requis
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Client *</label>
                                <input type="text" formControlName="agence" 
                                    placeholder="Saisir le nom du client..." class="text-input">
                                <div *ngIf="addForm.get('agence')?.invalid && addForm.get('agence')?.touched" class="error-message">
                                    <i class="fas fa-exclamation-circle"></i>
                                    Le client est requis
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration des frais -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-calculator"></i> Configuration des frais
                        </h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Type de calcul *</label>
                                <div class="select-wrapper">
                                    <select formControlName="typeCalcul" (change)="onTypeCalculChange()" class="modern-select">
                                        <option value="NOMINAL">Frais fixe</option>
                                        <option value="POURCENTAGE">Frais en pourcentage</option>
                                    </select>
                                    <i class="fas fa-chevron-down select-arrow"></i>
                                </div>
                                <div *ngIf="addForm.get('typeCalcul')?.invalid && addForm.get('typeCalcul')?.touched" class="error-message">
                                    <i class="fas fa-exclamation-circle"></i>
                                    Le type de calcul est requis
                                </div>
                            </div>
                        </div>

                        <div class="form-row" *ngIf="addForm.get('typeCalcul')?.value === 'NOMINAL'">
                            <div class="form-group full-width">
                                <label>Montant du frais (FCFA) *</label>
                                <div class="amount-input-wrapper">
                                    <input type="number" formControlName="montantFrais" 
                                        placeholder="0.00" step="0.01" min="0" class="amount-input">
                                    <span class="currency-symbol">FCFA</span>
                                </div>
                                <div *ngIf="addForm.get('montantFrais')?.invalid && addForm.get('montantFrais')?.touched" class="error-message">
                                    <i class="fas fa-exclamation-circle"></i>
                                    Le montant est requis et doit √™tre positif
                                </div>
                            </div>
                        </div>

                        <div class="form-row" *ngIf="addForm.get('typeCalcul')?.value === 'POURCENTAGE'">
                            <div class="form-group full-width">
                                <label>Pourcentage (%) *</label>
                                <div class="percentage-input-wrapper">
                                    <input type="number" formControlName="pourcentage" 
                                        placeholder="0.00" step="0.01" min="0" max="100" class="percentage-input">
                                    <span class="percentage-symbol">%</span>
                                </div>
                                <div *ngIf="addForm.get('pourcentage')?.invalid && addForm.get('pourcentage')?.touched" class="error-message">
                                    <i class="fas fa-exclamation-circle"></i>
                                    Le pourcentage est requis et doit √™tre entre 0 et 100
                                </div>
                            </div>
                        </div>

                        <!-- Aper√ßu du calcul -->
                        <div class="calculation-preview" *ngIf="showCalculationPreview()">
                            <div class="preview-card">
                                <div class="preview-header">
                                    <h5>Aper√ßu du calcul</h5>
                                </div>
                                <div class="preview-content">
                                    <div class="preview-item">
                                        <span class="preview-label">Type:</span>
                                        <span class="preview-value">{{ getTypeCalculDisplayName() }}</span>
                                    </div>
                                    <div class="preview-item" *ngIf="addForm.get('typeCalcul')?.value === 'NOMINAL'">
                                        <span class="preview-label">Montant fixe:</span>
                                        <span class="preview-value">{{ addForm.get('montantFrais')?.value | currency:'XAF':'symbol':'1.0-0' }}</span>
                                    </div>
                                    <div class="preview-item" *ngIf="addForm.get('typeCalcul')?.value === 'POURCENTAGE'">
                                        <span class="preview-label">Pourcentage:</span>
                                        <span class="preview-value">{{ addForm.get('pourcentage')?.value }}%</span>
                                    </div>
                                    <div class="preview-item">
                                        <span class="preview-label">Service:</span>
                                        <span class="preview-value">{{ addForm.get('service')?.value || 'Non d√©fini' }}</span>
                                    </div>
                                    <div class="preview-item">
                                        <span class="preview-label">Client:</span>
                                        <span class="preview-value">{{ addForm.get('agence')?.value || 'Non d√©fini' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- D√©tails suppl√©mentaires -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-cog"></i> D√©tails suppl√©mentaires
                        </h4>
                        
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Description</label>
                                <input type="text" formControlName="description" 
                                    placeholder="Description du frais (optionnel)" class="text-input">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <div class="checkbox-wrapper">
                                    <label class="checkbox-label">
                                        <input type="checkbox" formControlName="actif" class="modern-checkbox">
                                        <span class="checkmark"></span>
                                        Actif
                                    </label>
                                    <div class="checkbox-help">
                                        <i class="fas fa-info-circle"></i>
                                        Les frais inactifs ne seront pas appliqu√©s automatiquement
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" (click)="cancelAdd()">
                        <i class="fas fa-times"></i>
                        Annuler
                    </button>
                    <button type="submit" class="btn-primary" 
                        [disabled]="!addForm.valid || isAdding"
                        (click)="addFraisTransaction()">
                        <i class="fas fa-plus"></i>
                        {{ isAdding ? 'Ajout en cours...' : 'Ajouter le frais' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire de modification -->
    <div *ngIf="showEditForm && editingFrais" class="edit-form-section">
        <h3>Modifier le frais</h3>
        <form [formGroup]="editForm" (ngSubmit)="updateFraisTransaction()" class="form">
            <div class="form-row">
                <div class="form-group">
                    <label>Service *</label>
                    <input type="text" formControlName="service" 
                        placeholder="Saisir le nom du service..." class="text-input">
                    <div *ngIf="editForm.get('service')?.invalid && editForm.get('service')?.touched" class="error-message">
                        Le service est requis
                    </div>
                </div>
                <div class="form-group">
                    <label>Client *</label>
                    <input type="text" formControlName="agence" 
                        placeholder="Saisir le nom du client..." class="text-input">
                    <div *ngIf="editForm.get('agence')?.invalid && editForm.get('agence')?.touched" class="error-message">
                        Le client est requis
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Type de calcul *</label>
                    <select formControlName="typeCalcul" (change)="onTypeCalculChange()">
                        <option value="NOMINAL">Frais fixe</option>
                        <option value="POURCENTAGE">Frais en pourcentage</option>
                    </select>
                    <div *ngIf="editForm.get('typeCalcul')?.invalid && editForm.get('typeCalcul')?.touched" class="error-message">
                        Le type de calcul est requis
                    </div>
                </div>
                <div class="form-group" *ngIf="editForm.get('typeCalcul')?.value === 'NOMINAL'">
                    <label>Montant du frais (FCFA) *</label>
                    <input type="number" formControlName="montantFrais" placeholder="0.00" step="0.01" min="0">
                    <div *ngIf="editForm.get('montantFrais')?.invalid && editForm.get('montantFrais')?.touched" class="error-message">
                        Le montant est requis et doit √™tre positif
                    </div>
                </div>
                <div class="form-group" *ngIf="editForm.get('typeCalcul')?.value === 'POURCENTAGE'">
                    <label>Pourcentage (%) *</label>
                    <input type="number" formControlName="pourcentage" placeholder="0.00" step="0.01" min="0" max="100">
                    <div *ngIf="editForm.get('pourcentage')?.invalid && editForm.get('pourcentage')?.touched" class="error-message">
                        Le pourcentage est requis et doit √™tre entre 0 et 100
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" formControlName="description" placeholder="Description du frais">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>
                        <input type="checkbox" formControlName="actif">
                        Actif
                    </label>
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" [disabled]="!editForm.valid">
                    Mettre √† jour
                </button>
                <button type="button" (click)="cancelEdit()">Annuler</button>
            </div>
        </form>
    </div>

    <!-- Filtres -->
    <div class="filters-section">
        <h3>Filtres</h3>
        <form [formGroup]="filterForm" class="filters-form">
            <div class="form-row single-line">
                <div class="form-group">
                    <label>Service</label>
                    <mat-form-field appearance="fill" class="filter-select">
                        <mat-label>Service</mat-label>
                        <mat-select #serviceSelect formControlName="services" multiple (selectionChange)="onServiceChange($event)">
                            <mat-option>
                                <ngx-mat-select-search [formControl]="serviceSearchCtrl" placeholderLabel="Rechercher un service..." noEntriesFoundLabel="Aucun service trouv√©"></ngx-mat-select-search>
                            </mat-option>
                            <mat-option *ngFor="let service of filteredServicesList" [value]="service">
                                {{ service }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div class="form-group">
                    <label>Client</label>
                    <mat-form-field appearance="fill" class="filter-select">
                        <mat-label>Client</mat-label>
                        <mat-select #agenceSelect formControlName="agences" multiple (selectionChange)="onAgenceChange($event)">
                            <mat-option>
                                <ngx-mat-select-search [formControl]="agenceSearchCtrl" placeholderLabel="Rechercher un client..." noEntriesFoundLabel="Aucun client trouv√©"></ngx-mat-select-search>
                            </mat-option>
                            <mat-option *ngFor="let agence of filteredAgencesList" [value]="agence">
                                {{ agence }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div class="form-group">
                    <label>Statut</label>
                    <select formControlName="actif" (change)="applyFilters()">
                        <option value="">Tous</option>
                        <option [value]="true">Actif</option>
                        <option [value]="false">Inactif</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="dateDebut">Date de d√©but</label>
                    <input id="dateDebut" type="date" [value]="dateDebut" (change)="onDateDebutChange($event)">
                </div>
                <div class="form-group">
                    <label for="dateFin">Date de fin</label>
                    <input id="dateFin" type="date" [value]="dateFin" (change)="onDateFinChange($event)">
                </div>
                <div class="form-group">
                    <button type="button" (click)="clearFilters()">Effacer les filtres</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Liste des frais -->
    <div class="frais-list">
        <div class="list-header">
            <h3>Liste des Frais de Transaction</h3>
            <div class="export-buttons" *ngIf="!isLoading && pagedFrais.length > 0">
                <button class="btn-export btn-csv" (click)="exportToCSV()" [disabled]="isExporting">
                    <i class="fas fa-file-csv"></i>
                    {{ isExporting ? 'Export en cours...' : 'Exporter CSV' }}
                </button>
                <button class="btn-export btn-excel" (click)="exportToExcel()" [disabled]="isExporting">
                    <i class="fas fa-file-excel"></i>
                    {{ isExporting ? 'Export en cours...' : 'Exporter Excel' }}
                </button>
                <button class="btn-export btn-api" (click)="exportViaAPI()" [disabled]="isExporting">
                    <i class="fas fa-download"></i>
                    {{ isExporting ? 'Export en cours...' : 'Export API' }}
                </button>
            </div>
        </div>

        <div *ngIf="isLoading" class="loading">
            <p>Chargement des frais de transaction...</p>
        </div>

        <div *ngIf="!isLoading && pagedFrais.length === 0" class="no-data">
            <p>Aucun frais de transaction trouv√©</p>
        </div>

        <div *ngIf="!isLoading && pagedFrais.length > 0" class="table-container">
            <table class="frais-table">
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Client</th>
                        <th>Type</th>
                        <th>Valeur Param√©tr√©e</th>
                        <th>Description</th>
                        <th>Statut</th>
                        <th>Date Cr√©ation</th>
                        <th>Date Modification</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let frais of pagedFrais">
                        <td>
                            <span class="badge service-{{ frais.service.toLowerCase() }}">
                                {{ frais.service }}
                            </span>
                        </td>
                        <td>{{ frais.agence }}</td>
                        <td>
                            <span class="badge type-{{ frais.typeCalcul?.toLowerCase() || 'nominal' }}">
                                {{ frais.typeCalcul === 'POURCENTAGE' ? 'Frais en %' : 'Frais fixe' }}
                            </span>
                        </td>
                        <td>
                            <span *ngIf="frais.typeCalcul === 'POURCENTAGE'">
                                {{ frais.pourcentage | number:'1.2-2' }}%
                            </span>
                            <span *ngIf="frais.typeCalcul !== 'POURCENTAGE'">
                                {{ frais.montantFrais | number:'1.2-2' }} FCFA
                            </span>
                        </td>
                        <td>{{ frais.description || '-' }}</td>
                        <td>
                            <span class="badge status-{{ frais.actif ? 'actif' : 'inactif' }}">
                                {{ frais.actif ? 'Actif' : 'Inactif' }}
                            </span>
                        </td>
                        <td>{{ frais.dateCreation | date:'dd/MM/yyyy HH:mm' }}</td>
                        <td>{{ frais.dateModification | date:'dd/MM/yyyy HH:mm' }}</td>
                        <td class="actions">
                            <button class="btn-icon" (click)="editFraisTransaction(frais)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon btn-toggle" (click)="toggleFraisTransaction(frais.id)" *ngIf="frais.id">
                                <i class="fas" [class.fa-toggle-on]="frais.actif" [class.fa-toggle-off]="!frais.actif"></i>
                            </button>
                            <button class="btn-icon btn-danger" (click)="deleteFraisTransaction(frais.id)" *ngIf="frais.id">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination" *ngIf="totalPages > 1">
            <button (click)="prevPage()" [disabled]="currentPage === 1">
                <i class="fas fa-chevron-left"></i> Pr√©c√©dent
            </button>
            
            <div class="pagination-indicators">
                <span *ngFor="let page of getVisiblePages()" 
                      class="page-indicator"
                      [class.active]="currentPage === page"
                      (click)="goToPage(page)">
                    {{ page }}
                </span>
            </div>
            
            <button (click)="nextPage()" [disabled]="currentPage === totalPages">
                Suivant <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Section d'information sur la logique de calcul -->
    <div class="info-section">
        <h3>‚ÑπÔ∏è Logique de calcul des frais</h3>
        <div class="info-content">
            <div class="info-card">
                <h4>üí∞ Frais fixes (NOMINAL)</h4>
                <p><strong>Formule:</strong> Montant configur√© √ó Nombre de transactions</p>
                <p><strong>Source du nombre de transactions:</strong> Donn√©es r√©elles de l'AgencySummary</p>
                <p><strong>Exemple:</strong> Si le montant configur√© est 500 FCFA et qu'il y a 10 transactions, les frais = 500 √ó 10 = 5 000 FCFA</p>
            </div>
            <div class="info-card">
                <h4>üìä Frais en pourcentage (POURCENTAGE)</h4>
                <p><strong>Formule:</strong> Volume total de l'op√©ration √ó Pourcentage</p>
                <p><strong>Source du volume:</strong> Montant de l'op√©ration principale</p>
                <p><strong>Exemple:</strong> Si le volume est 10 000 FCFA et le pourcentage 2.5%, les frais = 10 000 √ó 2.5% = 250 FCFA</p>
            </div>
        </div>
    </div>

    <!-- Section de test du calcul des frais -->
    <div class="test-section">
        <h3>üß™ Test du calcul des frais</h3>
        <div class="test-form">
            <div class="form-row">
                <div class="form-group">
                    <label>Service</label>
                    <input type="text" [(ngModel)]="testService" placeholder="Ex: AIRTIME">
                </div>
                <div class="form-group">
                    <label>Client</label>
                    <input type="text" [(ngModel)]="testAgence" placeholder="Ex: CL001">
                </div>
                <div class="form-group">
                    <label>Type de calcul</label>
                    <select [(ngModel)]="testTypeCalcul" (change)="onTestTypeChange()">
                        <option value="NOMINAL">Frais fixe</option>
                        <option value="POURCENTAGE">Frais en pourcentage</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" *ngIf="testTypeCalcul === 'NOMINAL'">
                    <label>Montant du frais (FCFA)</label>
                    <input type="number" [(ngModel)]="testMontantFrais" placeholder="Ex: 100">
                </div>
                <div class="form-group" *ngIf="testTypeCalcul === 'POURCENTAGE'">
                    <label>Pourcentage (%)</label>
                    <input type="number" [(ngModel)]="testPourcentage" placeholder="Ex: 2.5">
                </div>
                <div class="form-group">
                    <label>Volume de l'op√©ration (FCFA)</label>
                    <input type="number" [(ngModel)]="testVolumeOperation" placeholder="Ex: 10000">
                </div>
                <div class="form-group" *ngIf="testTypeCalcul === 'NOMINAL'">
                    <label>Nombre de transactions</label>
                    <input type="number" [(ngModel)]="testNombreTransactions" placeholder="Ex: 50">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <button type="button" (click)="testFraisCalculation()" class="btn btn-primary">
                        üß™ Tester le calcul
                    </button>
                </div>
            </div>
            
            <!-- R√©sultat du test -->
            <div *ngIf="testResult" class="test-result">
                <h4>üìä R√©sultat du test</h4>
                <div class="result-details">
                    <p><strong>Type:</strong> {{ testResult.type }}</p>
                    <p><strong>Formule:</strong> {{ testResult.formule }}</p>
                    <p *ngIf="testResult.volumeTotal"><strong>Volume total:</strong> {{ testResult.volumeTotal | number:'1.2-2' }} FCFA</p>
                    <p *ngIf="testResult.pourcentage"><strong>Pourcentage:</strong> {{ testResult.pourcentage }}%</p>
                    <p *ngIf="testResult.montantParametre"><strong>Montant param√©tr√©:</strong> {{ testResult.montantParametre | number:'1.2-2' }} FCFA</p>
                    <p *ngIf="testResult.nombreTransactions"><strong>Nombre de transactions:</strong> {{ testResult.nombreTransactions }}</p>
                    <p class="result-total"><strong>Montant des frais calcul√©:</strong> <span class="highlight">{{ testResult.montantFraisCalcule | number:'1.2-2' }} FCFA</span></p>
                </div>
            </div>
        </div>
    </div>
</div> 