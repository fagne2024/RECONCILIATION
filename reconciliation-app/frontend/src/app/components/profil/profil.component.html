<div class="profil-container">
  <div class="header">
    <h2>Gestion des profils</h2>
    <div class="actions">
      <button (click)="showAddForm = !showAddForm" class="btn add-btn">
        <i class="fas fa-plus"></i> Nouveau Profil
      </button>
    </div>
  </div>

  <!-- Modal d'ajout de profil -->
  <div *ngIf="showAddForm" class="modal-overlay" (click)="closeAddModal($event)">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3><i class="fas fa-plus-circle"></i> Créer un nouveau profil</h3>
        <button type="button" class="modal-close" (click)="cancelAdd()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form [formGroup]="addForm" (ngSubmit)="createProfil()" class="add-form">
          <div class="form-section">
            <div class="form-group">
              <label>Nom du profil *</label>
              <input type="text" formControlName="nom" placeholder="Ex: Administrateur" class="text-input">
              <div *ngIf="addForm.get('nom')?.invalid && addForm.get('nom')?.touched" class="error-message">
                Le nom du profil est requis.
              </div>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea formControlName="description" placeholder="Description du profil..." class="text-input"></textarea>
            </div>
          </div>
          
          <div class="modal-footer">
            <div class="modal-actions">
              <button type="button" class="btn-secondary" (click)="cancelAdd()">
                <i class="fas fa-times"></i>
                Annuler
              </button>
              <button type="submit" class="btn-primary" [disabled]="!addForm.valid || isAdding">
                <i class="fas fa-plus"></i>
                {{ isAdding ? 'Création...' : 'Créer' }}
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal d'édition de profil -->
  <div *ngIf="showEditForm" class="modal-overlay" (click)="cancelEdit()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3><i class="fas fa-edit"></i> Modifier le profil</h3>
        <button type="button" class="modal-close" (click)="cancelEdit()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form [formGroup]="editForm" (ngSubmit)="updateProfil()" class="edit-form">
          <div class="form-section">
            <div class="form-group">
              <label>Nom du profil *</label>
              <input type="text" formControlName="nom" placeholder="Ex: Administrateur" class="text-input">
              <div *ngIf="editForm.get('nom')?.invalid && editForm.get('nom')?.touched" class="error-message">
                Le nom du profil est requis.
              </div>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea formControlName="description" placeholder="Description du profil..." class="text-input"></textarea>
            </div>
          </div>
          
          <div class="modal-footer">
            <div class="modal-actions">
              <button type="button" class="btn-secondary" (click)="cancelEdit()">
                <i class="fas fa-times"></i>
                Annuler
              </button>
              <button type="submit" class="btn-primary" [disabled]="!editForm.valid || isEditing">
                <i class="fas fa-save"></i>
                {{ isEditing ? 'Modification...' : 'Modifier' }}
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Tableau des profils -->
  <div class="table-container">
    <div *ngIf="isLoading" class="loading">
      <p>Chargement des profils...</p>
    </div>

    <div *ngIf="!isLoading && profils.length === 0" class="no-data">
      <p>Aucun profil trouvé</p>
    </div>

    <div *ngIf="!isLoading && profils.length > 0" class="table-wrapper">
      <table class="profils-table">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Description</th>
            <th>Modules associés</th>
            <th>Permissions</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let profil of profils">
            <td>
              <span class="profil-name" (click)="selectProfil(profil)" [class.selected]="selectedProfil && selectedProfil.id === profil.id">
                {{ profil.nom }}
              </span>
            </td>
            <td>{{ profil.description || '-' }}</td>
            <td>
              <span class="modules-count">{{ getAssociatedModulesForProfil(profil).length }} module(s)</span>
            </td>
            <td>
              <span class="permissions-count">{{ getProfilPermissionsCount(profil) }} permission(s)</span>
            </td>
            <td class="actions">
              <button (click)="editProfil(profil)" [disabled]="isDeleting" class="btn icon-btn edit" title="Modifier">
                <i class="fas fa-edit" [style.color]="isDeleting ? '#ccc' : 'green'"></i>
              </button>
              <button (click)="selectProfil(profil)" [disabled]="isDeleting" class="btn icon-btn view" title="Voir les droits">
                <i class="fas fa-eye" [style.color]="isDeleting ? '#ccc' : 'blue'"></i>
              </button>
              <button (click)="deleteProfil(profil)" [disabled]="isDeleting" class="btn icon-btn delete" title="Supprimer">
                <i class="fas fa-trash" [style.color]="isDeleting ? '#ccc' : 'red'"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div *ngIf="selectedProfil" class="profil-droits">
    <h3>Droits du profil : {{ selectedProfil.nom }}</h3>
    <table class="droits-table">
      <thead>
        <tr>
          <th>Module</th>
          <th *ngFor="let permission of permissions">{{ permission.nom }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let module of getAssociatedModules()">
          <td>{{ module.nom }}</td>
          <td *ngFor="let permission of permissions">
            <input type="checkbox"
              [checked]="hasPermission(module, permission)"
              (change)="togglePermission(module, permission, $event)"
            />
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="selectedProfil" class="module-action-management">
    <h3>Choisir un menu (module)</h3>
    <select [(ngModel)]="selectedModuleId" (change)="onModuleChange()">
      <option value="" disabled>Choisir un menu</option>
      <option *ngFor="let module of modules" [value]="module.id">{{ module.nom }}</option>
    </select>
  </div>

  <div *ngIf="selectedProfil && selectedModuleId" class="permission-management">
    <h3>Ajouter une action (permission) au menu sélectionné</h3>
    
    <div *ngIf="loadingModulePermissions" class="loading-message">
      Chargement des actions disponibles...
    </div>
    
    <div *ngIf="!loadingModulePermissions">
      <p class="info-message">
        Sélectionnez une action dans la liste ci-dessous. Les actions déjà attribuées à ce profil pour ce module sont désactivées.
      </p>
      <select [(ngModel)]="selectedPermissionName">
        <option value="" disabled>Choisir une action existante</option>
        <option *ngFor="let permission of availableModulePermissions" [value]="permission.nom" [disabled]="permissionExistsForModule(permission.nom)">
          {{ permission.nom }}{{ permissionExistsForModule(permission.nom) ? ' (déjà attribuée)' : '' }}
        </option>
      </select>
      <button (click)="addExistingPermissionToModule()" [disabled]="!selectedPermissionName || permissionExistsForModule(selectedPermissionName)">Ajouter l'action sélectionnée</button>
      <br><br>
      <input [(ngModel)]="newPermissionName" placeholder="Nouvelle action (ex: Valider)">
      <button (click)="createPermissionForModule()" [disabled]="!newPermissionName || permissionExistsForModule(newPermissionName)">Ajouter la nouvelle action</button>
    </div>
  </div>

  <div *ngIf="selectedProfil" class="module-management">
    <h3>Gestion des menus (modules)</h3>
    <ul>
      <li *ngFor="let module of modules">
        {{ module.nom }}
        <button (click)="deleteModule(module)">Supprimer</button>
      </li>
    </ul>
    <select [(ngModel)]="selectedMenuName">
      <option value="" disabled>Choisir un menu</option>
      <option *ngFor="let menu of appMenus" [value]="menu" [disabled]="menuExists(menu)">
        {{ menu }}
      </option>
    </select>
    <button (click)="createModule()" [disabled]="!selectedMenuName || menuExists(selectedMenuName)">Ajouter le menu</button>
  </div>
</div> 