<div class="auto-processing-models-container">
  <div class="header">
    <h2>Mod√®les de Traitement Automatique</h2>
    <p>Cr√©ez et g√©rez des mod√®les de traitement automatique pour vos fichiers</p>
    <div class="header-actions">
      <button (click)="cleanupModels()" class="btn btn-warning">
        <i class="fas fa-broom"></i> Nettoyer mod√®les vides
      </button>
      <button (click)="createDefaultBOModel()" class="btn btn-secondary">
        <i class="fas fa-magic"></i> Cr√©er mod√®le BO TRXBO
      </button>
      <button (click)="createDefaultOrangeMoneyModel()" class="btn btn-info">
        <i class="fas fa-mobile-alt"></i> Cr√©er mod√®le Orange Money
      </button>
      <button (click)="createExtendedCIOMModel()" class="btn btn-info">
        <i class="fas fa-expand"></i> Cr√©er mod√®le CIOM/PMOM √©tendu
      </button>
      <button class="btn btn-success me-2" (click)="fixReconciliationKeys()">
        <i class="fas fa-wrench"></i> Corriger cl√©s r√©conciliation
      </button>
    </div>
  </div>

  <!-- Messages d'erreur -->
  <div *ngIf="errorMessage" class="error-message">
    <span>{{ errorMessage }}</span>
    <button (click)="clearError()" class="close-btn">√ó</button>
  </div>

  <!-- Liste des mod√®les existants -->
  <div class="models-section">
    <div class="section-header">
      <h3>Mod√®les existants</h3>
      <div class="header-actions">
        <button (click)="toggleModelFilter()" class="btn btn-info me-2" 
                [class.active]="showModelFilter">
          <i class="fas fa-filter"></i> 
          {{ showModelFilter ? 'Masquer' : 'Afficher' }} filtres mod√®les
        </button>
        <button (click)="togglePartnerFilter()" class="btn btn-warning me-2" 
                [class.active]="showPartnerFilter">
          <i class="fas fa-filter"></i> 
          {{ showPartnerFilter ? 'Masquer' : 'Afficher' }} filtres partenaires
        </button>
        <button (click)="createModel()" class="btn btn-primary">
          <i class="fas fa-plus"></i> Nouveau mod√®le
        </button>
      </div>
    </div>

    <!-- Section de filtrage g√©n√©ral des mod√®les -->
    <div *ngIf="showModelFilter && models.length > 0" class="model-filter-section">
      <h4>üîç Filtrer tous les mod√®les</h4>
      <div class="filter-controls">
        <div class="filter-group">
          <label>Colonne :</label>
          <select [(ngModel)]="selectedModelFilterColumn" (change)="onModelFilterColumnChange()">
            <option value="">-- Choisir une colonne --</option>
            <option *ngFor="let col of getModelFilterColumns()" [value]="col.value">
              {{ col.label }}
            </option>
          </select>
        </div>
        
        <div class="filter-group" *ngIf="selectedModelFilterColumn && modelFilterValues.length > 0">
          <label>Valeur √† garder :</label>
          <mat-form-field appearance="fill" class="filter-select">
            <mat-label>S√©lectionner des valeurs</mat-label>
            <mat-select [(ngModel)]="selectedModelFilterValues" multiple>
              <mat-option>
                <ngx-mat-select-search [formControl]="modelFilterValueSearchCtrl" 
                                     placeholderLabel="Rechercher une valeur..." 
                                     noEntriesFoundLabel="Aucune valeur trouv√©e">
                </ngx-mat-select-search>
              </mat-option>
              <mat-option value="__TOUS__" (click)="selectAllModelFilterValues()">
                <strong>üìã Tous</strong>
              </mat-option>
              <mat-option *ngFor="let val of filteredModelFilterValues" [value]="val">
                {{ val || '(vide)' }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        
        <div class="filter-actions">
          <button (click)="applyModelFilter()" 
                  [disabled]="!selectedModelFilterColumn || !selectedModelFilterValues.length" 
                  class="apply-btn">
            Appliquer le filtre
          </button>
          <button (click)="resetModelFilter()" 
                  [disabled]="!selectedModelFilterColumn && !selectedModelFilterValues.length" 
                  class="reset-btn">
            R√©initialiser
          </button>
        </div>
      </div>
      
      <!-- Indicateur de filtre appliqu√© -->
      <div *ngIf="modelFilterApplied" class="filter-status">
        <span class="filter-badge">
          <i class="fas fa-filter"></i>
          Filtre appliqu√©: {{ filteredModels.length }} mod√®le(s) sur {{ models.length }}
        </span>
      </div>
    </div>

    <!-- Section de filtrage des mod√®les partenaires -->
    <div *ngIf="showPartnerFilter && getPartnerModels().length > 0" class="partner-filter-section">
      <h4>üîç Filtrer les mod√®les partenaires</h4>
      <div class="filter-controls">
        <!-- Filtre par colonne existant -->
        <div class="filter-group">
          <label>Colonne :</label>
          <select [(ngModel)]="selectedPartnerFilterColumn" (change)="onPartnerFilterColumnChange()">
            <option value="">-- Choisir une colonne --</option>
            <option *ngFor="let col of getPartnerFilterColumns()" [value]="col.value">
              {{ col.label }}
            </option>
          </select>
        </div>
        
        <div class="filter-group" *ngIf="selectedPartnerFilterColumn && partnerFilterValues.length > 0">
          <label>Valeur √† garder :</label>
          <mat-form-field appearance="fill" class="filter-select">
            <mat-label>S√©lectionner des valeurs</mat-label>
            <mat-select [(ngModel)]="selectedPartnerFilterValues" multiple>
              <mat-option>
                <ngx-mat-select-search [formControl]="partnerFilterValueSearchCtrl" 
                                     placeholderLabel="Rechercher une valeur..." 
                                     noEntriesFoundLabel="Aucune valeur trouv√©e">
                </ngx-mat-select-search>
              </mat-option>
              <mat-option value="__TOUS__" (click)="selectAllPartnerFilterValues()">
                <strong>üìã Tous</strong>
              </mat-option>
              <mat-option *ngFor="let val of filteredPartnerFilterValues" [value]="val">
                {{ val || '(vide)' }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Nouveau filtre par pays -->
        <div class="filter-group">
          <label>Pays (2 derni√®res lettres) :</label>
          <mat-form-field appearance="fill" class="filter-select">
            <mat-label>S√©lectionner des pays</mat-label>
            <mat-select [(ngModel)]="selectedPartnerCountries" multiple (selectionChange)="onPartnerCountryChange()">
              <mat-option>
                <ngx-mat-select-search [formControl]="partnerCountrySearchCtrl" 
                                     placeholderLabel="Rechercher un pays..." 
                                     noEntriesFoundLabel="Aucun pays trouv√©">
                </ngx-mat-select-search>
              </mat-option>
              <mat-option value="__TOUS__" (click)="selectAllPartnerCountries()">
                <strong>üåç Tous les pays</strong>
              </mat-option>
              <mat-option *ngFor="let country of filteredPartnerCountries" [value]="country">
                <span class="country-option">
                  <span class="country-code">{{ country }}</span>
                  <span class="country-example">(ex: CIOM{{ country }})</span>
                </span>
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        
        <div class="filter-actions">
          <button (click)="applyPartnerFilter()" 
                  [disabled]="!selectedPartnerFilterColumn || !selectedPartnerFilterValues.length" 
                  class="apply-btn">
            Appliquer le filtre
          </button>
          <button (click)="resetPartnerFilter()" 
                  [disabled]="!selectedPartnerFilterColumn && !selectedPartnerFilterValues.length && !selectedPartnerCountries.length" 
                  class="reset-btn">
            R√©initialiser
          </button>
        </div>
      </div>
      
      <!-- Indicateur de filtre appliqu√© -->
      <div *ngIf="partnerFilterApplied" class="filter-status">
        <span class="filter-badge">
          <i class="fas fa-filter"></i>
          Filtre appliqu√©: {{ filteredPartnerModels.length }} mod√®le(s) sur {{ getPartnerModels().length }}
        </span>
      </div>
    </div>

    <div class="models-grid" *ngIf="models.length > 0; else noModels">
      <div class="model-card" 
           [ngClass]="{
             'model-ci': isCIModel(model),
             'model-pm': isPMModel(model)
           }"
           *ngFor="let model of getDisplayedModels()">
        <div class="model-header">
          <div class="model-title-section">
            <h4 [ngClass]="{
              'title-ci': isCIModel(model),
              'title-pm': isPMModel(model)
            }">{{ model.name }}</h4>
            <div class="model-badges">
              <span *ngIf="isCIModel(model)" class="badge badge-ci">
                <i class="fas fa-check-circle"></i> CI
              </span>
              <span *ngIf="isPMModel(model)" class="badge badge-pm">
                <i class="fas fa-exclamation-circle"></i> PM
              </span>
            </div>
          </div>
          <div class="model-actions">
            <button (click)="editModel(model)" class="btn btn-sm btn-edit" title="Modifier">
              <i class="fas fa-edit"></i>
            </button>
            <button (click)="deleteModel(model.id)" class="btn btn-sm btn-delete" title="Supprimer">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        
        <div class="model-info">
          <p><strong>Pattern:</strong> {{ model.filePattern }}</p>
          <p><strong>Type:</strong> {{ model.fileType }}</p>
          <p><strong>√âtapes:</strong> {{ getStepCount(model) }}</p>
          <p><strong>Auto-appliqu√©:</strong> {{ model.autoApply ? 'Oui' : 'Non' }}</p>
          <p *ngIf="model.templateFile"><strong>Fichier mod√®le:</strong> {{ model.templateFile }}</p>
        </div>

        <div class="model-steps" *ngIf="model.processingSteps.length > 0">
          <h5>√âtapes de traitement:</h5>
          <ul>
            <li *ngFor="let step of model.processingSteps">{{ step.name }}</li>
          </ul>
        </div>
      </div>
    </div>

    <ng-template #noModels>
      <div class="no-models">
        <p>Aucun mod√®le de traitement automatique cr√©√©.</p>
        <button (click)="createModel()" class="btn btn-primary">
          <i class="fas fa-plus"></i> Cr√©er le premier mod√®le
        </button>
      </div>
    </ng-template>
  </div>

  <!-- Formulaire de cr√©ation/√©dition -->
  <div class="form-section" *ngIf="showCreateForm">
    <div class="form-header">
      <h3>{{ editingModel ? 'Modifier le mod√®le' : 'Cr√©er un nouveau mod√®le' }}</h3>
      <button (click)="closeForm()" class="btn btn-secondary">
        <i class="fas fa-times"></i> Fermer
      </button>
    </div>

    <form [formGroup]="modelForm" (ngSubmit)="saveModel()" class="model-form">
      <div class="form-row">
        <div class="form-group">
          <label for="name">Nom du mod√®le *</label>
          <input type="text" id="name" formControlName="name" class="form-control" 
                 placeholder="Ex: Traitement BO Standard">
        </div>

        <div class="form-group">
          <label for="fileType">Type de fichier *</label>
          <select id="fileType" formControlName="fileType" class="form-control">
            <option value="bo">Back Office</option>
            <option value="partner">Partenaire</option>
            <option value="both">Les deux</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="filePattern">Pattern de fichier *</label>
          <input type="text" id="filePattern" formControlName="filePattern" class="form-control" 
                 placeholder="Ex: *bo*.csv">
        </div>

        <div class="form-group">
          <label for="templateFile">Fichier mod√®le</label>
          <div class="template-file-section">
            <input type="text" id="templateFile" formControlName="templateFile" class="form-control" 
                   placeholder="S√©lectionner un fichier mod√®le" readonly>
            <button type="button" (click)="openFileSelector()" class="btn btn-secondary">
              <i class="fas fa-folder-open"></i> Choisir
            </button>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" formControlName="autoApply">
          Appliquer automatiquement lors de l'upload
        </label>
      </div>

      <!-- √âtapes de traitement -->
      <div class="processing-steps-section">
        <div class="steps-header">
          <h4>√âtapes de traitement</h4>
          <button type="button" (click)="addProcessingStep()" class="btn btn-success">
            <i class="fas fa-plus"></i> Ajouter une √©tape
          </button>
        </div>

        <div class="steps-list" formArrayName="processingSteps">
          <div class="step-item" *ngFor="let step of processingStepsFormArray.controls; let i = index" 
               [formGroupName]="i">
            
            <div class="step-header">
              <h5>√âtape {{ i + 1 }}</h5>
              <button type="button" (click)="removeProcessingStep(i)" class="btn btn-sm btn-delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>

            <div class="step-form">
              <div class="form-row">
                <div class="form-group">
                  <label>Nom de l'√©tape *</label>
                  <input type="text" formControlName="name" class="form-control" 
                         placeholder="Ex: Formatage des montants">
                </div>

                <div class="form-group">
                  <label>Type d'√©tape *</label>
                  <select formControlName="type" (change)="onStepTypeChange(i)" class="form-control">
                    <option *ngFor="let type of stepTypes" [value]="type.value">
                      {{ type.label }}
                    </option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Champ √† traiter *</label>
                  <select formControlName="field" class="form-control" multiple size="4">
                    <option *ngFor="let col of availableColumnsForTemplate" [value]="col">
                      {{ col }}
                    </option>
                  </select>
                  <small class="form-text text-muted">Maintenez Ctrl (ou Cmd sur Mac) pour s√©lectionner plusieurs champs</small>
                </div>

                <div class="form-group">
                  <label>Action *</label>
                  <select formControlName="action" class="form-control">
                    <option *ngFor="let action of getActionsForType(step.get('type')?.value)" [value]="action.value">
                      {{ action.label }}
                    </option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label>Description *</label>
                <textarea formControlName="description" class="form-control" rows="2"
                          placeholder="Description de ce que fait cette √©tape"></textarea>
              </div>

              <!-- Param√®tres dynamiques selon l'action -->
              <div class="dynamic-params" *ngIf="step.get('action')?.value">
                
                <!-- Param√®tres pour formatage -->
                <div class="param-group" *ngIf="step.get('type')?.value === 'format'">

                  <!-- Param√®tres sp√©cifiques selon l'action -->
                  <div class="format-params" *ngIf="step.get('action')?.value === 'currency'">
                    <div class="form-row">
                      <div class="form-group">
                        <label>Locale</label>
                        <select formControlName="locale" class="form-control">
                          <option value="fr-FR">Fran√ßais (France)</option>
                          <option value="en-US">Anglais (√âtats-Unis)</option>
                          <option value="en-GB">Anglais (Royaume-Uni)</option>
                          <option value="de-DE">Allemand</option>
                          <option value="es-ES">Espagnol</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Devise</label>
                        <select formControlName="currency" class="form-control">
                          <option value="EUR">EUR (‚Ç¨)</option>
                          <option value="USD">USD ($)</option>
                          <option value="GBP">GBP (¬£)</option>
                          <option value="CHF">CHF (Fr)</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="format-params" *ngIf="step.get('action')?.value === 'normalizeDates'">
                    <div class="form-group">
                      <label>Format de date</label>
                      <select formControlName="dateFormat" class="form-control">
                        <option value="yyyy-MM-dd">yyyy-MM-dd</option>
                        <option value="dd/MM/yyyy">dd/MM/yyyy</option>
                        <option value="MM/dd/yyyy">MM/dd/yyyy</option>
                        <option value="yyyy/MM/dd">yyyy/MM/dd</option>
                      </select>
                    </div>
                  </div>

                  <div class="format-params" *ngIf="step.get('action')?.value === 'removeCharacters'">
                    <div class="form-row">
                      <div class="form-group">
                        <label>Position</label>
                        <select formControlName="position" class="form-control">
                          <option value="start">Depuis le d√©but</option>
                          <option value="end">Depuis la fin</option>
                          <option value="specific">Position sp√©cifique</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Nombre de caract√®res</label>
                        <input type="number" formControlName="count" class="form-control" min="1" value="1">
                      </div>
                      <div class="form-group" *ngIf="step.get('position')?.value === 'specific'">
                        <label>Position sp√©cifique (1-based)</label>
                        <input type="number" formControlName="specificPosition" class="form-control" min="1" value="1">
                      </div>
                    </div>
                  </div>

                  <div class="format-params" *ngIf="step.get('action')?.value === 'removeSpecificCharacters'">
                    <div class="form-row">
                      <div class="form-group">
                        <label>Caract√®res √† supprimer</label>
                        <input type="text" formControlName="characters" class="form-control" 
                               placeholder="Ex: _CM ou abc123">
                      </div>
                      <div class="form-group">
                        <label>
                          <input type="checkbox" formControlName="caseSensitive">
                          Sensible √† la casse
                        </label>
                      </div>
                    </div>
                  </div>

                  <div class="format-params" *ngIf="step.get('action')?.value === 'insertCharacters'">
                    <div class="form-row">
                      <div class="form-group">
                        <label>Caract√®res √† ins√©rer</label>
                        <input type="text" formControlName="characters" class="form-control" 
                               placeholder="Ex: _CM ou 123">
                      </div>
                      <div class="form-group">
                        <label>Position</label>
                        <select formControlName="position" class="form-control">
                          <option value="start">Au d√©but</option>
                          <option value="end">√Ä la fin</option>
                          <option value="specific">Position sp√©cifique</option>
                        </select>
                      </div>
                      <div class="form-group" *ngIf="step.get('position')?.value === 'specific'">
                        <label>Position sp√©cifique (1-based)</label>
                        <input type="number" formControlName="specificPosition" class="form-control" min="1" value="1">
                      </div>
                    </div>
                  </div>

                  <!-- Aide pour les actions de formatage -->
                  <div class="format-help" *ngIf="['trimSpaces', 'toLowerCase', 'toUpperCase', 'removeDashesAndCommas', 'removeSeparators', 'dotToComma', 'normalizeDates', 'normalizeNumbers', 'absoluteValue', 'cleanAmounts'].includes(step.get('action')?.value)">
                    <small class="form-text text-muted">
                      <strong>üí° Aide :</strong>
                      <span *ngIf="step.get('action')?.value === 'trimSpaces'">
                        Supprime les espaces en d√©but et fin de cha√Æne
                      </span>
                      <span *ngIf="step.get('action')?.value === 'toLowerCase'">
                        Convertit tout le texte en minuscules
                      </span>
                      <span *ngIf="step.get('action')?.value === 'toUpperCase'">
                        Convertit tout le texte en majuscules
                      </span>
                      <span *ngIf="step.get('action')?.value === 'removeDashesAndCommas'">
                        Supprime les tirets (-) et les virgules (,)
                      </span>
                      <span *ngIf="step.get('action')?.value === 'removeSeparators'">
                        Supprime les virgules, points et espaces
                      </span>
                      <span *ngIf="step.get('action')?.value === 'dotToComma'">
                        Remplace les points par des virgules
                      </span>
                      <span *ngIf="step.get('action')?.value === 'normalizeDates'">
                        Normalise les dates au format ISO (yyyy-MM-dd)
                      </span>
                      <span *ngIf="step.get('action')?.value === 'normalizeNumbers'">
                        Convertit les cha√Ænes en nombres
                      </span>
                      <span *ngIf="step.get('action')?.value === 'absoluteValue'">
                        Convertit en valeur absolue
                      </span>
                      <span *ngIf="step.get('action')?.value === 'cleanAmounts'">
                        Nettoie les montants (enl√®ve espaces et ,00)
                      </span>
                    </small>
                  </div>
                </div>

                <!-- Param√®tres pour extraction -->
                <div class="param-group" *ngIf="step.get('action')?.value === 'extract'">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Type d'extraction</label>
                      <select formControlName="extractType" class="form-control">
                        <option value="first">Premiers caract√®res</option>
                        <option value="last">Derniers caract√®res</option>
                        <option value="from">√Ä partir de</option>
                        <option value="between">Entre deux caract√®res</option>
                        <option value="key">Apr√®s une cl√©</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Nombre de caract√®res</label>
                      <input type="number" formControlName="extractCount" class="form-control" min="1">
                    </div>
                  </div>
                </div>

                <!-- Param√®tres pour concat√©nation -->
                <div class="param-group" *ngIf="step.get('action')?.value === 'concat'">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Colonnes √† concat√©ner</label>
                      <select formControlName="field" class="form-control" multiple size="4">
                        <option *ngFor="let col of availableColumnsForTemplate" [value]="col">
                          {{ col }}
                        </option>
                      </select>
                      <small class="form-text text-muted">
                        S√©lectionnez les colonnes √† concat√©ner (s√©lection multiple possible)
                      </small>
                    </div>
                    <div class="form-group">
                      <label>Nouvelle colonne</label>
                      <input type="text" formControlName="newColumn" class="form-control" 
                             placeholder="concatenated">
                    </div>
                    <div class="form-group">
                      <label>S√©parateur</label>
                      <input type="text" formControlName="separator" class="form-control" value=" ">
                    </div>
                  </div>
                </div>

                <!-- Param√®tres pour filtrage -->
                <div class="param-group" *ngIf="step.get('action')?.value === 'keepMatching'">
                  <div class="form-group">
                    <label>Pattern regex</label>
                    <input type="text" formControlName="pattern" class="form-control" value=".*">
                  </div>
                </div>

                <!-- Param√®tres pour s√©lection de colonnes -->
                <div class="param-group" *ngIf="['keepColumns', 'removeColumns', 'removeDuplicates'].includes(step.get('action')?.value)">
                  <!-- Le champ "Champ √† traiter" est d√©j√† d√©fini dans la section principale de l'√©tape -->
                </div>

                <!-- Param√®tres pour extraction de donn√©es -->
                <div class="param-group" *ngIf="['extractFirst', 'extractLast', 'extractFrom', 'extractBetween', 'extractAfterKey'].includes(step.get('action')?.value)">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Colonne source *</label>
                      <select formControlName="sourceColumn" class="form-control">
                        <option value="">-- Choisir une colonne --</option>
                        <option *ngFor="let col of availableColumnsForTemplate" [value]="col">
                          {{ col }}
                        </option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Nouvelle colonne</label>
                      <input type="text" formControlName="newColumn" class="form-control" 
                             placeholder="colonne_extraite">
                    </div>
                  </div>
                  
                  <!-- Param√®tres sp√©cifiques selon le type d'extraction -->
                  <div class="form-row" *ngIf="['extractFirst', 'extractLast'].includes(step.get('action')?.value)">
                    <div class="form-group">
                      <label>Nombre de caract√®res</label>
                      <input type="number" formControlName="extractCount" class="form-control" min="1" value="1">
                    </div>
                  </div>
                  
                  <div class="form-row" *ngIf="step.get('action')?.value === 'extractFrom'">
                    <div class="form-group">
                      <label>Position de d√©part</label>
                      <input type="number" formControlName="extractStart" class="form-control" min="1" value="1">
                    </div>
                    <div class="form-group">
                      <label>Nombre de caract√®res</label>
                      <input type="number" formControlName="extractCount" class="form-control" min="1" value="1">
                    </div>
                  </div>
                  
                  <div class="form-row" *ngIf="step.get('action')?.value === 'extractBetween'">
                    <div class="form-group">
                      <label>Caract√®re de d√©but</label>
                      <input type="text" formControlName="startChar" class="form-control" placeholder="(">
                    </div>
                    <div class="form-group">
                      <label>Caract√®re de fin</label>
                      <input type="text" formControlName="endChar" class="form-control" placeholder=")">
                    </div>
                  </div>
                  
                  <div class="form-row" *ngIf="step.get('action')?.value === 'extractAfterKey'">
                    <div class="form-group">
                      <label>Cl√© de recherche</label>
                      <input type="text" formControlName="searchKey" class="form-control" placeholder="ID:">
                    </div>
                    <div class="form-group">
                      <label>Nombre de caract√®res apr√®s la cl√©</label>
                      <input type="number" formControlName="extractCount" class="form-control" min="1" value="1">
                    </div>
                  </div>
                </div>

                <!-- Param√®tres pour filtrage par colonne -->
                <div class="param-group" *ngIf="['filterByColumn', 'filterByMultipleValues'].includes(step.get('action')?.value)">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Colonne de filtrage *</label>
                      <select formControlName="filterColumn" class="form-control">
                        <option value="">-- Choisir une colonne --</option>
                        <option *ngFor="let col of availableColumnsForTemplate" [value]="col">
                          {{ col }}
                        </option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Valeurs √† garder</label>
                      <input type="text" formControlName="filterValues" class="form-control" 
                             placeholder="valeur1,valeur2,valeur3">
                      <small class="form-text text-muted">
                        S√©parez les valeurs par des virgules
                      </small>
                    </div>
                  </div>
                </div>

                <!-- Param√®tres pour filtrage par valeur -->
                <div class="param-group" *ngIf="step.get('action')?.value === 'filterByValue'">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Champ √† filtrer *</label>
                      <select formControlName="field" class="form-control" (change)="onFilterFieldChange(i)">
                        <option value="">-- Choisir un champ --</option>
                        <option *ngFor="let col of availableColumnsForTemplate" [value]="col">
                          {{ col }}
                        </option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Valeurs disponibles</label>
                      <div class="available-values-container">
                        <div class="values-list" *ngIf="getAvailableValuesForField(step.get('field')?.value).length > 0">
                          <div class="value-item" *ngFor="let value of getAvailableValuesForField(step.get('field')?.value)" 
                               (click)="toggleValueSelection(i, value)"
                               [class.selected]="isValueSelected(i, value)">
                            {{ value }}
                          </div>
                        </div>
                        <div class="no-values" *ngIf="getAvailableValuesForField(step.get('field')?.value).length === 0">
                          <small class="text-muted">Aucune valeur disponible pour ce champ</small>
                        </div>
                      </div>
                      <small class="form-text text-muted">
                        Cliquez sur les valeurs pour les s√©lectionner/d√©s√©lectionner
                      </small>
                      <div class="help-info" *ngIf="step.get('field')?.value">
                        <small class="text-info">
                          <strong>üí° Aide :</strong> Colonnes disponibles dans votre fichier : 
                          <span class="available-columns">{{ availableColumnsForTemplate.join(', ') }}</span>
                        </small>
                      </div>
                    </div>
                  </div>
                  <div class="form-row" *ngIf="getSelectedValuesForField(i).length > 0">
                    <div class="form-group">
                      <label>Valeurs s√©lectionn√©es</label>
                      <div class="selected-values">
                        <span class="selected-value" *ngFor="let value of getSelectedValuesForField(i)">
                          {{ value }}
                          <button type="button" class="remove-value" (click)="removeValueSelection(i, value)">√ó</button>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Param√®tres pour export par type -->
                <div class="param-group" *ngIf="['exportByType', 'exportByColumn', 'exportByValue'].includes(step.get('action')?.value)">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Colonne de tri *</label>
                      <select formControlName="exportColumn" class="form-control">
                        <option value="">-- Choisir une colonne --</option>
                        <option *ngFor="let col of availableColumnsForTemplate" [value]="col">
                          {{ col }}
                        </option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Valeurs √† exporter</label>
                      <input type="text" formControlName="exportValues" class="form-control" 
                             placeholder="valeur1,valeur2,valeur3">
                      <small class="form-text text-muted">
                        S√©parez les valeurs par des virgules. Laissez vide pour toutes les valeurs.
                      </small>
                    </div>
                  </div>
                  
                  <div class="form-row">
                    <div class="form-group">
                      <label>Suffixe du fichier</label>
                      <input type="text" formControlName="exportSuffix" class="form-control" 
                             placeholder="_export">
                    </div>
                    <div class="form-group">
                      <label>Description</label>
                      <input type="text" formControlName="exportDescription" class="form-control" 
                             placeholder="Export par type">
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Configuration des cl√©s de r√©conciliation -->
      <div class="reconciliation-keys-section" formGroupName="reconciliationKeys">
        <div class="section-header">
          <h4>Configuration des cl√©s de r√©conciliation</h4>
          <p class="section-description">
            Configuration sp√©cifique selon le type de mod√®le
          </p>
        </div>

        <!-- Configuration pour les mod√®les partenaire -->
        <div class="partner-config" *ngIf="modelForm.get('fileType')?.value === 'partner'">
          <div class="form-row">
            <div class="form-group">
              <label>Cl√©s c√¥t√© partenaire *</label>
              <select formControlName="partnerKeys" class="form-control" multiple size="4">
                <option *ngFor="let col of availableColumnsForTemplate" [value]="col">
                  {{ col }}
                </option>
              </select>
              <small class="form-text text-muted">
                S√©lectionnez les colonnes qui serviront de cl√©s de r√©conciliation c√¥t√© partenaire
              </small>
              
              <!-- Indicateur des cl√©s partenaires s√©lectionn√©es -->
              <div class="selected-keys-indicator" *ngIf="modelForm.get('reconciliationKeys.partnerKeys')?.value?.length > 0">
                <strong>Cl√©s partenaires s√©lectionn√©es :</strong>
                <div class="selected-keys-list">
                  <span class="selected-key" *ngFor="let key of modelForm.get('reconciliationKeys.partnerKeys')?.value">
                    {{ key }}
                  </span>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>Mod√®les BO √† utiliser *</label>
              <select formControlName="boModels" class="form-control" multiple size="4" (change)="onBOModelsChange()" (ngModelChange)="onBOModelsChange()">
                <option *ngFor="let boModel of getAvailableBOModels()" [value]="boModel.id">
                  {{ boModel.name }} ({{ boModel.filePattern }})
                </option>
              </select>
              <small class="form-text text-muted">
                S√©lectionnez les mod√®les BO qui seront utilis√©s pour la r√©conciliation
              </small>
            </div>
          </div>

          <!-- Configuration des cl√©s et traitements pour chaque mod√®le BO s√©lectionn√© -->
          <div class="bo-models-config" *ngIf="getSelectedBOModels().length > 0">
            <h5>Configuration des mod√®les BO</h5>
            <div class="bo-model-config" *ngFor="let boModel of getSelectedBOModels()">
              <div class="bo-model-header">
                <h6>{{ boModel.name }}</h6>
                <small>{{ boModel.filePattern }}</small>
              </div>
              
              <!-- Configuration des cl√©s -->
              <div class="form-row">
                <div class="form-group">
                  <label>Cl√©s de r√©conciliation pour {{ boModel.name }}</label>
                  <select [formControlName]="'boKeys_' + boModel.id" class="form-control" multiple size="3" (change)="onBOKeysChange(boModel.id, $event)">
                    <option *ngFor="let col of getBOModelColumnsForTemplate()[boModel.id]" [value]="col">
                      {{ col }}
                    </option>
                  </select>
                  <small class="form-text text-muted">
                    Cl√©s de r√©conciliation pour ce mod√®le BO
                  </small>
                  
                  <!-- Indicateur des cl√©s s√©lectionn√©es -->
                  <div class="selected-keys-indicator" *ngIf="getSelectedKeysForModel(boModel.id).length > 0">
                    <strong>Cl√©s s√©lectionn√©es :</strong>
                    <div class="selected-keys-list">
                      <span class="selected-key" *ngFor="let key of getSelectedKeysForModel(boModel.id)">
                        {{ key }}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Configuration des traitements BO -->
                <div class="form-group">
                  <label>Traitements pour {{ boModel.name }}</label>
                  <div class="bo-treatments">
                    <div class="treatment-step" *ngFor="let treatmentStep of getBOTreatmentStepsArray(boModel.id); let i = index">
                      <div class="treatment-header">
                        <span>Traitement {{ i + 1 }}</span>
                        <button type="button" class="btn btn-sm btn-danger" (click)="removeBOTreatmentStep(boModel.id, i)">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                      <div class="treatment-content">
                        <div class="form-row">
                          <div class="form-group">
                            <label>Type</label>
                            <select [formControlName]="'type'" class="form-control" (change)="onBOTreatmentTypeChange(boModel.id, i)">
                              <option *ngFor="let stepType of getStepTypesArray()" [value]="stepType.value">
                                {{ stepType.label }}
                              </option>
                            </select>
                          </div>
                          <div class="form-group">
                            <label>Action</label>
                            <select [formControlName]="'action'" class="form-control">
                              <option *ngFor="let action of getBOTreatmentActions(boModel.id, i)" [value]="action.value">
                                {{ action.label }}
                              </option>
                            </select>
                          </div>
                        </div>
                      </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-primary" (click)="addBOTreatmentStep(boModel.id)">
                      <i class="fas fa-plus"></i> Ajouter un traitement
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>


        </div>

                 <!-- Configuration pour les mod√®les BO et "both" -->
         <div class="other-config" *ngIf="modelForm.get('fileType')?.value !== 'partner'">
           <div class="info-message">
             <p><i class="fas fa-info-circle"></i> La configuration des cl√©s de r√©conciliation se fait uniquement sur les mod√®les "Partenaire".</p>
             <p>Pour les mod√®les BO et "Les deux", les cl√©s seront d√©termin√©es automatiquement lors de la r√©conciliation.</p>
           </div>
         </div>
      </div>

      <div class="form-actions">
        <button type="submit" [disabled]="!modelForm.valid || loading" class="btn btn-primary">
          <i class="fas fa-save"></i> {{ editingModel ? 'Mettre √† jour' : 'Cr√©er' }}
        </button>
        <button type="button" (click)="closeForm()" class="btn btn-secondary">
          Annuler
        </button>
      </div>
    </form>
  </div>

  <!-- Modal de s√©lection de fichiers -->
  <div class="modal-overlay" *ngIf="showFileSelector" (click)="closeFileSelector()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>S√©lectionner un fichier mod√®le</h3>
        <button (click)="closeFileSelector()" class="btn btn-sm btn-secondary">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <!-- Barre de recherche -->
        <div *ngIf="!loading && availableFiles.length > 0" class="search-section">
          <div class="search-input-container">
            <i class="fas fa-search search-icon"></i>
            <input 
              type="text" 
              [(ngModel)]="fileSearchTerm" 
              (ngModelChange)="onFileSearchChange()"
              placeholder="Rechercher un fichier par nom, type ou colonnes..."
              class="search-input"
            >
            <button 
              *ngIf="fileSearchTerm" 
              (click)="clearFileSearch()" 
              class="clear-search-btn"
              title="Effacer la recherche">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="search-stats" *ngIf="fileSearchTerm">
            <span>{{ filteredFiles.length }} fichier(s) trouv√©(s) sur {{ availableFiles.length }}</span>
          </div>
        </div>

        <div *ngIf="loading" class="loading">
          <i class="fas fa-spinner fa-spin"></i> Chargement des fichiers...
        </div>

        <div *ngIf="!loading && availableFiles.length === 0" class="no-files">
          <p>Aucun fichier disponible dans le dossier watch-folder.</p>
          <p>Placez des fichiers CSV, Excel ou JSON dans le dossier pour les voir ici.</p>
        </div>

        <div *ngIf="!loading && availableFiles.length > 0 && filteredFiles.length === 0 && fileSearchTerm" class="no-results">
          <i class="fas fa-search"></i>
          <p>Aucun fichier ne correspond √† votre recherche : "{{ fileSearchTerm }}"</p>
          <button (click)="clearFileSearch()" class="btn btn-secondary">
            <i class="fas fa-times"></i> Effacer la recherche
          </button>
        </div>

        <div *ngIf="!loading && availableFiles.length > 0 && filteredFiles.length > 0" class="files-list">
          <div class="file-item" *ngFor="let file of filteredFiles" (click)="selectFileModel(file)">
            <div class="file-info">
              <i class="fas fa-file" [class.fa-file-csv]="file.fileType === 'csv'"
                 [class.fa-file-excel]="file.fileType === 'excel'"
                 [class.fa-file-code]="file.fileType === 'json'"></i>
              <div class="file-details">
                <h4>{{ file.fileName }}</h4>
                <p>{{ file.fileType.toUpperCase() }} ‚Ä¢ {{ file.recordCount }} enregistrements</p>
                <p *ngIf="file.columns.length > 0">
                  <strong>Colonnes:</strong> {{ file.columns.join(', ') }}
                </p>
              </div>
            </div>
            <button class="btn btn-sm btn-primary">
              <i class="fas fa-check"></i> S√©lectionner
            </button>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button (click)="closeFileSelector()" class="btn btn-secondary">
          Annuler
        </button>
      </div>
    </div>
  </div>
</div> 