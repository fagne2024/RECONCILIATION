<div class="auto-processing-models-container">
  <div class="header">
    <h2>Mod√®les de Traitement Automatique</h2>
    <p>Cr√©ez et g√©rez des mod√®les de traitement automatique pour vos fichiers</p>
    <div class="header-actions">
      <button (click)="cleanupModels()" class="btn btn-warning">
        <i class="fas fa-broom"></i> Nettoyer mod√®les vides
      </button>
      <button (click)="createDefaultBOModel()" class="btn btn-secondary">
        <i class="fas fa-magic"></i> Cr√©er mod√®le BO TRXBO
      </button>
      <button class="btn btn-success me-2" (click)="fixReconciliationKeys()">
        <i class="fas fa-wrench"></i> Corriger cl√©s r√©conciliation
      </button>
    </div>
  </div>

  <!-- Messages d'erreur -->
  <div *ngIf="errorMessage" class="error-message">
    <span>{{ errorMessage }}</span>
    <button (click)="clearError()" class="close-btn">√ó</button>
  </div>

  <!-- Liste des mod√®les existants -->
  <div class="models-section">
    <div class="section-header">
      <h3>Mod√®les existants</h3>
      <button (click)="createModel()" class="btn btn-primary">
        <i class="fas fa-plus"></i> Nouveau mod√®le
      </button>
    </div>

    <div class="models-grid" *ngIf="models.length > 0; else noModels">
      <div class="model-card" *ngFor="let model of models">
        <div class="model-header">
          <h4>{{ model.name }}</h4>
          <div class="model-actions">
            <button (click)="editModel(model)" class="btn btn-sm btn-edit" title="Modifier">
              <i class="fas fa-edit"></i>
            </button>
            <button (click)="deleteModel(model.id)" class="btn btn-sm btn-delete" title="Supprimer">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        
        <div class="model-info">
          <p><strong>Pattern:</strong> {{ model.filePattern }}</p>
          <p><strong>Type:</strong> {{ model.fileType }}</p>
          <p><strong>√âtapes:</strong> {{ getStepCount(model) }}</p>
          <p><strong>Auto-appliqu√©:</strong> {{ model.autoApply ? 'Oui' : 'Non' }}</p>
          <p *ngIf="model.templateFile"><strong>Fichier mod√®le:</strong> {{ model.templateFile }}</p>
        </div>

        <div class="model-steps" *ngIf="model.processingSteps.length > 0">
          <h5>√âtapes de traitement:</h5>
          <ul>
            <li *ngFor="let step of model.processingSteps">{{ step.name }}</li>
          </ul>
        </div>
      </div>
    </div>

    <ng-template #noModels>
      <div class="no-models">
        <p>Aucun mod√®le de traitement automatique cr√©√©.</p>
        <button (click)="createModel()" class="btn btn-primary">
          <i class="fas fa-plus"></i> Cr√©er le premier mod√®le
        </button>
      </div>
    </ng-template>
  </div>

  <!-- Formulaire de cr√©ation/√©dition -->
  <div class="form-section" *ngIf="showCreateForm">
    <div class="form-header">
      <h3>{{ editingModel ? 'Modifier le mod√®le' : 'Cr√©er un nouveau mod√®le' }}</h3>
      <button (click)="closeForm()" class="btn btn-secondary">
        <i class="fas fa-times"></i> Fermer
      </button>
    </div>

    <form [formGroup]="modelForm" (ngSubmit)="saveModel()" class="model-form">
      <div class="form-row">
        <div class="form-group">
          <label for="name">Nom du mod√®le *</label>
          <input type="text" id="name" formControlName="name" class="form-control" 
                 placeholder="Ex: Traitement BO Standard">
        </div>

        <div class="form-group">
          <label for="fileType">Type de fichier *</label>
          <select id="fileType" formControlName="fileType" class="form-control">
            <option value="bo">Back Office</option>
            <option value="partner">Partenaire</option>
            <option value="both">Les deux</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="filePattern">Pattern de fichier *</label>
          <input type="text" id="filePattern" formControlName="filePattern" class="form-control" 
                 placeholder="Ex: *bo*.csv">
        </div>

        <div class="form-group">
          <label for="templateFile">Fichier mod√®le</label>
          <div class="template-file-section">
            <input type="text" id="templateFile" formControlName="templateFile" class="form-control" 
                   placeholder="S√©lectionner un fichier mod√®le" readonly>
            <button type="button" (click)="openFileSelector()" class="btn btn-secondary">
              <i class="fas fa-folder-open"></i> Choisir
            </button>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" formControlName="autoApply">
          Appliquer automatiquement lors de l'upload
        </label>
      </div>

      <!-- √âtapes de traitement -->
      <div class="processing-steps-section">
        <div class="steps-header">
          <h4>√âtapes de traitement</h4>
          <button type="button" (click)="addProcessingStep()" class="btn btn-success">
            <i class="fas fa-plus"></i> Ajouter une √©tape
          </button>
        </div>

        <div class="steps-list" formArrayName="processingSteps">
          <div class="step-item" *ngFor="let step of processingStepsFormArray.controls; let i = index" 
               [formGroupName]="i">
            
            <div class="step-header">
              <h5>√âtape {{ i + 1 }}</h5>
              <button type="button" (click)="removeProcessingStep(i)" class="btn btn-sm btn-delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>

            <div class="step-form">
              <div class="form-row">
                <div class="form-group">
                  <label>Nom de l'√©tape *</label>
                  <input type="text" formControlName="name" class="form-control" 
                         placeholder="Ex: Formatage des montants">
                </div>

                <div class="form-group">
                  <label>Type d'√©tape *</label>
                  <select formControlName="type" (change)="onStepTypeChange(i)" class="form-control">
                    <option *ngFor="let type of stepTypes" [value]="type.value">
                      {{ type.label }}
                    </option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Champ √† traiter *</label>
                  <select formControlName="field" class="form-control" multiple size="4">
                    <option *ngFor="let col of availableColumnsForTemplate" [value]="col">
                      {{ col }}
                    </option>
                  </select>
                  <small class="form-text text-muted">Maintenez Ctrl (ou Cmd sur Mac) pour s√©lectionner plusieurs champs</small>
                </div>

                <div class="form-group">
                  <label>Action *</label>
                  <select formControlName="action" class="form-control">
                    <option *ngFor="let action of getActionsForType(step.get('type')?.value)" [value]="action.value">
                      {{ action.label }}
                    </option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label>Description *</label>
                <textarea formControlName="description" class="form-control" rows="2"
                          placeholder="Description de ce que fait cette √©tape"></textarea>
              </div>

              <!-- Param√®tres dynamiques selon l'action -->
              <div class="dynamic-params" *ngIf="step.get('action')?.value">
                
                <!-- Param√®tres pour formatage -->
                <div class="param-group" *ngIf="step.get('type')?.value === 'format'">
                  <div class="form-group">
                    <label>Champ √† traiter *</label>
                    <select formControlName="field" class="form-control" multiple size="4">
                      <option *ngFor="let col of availableColumnsForTemplate" [value]="col">
                        {{ col }}
                      </option>
                    </select>
                    <small class="form-text text-muted">
                      S√©lectionnez les colonnes √† formater (s√©lection multiple possible)
                    </small>
                  </div>

                  <!-- Param√®tres sp√©cifiques selon l'action -->
                  <div class="format-params" *ngIf="step.get('action')?.value === 'currency'">
                    <div class="form-row">
                      <div class="form-group">
                        <label>Locale</label>
                        <select formControlName="locale" class="form-control">
                          <option value="fr-FR">Fran√ßais (France)</option>
                          <option value="en-US">Anglais (√âtats-Unis)</option>
                          <option value="en-GB">Anglais (Royaume-Uni)</option>
                          <option value="de-DE">Allemand</option>
                          <option value="es-ES">Espagnol</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Devise</label>
                        <select formControlName="currency" class="form-control">
                          <option value="EUR">EUR (‚Ç¨)</option>
                          <option value="USD">USD ($)</option>
                          <option value="GBP">GBP (¬£)</option>
                          <option value="CHF">CHF (Fr)</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="format-params" *ngIf="step.get('action')?.value === 'normalizeDates'">
                    <div class="form-group">
                      <label>Format de date</label>
                      <select formControlName="dateFormat" class="form-control">
                        <option value="yyyy-MM-dd">yyyy-MM-dd</option>
                        <option value="dd/MM/yyyy">dd/MM/yyyy</option>
                        <option value="MM/dd/yyyy">MM/dd/yyyy</option>
                        <option value="yyyy/MM/dd">yyyy/MM/dd</option>
                      </select>
                    </div>
                  </div>

                  <div class="format-params" *ngIf="step.get('action')?.value === 'removeCharacters'">
                    <div class="form-row">
                      <div class="form-group">
                        <label>Position</label>
                        <select formControlName="position" class="form-control">
                          <option value="start">Depuis le d√©but</option>
                          <option value="end">Depuis la fin</option>
                          <option value="specific">Position sp√©cifique</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Nombre de caract√®res</label>
                        <input type="number" formControlName="count" class="form-control" min="1" value="1">
                      </div>
                      <div class="form-group" *ngIf="step.get('position')?.value === 'specific'">
                        <label>Position sp√©cifique (1-based)</label>
                        <input type="number" formControlName="specificPosition" class="form-control" min="1" value="1">
                      </div>
                    </div>
                  </div>

                  <div class="format-params" *ngIf="step.get('action')?.value === 'removeSpecificCharacters'">
                    <div class="form-row">
                      <div class="form-group">
                        <label>Caract√®res √† supprimer</label>
                        <input type="text" formControlName="characters" class="form-control" 
                               placeholder="Ex: _CM ou abc123">
                      </div>
                      <div class="form-group">
                        <label>
                          <input type="checkbox" formControlName="caseSensitive">
                          Sensible √† la casse
                        </label>
                      </div>
                    </div>
                  </div>

                  <div class="format-params" *ngIf="step.get('action')?.value === 'insertCharacters'">
                    <div class="form-row">
                      <div class="form-group">
                        <label>Caract√®res √† ins√©rer</label>
                        <input type="text" formControlName="characters" class="form-control" 
                               placeholder="Ex: _CM ou 123">
                      </div>
                      <div class="form-group">
                        <label>Position</label>
                        <select formControlName="position" class="form-control">
                          <option value="start">Au d√©but</option>
                          <option value="end">√Ä la fin</option>
                          <option value="specific">Position sp√©cifique</option>
                        </select>
                      </div>
                      <div class="form-group" *ngIf="step.get('position')?.value === 'specific'">
                        <label>Position sp√©cifique (1-based)</label>
                        <input type="number" formControlName="specificPosition" class="form-control" min="1" value="1">
                      </div>
                    </div>
                  </div>

                  <!-- Aide pour les actions de formatage -->
                  <div class="format-help" *ngIf="['trimSpaces', 'toLowerCase', 'toUpperCase', 'removeDashesAndCommas', 'removeSeparators', 'dotToComma', 'normalizeDates', 'normalizeNumbers', 'absoluteValue', 'cleanAmounts'].includes(step.get('action')?.value)">
                    <small class="form-text text-muted">
                      <strong>üí° Aide :</strong>
                      <span *ngIf="step.get('action')?.value === 'trimSpaces'">
                        Supprime les espaces en d√©but et fin de cha√Æne
                      </span>
                      <span *ngIf="step.get('action')?.value === 'toLowerCase'">
                        Convertit tout le texte en minuscules
                      </span>
                      <span *ngIf="step.get('action')?.value === 'toUpperCase'">
                        Convertit tout le texte en majuscules
                      </span>
                      <span *ngIf="step.get('action')?.value === 'removeDashesAndCommas'">
                        Supprime les tirets (-) et les virgules (,)
                      </span>
                      <span *ngIf="step.get('action')?.value === 'removeSeparators'">
                        Supprime les virgules, points et espaces
                      </span>
                      <span *ngIf="step.get('action')?.value === 'dotToComma'">
                        Remplace les points par des virgules
                      </span>
                      <span *ngIf="step.get('action')?.value === 'normalizeDates'">
                        Normalise les dates au format ISO (yyyy-MM-dd)
                      </span>
                      <span *ngIf="step.get('action')?.value === 'normalizeNumbers'">
                        Convertit les cha√Ænes en nombres
                      </span>
                      <span *ngIf="step.get('action')?.value === 'absoluteValue'">
                        Convertit en valeur absolue
                      </span>
                      <span *ngIf="step.get('action')?.value === 'cleanAmounts'">
                        Nettoie les montants (enl√®ve espaces et ,00)
                      </span>
                    </small>
                  </div>
                </div>

                <!-- Param√®tres pour extraction -->
                <div class="param-group" *ngIf="step.get('action')?.value === 'extract'">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Type d'extraction</label>
                      <select formControlName="extractType" class="form-control">
                        <option value="first">Premiers caract√®res</option>
                        <option value="last">Derniers caract√®res</option>
                        <option value="from">√Ä partir de</option>
                        <option value="between">Entre deux caract√®res</option>
                        <option value="key">Apr√®s une cl√©</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Nombre de caract√®res</label>
                      <input type="number" formControlName="extractCount" class="form-control" min="1">
                    </div>
                  </div>
                </div>

                <!-- Param√®tres pour concat√©nation -->
                <div class="param-group" *ngIf="step.get('action')?.value === 'concat'">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Colonnes √† concat√©ner</label>
                      <select formControlName="field" class="form-control" multiple size="4">
                        <option *ngFor="let col of availableColumnsForTemplate" [value]="col">
                          {{ col }}
                        </option>
                      </select>
                      <small class="form-text text-muted">
                        S√©lectionnez les colonnes √† concat√©ner (s√©lection multiple possible)
                      </small>
                    </div>
                    <div class="form-group">
                      <label>Nouvelle colonne</label>
                      <input type="text" formControlName="newColumn" class="form-control" 
                             placeholder="concatenated">
                    </div>
                    <div class="form-group">
                      <label>S√©parateur</label>
                      <input type="text" formControlName="separator" class="form-control" value=" ">
                    </div>
                  </div>
                </div>

                <!-- Param√®tres pour filtrage -->
                <div class="param-group" *ngIf="step.get('action')?.value === 'keepMatching'">
                  <div class="form-group">
                    <label>Pattern regex</label>
                    <input type="text" formControlName="pattern" class="form-control" value=".*">
                  </div>
                </div>

                <!-- Param√®tres pour s√©lection de colonnes -->
                <div class="param-group" *ngIf="['keepColumns', 'removeColumns', 'removeDuplicates'].includes(step.get('action')?.value)">
                  <div class="form-group">
                    <label>Champ √† traiter *</label>
                    <select formControlName="field" class="form-control" multiple size="4">
                      <option *ngFor="let col of availableColumnsForTemplate" [value]="col">
                        {{ col }}
                      </option>
                    </select>
                    <small class="form-text text-muted">
                      S√©lectionnez les colonnes √† traiter (s√©lection multiple possible)
                    </small>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Configuration des cl√©s de r√©conciliation -->
      <div class="reconciliation-keys-section" formGroupName="reconciliationKeys">
        <div class="section-header">
          <h4>Configuration des cl√©s de r√©conciliation</h4>
          <p class="section-description">
            Configuration sp√©cifique selon le type de mod√®le
          </p>
        </div>

        <!-- Configuration pour les mod√®les partenaire -->
        <div class="partner-config" *ngIf="modelForm.get('fileType')?.value === 'partner'">
          <div class="form-row">
            <div class="form-group">
              <label>Cl√©s c√¥t√© partenaire *</label>
              <select formControlName="partnerKeys" class="form-control" multiple size="4">
                <option *ngFor="let col of availableColumnsForTemplate" [value]="col">
                  {{ col }}
                </option>
              </select>
              <small class="form-text text-muted">
                S√©lectionnez les colonnes qui serviront de cl√©s de r√©conciliation c√¥t√© partenaire
              </small>
            </div>

            <div class="form-group">
              <label>Mod√®les BO √† utiliser *</label>
              <select formControlName="boModels" class="form-control" multiple size="4" (change)="onBOModelsChange()" (ngModelChange)="onBOModelsChange()">
                <option *ngFor="let boModel of getAvailableBOModels()" [value]="boModel.id">
                  {{ boModel.name }} ({{ boModel.filePattern }})
                </option>
              </select>
              <small class="form-text text-muted">
                S√©lectionnez les mod√®les BO qui seront utilis√©s pour la r√©conciliation
              </small>
            </div>
          </div>

          <!-- Configuration des cl√©s et traitements pour chaque mod√®le BO s√©lectionn√© -->
          <div class="bo-models-config" *ngIf="getSelectedBOModels().length > 0">
            <h5>Configuration des mod√®les BO</h5>
            <div class="bo-model-config" *ngFor="let boModel of getSelectedBOModels()">
              <div class="bo-model-header">
                <h6>{{ boModel.name }}</h6>
                <small>{{ boModel.filePattern }}</small>
              </div>
              
              <!-- Configuration des cl√©s -->
              <div class="form-row">
                <div class="form-group">
                  <label>Cl√©s de r√©conciliation pour {{ boModel.name }}</label>
                  <select [formControlName]="'boKeys_' + boModel.id" class="form-control" multiple size="3" (change)="onBOKeysChange(boModel.id, $event)">
                    <option *ngFor="let col of getBOModelColumnsForTemplate()[boModel.id]" [value]="col">
                      {{ col }}
                    </option>
                  </select>
                  <small class="form-text text-muted">
                    Cl√©s de r√©conciliation pour ce mod√®le BO
                  </small>
                </div>
              </div>

              <!-- Configuration des traitements BO -->
              <div class="bo-treatments-section">
                <h6>Traitements √† appliquer sur {{ boModel.name }}</h6>
                <div class="treatments-container">
                  <div class="treatment-steps" [formGroupName]="'boTreatments_' + boModel.id">
                    <div class="treatment-step" *ngFor="let step of getBOTreatmentStepsArray(boModel.id); let i = index" [formGroupName]="i">
                      <div class="step-header">
                        <h6>√âtape {{ i + 1 }}</h6>
                        <button type="button" class="btn btn-sm btn-danger" (click)="removeBOTreatmentStep(boModel.id, i)">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                      
                      <div class="form-row">
                        <div class="form-group">
                          <label>Type de traitement</label>
                          <select formControlName="type" class="form-control" (change)="onBOTreatmentTypeChange(boModel.id, i)">
                            <option value="">-- Choisir un type --</option>
                            <option *ngFor="let stepType of getStepTypesArray()" [value]="stepType.value">
                              {{ stepType.label }}
                            </option>
                          </select>
                        </div>
                        
                        <div class="form-group" *ngIf="getBOTreatmentType(boModel.id, i)">
                          <label>Action</label>
                          <select formControlName="action" class="form-control">
                            <option value="">-- Choisir une action --</option>
                            <option *ngFor="let action of getBOTreatmentActions(boModel.id, i)" [value]="action.value">
                              {{ action.label }}
                            </option>
                          </select>
                        </div>
                      </div>

                      <div class="form-row" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('action')?.value">
                        <div class="form-group">
                          <label>Champ(s) √† traiter</label>
                          <select formControlName="field" class="form-control" multiple size="3">
                            <option *ngFor="let col of getBOModelColumnsForTemplate()[boModel.id]" [value]="col">
                              {{ col }}
                            </option>
                          </select>
                          <small class="form-text text-muted">
                            S√©lectionnez les colonnes √† traiter
                          </small>
                        </div>
                      </div>

                      <!-- Param√®tres sp√©cifiques selon l'action -->
                      <div class="treatment-params" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('action')?.value">
                        <!-- Param√®tres pour formatage -->
                        <div class="format-params" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('action')?.value === 'currency'">
                          <div class="form-row">
                            <div class="form-group">
                              <label>Locale</label>
                              <select formControlName="locale" class="form-control">
                                <option value="fr-FR">Fran√ßais (France)</option>
                                <option value="en-US">Anglais (√âtats-Unis)</option>
                                <option value="en-GB">Anglais (Royaume-Uni)</option>
                                <option value="de-DE">Allemand</option>
                                <option value="es-ES">Espagnol</option>
                              </select>
                            </div>
                            <div class="form-group">
                              <label>Devise</label>
                              <select formControlName="currency" class="form-control">
                                <option value="EUR">EUR (‚Ç¨)</option>
                                <option value="USD">USD ($)</option>
                                <option value="GBP">GBP (¬£)</option>
                                <option value="CHF">CHF (Fr)</option>
                              </select>
                            </div>
                          </div>
                        </div>

                        <div class="format-params" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('action')?.value === 'normalizeDates'">
                          <div class="form-group">
                            <label>Format de date</label>
                            <select formControlName="dateFormat" class="form-control">
                              <option value="yyyy-MM-dd">yyyy-MM-dd</option>
                              <option value="dd/MM/yyyy">dd/MM/yyyy</option>
                              <option value="MM/dd/yyyy">MM/dd/yyyy</option>
                              <option value="yyyy/MM/dd">yyyy/MM/dd</option>
                            </select>
                          </div>
                        </div>

                        <div class="format-params" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('action')?.value === 'removeCharacters'">
                          <div class="form-row">
                            <div class="form-group">
                              <label>Position</label>
                              <select formControlName="position" class="form-control">
                                <option value="start">Depuis le d√©but</option>
                                <option value="end">Depuis la fin</option>
                                <option value="specific">Position sp√©cifique</option>
                              </select>
                            </div>
                            <div class="form-group">
                              <label>Nombre de caract√®res</label>
                              <input type="number" formControlName="count" class="form-control" min="1" value="1">
                            </div>
                            <div class="form-group" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('position')?.value === 'specific'">
                              <label>Position sp√©cifique (1-based)</label>
                              <input type="number" formControlName="specificPosition" class="form-control" min="1" value="1">
                            </div>
                          </div>
                        </div>

                        <div class="format-params" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('action')?.value === 'removeSpecificCharacters'">
                          <div class="form-row">
                            <div class="form-group">
                              <label>Caract√®res √† supprimer</label>
                              <input type="text" formControlName="characters" class="form-control" 
                                     placeholder="Ex: _CM ou abc123">
                            </div>
                            <div class="form-group">
                              <label>
                                <input type="checkbox" formControlName="caseSensitive">
                                Sensible √† la casse
                              </label>
                            </div>
                          </div>
                        </div>

                        <div class="format-params" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('action')?.value === 'insertCharacters'">
                          <div class="form-row">
                            <div class="form-group">
                              <label>Caract√®res √† ins√©rer</label>
                              <input type="text" formControlName="characters" class="form-control" 
                                     placeholder="Ex: _CM ou 123">
                            </div>
                            <div class="form-group">
                              <label>Position</label>
                              <select formControlName="position" class="form-control">
                                <option value="start">Au d√©but</option>
                                <option value="end">√Ä la fin</option>
                                <option value="specific">Position sp√©cifique</option>
                              </select>
                            </div>
                            <div class="form-group" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('position')?.value === 'specific'">
                              <label>Position sp√©cifique (1-based)</label>
                              <input type="number" formControlName="specificPosition" class="form-control" min="1" value="1">
                            </div>
                          </div>
                        </div>

                        <!-- Param√®tres pour concat√©nation -->
                        <div class="concat-params" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('action')?.value === 'concat'">
                          <div class="form-row">
                            <div class="form-group">
                              <label>Nouvelle colonne</label>
                              <input type="text" formControlName="newColumn" class="form-control" 
                                     placeholder="Nom de la nouvelle colonne">
                            </div>
                            <div class="form-group">
                              <label>S√©parateur</label>
                              <input type="text" formControlName="separator" class="form-control" 
                                     placeholder="Ex: - ou _ ou espace" value=" ">
                            </div>
                          </div>
                        </div>

                        <!-- Param√®tres pour filtrage -->
                        <div class="filter-params" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('action')?.value === 'keepMatching'">
                          <div class="form-group">
                            <label>Pattern (regex)</label>
                            <input type="text" formControlName="pattern" class="form-control" 
                                   placeholder="Ex: ^[A-Z]{2}[0-9]{6}$">
                          </div>
                        </div>

                        <div class="filter-params" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('action')?.value === 'filterByValue'">
                          <div class="form-group">
                            <label>Valeurs (s√©par√©es par des virgules)</label>
                            <input type="text" formControlName="values" class="form-control" 
                                   placeholder="Ex: valeur1,valeur2,valeur3">
                          </div>
                        </div>

                        <div class="filter-params" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('action')?.value === 'filterByExactValue'">
                          <div class="form-group">
                            <label>Valeur exacte</label>
                            <input type="text" formControlName="value" class="form-control" 
                                   placeholder="Valeur exacte √† filtrer">
                          </div>
                        </div>

                        <!-- Param√®tres pour validation -->
                        <div class="validation-params" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('action')?.value === 'dateFormat'">
                          <div class="form-group">
                            <label>Format de date</label>
                            <select formControlName="validationDateFormat" class="form-control">
                              <option value="yyyy-MM-dd">yyyy-MM-dd</option>
                              <option value="dd/MM/yyyy">dd/MM/yyyy</option>
                              <option value="MM/dd/yyyy">MM/dd/yyyy</option>
                              <option value="yyyy/MM/dd">yyyy/MM/dd</option>
                            </select>
                          </div>
                        </div>

                        <!-- Param√®tres pour transformation -->
                        <div class="transform-params" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('action')?.value === 'extract'">
                          <div class="form-row">
                            <div class="form-group">
                              <label>Type d'extraction</label>
                              <select formControlName="extractType" class="form-control">
                                <option value="first">Premiers caract√®res</option>
                                <option value="last">Derniers caract√®res</option>
                                <option value="from">Depuis une position</option>
                                <option value="between">Entre deux caract√®res</option>
                                <option value="key">Apr√®s une cl√©</option>
                              </select>
                            </div>
                            <div class="form-group">
                              <label>Nombre de caract√®res</label>
                              <input type="number" formControlName="extractCount" class="form-control" min="1" value="5">
                            </div>
                          </div>
                          <div class="form-row" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('extractType')?.value === 'from'">
                            <div class="form-group">
                              <label>Position de d√©part</label>
                              <input type="number" formControlName="extractStart" class="form-control" min="1" value="1">
                            </div>
                          </div>
                          <div class="form-row" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('extractType')?.value === 'key'">
                            <div class="form-group">
                              <label>Cl√© de recherche</label>
                              <input type="text" formControlName="extractKey" class="form-control" 
                                     placeholder="Cl√© √† rechercher">
                            </div>
                          </div>
                          <div class="form-row" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('extractType')?.value === 'between'">
                            <div class="form-group">
                              <label>Caract√®re de d√©but</label>
                              <input type="text" formControlName="startChar" class="form-control" 
                                     placeholder="Caract√®re de d√©but">
                            </div>
                            <div class="form-group">
                              <label>Caract√®re de fin</label>
                              <input type="text" formControlName="endChar" class="form-control" 
                                     placeholder="Caract√®re de fin">
                            </div>
                          </div>
                        </div>

                        <!-- Param√®tres pour calcul -->
                        <div class="calculate-params" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('action')?.value === 'sum'">
                          <div class="form-group">
                            <label>Champs √† additionner (s√©par√©s par des virgules)</label>
                            <input type="text" formControlName="fields" class="form-control" 
                                   placeholder="Ex: montant1,montant2,montant3">
                          </div>
                        </div>

                        <div class="calculate-params" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('action')?.value === 'average'">
                          <div class="form-group">
                            <label>Champ pour la moyenne</label>
                            <input type="text" formControlName="field" class="form-control" 
                                   placeholder="Nom du champ">
                          </div>
                        </div>

                        <div class="calculate-params" *ngIf="getBOTreatmentStep(boModel.id, i)?.get('action')?.value === 'count'">
                          <div class="form-group">
                            <label>Champ √† compter</label>
                            <input type="text" formControlName="field" class="form-control" 
                                   placeholder="Nom du champ">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <button type="button" class="btn btn-sm btn-success" (click)="addBOTreatmentStep(boModel.id)">
                    <i class="fas fa-plus"></i> Ajouter un traitement
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

                 <!-- Configuration pour les mod√®les BO et "both" -->
         <div class="other-config" *ngIf="modelForm.get('fileType')?.value !== 'partner'">
           <div class="info-message">
             <p><i class="fas fa-info-circle"></i> La configuration des cl√©s de r√©conciliation se fait uniquement sur les mod√®les "Partenaire".</p>
             <p>Pour les mod√®les BO et "Les deux", les cl√©s seront d√©termin√©es automatiquement lors de la r√©conciliation.</p>
           </div>
         </div>
      </div>

      <div class="form-actions">
        <button type="submit" [disabled]="!modelForm.valid || loading" class="btn btn-primary">
          <i class="fas fa-save"></i> {{ editingModel ? 'Mettre √† jour' : 'Cr√©er' }}
        </button>
        <button type="button" (click)="closeForm()" class="btn btn-secondary">
          Annuler
        </button>
      </div>
    </form>
  </div>

  <!-- Modal de s√©lection de fichiers -->
  <div class="modal-overlay" *ngIf="showFileSelector" (click)="closeFileSelector()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>S√©lectionner un fichier mod√®le</h3>
        <button (click)="closeFileSelector()" class="btn btn-sm btn-secondary">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div *ngIf="loading" class="loading">
          <i class="fas fa-spinner fa-spin"></i> Chargement des fichiers...
        </div>

        <div *ngIf="!loading && availableFiles.length === 0" class="no-files">
          <p>Aucun fichier disponible dans le dossier watch-folder.</p>
          <p>Placez des fichiers CSV, Excel ou JSON dans le dossier pour les voir ici.</p>
        </div>

        <div *ngIf="!loading && availableFiles.length > 0" class="files-list">
          <div class="file-item" *ngFor="let file of availableFiles" (click)="selectFileModel(file)">
            <div class="file-info">
              <i class="fas fa-file" [class.fa-file-csv]="file.fileType === 'csv'"
                 [class.fa-file-excel]="file.fileType === 'excel'"
                 [class.fa-file-code]="file.fileType === 'json'"></i>
              <div class="file-details">
                <h4>{{ file.fileName }}</h4>
                <p>{{ file.fileType.toUpperCase() }} ‚Ä¢ {{ file.recordCount }} enregistrements</p>
                <p *ngIf="file.columns.length > 0">
                  <strong>Colonnes:</strong> {{ file.columns.join(', ') }}
                </p>
              </div>
            </div>
            <button class="btn btn-sm btn-primary">
              <i class="fas fa-check"></i> S√©lectionner
            </button>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button (click)="closeFileSelector()" class="btn btn-secondary">
          Annuler
        </button>
      </div>
    </div>
  </div>
</div> 