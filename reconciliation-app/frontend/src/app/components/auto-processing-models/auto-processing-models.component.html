<div class="auto-processing-models-container">
  <div class="header">
    <h2>Mod√®les de traitement automatique</h2>
    <button class="btn btn-primary" (click)="resetForm()">
          <i class="fas fa-plus"></i> Nouveau mod√®le
        </button>
    </div>

  <!-- Messages d'erreur et de succ√®s -->
  <div class="alert alert-danger" *ngIf="errorMessage">
    {{ errorMessage }}
        </div>
  <div class="alert alert-success" *ngIf="successMessage">
    {{ successMessage }}
    </div>

  <!-- Debug temporaire -->
  <div class="alert alert-info" style="margin-bottom: 10px;">
    <strong>Debug:</strong> showCreateForm = {{ showCreateForm }}, editingModel = {{ editingModel ? 'true' : 'false' }}, 
    Condition = {{ (editingModel || showCreateForm) ? 'true' : 'false' }}
  </div>

  <!-- Formulaire de cr√©ation/√©dition pour mod√®les autonomes -->
  <div class="form-section" *ngIf="editingModel || showCreateForm">
    <h3>{{ editingModel ? 'Modifier le mod√®le autonome' : 'Cr√©er un nouveau mod√®le autonome' }}</h3>
    <p class="form-description">
      <i class="fas fa-robot"></i> 
      Configurez un mod√®le autonome qui g√©rera automatiquement la r√©conciliation sans code dur.
    </p>

    <form [formGroup]="modelForm" (ngSubmit)="saveModel()">
      
      <!-- Section 1: Configuration de base -->
      <div class="config-section">
        <h4><i class="fas fa-cog"></i> Configuration de base</h4>
        
      <div class="form-row">
        <div class="form-group">
          <label for="name">Nom du mod√®le *</label>
            <input type="text" id="name" formControlName="name" class="form-control" 
                   placeholder="Ex: TRXBO-OPPART Autonome">
            <small class="form-text text-muted">Donnez un nom descriptif √† votre mod√®le</small>
        </div>

        <div class="form-group">
          <label for="filePattern">Pattern de fichier *</label>
          <input type="text" id="filePattern" formControlName="filePattern" class="form-control" 
                 [class.is-invalid]="modelForm.get('filePattern')?.invalid && modelForm.get('filePattern')?.touched"
                   placeholder="Ex: *TRXBO*.xls, *OPPART*.csv">
          <div class="invalid-feedback" *ngIf="modelForm.get('filePattern')?.invalid && modelForm.get('filePattern')?.touched">
            Le pattern de fichier est obligatoire.
          </div>
            <small class="form-text text-muted">Utilisez * comme wildcard (ex: *TRXBO*.xls)</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="fileType">Type de fichier *</label>
          <select id="fileType" formControlName="fileType" class="form-control">
              <option value="partner">Partenaire</option>
            <option value="bo">Back Office (BO)</option>
          </select>
            <small class="form-text text-muted">S√©lectionnez le type de fichier que ce mod√®le traitera</small>
        </div>

        <div class="form-group">
            <label for="templateFile">Fichier mod√®le *</label>
            <select id="templateFile" formControlName="templateFile" class="form-control" 
                    [class.is-invalid]="modelForm.get('templateFile')?.invalid && modelForm.get('templateFile')?.touched">
              <option value="">S√©lectionner un fichier depuis watch-folder</option>
            <option *ngFor="let file of availableFiles" [value]="file.fileName">
              {{ file.fileName }}
                    </option>
                  </select>
            <div class="invalid-feedback" *ngIf="modelForm.get('templateFile')?.invalid && modelForm.get('templateFile')?.touched">
              Le fichier mod√®le est obligatoire.
            </div>
            <small class="form-text text-muted">Fichier de r√©f√©rence pour la structure des donn√©es</small>
                </div>
              </div>

        <div class="form-row">
                      <div class="form-group">
                        <label>
          <input type="checkbox" formControlName="autoApply">
          Appliquer automatiquement
                        </label>
            <small class="form-text text-muted">Le mod√®le sera appliqu√© automatiquement aux fichiers correspondants</small>
          </div>
        </div>
                  </div>

                    <!-- Section 2: Cl√©s de r√©conciliation (masqu√©e pour les fichiers BO) -->
        <div class="config-section" *ngIf="modelForm.get('fileType')?.value !== 'bo'">
          <h4><i class="fas fa-key"></i> Cl√©s de r√©conciliation</h4>
          <p class="section-description">Configurez les cl√©s qui permettront de faire correspondre les enregistrements entre les fichiers BO et Partenaire.</p>
        
        <!-- Message d'information si aucun fichier mod√®le s√©lectionn√© -->
        <div class="alert alert-info" *ngIf="!modelForm.get('templateFile')?.value">
          <i class="fas fa-info-circle"></i>
          <strong>Information :</strong> Veuillez d'abord s√©lectionner un fichier mod√®le pour charger les colonnes disponibles.
        </div>

        <!-- Chargement des colonnes du fichier mod√®le -->
        <div class="form-row" *ngIf="modelForm.get('templateFile')?.value && !isLoadingTemplateColumns">
          <div class="form-group">
            <label>Cl√©s partenaire</label>
            <div class="key-selection" *ngIf="availableTemplateColumns.length > 0">
              <div *ngFor="let column of availableTemplateColumns" 
                   class="key-option"
                   [class.selected]="selectedPartnerKeys.includes(column)">
                <label class="key-label">
                  <input type="checkbox" 
                         [value]="column" 
                         [checked]="selectedPartnerKeys.includes(column)"
                         (change)="togglePartnerKey(column, $event)">
                  <span class="column-name" [class.selected-text]="selectedPartnerKeys.includes(column)">
                    <i class="fas fa-check-circle selected-icon" *ngIf="selectedPartnerKeys.includes(column)"></i>
                    {{ column }}
                  </span>
                </label>
              </div>
            </div>
            <div class="no-columns" *ngIf="availableTemplateColumns.length === 0">
              <small class="text-muted">Aucune colonne disponible pour ce fichier mod√®le</small>
            </div>
            <small class="form-text text-muted">S√©lectionnez les colonnes cl√©s du fichier partenaire</small>
          </div>

          <div class="form-group">
            <label>Mod√®les BO √† utiliser</label>
            <div class="bo-model-selection" *ngIf="availableBOModels.length > 0">
              <div *ngFor="let boModel of availableBOModels" 
                   class="bo-model-option"
                   [class.selected]="selectedBOModels.includes(boModel.id)">
                <label class="model-label">
                  <input type="checkbox" 
                         [value]="boModel.id" 
                         [checked]="selectedBOModels.includes(boModel.id)"
                         (change)="toggleBOModel(boModel.id, $event)">
                  <span class="model-name" [class.selected-text]="selectedBOModels.includes(boModel.id)">
                    <i class="fas fa-check-circle selected-icon" *ngIf="selectedBOModels.includes(boModel.id)"></i>
                    {{ boModel.name }}
                  </span>
                  <small class="model-pattern">({{ boModel.filePattern }})</small>
                </label>
              </div>
            </div>
            <div class="no-models" *ngIf="availableBOModels.length === 0">
              <small class="text-muted">Aucun mod√®le BO disponible</small>
            </div>
            <small class="form-text text-muted">S√©lectionnez les mod√®les BO pour la r√©conciliation</small>
          </div>
        </div>

        <!-- Indicateur de chargement -->
        <div class="loading-indicator" *ngIf="isLoadingTemplateColumns">
          <i class="fas fa-spinner fa-spin"></i>
          <span>Chargement des colonnes du fichier mod√®le...</span>
        </div>

        <!-- Colonnes des mod√®les BO s√©lectionn√©s -->
        <div class="form-row" *ngIf="selectedBOModels.length > 0 && !isLoadingBOColumns">
          <div class="form-group">
            <label>Colonnes des mod√®les BO s√©lectionn√©s</label>
            <div class="key-selection" *ngIf="availableBOColumns.length > 0">
              <div *ngFor="let column of availableBOColumns" 
                   class="key-option"
                   [class.selected]="selectedBOKeys.includes(column)">
                <label class="key-label">
                  <input type="checkbox" 
                         [value]="column" 
                         [checked]="selectedBOKeys.includes(column)"
                         (change)="toggleBOKey(column, $event)">
                  <span class="column-name" [class.selected-text]="selectedBOKeys.includes(column)">
                    <i class="fas fa-check-circle selected-icon" *ngIf="selectedBOKeys.includes(column)"></i>
                    {{ column }}
                  </span>
                </label>
              </div>
            </div>
            <div class="no-columns" *ngIf="availableBOColumns.length === 0">
              <small class="text-muted">Aucune colonne disponible pour les mod√®les BO s√©lectionn√©s</small>
            </div>
            <small class="form-text text-muted">Colonnes disponibles dans les mod√®les BO s√©lectionn√©s</small>
          </div>
        </div>

        <!-- Indicateur de chargement pour les colonnes BO -->
        <div class="loading-indicator" *ngIf="isLoadingBOColumns">
          <i class="fas fa-spinner fa-spin"></i>
          <span>Chargement des colonnes des mod√®les BO...</span>
        </div>



        <!-- R√©sum√© des s√©lections -->
        <div class="selection-summary" *ngIf="selectedPartnerKeys.length > 0 || selectedBOModels.length > 0 || selectedBOKeys.length > 0">
          <h5><i class="fas fa-list"></i> R√©sum√© des s√©lections</h5>
          <div class="summary-items">
            <div class="summary-item" *ngIf="selectedPartnerKeys.length > 0">
              <strong>Cl√©s partenaire :</strong> {{ selectedPartnerKeys.join(', ') }}
            </div>
            <div class="summary-item" *ngIf="selectedBOModels.length > 0">
              <strong>Mod√®les BO :</strong> {{ getSelectedBOModelNames() }}
            </div>
            <div class="summary-item" *ngIf="selectedBOKeys.length > 0">
              <strong>Cl√©s BO :</strong> {{ selectedBOKeys.join(', ') }}
            </div>
          </div>
        </div>
              </div>

        <!-- Message informatif pour les fichiers BO -->
        <div class="config-section" *ngIf="modelForm.get('fileType')?.value === 'bo'">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Information :</strong> Pour les fichiers de type "BO", les cl√©s de r√©conciliation sont configur√©es au niveau des mod√®les partenaires. Cette section n'est donc pas n√©cessaire.
          </div>
        </div>

        <!-- Section 3: Logique de r√©conciliation -->
      <div class="config-section">
        <h4>
          <i class="fas fa-cogs"></i> Logique de r√©conciliation
          <button type="button" class="btn btn-sm btn-outline-info" (click)="toggleReconciliationLogicSection()">
            <i class="fas fa-cog"></i> {{ showReconciliationLogicSection ? 'Masquer' : 'Afficher' }}
          </button>
        </h4>
        <p class="section-description">D√©finissez la logique de correspondance entre les enregistrements BO et Partenaire.</p>
        
        <div *ngIf="showReconciliationLogicSection" class="logic-config-container">
          <!-- Affichage de la logique actuelle -->
          <div class="logic-display" *ngIf="modelForm.get('logicType')?.value">
            <div class="logic-item">
              <div class="logic-header">
                <span class="logic-type">{{ modelForm.get('logicType')?.value }}</span>
                <span class="logic-ratio badge badge-primary" *ngIf="modelForm.get('expectedRatio')?.value">
                  {{ modelForm.get('expectedRatio')?.value }}
                </span>
                <div class="logic-actions">
                  <button type="button" class="btn btn-sm btn-outline-primary" (click)="editReconciliationLogic()">
                    <i class="fas fa-edit"></i>
                  </button>
                </div>
              </div>
              <div class="logic-description" *ngIf="modelForm.get('logicDescription')?.value">
                {{ modelForm.get('logicDescription')?.value }}
              </div>
            </div>
          </div>

          <!-- Formulaire d'√©dition -->
          <div *ngIf="editingReconciliationLogic" class="logic-form">
            <h5>Configuration de la logique de r√©conciliation</h5>
            <form [formGroup]="modelForm">
                  <div class="form-row">
                <div class="form-group">
                  <label for="logicType">Type de logique *</label>
                  <select id="logicType" formControlName="logicType" class="form-control" (change)="onLogicTypeChange()">
                    <option value="STANDARD">Standard (1:1)</option>
                    <option value="SPECIAL_RATIO">Ratio sp√©cial (1:2, 1:3, etc.)</option>
                    <option value="CUSTOM">Personnalis√©e</option>
                  </select>
                  <small class="form-text text-muted">Choisissez le type de logique de r√©conciliation</small>
                </div>
                
                <div class="form-group" *ngIf="modelForm.get('logicType')?.value === 'SPECIAL_RATIO'">
                  <label for="expectedRatio">Ratio attendu</label>
                  <select id="expectedRatio" formControlName="expectedRatio" class="form-control">
                    <option value="1:2">1:2 (ex: TRXBO/OPPART)</option>
                    <option value="1:3">1:3</option>
                    <option value="2:1">2:1</option>
                    <option value="3:1">3:1</option>
                      </select>
                  <small class="form-text text-muted">D√©finissez le ratio de correspondance attendu</small>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="logicDescription">Description</label>
                  <textarea id="logicDescription" formControlName="logicDescription" class="form-control" rows="2"
                            placeholder="D√©crivez la logique de r√©conciliation..."></textarea>
                  <small class="form-text text-muted">Description optionnelle de la logique</small>
                </div>
              </div>

              <div class="form-actions">
                <button type="button" class="btn btn-primary" (click)="saveReconciliationLogic()">Sauvegarder</button>
                <button type="button" class="btn btn-secondary" (click)="cancelReconciliationLogicEdit()">Annuler</button>
              </div>
            </form>
          </div>

          <!-- Bouton d'ajout si aucune logique n'est configur√©e -->
          <div class="add-logic-section" *ngIf="!modelForm.get('logicType')?.value && !editingReconciliationLogic">
            <button type="button" class="btn btn-success" (click)="editReconciliationLogic()">
              <i class="fas fa-plus"></i> Configurer la logique de r√©conciliation
            </button>
          </div>
        </div>
      </div>





      <!-- Messages informatifs pour les mod√®les autonomes -->
      <div class="info-message" *ngIf="modelForm.get('fileType')?.value === 'partner' && !modelForm.get('templateFile')?.value">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Attention :</strong> Veuillez s√©lectionner un fichier mod√®le depuis le dossier watch-folder pour configurer les cl√©s de r√©conciliation.
        </div>
      </div>

      <div class="info-message" *ngIf="modelForm.get('fileType')?.value === 'partner' && 
                                   modelForm.get('templateFile')?.value && 
                                   availableColumns.length === 0">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Attention :</strong> Les colonnes du fichier mod√®le sont en cours de chargement...
        </div>
      </div>

      <!-- Message informatif pour les r√®gles de traitement des colonnes -->
      <div class="info-message" *ngIf="showColumnRulesSection && availableColumnsForTemplate.length === 0">
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <strong>Information :</strong> Les colonnes du mod√®le seront automatiquement charg√©es pour tous les types (partner, bo, both) avec encodage et typage corrects.
        </div>
      </div>

      <!-- R√®gles de traitement des colonnes -->
      <div class="config-section">
        <h4>
          <i class="fas fa-tools"></i> R√®gles de traitement des colonnes
          <button type="button" class="btn btn-sm btn-outline-info" (click)="toggleColumnProcessingSection()">
            <i class="fas fa-tools"></i> {{ showColumnProcessingSection ? 'Masquer' : 'Afficher' }}
          </button>
        </h4>
        <p class="section-description">Configurez les r√®gles de nettoyage des donn√©es avant la r√©conciliation.</p>
        
        <div *ngIf="showColumnProcessingSection" class="processing-config-container">
          <!-- Liste des r√®gles existantes -->
          <div class="processing-rules-list" *ngIf="columnProcessingRules.length > 0">
            <h5>R√®gles configur√©es ({{ columnProcessingRules.length }})</h5>
            <div *ngFor="let rule of columnProcessingRules; let i = index" class="processing-rule-item">
              <div class="rule-header">
                <span class="rule-order">{{ i + 1 }}</span>
                <span class="rule-title">
                  <i class="fas fa-columns"></i> 
                  {{ rule.sourceColumns ? rule.sourceColumns.length : 1 }} colonne(s)
                </span>
                <div class="rule-actions">
                  <button type="button" class="btn btn-sm btn-outline-primary" (click)="editColumnProcessingRule(i)">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-danger" (click)="deleteColumnProcessingRule(i)">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              <div class="rule-details">
                <div class="rule-columns">
                  <strong>Colonnes :</strong>
                  <div class="columns-badges">
                    <span *ngFor="let col of rule.sourceColumns || [rule.sourceColumn]" class="column-badge badge badge-primary">
                      {{ col }}
                    </span>
                  </div>
                </div>
                <div class="rule-badges">
                  <span class="rule-action badge badge-warning" *ngIf="rule.removeSpecialChars">
                    <i class="fas fa-magic"></i> Supprimer caract√®res sp√©ciaux
                  </span>
                  <span class="rule-action badge badge-info" *ngIf="rule.removeAccents">
                    <i class="fas fa-language"></i> Supprimer accents
                  </span>
                  <span class="rule-action badge badge-secondary" *ngIf="rule.toUpperCase">
                    <i class="fas fa-arrow-up"></i> Majuscules
                  </span>
                  <span class="rule-action badge badge-secondary" *ngIf="rule.toLowerCase">
                    <i class="fas fa-arrow-down"></i> Minuscules
                  </span>
                  <span class="rule-action badge badge-light" *ngIf="rule.trimSpaces">
                    <i class="fas fa-cut"></i> Nettoyer espaces
                  </span>
                </div>
                <div class="rule-details-text" *ngIf="rule.stringToRemove">
                  <small class="text-muted">
                    Cha√Æne √† supprimer : <code>{{ rule.stringToRemove }}</code>
                  </small>
                </div>
              </div>
            </div>
          </div>

          <div class="add-processing-rule-section">
            <button type="button" class="btn btn-success" (click)="addColumnProcessingRule()">
              <i class="fas fa-plus"></i> Ajouter une r√®gle de nettoyage
            </button>
                 </div>
                 
          <!-- Formulaire d'ajout/√©dition de r√®gle de traitement -->
          <div *ngIf="editingColumnProcessingRule !== null" class="processing-rule-form">
            <h5>{{ editingColumnProcessingRule === -1 ? 'Nouvelle r√®gle' : 'Modifier la r√®gle' }}</h5>
            <form [formGroup]="columnProcessingRuleForm" (ngSubmit)="saveColumnProcessingRule()">
              <div class="form-row">
                <div class="form-group">
                  <label>Colonnes √† nettoyer *</label>
                  <div class="columns-selection-container">
                    <div class="columns-list">
                      <div *ngFor="let col of availableTemplateColumns" class="column-checkbox-item">
                        <label class="column-checkbox-label">
                          <input type="checkbox" 
                                 [value]="col" 
                                 (change)="toggleColumnSelection(col, $event.target.checked)"
                                 [checked]="isColumnSelected(col)">
                          <span class="column-name">{{ col }}</span>
                        </label>
                      </div>
                    </div>
                    <div class="columns-selection-summary">
                      <small class="form-text text-info">
                        <i class="fas fa-info-circle"></i> 
                        {{ getSelectedColumnsCount() }} colonne(s) s√©lectionn√©e(s) sur {{ availableTemplateColumns.length }} disponibles
                      </small>
                      <button type="button" class="btn btn-sm btn-outline-secondary" (click)="selectAllColumns()">
                        <i class="fas fa-check-double"></i> Tout s√©lectionner
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-secondary" (click)="deselectAllColumns()">
                        <i class="fas fa-times"></i> Tout d√©s√©lectionner
                      </button>
                    </div>
                  </div>
                  <small class="form-text text-muted" *ngIf="availableTemplateColumns.length === 0">
                    <i class="fas fa-spinner fa-spin"></i> Chargement des colonnes du mod√®le...
                  </small>
                  <small class="form-text text-success" *ngIf="availableTemplateColumns.length > 0">
                    <i class="fas fa-check"></i> {{ availableTemplateColumns.length }} colonnes du mod√®le disponibles
                  </small>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>
                    <input type="checkbox" formControlName="removeSpecialChars" [checked]="true">
                    Supprimer les caract√®res sp√©ciaux
                  </label>
                  <small class="form-text text-muted">
                    Cette option supprime automatiquement les caract√®res sp√©ciaux de la colonne s√©lectionn√©e
                  </small>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>
                    <input type="checkbox" formControlName="removeAccents">
                    Supprimer les accents
                  </label>
                  <small class="form-text text-muted">
                    Cette option supprime automatiquement tous les accents des valeurs (√©, √®, √†, √ß, etc.)
                    <br>Exemple : "T√©l√©phone" ‚Üí "Telephone", "Num√©ro" ‚Üí "Numero"
                  </small>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>
                    <input type="checkbox" formControlName="toUpperCase">
                    Convertir en majuscules
                  </label>
                  <small class="form-text text-muted">
                    Convertit toutes les lettres en majuscules
                    <br>Exemple : "hello world" ‚Üí "HELLO WORLD"
                  </small>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>
                    <input type="checkbox" formControlName="toLowerCase">
                    Convertir en minuscules
                  </label>
                  <small class="form-text text-muted">
                    Convertit toutes les lettres en minuscules
                    <br>Exemple : "HELLO WORLD" ‚Üí "hello world"
                  </small>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>
                    <input type="checkbox" formControlName="trimSpaces">
                    Nettoyer les espaces
                  </label>
                  <small class="form-text text-muted">
                    Supprime les espaces en d√©but et fin de cha√Æne
                    <br>Exemple : "  hello world  " ‚Üí "hello world"
                  </small>
                </div>
              </div>
                
              <!-- Champ pour sp√©cifier les cha√Ænes √† supprimer -->
              <div class="form-row" *ngIf="columnProcessingRuleForm.get('removeSpecialChars')?.value">
                <div class="form-group">
                  <label>Cha√Æne √† supprimer</label>
                  <input type="text" formControlName="stringToRemove" class="form-control" 
                         placeholder="Ex: _CM ou abc123">
                  <small class="form-text text-muted">
                    <strong>Sensible √† la casse</strong><br>
                    üîç <strong>Appliquer seulement sur les lignes avec une valeur exacte</strong><br>
                    üí° <strong>Suppression de cha√Ænes sp√©cifiques autoris√©es :</strong><br>
                    ‚Ä¢ Seules les cha√Ænes suivantes sont autoris√©es : <code>_CM, _ML, _GN, _CI, _BF, _KE, _SN, _KN, _BJ, _GB</code><br>
                    ‚Ä¢ Exemple : <code>"_CM"</code> supprimera <code>"_CM"</code> dans <code>"ID_CM_123"</code> ‚Üí <code>"ID_123"</code><br>
                    ‚Ä¢ Exemple : <code>"_ML"</code> supprimera <code>"_ML"</code> dans <code>"REF_ML_456"</code> ‚Üí <code>"REF_456"</code><br>
                    ‚ö†Ô∏è <strong>Note :</strong> Les caract√®res individuels (C, M, P, etc.) ne sont pas autoris√©s
                  </small>
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-primary">Sauvegarder</button>
                <button type="button" class="btn btn-secondary" (click)="cancelColumnProcessingRuleEdit()">Annuler</button>
              </div>
            </form>
           </div>
         </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="!isFormValid()">
          {{ editingModel ? 'Modifier' : 'Cr√©er' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="cancelEdit()">
          {{ editingModel ? 'Annuler' : 'Fermer' }}
        </button>
        
        <!-- Bouton de debug temporaire -->
        <button type="button" class="btn btn-warning" (click)="debugValidationState()" style="margin-left: 10px;">
          üîç Debug Validation
        </button>
        
        <!-- Message d'aide pour la validation -->
        <div class="validation-help" *ngIf="!isFormValid() && modelForm.get('fileType')?.value !== 'bo'">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Pour activer le bouton "Cr√©er" :</strong>
            <ul>
              <li *ngIf="selectedPartnerKeys.length === 0">‚úÖ S√©lectionnez au moins une cl√© partenaire</li>
              <li *ngIf="selectedPartnerKeys.length > 0">‚úÖ Cl√©s partenaire s√©lectionn√©es ({{ selectedPartnerKeys.length }})</li>
              <li *ngIf="selectedBOModels.length === 0">‚úÖ S√©lectionnez au moins un mod√®le BO</li>
              <li *ngIf="selectedBOModels.length > 0">‚úÖ Mod√®les BO s√©lectionn√©s ({{ selectedBOModels.length }})</li>
            </ul>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Liste des mod√®les -->
  <div class="models-list" *ngIf="models.length > 0">
    <h3>Mod√®les existants ({{ models.length }})</h3>
    
    <div class="models-grid">
      <div class="model-card" *ngFor="let model of models">
        <div class="model-header">
          <h4>{{ model.name }}</h4>
          <div class="model-actions">
            <button (click)="editModel(model)" class="btn btn-sm btn-edit" title="Modifier">
              <i class="fas fa-edit"></i>
            </button>
            <button (click)="deleteModel(model)" class="btn btn-sm btn-delete" title="Supprimer">
              <i class="fas fa-trash"></i>
            </button>
        </div>
      </div>

        <div class="model-info">
          <p><strong>Pattern:</strong> {{ model.filePattern }}</p>
          <p><strong>Type:</strong> {{ model.fileType }}</p>
          <p><strong>Auto-appliqu√©:</strong> {{ model.autoApply ? 'Oui' : 'Non' }}</p>
          <p *ngIf="model.templateFile"><strong>Fichier mod√®le:</strong> {{ model.templateFile }}</p>
          
          <!-- Affichage des r√®gles de traitement des colonnes -->
          <div class="model-rules" *ngIf="model.columnProcessingRules && model.columnProcessingRules.length > 0">
            <p><strong>R√®gles de traitement:</strong> {{ model.columnProcessingRules.length }} r√®gle(s)</p>
            <div class="rules-preview">
              <span class="rule-badge" *ngFor="let rule of model.columnProcessingRules.slice(0, 3)">
                {{ rule.sourceColumn }} ‚Üí {{ rule.targetColumn }}
              </span>
              <span class="rule-more" *ngIf="model.columnProcessingRules.length > 3">
                +{{ model.columnProcessingRules.length - 3 }} autres
              </span>
            </div>
          </div>
      </div>
    </div>
    </div>
  </div>

  <!-- √âtat de chargement -->
  <div class="loading" *ngIf="loading">
    <i class="fas fa-spinner fa-spin"></i> Chargement...
  </div>
</div> 