<div class="reconciliation-results-container">
    <!-- Barre de progression -->
    <div *ngIf="showProgress" class="progress-container">
        <div class="progress-header">
            <h3>üîÑ R√©conciliation en cours...</h3>
            <div class="progress-stats">
                <span>üìä {{ processedRecords }} / {{ totalRecords }} enregistrements trait√©s</span>
                <span>‚è±Ô∏è {{ formatTime(getElapsedTime()) }}</span>
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="progressPercentage"></div>
        </div>
        <div class="progress-percentage">{{ progressPercentage | number:'1.0-0' }}%</div>
    </div>

    <!-- R√©sultats de r√©conciliation -->
    <div *ngIf="response && !showProgress" class="results-content">
        <!-- En-t√™te avec statistiques -->
        <div class="results-header">
            <div class="header-left">
                <h2>üìä R√©sultats de la R√©conciliation</h2>
                <div class="execution-info" *ngIf="executionTime > 0">
                    <span>‚è±Ô∏è Temps d'ex√©cution: {{ formatTime(executionTime) }}</span>
                    <span>üìà {{ processedRecords }} enregistrements trait√©s</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" (click)="nouvelleReconciliation()">
                    üîÑ Nouvelle R√©conciliation
                </button>
                <button class="btn btn-success" (click)="goToStats()">
                    üìà Voir les Statistiques
                </button>
            </div>
        </div>

        <!-- Onglets -->
        <div class="tabs-container">
            <div class="tabs">
                <button 
                    class="tab-btn" 
                    [class.active]="activeTab === 'matches'"
                    (click)="setActiveTab('matches')">
                    üîó Correspondances ({{ filteredMatches.length }})
                </button>
                <button 
                    class="tab-btn" 
                    [class.active]="activeTab === 'boOnly'"
                    (click)="setActiveTab('boOnly')">
                    üìã BO Uniquement ({{ filteredBoOnly.length }})
                </button>
                <button 
                    class="tab-btn" 
                    [class.active]="activeTab === 'partnerOnly'"
                    (click)="setActiveTab('partnerOnly')">
                    ü§ù Partenaire Uniquement ({{ filteredPartnerOnly.length }})
                </button>
                <button 
                    class="tab-btn" 
                    [class.active]="activeTab === 'agencySummary'"
                    (click)="setActiveTab('agencySummary')">
                    üè¢ R√©sum√© par Agence
                </button>
            </div>
        </div>

        <!-- Barre de recherche -->
        <div class="search-container">
            <div class="search-box">
                <input 
                    type="text" 
                    [(ngModel)]="searchKey" 
                    (input)="onSearch()"
                    placeholder="üîç Rechercher..."
                    class="search-input">
            </div>
            <div class="export-section">
                <button class="btn btn-export" (click)="handleExport()" [disabled]="isExporting">
                    {{ isExporting ? 'üì§ Export en cours...' : 'üì§ Exporter' }}
                </button>
            </div>
        </div>

        <!-- Filtre par service -->
        <div class="service-filter">
            <label for="serviceSelect">Filtrer par service:</label>
            <select id="serviceSelect" [(ngModel)]="selectedService" (change)="applyServiceFilter()">
                <option value="">Tous les services</option>
                <option *ngFor="let service of getServiceOptions()" [value]="service">
                    {{ service }}
                </option>
            </select>
        </div>

        <!-- Contenu des onglets -->
        <div class="tab-content">
            <!-- Onglet Correspondances -->
            <div *ngIf="activeTab === 'matches'" class="tab-pane">
                <div class="stats-summary">
                    <div class="stat-card">
                        <h4>Volume Total BO</h4>
                        <span class="stat-value">{{ formatMontantDisplay(calculateTotalVolume('bo')) }}</span>
                    </div>
                    <div class="stat-card">
                        <h4>Volume Total Partenaire</h4>
                        <span class="stat-value">{{ formatMontantDisplay(calculateTotalVolume('partner')) }}</span>
                    </div>
                    <div class="stat-card">
                        <h4>√âcart</h4>
                        <span class="stat-value" [class.negative]="calculateVolumeDifference() < 0">
                            {{ formatMontantDisplay(calculateVolumeDifference()) }}
                        </span>
                    </div>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Cl√©</th>
                                <th>Donn√©es BO</th>
                                <th>Donn√©es Partenaire</th>
                                <th>Diff√©rences</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let match of getPagedMatches()">
                                <td class="match-key">{{ match.key }}</td>
                                <td class="bo-data">
                                    <div *ngFor="let key of getBoKeys(match)" class="data-row">
                                        <strong>{{ key }}:</strong> {{ match.boData[key] }}
                                    </div>
                                </td>
                                <td class="partner-data">
                                    <div *ngFor="let key of getPartnerKeys(match)" class="data-row">
                                        <strong>{{ key }}:</strong> {{ match.partnerData[key] }}
                                    </div>
                                </td>
                                <td class="differences">
                                    <div *ngIf="hasDifferences(match)" class="diff-list">
                                        <div *ngFor="let diff of match.differences" class="diff-item">
                                            <span class="diff-field">{{ diff.boColumn }} vs {{ diff.partnerColumn }}</span>
                                            <span class="diff-values">
                                                BO: {{ diff.boValue }} | Partenaire: {{ diff.partnerValue }}
                                            </span>
                                        </div>
                                    </div>
                                    <span *ngIf="!hasDifferences(match)" class="no-diff">‚úÖ Correspondance parfaite</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination pour les correspondances -->
                <div class="pagination">
                    <button [disabled]="matchesPage === 1" (click)="prevPage('matches')">‚Üê Pr√©c√©dent</button>
                    <span>Page {{ matchesPage }} sur {{ getTotalPages('matches') }}</span>
                    <button [disabled]="matchesPage >= getTotalPages('matches')" (click)="nextPage('matches')">Suivant ‚Üí</button>
                </div>
            </div>

            <!-- Onglet BO Uniquement -->
            <div *ngIf="activeTab === 'boOnly'" class="tab-pane">
                <div class="stats-summary">
                    <div class="stat-card">
                        <h4>Volume Total BO Only</h4>
                        <span class="stat-value">{{ formatMontantDisplay(calculateTotalVolumeBoOnly()) }}</span>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-save" (click)="saveEcartBoToEcartSolde()" [disabled]="isSavingEcartBo">
                        {{ isSavingEcartBo ? 'üíæ Sauvegarde...' : 'üíæ Sauvegarder ECART BO' }}
                    </button>
                    <button class="btn btn-save" (click)="saveEcartBoToTrxSf()" [disabled]="isSavingEcartBoToTrxSf">
                        {{ isSavingEcartBoToTrxSf ? 'üíæ Sauvegarde...' : 'üíæ Sauvegarder dans TRX SF' }}
                    </button>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th *ngFor="let key of getRecordKeys(getPagedBoOnly()[0] || {})">{{ key }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let record of getPagedBoOnly()">
                                <td *ngFor="let key of getRecordKeys(record)">{{ record[key] }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination pour BO Only -->
                <div class="pagination">
                    <button [disabled]="boOnlyPage === 1" (click)="prevPage('boOnly')">‚Üê Pr√©c√©dent</button>
                    <span>Page {{ boOnlyPage }} sur {{ getTotalPages('boOnly') }}</span>
                    <button [disabled]="boOnlyPage >= getTotalPages('boOnly')" (click)="nextPage('boOnly')">Suivant ‚Üí</button>
                </div>
            </div>

            <!-- Onglet Partenaire Uniquement -->
            <div *ngIf="activeTab === 'partnerOnly'" class="tab-pane">
                <div class="stats-summary">
                    <div class="stat-card">
                        <h4>Volume Total Partenaire Only</h4>
                        <span class="stat-value">{{ formatMontantDisplay(calculateTotalVolumePartnerOnly()) }}</span>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-save" (click)="saveEcartPartnerToEcartSolde()" [disabled]="isSavingEcartPartner" title="Sauvegarder les √©carts partenaires">
                        {{ isSavingEcartPartner ? 'üíæ Sauvegarde...' : 'üíæ Sauvegarder ECART Partenaire' }}
                    </button>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th *ngFor="let key of getRecordKeys(getPagedPartnerOnly()[0] || {})">{{ key }}</th>
                                <th>Commentaire TSOP</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let record of getPagedPartnerOnly()" 
                                [class.tsop-duplicate]="getTSOPType(record) === 'COMPLETE'"
                                [class.tsop-sans-frais]="getTSOPType(record) === 'SANS_FRAIS'">
                                <td *ngFor="let key of getRecordKeys(record)">{{ record[key] }}</td>
                                <td class="tsop-comment">{{ getTSOPComment(record) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination pour Partner Only -->
                <div class="pagination">
                    <button [disabled]="partnerOnlyPage === 1" (click)="prevPage('partnerOnly')">‚Üê Pr√©c√©dent</button>
                    <span>Page {{ partnerOnlyPage }} sur {{ getTotalPages('partnerOnly') }}</span>
                    <button [disabled]="partnerOnlyPage >= getTotalPages('partnerOnly')" (click)="nextPage('partnerOnly')">Suivant ‚Üí</button>
                </div>
            </div>

            <!-- Onglet R√©sum√© par Agence -->
            <div *ngIf="activeTab === 'agencySummary'" class="tab-pane">
                <div class="stats-summary">
                    <div class="stat-card">
                        <h4>Volume Total</h4>
                        <span class="stat-value">{{ formatMontantDisplay(getTotalVolume()) }}</span>
                    </div>
                    <div class="stat-card">
                        <h4>Nombre Total d'Enregistrements</h4>
                        <span class="stat-value">{{ getTotalRecords() }}</span>
                    </div>
                </div>

                <div class="agency-summary-actions">
                    <div class="date-selection">
                        <label for="selectedDate">Date d'import:</label>
                        <input type="date" id="selectedDate" [(ngModel)]="selectedDate">
                    </div>
                    <div class="selection-controls">
                        <label>
                            <input type="checkbox" 
                                   [checked]="allAgencySelected" 
                                   (change)="toggleSelectAllAgency($event)">
                            Tout s√©lectionner
                        </label>
                    </div>
                    <button class="btn btn-save" (click)="saveAgencySummary()" [disabled]="isSaving">
                        {{ isSaving ? 'üíæ Sauvegarde...' : 'üíæ Sauvegarder R√©sum√©' }}
                    </button>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" 
                                           [checked]="allAgencySelected" 
                                           (change)="toggleSelectAllAgency($event)">
                                </th>
                                <th>Agence</th>
                                <th>Service</th>
                                <th>Pays</th>
                                <th>Date</th>
                                <th>Volume Total</th>
                                <th>Nombre d'Enregistrements</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let summary of getPagedAgencySummary()">
                                <td>
                                    <input type="checkbox" 
                                           [checked]="isAgencySelected(summary)" 
                                           (change)="toggleAgencySelection(summary, $event)">
                                </td>
                                <td>{{ summary.agency }}</td>
                                <td>{{ summary.service }}</td>
                                <td>{{ summary.country }}</td>
                                <td>{{ summary.date }}</td>
                                <td>{{ formatMontantDisplay(summary.totalVolume) }}</td>
                                <td>{{ summary.recordCount }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination pour le r√©sum√© par agence -->
                <div class="pagination">
                    <button [disabled]="agencyPage === 1" (click)="prevAgencyPage()">‚Üê Pr√©c√©dent</button>
                    <span>Page {{ agencyPage }} sur {{ getTotalAgencyPages() }}</span>
                    <button [disabled]="agencyPage >= getTotalAgencyPages()" (click)="nextAgencyPage()">Suivant ‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message si aucun r√©sultat -->
    <div *ngIf="!response && !showProgress" class="no-results">
        <h3>üìã Aucun r√©sultat de r√©conciliation disponible</h3>
        <p>Veuillez effectuer une r√©conciliation pour voir les r√©sultats.</p>
        <button class="btn btn-primary" (click)="startReconciliation()">
            üîÑ Commencer une R√©conciliation
        </button>
    </div>
</div> 