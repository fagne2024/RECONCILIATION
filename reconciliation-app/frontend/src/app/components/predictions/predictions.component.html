<div class="predictions-container">
  <div class="header">
    <div class="header-top">
      <button (click)="goBack()" class="btn-back">
        <i class="fas fa-arrow-left"></i> Retour
      </button>
      <h1>üîÆ Pr√©dictions des Op√©rations Bancaires</h1>
    </div>
    <p class="subtitle">Pr√©disez les approvisionnements, compensations et niveillements futurs bas√©s sur les donn√©es historiques</p>
  </div>

  <!-- Formulaire de pr√©diction -->
  <div class="prediction-form-card">
    <h2>Param√®tres de Pr√©diction</h2>
    <form [formGroup]="predictionForm" (ngSubmit)="generatePrediction()">
      <div class="form-grid">
        <div class="form-group">
          <label for="typeOperation">Type d'Op√©ration *</label>
          <select id="typeOperation" formControlName="typeOperation" class="form-control">
            <option value="">-- S√©lectionner un type --</option>
            <option *ngFor="let type of availableTypes" [value]="type.value">{{ type.label }}</option>
          </select>
          <div *ngIf="predictionForm.get('typeOperation')?.invalid && predictionForm.get('typeOperation')?.touched" class="error-message">
            Le type d'op√©ration est requis
          </div>
        </div>

        <div class="form-group">
          <label for="horizonJours">Horizon de Pr√©diction (jours) *</label>
          <input type="number" id="horizonJours" formControlName="horizonJours" class="form-control" min="1" max="365">
          <small class="form-text">Nombre de jours √† pr√©dire (1-365)</small>
          <div *ngIf="predictionForm.get('horizonJours')?.invalid && predictionForm.get('horizonJours')?.touched" class="error-message">
            L'horizon doit √™tre entre 1 et 365 jours
          </div>
        </div>

        <div class="form-group">
          <label for="periodeAnalyseJours">P√©riode d'Analyse (jours) *</label>
          <input type="number" id="periodeAnalyseJours" formControlName="periodeAnalyseJours" class="form-control" min="7" max="730">
          <small class="form-text">Nombre de jours d'historique √† analyser (7-730)</small>
          <div *ngIf="predictionForm.get('periodeAnalyseJours')?.invalid && predictionForm.get('periodeAnalyseJours')?.touched" class="error-message">
            La p√©riode d'analyse doit √™tre entre 7 et 730 jours
          </div>
        </div>

        <div class="form-group">
          <label for="methodePrediction">M√©thode de Pr√©diction *</label>
          <select id="methodePrediction" formControlName="methodePrediction" class="form-control">
            <option *ngFor="let methode of methodesPrediction" [value]="methode.value">{{ methode.label }}</option>
          </select>
        </div>

        <div class="form-group">
          <label for="codeProprietaire">Agence (optionnel)</label>
          <input type="text" id="codeProprietaire" formControlName="codeProprietaire" class="form-control" placeholder="Filtrer par agence">
        </div>

        <div class="form-group">
          <label for="service">Service (optionnel)</label>
          <input type="text" id="service" formControlName="service" class="form-control" placeholder="Filtrer par service">
        </div>

        <div class="form-group">
          <label for="pays">Pays (optionnel)</label>
          <input type="text" id="pays" formControlName="pays" class="form-control" placeholder="Filtrer par pays">
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="isLoading || predictionForm.invalid">
          <span *ngIf="!isLoading">üîÆ G√©n√©rer la Pr√©diction</span>
          <span *ngIf="isLoading">‚è≥ G√©n√©ration en cours...</span>
        </button>
      </div>
    </form>
  </div>

  <!-- Message d'erreur -->
  <div *ngIf="errorMessage" class="alert alert-error">
    <strong>Erreur:</strong> {{ errorMessage }}
  </div>

  <!-- R√©sultats de la pr√©diction -->
  <div *ngIf="predictionResponse" class="prediction-results">
    <div class="results-header">
      <h2>üìä R√©sultats de la Pr√©diction</h2>
      <button class="btn btn-secondary" (click)="exportToCSV()">üì• Exporter en CSV</button>
    </div>

    <!-- Statistiques globales -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
          <div class="stat-label">Montant Total Pr√©dit</div>
          <div class="stat-value">{{ formatCurrency(predictionResponse.montantTotalPrediction) }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">üìà</div>
        <div class="stat-content">
          <div class="stat-label">Montant Moyen/Jour</div>
          <div class="stat-value">{{ formatCurrency(predictionResponse.montantMoyenParJour) }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-content">
          <div class="stat-label">Nombre d'Op√©rations</div>
          <div class="stat-value">{{ predictionResponse.nombreOperationsPredites }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">üéØ</div>
        <div class="stat-content">
          <div class="stat-label">Confiance</div>
          <div class="stat-value">{{ formatPercent(predictionResponse.confiance) }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">üìâ</div>
        <div class="stat-content">
          <div class="stat-label">Montant Minimum</div>
          <div class="stat-value">{{ formatCurrency(predictionResponse.montantMin) }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">üìà</div>
        <div class="stat-content">
          <div class="stat-label">Montant Maximum</div>
          <div class="stat-value">{{ formatCurrency(predictionResponse.montantMax) }}</div>
        </div>
      </div>
    </div>

    <!-- Message d'information -->
    <div *ngIf="predictionResponse.message" class="alert alert-info">
      {{ predictionResponse.message }}
    </div>

    <!-- Analyse des seuils de d√©clenchement -->
    <div *ngIf="predictionResponse.statistiquesHistoriques?.seuilDeclenchementMoyen !== undefined" class="seuils-section">
      <h3>üîç Analyse des Seuils de D√©clenchement</h3>
      <p class="section-description">
        Cette analyse identifie les niveaux de solde qui d√©clenchent historiquement les op√©rations.
        Les pr√©dictions utilisent ces seuils en arri√®re-plan pour d√©terminer quand les op√©rations se produiront.
      </p>
      <div class="seuils-grid">
        <div class="seuil-card">
          <div class="seuil-label">Seuil Moyen de D√©clenchement</div>
          <div class="seuil-value">{{ formatCurrency(predictionResponse.statistiquesHistoriques.seuilDeclenchementMoyen) }}</div>
          <div class="seuil-description">
            Solde moyen avant chaque op√©ration historique
          </div>
        </div>
        
        <div class="seuil-card">
          <div class="seuil-label">Seuil Minimum</div>
          <div class="seuil-value">{{ formatCurrency(predictionResponse.statistiquesHistoriques.seuilDeclenchementMin) }}</div>
          <div class="seuil-description">
            Solde minimum observ√© avant une op√©ration
          </div>
        </div>
        
        <div class="seuil-card">
          <div class="seuil-label">Seuil Maximum</div>
          <div class="seuil-value">{{ formatCurrency(predictionResponse.statistiquesHistoriques.seuilDeclenchementMax) }}</div>
          <div class="seuil-description">
            Solde maximum observ√© avant une op√©ration
          </div>
        </div>
        
        <div class="seuil-card">
          <div class="seuil-label">√âcart-Type</div>
          <div class="seuil-value">{{ formatCurrency(predictionResponse.statistiquesHistoriques.seuilDeclenchementEcartType) }}</div>
          <div class="seuil-description">
            Mesure de la r√©gularit√© des seuils (plus bas = plus r√©gulier)
          </div>
        </div>
        
        <div class="seuil-card" *ngIf="predictionResponse.statistiquesHistoriques?.nombreOccurrencesSeuil">
          <div class="seuil-label">Nombre d'Occurrences Analys√©es</div>
          <div class="seuil-value">{{ predictionResponse.statistiquesHistoriques.nombreOccurrencesSeuil }}</div>
          <div class="seuil-description">
            Nombre d'op√©rations utilis√©es pour calculer les seuils
          </div>
        </div>
      </div>
    </div>

    <!-- Graphique -->
    <div class="chart-container">
      <canvas id="predictionChart"></canvas>
    </div>

    <!-- Tableau des pr√©dictions -->
    <div class="table-container">
      <h3>Pr√©dictions D√©taill√©es par Jour</h3>
      <table class="predictions-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Jour de la Semaine</th>
            <th>Montant Pr√©dit</th>
            <th>Nombre d'Op√©rations</th>
            <th>Confiance</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let prediction of predictionResponse.predictionsParJour">
            <td>{{ prediction.date | date:'dd/MM/yyyy' }}</td>
            <td>{{ prediction.jourSemaine }}</td>
            <td class="amount">{{ formatCurrency(prediction.montantPrediction) }}</td>
            <td>{{ prediction.nombreOperationsPredites }}</td>
            <td>
              <span class="confidence-badge" [ngClass]="{
                'high': prediction.confiance >= 0.7,
                'medium': prediction.confiance >= 0.4 && prediction.confiance < 0.7,
                'low': prediction.confiance < 0.4
              }">
                {{ formatPercent(prediction.confiance) }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

