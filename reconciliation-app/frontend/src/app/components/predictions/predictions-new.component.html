<div class="supply-prediction-container">

  <!-- Toast notifications -->
  <div *ngIf="toastMessage" class="toast" [ngClass]="'toast-' + toastType">
    <span class="toast-icon" *ngIf="toastType === 'success'">‚úÖ</span>
    <span class="toast-icon" *ngIf="toastType === 'error'">‚ùå</span>
    <span class="toast-icon" *ngIf="toastType === 'info'">‚ÑπÔ∏è</span>
    <span class="toast-message">{{ toastMessage }}</span>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="header-top">
      <button (click)="goBack()" class="btn-back">
        <i class="fas fa-arrow-left"></i> Retour
      </button>
      <h1>üì¶ Syst√®me de Pr√©diction {{ isCompensationType() ? 'des Compensations' : 'de la Tr√©sorerie' }}</h1>
    </div>
    <p class="subtitle">
      {{ isCompensationType() 
        ? 'Analysez les patterns de compensation et pr√©disez les besoins futurs bas√©s sur la fr√©quence et les soldes'
        : 'Analysez vos donn√©es historiques pour optimiser la gestion du tr√©so et pr√©dire les besoins futurs en approvisionnements' 
      }}
    </p>
  </div>

  <!-- Configuration Section (Enhanced) -->
  <div class="config-section" *ngIf="showConfig">
    <div class="config-header">
      <h2>‚öôÔ∏è Configuration {{ isCompensationType() ? 'des Compensations' : 'des Approvisionnements' }}</h2>
      <button type="button" (click)="showConfig = false" class="btn-close-config" title="Masquer la configuration">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form [formGroup]="configForm">
      <div class="config-grid">
        <!-- Configuration commune -->
        <div class="form-group" *ngIf="!isCompensationType()">
          <label>D√©lai d'Approvisionnement (jours)</label>
          <input type="number" formControlName="leadTimeDays" class="form-control" min="1" max="30">
          <small>Temps n√©cessaire pour recevoir un approvisionnement</small>
        </div>
        
        <div class="form-group" *ngIf="!isCompensationType()">
          <label>Facteur de S√©curit√©</label>
          <input type="number" formControlName="safetyFactor" class="form-control" step="0.1" min="1.0" max="3.0">
          <small>Multiplie le stock de s√©curit√© (1.0-3.0)</small>
        </div>
        
        <!-- Configuration sp√©cifique aux compensations -->
        <div class="form-group" *ngIf="isCompensationType()">
          <label>Seuil de Compensation (XOF) *</label>
          <input type="number" formControlName="compensationThresholdAmount" class="form-control" min="0">
          <small>Solde maximum : lorsque le solde atteint ou d√©passe ce seuil, une compensation est d√©clench√©e</small>
        </div>
        
        <div class="form-group">
          <label>Seuil Urgent (jours)</label>
          <input type="number" formControlName="urgentThresholdDays" class="form-control" min="1">
          <small>{{ isCompensationType() ? 'Jours avant la prochaine compensation n√©cessaire' : 'Jours avant rupture de stock' }}</small>
        </div>
        
        <div class="form-group">
          <label>Seuil Normal (jours)</label>
          <input type="number" formControlName="normalThresholdDays" class="form-control" min="1">
          <small>{{ isCompensationType() ? 'Jours confortables avant compensation' : 'Jours confortables avant rupture' }}</small>
        </div>
        <!-- Nouveaux param√®tres pour la pr√©cision -->
        <div class="form-group">
          <label>Analyse Saisonni√®re</label>
          <div class="checkbox-wrapper">
            <input type="checkbox" formControlName="seasonalityEnabled" id="seasonality">
            <label for="seasonality">Activer la d√©tection de saisonnalit√©</label>
          </div>
          <small>D√©tecte les patterns r√©currents dans le temps</small>
        </div>
        <div class="form-group">
          <label>Analyse de Tendance</label>
          <div class="checkbox-wrapper">
            <input type="checkbox" formControlName="trendAnalysisEnabled" id="trend">
            <label for="trend">Activer l'analyse des tendances</label>
          </div>
          <small>Identifie les √©volutions √† long terme</small>
        </div>
        <div class="form-group">
          <label>Poids de Volatilit√©</label>
          <input type="number" formControlName="volatilityWeight" class="form-control" step="0.1" min="0" max="1">
          <small>Impact de la variabilit√© sur les pr√©dictions (0-1)</small>
        </div>
        <div class="form-group">
          <label>Seuil de Confiance</label>
          <input type="number" formControlName="predictionConfidenceThreshold" class="form-control" step="0.05" min="0" max="1">
          <small>Niveau de confiance minimum requis (0-1)</small>
        </div>
      </div>
      <div class="action-buttons">
        <button (click)="saveConfiguration()" class="btn btn-secondary">
          üíæ Sauvegarder Configuration
        </button>
      </div>
    </form>
  </div>

  <!-- Bouton pour afficher la configuration -->
  <div class="config-toggle-section" *ngIf="!showConfig">
    <button type="button" (click)="showConfig = true" class="btn btn-secondary btn-show-config">
      <i class="fas fa-cog"></i> Afficher la Configuration
    </button>
  </div>

  <!-- Formulaire d'analyse -->
  <div class="analysis-section">
    <h2>üîç Param√®tres d'Analyse</h2>
    <form [formGroup]="analysisForm">
      <div class="form-grid">
        <div class="form-group">
          <label>Type d'Op√©ration *</label>
          <select formControlName="typeOperation" class="form-control">
            <option value="">-- S√©lectionner --</option>
            <option *ngFor="let type of availableTypes" [value]="type.value">{{ type.label }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Pays (optionnel)</label>
          <input type="text" formControlName="pays" class="form-control" placeholder="Ex: CI, SN, CM">
        </div>
        <div class="form-group">
          <label>P√©riode d'Analyse (jours)</label>
          <input type="number" formControlName="periodeAnalyseJours" class="form-control" min="7" max="730">
        </div>
        <div class="form-group">
          <label>Calendrier (jours)</label>
          <input type="number" formControlName="calendarDays" class="form-control" min="7" max="365">
        </div>
      </div>
      <div class="action-buttons">
        <button (click)="loadMetrics()" class="btn btn-secondary" [disabled]="!analysisForm.get('typeOperation')?.value">
          üìä M√©triques Globales
        </button>
        <button (click)="loadRecommendations()" class="btn btn-primary" [disabled]="isLoading || !analysisForm.get('typeOperation')?.value">
          üìã Recommandations
        </button>
        <button (click)="loadCalendar()" class="btn btn-primary" [disabled]="isLoading || !analysisForm.get('typeOperation')?.value">
          üìÖ Calendrier
        </button>
      </div>
    </form>
  </div>

  <!-- Message d'erreur -->
  <div *ngIf="errorMessage" class="alert alert-error">
    <strong>Erreur:</strong> {{ errorMessage }}
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-spinner">
    <div class="spinner"></div>
    <p>Chargement en cours...</p>
  </div>

  <!-- Onglets de navigation -->
  <div *ngIf="(metrics || compensationMetrics) || (recommendations.length > 0 || compensationRecommendations.length > 0) || (calendar || compensationCalendar)" class="tabs-navigation">
    <button 
      class="tab-button" 
      [class.active]="selectedTab === 'overview'"
      (click)="selectedTab = 'overview'"
      [disabled]="!metrics && !compensationMetrics">
      üìä Vue d'Ensemble
    </button>
    <button 
      class="tab-button" 
      [class.active]="selectedTab === 'recommendations'"
      (click)="selectedTab = 'recommendations'"
      [disabled]="recommendations.length === 0 && compensationRecommendations.length === 0">
      üìã Recommandations
      <span *ngIf="recommendations.length > 0 || compensationRecommendations.length > 0" class="badge">
        {{ isCompensationType() ? compensationRecommendations.length : recommendations.length }}
      </span>
    </button>
    <button 
      class="tab-button" 
      [class.active]="selectedTab === 'calendar'"
      (click)="selectedTab = 'calendar'"
      [disabled]="!calendar && !compensationCalendar">
      üìÖ Calendrier
    </button>
    <button 
      class="tab-button" 
      [class.active]="selectedTab === 'analytics'"
      (click)="selectedTab = 'analytics'"
      [disabled]="!selectedAgencyAnalytics && !selectedCompensationAnalytics">
      üîç Analytiques
    </button>
  </div>

  <!-- ============================================ -->
  <!-- M√âTRIQUES APPROVISIONNEMENTS -->
  <!-- ============================================ -->
  <div *ngIf="metrics && selectedTab === 'overview' && !isCompensationType()" class="metrics-section">
    <h2>üìä Vue d'Ensemble - Approvisionnements</h2>
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-icon">üè¢</div>
        <div class="metric-content">
          <div class="metric-label">Total Agences</div>
          <div class="metric-value">{{ metrics.totalAgencies }}</div>
        </div>
      </div>
      <div class="metric-card critical">
        <div class="metric-icon">üö®</div>
        <div class="metric-content">
          <div class="metric-label">Agences Critiques</div>
          <div class="metric-value">{{ metrics.criticalAgencies }}</div>
        </div>
      </div>
      <div class="metric-card warning">
        <div class="metric-icon">‚ö†Ô∏è</div>
        <div class="metric-content">
          <div class="metric-label">Surstock</div>
          <div class="metric-value">{{ metrics.overstockedAgencies }}</div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-icon">üìä</div>
        <div class="metric-content">
          <div class="metric-label">Confiance Moyenne</div>
          <div class="metric-value">{{ formatPercent(metrics.averageConfidenceLevel) }}</div>
        </div>
      </div>
      <div class="metric-card urgent">
        <div class="metric-icon">üî¥</div>
        <div class="metric-content">
          <div class="metric-label">Commandes Urgentes</div>
          <div class="metric-value">{{ metrics.urgentOrders }}</div>
        </div>
      </div>
      <div class="metric-card normal">
        <div class="metric-icon">üü°</div>
        <div class="metric-content">
          <div class="metric-label">Commandes Normales</div>
          <div class="metric-value">{{ metrics.normalOrders }}</div>
        </div>
      </div>
    </div>

    <!-- Alertes critiques -->
    <div *ngIf="metrics.topCriticalAgencies && metrics.topCriticalAgencies.length > 0" class="critical-alerts-section">
      <div class="alert-banner critical">
        <div class="alert-icon">üö®</div>
        <div class="alert-content">
          <h3>Attention : {{ metrics.topCriticalAgencies.length }} agence(s) en situation critique</h3>
          <div class="alert-list">
            <div *ngFor="let agency of metrics.topCriticalAgencies.slice(0, 5)" class="alert-item">
              <button 
                class="alert-link" 
                (click)="loadAgencyAnalytics(agency.codeProprietaire)">
                <strong>{{ agency.codeProprietaire }}</strong>
                <span class="alert-days">{{ agency.value | number:'1.0-0' }} jours restants</span>
              </button>
            </div>
            <p *ngIf="metrics.topCriticalAgencies.length > 5" class="alert-more">
              Et {{ metrics.topCriticalAgencies.length - 5 }} autre(s) agence(s)...
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- M√âTRIQUES COMPENSATIONS -->
  <!-- ============================================ -->
  <div *ngIf="compensationMetrics && selectedTab === 'overview' && isCompensationType()" class="metrics-section">
    <h2>üìä Vue d'Ensemble - Compensations</h2>
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-icon">üè¢</div>
        <div class="metric-content">
          <div class="metric-label">Total Agences</div>
          <div class="metric-value">{{ compensationMetrics.totalAgencies }}</div>
        </div>
      </div>
      <div class="metric-card critical">
        <div class="metric-icon">üí∞</div>
        <div class="metric-content">
          <div class="metric-label">N√©cessitant Compensation</div>
          <div class="metric-value">{{ compensationMetrics.agenciesNeedingCompensation }}</div>
        </div>
      </div>
      <div class="metric-card urgent">
        <div class="metric-icon">üö®</div>
        <div class="metric-content">
          <div class="metric-label">Compensations Urgentes</div>
          <div class="metric-value">{{ compensationMetrics.urgentCompensations }}</div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-icon">üìÖ</div>
        <div class="metric-content">
          <div class="metric-label">Fr√©quence Moyenne (jours)</div>
          <div class="metric-value">{{ compensationMetrics.averageCompensationFrequency | number:'1.0-0' }}</div>
        </div>
      </div>
      <div class="metric-card success">
        <div class="metric-icon">üíµ</div>
        <div class="metric-content">
          <div class="metric-label">Montant Total Pr√©vu</div>
          <div class="metric-value">{{ formatCurrency(compensationMetrics.totalCompensationAmount) }}</div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-icon">üìà</div>
        <div class="metric-content">
          <div class="metric-label">Montant Moyen</div>
          <div class="metric-value">{{ formatCurrency(compensationMetrics.averageCompensationAmount) }}</div>
        </div>
      </div>
      <div class="metric-card warning">
        <div class="metric-icon">‚¨ÜÔ∏è</div>
        <div class="metric-content">
          <div class="metric-label">Atteignant le Seuil</div>
          <div class="metric-value">{{ compensationMetrics.agenciesAboveThreshold }}</div>
        </div>
      </div>
      <div class="metric-card info">
        <div class="metric-icon">‚¨áÔ∏è</div>
        <div class="metric-content">
          <div class="metric-label">En-dessous du Seuil</div>
          <div class="metric-value">{{ compensationMetrics.agenciesBelowThreshold }}</div>
        </div>
      </div>
    </div>

    <!-- Info sur le seuil configur√© -->
    <div class="info-banner">
      <div class="info-icon">‚ÑπÔ∏è</div>
      <div class="info-content">
        <p><strong>Seuil de Compensation Configur√©:</strong> {{ formatCurrency(configForm.get('compensationThresholdAmount')?.value) }}</p>
        <p>Lorsqu'une agence atteint un solde √©gal ou sup√©rieur √† ce seuil maximum, une compensation est d√©clench√©e.</p>
        <p style="margin-top: 10px;">
          <button type="button" (click)="openThresholdModal()" class="btn btn-secondary btn-sm" *ngIf="isCompensationType()">
            <i class="fas fa-cog"></i> G√©rer les Seuils Personnalis√©s par Agence
          </button>
        </p>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- RECOMMANDATIONS APPROVISIONNEMENTS -->
  <!-- ============================================ -->
  <div *ngIf="selectedTab === 'recommendations' && recommendations.length > 0 && !isCompensationType()" class="recommendations-section">
    <h2>üìã Recommandations d'Approvisionnement</h2>
    <div class="recommendations-list">
      <div *ngFor="let rec of recommendations" class="recommendation-card" [ngClass]="getAlertClass(rec.alertLevel)">
        <div class="recommendation-header">
          <div class="agency-info">
            <span class="alert-icon">{{ getAlertIcon(rec.alertLevel) }}</span>
            <div>
              <div class="agency-code">{{ rec.codeProprietaire }}</div>
              <div class="agency-name">{{ rec.agence || rec.codeProprietaire }}</div>
            </div>
          </div>
          <span class="alert-badge" [ngClass]="getAlertClass(rec.alertLevel)">{{ rec.alertLevel.toUpperCase() }}</span>
        </div>
        <div class="recommendation-body">
          <div class="recommendation-grid">
            <div class="recommendation-item">
              <div class="item-label">Date Recommand√©e</div>
              <div class="item-value">{{ rec.predictedDate | date:'dd/MM/yyyy' }}</div>
            </div>
            <div class="recommendation-item">
              <div class="item-label">Solde Recommand√©</div>
              <div class="item-value amount">{{ formatCurrency(rec.recommendedBalance || rec.recommendedQuantity) }}</div>
            </div>
            <div class="recommendation-item">
              <div class="item-label">Solde Actuel</div>
              <div class="item-value">{{ formatCurrency(rec.currentBalance || rec.currentStock) }}</div>
            </div>
            <div class="recommendation-item">
              <div class="item-label">Consommation Moyenne/Jour</div>
              <div class="item-value">{{ formatCurrency(rec.averageConsumptionDaily || rec.averageConsumption) }}</div>
            </div>
            <div class="recommendation-item">
              <div class="item-label">Jours Avant Rupture</div>
              <div class="item-value" [ngClass]="{'urgent': rec.daysUntilStockout <= 2}">{{ rec.daysUntilStockout }}</div>
            </div>
            <div class="recommendation-item">
              <div class="item-label">Stock de S√©curit√©</div>
              <div class="item-value">{{ formatCurrency(rec.safetyStock) }}</div>
            </div>
            <div class="recommendation-item">
              <div class="item-label">Confiance</div>
              <div class="item-value">{{ formatPercent(rec.confidenceLevel) }}</div>
            </div>
            <div class="recommendation-item" *ngIf="rec.volatilityScore">
              <div class="item-label">Volatilit√©</div>
              <div class="item-value">{{ formatPercent(rec.volatilityScore) }}</div>
            </div>
          </div>
          <button class="btn btn-small" (click)="loadAgencyAnalytics(rec.codeProprietaire)">
            üîç Voir les Analytiques
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- RECOMMANDATIONS COMPENSATIONS -->
  <!-- ============================================ -->
  <div *ngIf="selectedTab === 'recommendations' && compensationRecommendations.length > 0 && isCompensationType()" class="recommendations-section">
    <h2>üìã Recommandations de Compensation</h2>
    <div class="recommendations-list">
      <div *ngFor="let rec of compensationRecommendations" class="recommendation-card" [ngClass]="getAlertClass(rec.alertLevel)">
        <div class="recommendation-header">
          <div class="agency-info">
            <span class="alert-icon">{{ getAlertIcon(rec.alertLevel) }}</span>
            <div>
              <div class="agency-code">{{ rec.codeProprietaire }}</div>
              <div class="agency-name">{{ rec.agence }}</div>
            </div>
          </div>
          <span class="alert-badge" [ngClass]="getAlertClass(rec.alertLevel)">{{ rec.alertLevel.toUpperCase() }}</span>
        </div>
        <div class="recommendation-body">
          <div class="recommendation-grid">
            <div class="recommendation-item">
              <div class="item-label">Date Pr√©vue</div>
              <div class="item-value">{{ rec.predictedDate | date:'dd/MM/yyyy' }}</div>
            </div>
            <div class="recommendation-item">
              <div class="item-label">Montant Recommand√©</div>
              <div class="item-value amount">{{ formatCurrency(rec.recommendedAmount) }}</div>
            </div>
            <div class="recommendation-item">
              <div class="item-label">Solde Actuel</div>
              <div class="item-value">{{ formatCurrency(rec.currentBalance) }}</div>
            </div>
            <div class="recommendation-item">
              <div class="item-label">
                Seuil Maximum (XOF)
                <span class="custom-threshold-badge" *ngIf="hasCustomThreshold(rec.codeProprietaire)" title="Seuil personnalis√©">
                  <i class="fas fa-star"></i> Personnalis√©
                </span>
              </div>
              <div class="item-value">{{ formatCurrency(rec.thresholdAmount) }}</div>
            </div>
            <div class="recommendation-item">
              <div class="item-label">Montant Moyen Compensation</div>
              <div class="item-value">{{ formatCurrency(rec.averageCompensationAmount) }}</div>
            </div>
            <div class="recommendation-item">
              <div class="item-label">Fr√©quence (jours)</div>
              <div class="item-value">{{ rec.compensationFrequencyDays | number:'1.0-0' }}</div>
            </div>
            <div class="recommendation-item">
              <div class="item-label">Derni√®re Compensation</div>
              <div class="item-value">{{ rec.lastCompensationDate ? (rec.lastCompensationDate | date:'dd/MM/yyyy') : 'Aucune' }}</div>
            </div>
            <div class="recommendation-item">
              <div class="item-label">Jours Depuis Derni√®re</div>
              <div class="item-value">{{ rec.daysSinceLastCompensation | number:'1.0-0' }}</div>
            </div>
            <div class="recommendation-item">
              <div class="item-label">Pattern</div>
              <div class="item-value">{{ getCompensationPatternLabel(rec.compensationPattern) }}</div>
            </div>
            <div class="recommendation-item">
              <div class="item-label">Confiance</div>
              <div class="item-value">{{ formatPercent(rec.confidenceLevel) }}</div>
            </div>
          </div>
          <button class="btn btn-small" (click)="loadAgencyAnalytics(rec.codeProprietaire)">
            üîç Voir les Analytiques
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- CALENDRIER (Commun mais adapt√©) -->
  <!-- ============================================ -->
  <div *ngIf="selectedTab === 'calendar' && (calendar || compensationCalendar)" class="calendar-section">
    <h2>üìÖ Calendrier Pr√©dictif {{ isCompensationType() ? 'de Compensation' : 'd\'Approvisionnement' }}</h2>
    
    <div class="calendar-summary">
      <div class="summary-item">
        <span class="summary-label">Total {{ isCompensationType() ? 'Compensations' : 'Commandes' }}:</span>
        <span class="summary-value">{{ (isCompensationType() ? compensationCalendar?.totalOrders : calendar?.totalOrders) || 0 }}</span>
      </div>
      <div class="summary-item urgent">
        <span class="summary-label">Urgentes:</span>
        <span class="summary-value">{{ (isCompensationType() ? compensationCalendar?.urgentOrders : calendar?.urgentOrders) || 0 }}</span>
      </div>
      <div class="summary-item normal">
        <span class="summary-label">Normales:</span>
        <span class="summary-value">{{ (isCompensationType() ? compensationCalendar?.normalOrders : calendar?.normalOrders) || 0 }}</span>
      </div>
      <div class="summary-item low">
        <span class="summary-label">Faible Priorit√©:</span>
        <span class="summary-value">{{ (isCompensationType() ? compensationCalendar?.lowPriorityOrders : calendar?.lowPriorityOrders) || 0 }}</span>
      </div>
    </div>
    
    <div *ngIf="getCalendarWeeks().length === 0" class="empty-calendar">
      <p>Aucun {{ isCompensationType() ? 'compensation pr√©vue' : 'approvisionnement pr√©vu' }} dans les {{ analysisForm.get('calendarDays')?.value || 30 }} prochains jours</p>
    </div>
    
    <!-- Calendrier group√© par semaine -->
    <div *ngIf="getCalendarWeeks().length > 0" class="calendar-weeks">
      <div *ngFor="let weekEntry of getCalendarWeeks()" class="calendar-week">
        <div class="week-header">
          <h3>Semaine du {{ weekEntry.week }}</h3>
          <span class="week-count">{{ weekEntry.events.length }} √©v√©nement(s)</span>
        </div>
        <div class="week-events">
          <div *ngFor="let event of weekEntry.events" class="calendar-event" [ngClass]="getAlertClass(event.alertLevel)">
            <div class="event-date">{{ formatDate(event.date) }}</div>
            <div class="event-agency">{{ event.agence || event.codeProprietaire }}</div>
            <div class="event-quantity">{{ formatCurrency(getEventRecommendedBalance(event)) }}</div>
            <span class="event-badge" [ngClass]="getAlertClass(event.alertLevel)">{{ event.alertLevel }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- ANALYTIQUES APPROVISIONNEMENTS -->
  <!-- ============================================ -->
  <div *ngIf="selectedTab === 'analytics' && selectedAgencyAnalytics && !isCompensationType()" class="analytics-section">
    <h2>üîç Analytiques D√©taill√©es - {{ selectedAgencyAnalytics.agence || selectedAgencyAnalytics.codeProprietaire }}</h2>
    <div class="analytics-grid">
      <div class="analytics-card">
        <h3>üìà Consommation</h3>
        <div class="analytics-item">
          <span>Journali√®re:</span>
          <strong>{{ formatCurrency(selectedAgencyAnalytics.averageConsumptionDaily) }}</strong>
        </div>
        <div class="analytics-item">
          <span>Hebdomadaire:</span>
          <strong>{{ formatCurrency(selectedAgencyAnalytics.averageConsumptionWeekly) }}</strong>
        </div>
        <div class="analytics-item">
          <span>Mensuelle:</span>
          <strong>{{ formatCurrency(selectedAgencyAnalytics.averageConsumptionMonthly) }}</strong>
        </div>
        <div class="analytics-item">
          <span>Tendance:</span>
          <strong [ngClass]="{
            'trend-increasing': selectedAgencyAnalytics.consumptionTrend === 'increasing',
            'trend-decreasing': selectedAgencyAnalytics.consumptionTrend === 'decreasing',
            'trend-stable': selectedAgencyAnalytics.consumptionTrend === 'stable'
          }">
            {{ selectedAgencyAnalytics.consumptionTrend === 'increasing' ? 'üìà Croissante' : 
               selectedAgencyAnalytics.consumptionTrend === 'decreasing' ? 'üìâ D√©croissante' : 
               '‚û°Ô∏è Stable' }}
          </strong>
        </div>
      </div>
      <div class="analytics-card">
        <h3>üè¶ Stock</h3>
        <div class="analytics-item">
          <span>Actuel:</span>
          <strong>{{ formatCurrency(selectedAgencyAnalytics.currentStock) }}</strong>
        </div>
        <div class="analytics-item">
          <span>Jours de Stock:</span>
          <strong>{{ selectedAgencyAnalytics.stockDays }}</strong>
        </div>
        <div class="analytics-item">
          <span>Stock Moyen:</span>
          <strong>{{ formatCurrency(selectedAgencyAnalytics.averageStock || 0) }}</strong>
        </div>
      </div>
      <div class="analytics-card">
        <h3>üìä Performance</h3>
        <div class="analytics-item">
          <span>Taux de Rotation:</span>
          <strong>{{ selectedAgencyAnalytics.turnoverRate | number:'1.2-2' }}</strong>
        </div>
        <div class="analytics-item">
          <span>Risque de Rupture:</span>
          <strong [ngClass]="{'risk-high': computeStockoutRiskPercent(selectedAgencyAnalytics) >= 50}">
            {{ computeStockoutRiskPercent(selectedAgencyAnalytics) }}%
          </strong>
        </div>
        <div class="analytics-item">
          <span>Statut:</span>
          <strong>
            <span [ngClass]="getStatusClass(getStatusFromRiskPercent(selectedAgencyAnalytics))">
              {{ getStatusLabel(getStatusFromRiskPercent(selectedAgencyAnalytics)) }}
            </span>
          </strong>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- ANALYTIQUES COMPENSATIONS -->
  <!-- ============================================ -->
  <div *ngIf="selectedTab === 'analytics' && selectedCompensationAnalytics && isCompensationType()" class="analytics-section">
    <h2>üîç Analytiques Compensation - {{ selectedCompensationAnalytics.agence || selectedCompensationAnalytics.codeProprietaire }}</h2>
    <div class="analytics-grid">
      <div class="analytics-card">
        <h3>üí∞ Solde & Seuil</h3>
        <div class="analytics-item">
          <span>Solde Actuel:</span>
          <strong>{{ formatCurrency(selectedCompensationAnalytics.currentBalance) }}</strong>
        </div>
        <div class="analytics-item">
          <span>Seuil Maximum (XOF):</span>
          <strong>{{ formatCurrency(configForm.get('compensationThresholdAmount')?.value) }}</strong>
        </div>
        <div class="analytics-item">
          <span>Diff√©rence:</span>
          <strong [ngClass]="{
            'amount-positive': selectedCompensationAnalytics.currentBalance >= configForm.get('compensationThresholdAmount')?.value,
            'amount-negative': selectedCompensationAnalytics.currentBalance < configForm.get('compensationThresholdAmount')?.value
          }">
            {{ formatCurrency(selectedCompensationAnalytics.currentBalance - configForm.get('compensationThresholdAmount')?.value) }}
          </strong>
          <small style="display: block; margin-top: 4px; color: #7f8c8d; font-size: 0.85rem;" *ngIf="selectedCompensationAnalytics.currentBalance >= configForm.get('compensationThresholdAmount')?.value">
            ‚ö†Ô∏è Seuil atteint - Compensation n√©cessaire
          </small>
        </div>
      </div>
      
      <div class="analytics-card">
        <h3>üìÖ Historique Compensations</h3>
        <div class="analytics-item">
          <span>Total Compensations:</span>
          <strong>{{ selectedCompensationAnalytics.totalCompensations }}</strong>
        </div>
        <div class="analytics-item">
          <span>Montant Moyen:</span>
          <strong>{{ formatCurrency(selectedCompensationAnalytics.averageCompensationAmount) }}</strong>
        </div>
        <div class="analytics-item">
          <span>Fr√©quence (jours):</span>
          <strong>{{ selectedCompensationAnalytics.compensationFrequencyDays | number:'1.0-0' }}</strong>
        </div>
        <div class="analytics-item">
          <span>Derni√®re Compensation:</span>
          <strong>{{ selectedCompensationAnalytics.lastCompensationDate ? (selectedCompensationAnalytics.lastCompensationDate | date:'dd/MM/yyyy') : 'Aucune' }}</strong>
        </div>
        <div class="analytics-item">
          <span>Jours Depuis:</span>
          <strong>{{ selectedCompensationAnalytics.daysSinceLastCompensation | number:'1.0-0' }}</strong>
        </div>
      </div>
      
      <div class="analytics-card">
        <h3>üìä Pr√©dictions & Tendances</h3>
        <div class="analytics-item">
          <span>Prochaine Compensation:</span>
          <strong>{{ selectedCompensationAnalytics.predictedNextCompensation | date:'dd/MM/yyyy' }}</strong>
        </div>
        <div class="analytics-item">
          <span>Tendance:</span>
          <strong [ngClass]="{
            'trend-increasing': selectedCompensationAnalytics.compensationTrend === 'increasing',
            'trend-decreasing': selectedCompensationAnalytics.compensationTrend === 'decreasing',
            'trend-stable': selectedCompensationAnalytics.compensationTrend === 'stable'
          }">
            {{ selectedCompensationAnalytics.compensationTrend === 'increasing' ? 'üìà Croissante' : 
               selectedCompensationAnalytics.compensationTrend === 'decreasing' ? 'üìâ D√©croissante' : 
               '‚û°Ô∏è Stable' }}
          </strong>
        </div>
        <div class="analytics-item">
          <span>Volatilit√©:</span>
          <strong>{{ formatPercent(selectedCompensationAnalytics.volatility) }}</strong>
        </div>
        <div class="analytics-item">
          <span>Facteur Saisonnier:</span>
          <strong>{{ selectedCompensationAnalytics.seasonalityFactor | number:'1.2-2' }}</strong>
        </div>
        <div class="analytics-item">
          <span>Niveau de Risque:</span>
          <strong [ngClass]="getRiskLevelClass(selectedCompensationAnalytics.riskLevel)">
            {{ getRiskLevelLabel(selectedCompensationAnalytics.riskLevel) }}
          </strong>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- MODAL POUR LA GESTION DES SEUILS PERSONNALIS√âS -->
  <!-- ============================================ -->
  <div class="modal-overlay" *ngIf="showThresholdsModal" (click)="closeThresholdModal()">
    <div class="modal-content" (click)="$event.stopPropagation()" *ngIf="isCompensationType()">
      <div class="modal-header">
        <h2>
          <i class="fas fa-sliders-h"></i> 
          {{ editingThreshold ? 'Modifier le Seuil Personnalis√©' : 'Cr√©er un Seuil Personnalis√©' }}
        </h2>
        <button type="button" (click)="closeThresholdModal()" class="btn-close-modal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <!-- Formulaire de cr√©ation/modification -->
        <form [formGroup]="thresholdForm" (ngSubmit)="saveThreshold()">
          <div class="form-group">
            <label>Code Propri√©taire *</label>
            <input 
              type="text" 
              formControlName="codeProprietaire" 
              class="form-control"
              [readonly]="!!editingThreshold"
              placeholder="Ex: AGENCE_DAKAR">
            <small>Code unique de l'agence</small>
          </div>
          
          <div class="form-group">
            <label>Seuil Maximum (XOF) *</label>
            <input 
              type="number" 
              formControlName="thresholdAmount" 
              class="form-control"
              min="1"
              placeholder="Montant en XOF">
            <small>Solde maximum d√©clenchant une compensation pour cette agence</small>
          </div>
          
          <div class="form-group">
            <label>Seuil Global</label>
            <input 
              type="text" 
              [value]="formatCurrency(configForm.get('compensationThresholdAmount')?.value)" 
              class="form-control"
              readonly>
            <small>Seuil utilis√© par d√©faut pour toutes les agences</small>
          </div>
          
          <div class="modal-actions">
            <button type="button" (click)="closeThresholdModal()" class="btn btn-secondary">
              Annuler
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="thresholdForm.invalid || isLoading">
              <i class="fas fa-save"></i> {{ editingThreshold ? 'Modifier' : 'Cr√©er' }}
            </button>
          </div>
        </form>
        
        <!-- Liste des seuils personnalis√©s existants -->
        <div class="thresholds-list" *ngIf="agencyThresholds.length > 0">
          <h3>Seuils Personnalis√©s Configur√©s ({{ agencyThresholds.length }})</h3>
          <div class="thresholds-table">
            <table>
              <thead>
                <tr>
                  <th>Agence</th>
                  <th>Code Propri√©taire</th>
                  <th>Seuil (XOF)</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let threshold of agencyThresholds">
                  <td>{{ threshold.agence || threshold.codeProprietaire }}</td>
                  <td>{{ threshold.codeProprietaire }}</td>
                  <td><strong>{{ formatCurrency(threshold.thresholdAmount) }}</strong></td>
                  <td>
                    <button 
                      type="button" 
                      (click)="openThresholdModal(threshold)" 
                      class="btn-icon" 
                      title="Modifier">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button 
                      type="button" 
                      (click)="deleteThreshold(threshold)" 
                      class="btn-icon btn-danger" 
                      title="Supprimer">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="empty-state" *ngIf="agencyThresholds.length === 0">
          <p>Aucun seuil personnalis√© configur√©. Utilisez le formulaire ci-dessus pour en cr√©er un.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- MODAL DE CONFIRMATION G√âN√âRIQUE -->
  <!-- ============================================ -->
  <div class="modal-overlay" *ngIf="showConfirmModal" (click)="onConfirmModal(false)">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <i class="fas fa-exclamation-triangle"></i>
          {{ confirmTitle }}
        </h2>
        <button type="button" (click)="onConfirmModal(false)" class="btn-close-modal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <p>{{ confirmMessage }}</p>
        <div class="modal-actions">
          <button type="button" (click)="onConfirmModal(false)" class="btn btn-secondary">Annuler</button>
          <button type="button" (click)="onConfirmModal(true)" class="btn btn-primary">Confirmer</button>
        </div>
      </div>
    </div>
  </div>
</div>
