<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>üìä Dashboard - Vue d'ensemble</h1>
        <p class="subtitle">Bienvenue dans votre outil de r√©conciliation de donn√©es</p>
        <div class="header-actions">
            <div class="last-update">
                <span *ngIf="!loading">Derni√®re mise √† jour : {{ lastActivity }}</span>
                <span *ngIf="loading">Mise √† jour en cours...</span>
            </div>
            <button class="refresh-btn" (click)="refreshMetrics()" [disabled]="loading">
                <span *ngIf="loading">üîÑ Chargement...</span>
                <span *ngIf="!loading">üîÑ Actualiser</span>
            </button>
        </div>
    </div>

    <!-- Bande d√©filante des soldes par compte -->
    <div class="scrolling-banner-wrapper" *ngIf="accountBalances && accountBalances.length > 0">
        <div class="scrolling-banner-header">
            <span class="banner-title">{{ bannerTitle }}</span>
            <span class="accounts-count">{{ accountBalances.length / 2 }} comptes</span>
        </div>
        <div class="scrolling-banner-container">
            <div class="scrolling-banner">
                <div class="scrolling-content" [style.animation-duration]="getScrollDuration() + 's'">
                    <div *ngFor="let balance of accountBalances" class="balance-item">
                        <span class="country-flag">{{ balance.flag }}</span>
                        <span class="account-name">{{ balance.accountName }}</span>
                        <span class="account-balance">{{ balance.balance | number:'1.0-0' }} FCFA</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-info">
        <div class="info-section">
            <h3>üí° Fonctionnalit√©s principales</h3>
            <ul>
                <li>Upload et comparaison de fichiers CSV/Excel</li>
                <li>R√©conciliation automatique des donn√©es</li>
                <li>Analyse des diff√©rences et correspondances</li>
                <li>G√©n√©ration de rapports d√©taill√©s</li>
                <li>Export des r√©sultats en Excel</li>
            </ul>
        </div>

        <div class="info-section">
            <h3>üìä M√©triques rapides</h3>
            <div *ngIf="error" class="error-message">
                {{ error }}
            </div>
            <div class="metrics-grid">
                <div class="metric">
                    <div class="metric-value">{{totalReconciliations}}</div>
                    <div class="metric-label">Total r√©conciliations</div>
                </div>
                <div class="metric">
                    <div class="metric-value">{{totalFiles}}</div>
                    <div class="metric-label">Fichiers trait√©s</div>
                </div>
                <div class="metric">
                    <div class="metric-value">{{todayReconciliations}}</div>
                    <div class="metric-label">R√©conciliations aujourd'hui</div>
                </div>
                <div class="metric">
                    <div class="metric-value">{{lastActivity}}</div>
                    <div class="metric-label">Derni√®re activit√©</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barre r√©capitulative clients/services/pays -->
    <div class="dashboard-summary-bar" style="display: flex; justify-content: space-between; align-items: center; background: #1976d2; color: #fff; padding: 24px 0; margin: 24px auto; border-radius: 6px; max-width: 1200px; width: 100%;">
      <div style="flex: 1; text-align: center;">
        <div style="font-size: 1.1rem; opacity: 0.8; margin-bottom: 10px;">Nombre de clients</div>
        <div style="font-size: 2.2rem; font-weight: bold;">{{ totalClientsCount }}</div>
      </div>
      <div style="flex: 1; text-align: center;">
        <div style="font-size: 1.1rem; opacity: 0.8; margin-bottom: 10px;">Nombre de services</div>
        <div style="font-size: 2.2rem; font-weight: bold;">{{ totalServicesCount }}</div>
      </div>
      <div style="flex: 1; text-align: center;">
        <div style="font-size: 1.1rem; opacity: 0.8; margin-bottom: 10px;">Nombre de pays</div>
        <div style="font-size: 2.2rem; font-weight: bold;">{{ totalCountriesCount }}</div>
      </div>
    </div>
    <!-- Fin barre r√©capitulative -->

    <!-- Nouvelle section pour les m√©triques d√©taill√©es -->
    <div class="detailed-metrics-section">
        <div class="detailed-metrics-header" style="display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 16px;">
          <div class="metric-select" style="flex: 1; text-align: left; min-width: 180px;">
            <mat-form-field appearance="fill" class="filter-select">
              <mat-label>Afficher</mat-label>
              <mat-select [(ngModel)]="selectedMetric" (selectionChange)="updateBarChartData()">
                <mat-option value="volume">Volume total</mat-option>
                <mat-option value="transactions">Nombre de transactions</mat-option>
                <mat-option value="revenu">Volume des revenus</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
          <div style="flex: 2; text-align: center;">
            <h3 style="margin: 0;">üìà M√©triques d√©taill√©es</h3>
          </div>
          <div class="chart-type-select" style="flex: 1; text-align: right; min-width: 180px;">
            <mat-form-field appearance="fill" class="filter-select">
              <mat-label>Vue</mat-label>
              <mat-select [(ngModel)]="selectedChartType">
                <mat-option value="bar">Barres</mat-option>
                <mat-option value="line">Courbe</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>
            <!-- Espace r√©serv√© pour les futurs graphiques plac√© ici -->
            <div class="graph-placeholder">
              <canvas *ngIf="selectedChartType === 'bar' && barChartData && barChartData.labels?.length" baseChart
                [data]="barChartData"
                [options]="barChartOptions"
                [type]="'bar'"
                [plugins]="[ChartDataLabels]"
                (chartClick)="onBarClick($event)">
              </canvas>
              <canvas *ngIf="selectedChartType === 'line' && lineChartData && lineChartData.labels?.length" baseChart
                [data]="lineChartData"
                [options]="lineChartOptions"
                [type]="'line'">
              </canvas>
              <div *ngIf="(!barChartData || !barChartData.labels?.length) && (!lineChartData || !lineChartData.labels?.length)" class="text">Aucune donn√©e √† afficher</div>
            </div>
            <div class="filters-export-row" style="display: flex; justify-content: space-between; align-items: center; gap: 24px; margin-bottom: 16px;">
              <button class="export-btn" (click)="exportDetailedMetricsExcel()">Exporter Excel</button>
              <div class="filters-container" style="display: flex; gap: 12px; justify-content: center; align-items: center;">
                <div class="filter-group">
                  <mat-form-field appearance="fill" class="filter-select">
                    <mat-label>Client</mat-label>
                    <mat-select #agencySelect [(ngModel)]="selectedAgency" multiple (selectionChange)="onFilterChange()" placeholder="S√©lection multiple possible">
                      <mat-option>
                        <ngx-mat-select-search [formControl]="agenceSearchCtrl" placeholderLabel="Rechercher un client..." noEntriesFoundLabel="Aucun client trouv√©"></ngx-mat-select-search>
                      </mat-option>
                      <mat-option *ngFor="let agency of filteredAgencies" [value]="agency">
                        {{ agency }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
                <div class="filter-group">
                  <mat-form-field appearance="fill" class="filter-select">
                    <mat-label>Service</mat-label>
                    <mat-select #serviceSelect [(ngModel)]="selectedService" multiple (selectionChange)="onFilterChange()" placeholder="S√©lection multiple possible">
                      <mat-option>
                        <ngx-mat-select-search [formControl]="serviceSearchCtrl" placeholderLabel="Rechercher un service..." noEntriesFoundLabel="Aucun service trouv√©"></ngx-mat-select-search>
                      </mat-option>
                      <mat-option *ngFor="let service of filteredServices" [value]="service">
                        {{ service }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
                <div class="filter-group">
                  <mat-form-field appearance="fill" class="filter-select">
                    <mat-label>Pays</mat-label>
                    <mat-select #countrySelect [(ngModel)]="selectedCountry" multiple (selectionChange)="onFilterChange()" placeholder="S√©lection multiple possible">
                      <mat-option>
                        <ngx-mat-select-search [formControl]="paysSearchCtrl" placeholderLabel="Rechercher un pays..." noEntriesFoundLabel="Aucun pays trouv√©"></ngx-mat-select-search>
                      </mat-option>
                      <mat-option *ngFor="let country of filteredCountries" [value]="country">
                        {{ country }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
                <div class="filter-group">
                  <mat-form-field appearance="fill" class="filter-select">
                    <mat-label>P√©riode</mat-label>
                    <mat-select [(ngModel)]="selectedTimeFilter" (selectionChange)="onTimeFilterChange()">
                      <mat-option *ngFor="let timeFilter of filterOptions?.timeFilters" [value]="timeFilter">
                        {{ timeFilter }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>
              <button type="button" (click)="resetFilters()" class="reset-btn">
                <i class="fas fa-undo"></i> R√©initialiser
              </button>
            </div>
        </div>

        <!-- Champs de dates personnalis√©es -->
        <div *ngIf="showCustomDateInputs" class="custom-date-inputs">
            <div class="date-input-group">
                <label for="startDate">Date de d√©but:</label>
                <input type="date" id="startDate" [(ngModel)]="startDate" (change)="onFilterChange()" class="date-input">
            </div>
            <div class="date-input-group">
                <label for="endDate">Date de fin:</label>
                <input type="date" id="endDate" [(ngModel)]="endDate" (change)="onFilterChange()" class="date-input">
            </div>
        </div>

        <div *ngIf="detailedError" class="error-message">
            {{ detailedError }}
        </div>

        <div *ngIf="detailedLoading" class="loading-message">
            Chargement des m√©triques d√©taill√©es...
        </div>

        <div *ngIf="!detailedLoading && detailedMetrics" class="detailed-metrics-content">
            <!-- M√©triques principales -->
            <div class="main-metrics-grid">
                <div class="main-metric">
                    <div class="main-metric-icon">üí∞</div>
                    <div class="main-metric-value">{{detailedMetrics.totalVolume | number:'1.0-0'}}</div>
                    <div class="main-metric-label">Volume Total</div>
                </div>
                <div class="main-metric">
                    <div class="main-metric-icon">üíµ</div>
                    <div class="main-metric-value">{{detailedMetrics.totalFees | number:'1.0-0'}}</div>
                    <div class="main-metric-label">Volume des Revenus</div>
                </div>
                <div class="main-metric">
                    <div class="main-metric-icon">üìä</div>
                    <div class="main-metric-value">{{detailedMetrics.totalTransactions}}</div>
                    <div class="main-metric-label">Transactions</div>
                </div>
                <div class="main-metric">
                    <div class="main-metric-icon">üë•</div>
                    <div class="main-metric-value">{{detailedMetrics.totalClients}}</div>
                    <div class="main-metric-label">Clients</div>
                </div>
                <div class="main-metric">
                    <div class="main-metric-icon">üìà</div>
                    <div class="main-metric-value">{{ getAverageTransactionsPerPeriod() }}</div>
                    <div class="main-metric-label">Transaction moyenne/Jour</div>
                </div>
                <div class="main-metric">
                    <div class="main-metric-icon">üíé</div>
                    <div class="main-metric-value">{{detailedMetrics.averageVolume | number:'1.0-0'}}</div>
                    <div class="main-metric-label">Volume Moyen/Jour</div>
                </div>
                <div class="main-metric">
                    <div class="main-metric-icon">üí∏</div>
                    <div class="main-metric-value">{{detailedMetrics.averageFeesPerDay | number:'1.0-0'}}</div>
                    <div class="main-metric-label">Revenu moyen/Jour</div>
                </div>
            </div>

            <!-- Statistiques par type d'op√©ration -->
            <div class="operation-stats-section">
                <h4>üìã Statistiques par type d'op√©ration</h4>
                <div class="operation-stats-grid">
                    <div *ngFor="let stat of filteredOperationStats" class="operation-stat-card">
                        <div class="operation-stat-header">
                            <span class="operation-type">{{stat.operationType}}</span>
                        </div>
                        <div class="operation-stat-content">
                            <div class="operation-stat-item">
                                <span class="stat-label">Transactions:</span>
                                <span class="stat-value">{{stat.transactionCount}}</span>
                            </div>
                            <div class="operation-stat-item">
                                <span class="stat-label">Volume:</span>
                                <span class="stat-value">{{stat.totalVolume | number:'1.0-0'}}</span>
                            </div>
                            <div class="operation-stat-item">
                                <span class="stat-label">Moyenne:</span>
                                <span class="stat-value">{{stat.averageVolume | number:'1.0-0'}}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fr√©quence par type d'op√©ration -->
            <div class="frequency-stats-section">
                <h4>üìä Fr√©quence par type d'op√©ration</h4>
                <div class="frequency-stats-grid">
                    <div *ngFor="let freq of filteredFrequencyStats" class="frequency-stat-card">
                        <div class="frequency-stat-header">
                            <span class="operation-type">{{freq.operationType}}</span>
                        </div>
                        <div class="frequency-stat-content">
                            <div class="frequency-bar">
                                <div class="frequency-fill" [style.width.%]="getFrequencyPercentage(freq.frequency)"></div>
                            </div>
                            <span class="frequency-value">{{freq.frequency}}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistiques des transactions cr√©√©es par service -->
            <div class="transaction-created-stats-section">
                <div class="bottom-section-header">
                    <h4>üîÑ Transactions cr√©√©es et annul√©es par service</h4>
                    <button class="toggle-btn" [class.active]="showBottomSection" (click)="showBottomSection = !showBottomSection">
                        <span class="toggle-icon">‚ñæ</span>
                        {{ showBottomSection ? 'Masquer' : 'Afficher' }}
                    </button>
                </div>
                <div *ngIf="transactionCreatedLoading && showBottomSection" class="loading-message">
                    Chargement des statistiques des transactions cr√©√©es...
                </div>
                <div *ngIf="transactionCreatedError && showBottomSection" class="error-message">
                    {{ transactionCreatedError }}
                </div>
                <div *ngIf="showBottomSection && transactionCreatedStats && !transactionCreatedLoading" class="transaction-stats-container">
                    <!-- R√©sum√© global -->
                    <div class="global-stats-summary">
                        <div class="summary-card">
                            <div class="summary-icon">üè¶</div>
                            <div class="summary-content">
                                <div class="summary-value">{{ transactionCreatedStats.totalServices }}</div>
                                <div class="summary-label">Services actifs</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">üí∞</div>
                            <div class="summary-content">
                                <div class="summary-value">{{ transactionCreatedStats.totalCashinVolume | number:'1.0-0' }}</div>
                                <div class="summary-label">Volume Total Cashin</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">üí≥</div>
                            <div class="summary-content">
                                <div class="summary-value">{{ transactionCreatedStats.totalPaymentVolume | number:'1.0-0' }}</div>
                                <div class="summary-label">Volume Total Paiement</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">üìä</div>
                            <div class="summary-content">
                                <div class="summary-value">{{ transactionCreatedStats.totalTransactionCount }}</div>
                                <div class="summary-label">Transactions cr√©√©es/annul√©es</div>
                            </div>
                        </div>
                    </div>

                    <!-- D√©tail par service -->
                    <div class="service-stats-table">
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Volume Cashin</th>
                                    <th>Volume Paiement</th>
                                    <th>Total Cashin</th>
                                    <th>Total Paiement</th>
                                    <th>Transactions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let service of transactionCreatedStats.serviceStats">
                                    <td class="service-name">{{ service.service }}</td>
                                    <td class="volume-cell cashin">{{ service.totalCashinVolume | number:'1.0-0' }}</td>
                                    <td class="volume-cell payment">{{ service.totalPaymentVolume | number:'1.0-0' }}</td>
                                    <td class="count-cell cashin">{{ service.totalCashinCount }}</td>
                                    <td class="count-cell payment">{{ service.totalPaymentCount }}</td>
                                    <td class="total-transactions">{{ service.totalTransactions }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
