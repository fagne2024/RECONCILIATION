<div class="users-container">
  <div class="header">
    <div class="header-title">
      <h2><i class="fas fa-users"></i> Gestion des utilisateurs</h2>
      <span class="users-count">{{ filteredUsers.length }} utilisateur(s)</span>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="loadUsers()" title="Rafraîchir la liste">
        <i class="fas fa-sync-alt"></i> Rafraîchir
      </button>
      <button class="btn btn-primary" (click)="showCreateForm = !showCreateForm">
        <i class="fas fa-plus"></i> {{ showCreateForm ? 'Annuler' : 'Nouvel utilisateur' }}
      </button>
    </div>
  </div>

  <!-- Barre de recherche et filtres -->
  <div class="search-filters-bar">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input 
        type="text" 
        [(ngModel)]="searchTerm" 
        placeholder="Rechercher un utilisateur..." 
        class="search-input"
        (input)="applyFilters()">
    </div>
    <div class="filter-box">
      <i class="fas fa-filter"></i>
      <select [(ngModel)]="selectedProfilFilter" (change)="applyFilters()" class="filter-select">
        <option value="">Tous les profils</option>
        <option *ngFor="let profil of profils" [value]="profil.id">{{ profil.nom }}</option>
      </select>
    </div>
    <button *ngIf="searchTerm || selectedProfilFilter" class="btn-clear-filters" (click)="clearFilters()">
      <i class="fas fa-times"></i> Effacer les filtres
    </button>
  </div>

  <!-- Messages d'erreur et de succès -->
  <div *ngIf="errorMessage" class="alert alert-danger">
    <i class="fas fa-exclamation-circle"></i> {{ errorMessage }}
  </div>
  <div *ngIf="successMessage" class="alert alert-success">
    <i class="fas fa-check-circle"></i> {{ successMessage }}
  </div>

  <!-- Formulaire de création -->
  <div *ngIf="showCreateForm" class="form-section">
    <h3>Créer un nouvel utilisateur</h3>
    <form (ngSubmit)="createUser()" #createForm="ngForm">
      <div class="form-group">
        <label for="newUsername">Nom d'utilisateur *</label>
        <input 
          type="text" 
          id="newUsername" 
          name="username" 
          [(ngModel)]="newUser.username" 
          required 
          class="form-control"
          placeholder="Entrez le nom d'utilisateur">
      </div>
      
      <div class="form-group">
        <label for="newEmail">Adresse email *</label>
        <input 
          type="email" 
          id="newEmail" 
          name="email" 
          [(ngModel)]="newUser.email" 
          required 
          class="form-control"
          placeholder="exemple@email.com">
        <small class="form-text text-muted">Le mot de passe sera généré automatiquement et envoyé à cette adresse email</small>
      </div>

      <div class="form-group">
        <label for="newProfil">Profil *</label>
        <select id="newProfil" name="profil" [(ngModel)]="newUser.profil" required class="form-control">
          <option *ngFor="let profil of profils" [ngValue]="profil">{{ profil.nom }}</option>
        </select>
      </div>
      
      <div class="form-actions">
        <button type="submit" class="btn btn-success" [disabled]="isCreating">
          {{ isCreating ? 'Création...' : 'Créer' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="showCreateForm = false">
          Annuler
        </button>
      </div>
    </form>
  </div>

  <!-- Formulaire de modification -->
  <div *ngIf="isEditing && editingUser" class="form-section">
    <h3>Modifier l'utilisateur</h3>
    <form (ngSubmit)="updateUser()" #editForm="ngForm">
      <div class="form-group">
        <label for="editUsername">Nom d'utilisateur *</label>
        <input 
          type="text" 
          id="editUsername" 
          name="username" 
          [(ngModel)]="editingUser.username" 
          required 
          class="form-control"
          placeholder="Entrez le nom d'utilisateur">
      </div>
      
      <div class="form-group">
        <label for="editEmail">Adresse email *</label>
        <input 
          type="email" 
          id="editEmail" 
          name="email" 
          [(ngModel)]="editingUser.email" 
          required 
          class="form-control"
          placeholder="exemple@email.com">
      </div>
      
      <div class="form-group">
        <label for="editPassword">Nouveau mot de passe (optionnel)</label>
        <input 
          type="password" 
          id="editPassword" 
          name="password" 
          [(ngModel)]="editingUser.password" 
          class="form-control"
          placeholder="Laissez vide pour ne pas changer">
      </div>

      <div class="form-group">
        <label for="editProfil">Profil *</label>
        <select id="editProfil" name="profil" [(ngModel)]="editingUser.profil" required class="form-control">
          <option *ngFor="let profil of profils" [ngValue]="profil">{{ profil.nom }}</option>
        </select>
      </div>
      
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          Mettre à jour
        </button>
        <button type="button" class="btn btn-secondary" (click)="cancelEdit()">
          Annuler
        </button>
      </div>
    </form>
  </div>

  <!-- Liste des utilisateurs -->
  <div class="users-list">
    <div *ngIf="filteredUsers.length === 0 && !isLoading" class="no-users">
      <i class="fas fa-user-slash"></i>
      <h3>Aucun utilisateur trouvé</h3>
      <p *ngIf="searchTerm || selectedProfilFilter" class="help-text">
        Aucun utilisateur ne correspond à vos critères de recherche.
        <br>
        <button class="btn-link" (click)="clearFilters()">Effacer les filtres</button>
      </p>
      <p *ngIf="!searchTerm && !selectedProfilFilter" class="help-text">
        Si vous venez de démarrer l'application, les utilisateurs de test peuvent ne pas être encore créés.
        <br>
        <strong>Solutions :</strong>
        <br>
        1. Redémarrez le backend pour exécuter les migrations
        <br>
        2. Exécutez le script de test : <code>.\test-users.ps1</code>
        <br>
        3. Créez manuellement un nouvel utilisateur
      </p>
    </div>
    
    <div *ngIf="filteredUsers.length > 0" class="users-grid">
      <div *ngFor="let user of filteredUsers" class="user-card">
        <div class="user-card-header">
          <div class="user-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="user-info">
            <h3 class="username">
              {{ user.username }}
              <span *ngIf="user.username === 'admin'" class="badge badge-primary">Admin</span>
            </h3>
            <p class="user-id">ID: {{ user.id }}</p>
          </div>
        </div>
        <div class="user-card-body">
          <div class="user-detail">
            <i class="fas fa-user-tag"></i>
            <span class="label">Profil:</span>
            <span class="value">{{ user.profil?.nom || 'Aucun profil' }}</span>
          </div>
          <div class="user-detail" *ngIf="user.email">
            <i class="fas fa-envelope"></i>
            <span class="label">Email:</span>
            <span class="value">{{ user.email }}</span>
          </div>
          <div class="user-detail" *ngIf="getUser2FAStatus(user.id)">
            <i class="fas fa-shield-alt" [class.enabled]="getUser2FAStatus(user.id)?.enabled" [class.disabled]="!getUser2FAStatus(user.id)?.enabled"></i>
            <span class="label">2FA:</span>
            <span class="value" [class.enabled]="getUser2FAStatus(user.id)?.enabled" [class.disabled]="!getUser2FAStatus(user.id)?.enabled">
              {{ getUser2FAStatus(user.id)?.enabled ? 'Activé' : 'Désactivé' }}
            </span>
          </div>
          <div class="user-detail" *ngIf="loading2FAStatus.has(user.id)">
            <i class="fas fa-spinner fa-spin"></i>
            <span class="label">2FA:</span>
            <span class="value">Chargement...</span>
          </div>
        </div>
        <div class="user-card-actions">
          <button 
            class="btn btn-action btn-edit" 
            (click)="editUser(user)"
            [disabled]="isEditing"
            title="Modifier">
            <i class="fas fa-edit"></i> Modifier
          </button>
          <button 
            class="btn btn-action btn-reset-password" 
            (click)="resetUserPassword(user)"
            [disabled]="!user.email"
            [title]="user.email ? 'Réinitialiser le mot de passe' : 'Cet utilisateur n\'a pas d\'email'">
            <i class="fas fa-key"></i> Réinitialiser MDP
          </button>
          <button 
            class="btn btn-action btn-2fa" 
            [class.btn-2fa-enabled]="getUser2FAStatus(user.id)?.enabled"
            [class.btn-2fa-disabled]="!getUser2FAStatus(user.id)?.enabled"
            (click)="toggle2FA(user)"
            [disabled]="loading2FAStatus.has(user.id)"
            [title]="getUser2FAStatus(user.id)?.enabled ? 'Désactiver le 2FA' : 'Activer le 2FA'">
            <i class="fas fa-shield-alt" *ngIf="!loading2FAStatus.has(user.id)"></i>
            <i class="fas fa-spinner fa-spin" *ngIf="loading2FAStatus.has(user.id)"></i>
            {{ getUser2FAStatus(user.id)?.enabled ? 'Désactiver 2FA' : 'Activer 2FA' }}
          </button>
          <button 
            class="btn btn-action btn-reset-2fa" 
            (click)="reset2FA(user)"
            [disabled]="loading2FAStatus.has(user.id) || !getUser2FAStatus(user.id)?.hasSecret"
            [title]="getUser2FAStatus(user.id)?.hasSecret ? 'Réinitialiser le 2FA (supprime la clé secrète)' : 'Aucune clé secrète à réinitialiser'">
            <i class="fas fa-redo" *ngIf="!loading2FAStatus.has(user.id)"></i>
            <i class="fas fa-spinner fa-spin" *ngIf="loading2FAStatus.has(user.id)"></i>
            Réinitialiser 2FA
          </button>
          <button 
            class="btn btn-action btn-delete" 
            (click)="deleteUser(user)"
            [disabled]="user.username === 'admin'"
            [title]="user.username === 'admin' ? 'Impossible de supprimer l\'administrateur' : 'Supprimer'">
            <i class="fas fa-trash"></i> Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>
</div> 