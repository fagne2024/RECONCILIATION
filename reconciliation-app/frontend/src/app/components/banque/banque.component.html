<div class="banque-container">
  <div class="banque-header">
    <h1>üè¶ Module BANQUE</h1>
    <p class="banque-description">Gestion des op√©rations bancaires et des comptes</p>
  </div>

  <div class="banque-content">
    <div class="banque-section">
      <h2>üìä Tableau de Bord Bancaire</h2>
      <div class="banque-stats">
        <div class="stat-card">
          <div class="stat-icon">üí∞</div>
          <div class="stat-info">
            <h3>Solde Total</h3>
            <p class="stat-value">{{ totalSoldeComptes | number:'1.0-0' }} FCFA</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìà</div>
          <div class="stat-info">
            <h3>Op√©rations bancaires</h3>
            <p class="stat-value">{{ totalOperations }}</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üèõÔ∏è</div>
          <div class="stat-info">
            <h3>Comptes</h3>
            <p class="stat-value">{{ totalComptes }}</p>
          </div>
        </div>
        <div class="stat-card warning">
          <div class="stat-icon">‚è≥</div>
          <div class="stat-info">
            <h3>En attente / En cours</h3>
            <p class="stat-value">{{ totalEnAttente }}</p>
          </div>
        </div>
        <div class="stat-card danger">
          <div class="stat-icon">üé´</div>
          <div class="stat-info">
            <h3>Tickets √† cr√©er</h3>
            <p class="stat-value">{{ totalTicketsACreer }}</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üß©</div>
          <div class="stat-info">
            <h3>Suspens</h3>
            <p class="stat-value">{{ totalSuspens }}</p>
          </div>
        </div>
      </div>
    </div>

    <div class="banque-section">
      <h2>üîß Fonctionnalit√©s</h2>
      <div class="banque-features">
        <div class="feature-card" (click)="highlightBankAccounts()" (dblclick)="goToComptes()" title="Cliquez pour voir les comptes Banque ici, double-cliquez pour ouvrir la page Comptes">
          <div class="feature-icon">üí≥</div>
          <h3>Gestion des Comptes</h3>
          <p>Cr√©er et g√©rer les comptes bancaires</p>
        </div>
        <div class="feature-card" (click)="showOperationsTable()">
          <div class="feature-icon">üí∏</div>
          <h3>Op√©rations</h3>
          <p>Effectuer des virements et paiements</p>
        </div>
        <div class="feature-card" (click)="openRapports()">
          <div class="feature-icon">üìã</div>
          <h3>Relev√© bancaire</h3>
          <p>G√©n√©rer un relev√© bancaire</p>
        </div>
        <div class="feature-card" (click)="openSecurite()">
          <div class="feature-icon">üîÅ</div>
          <h3>R√©conciliation banque</h3>
          <p>Lancer la r√©conciliation bancaire</p>
        </div>
      </div>
    </div>

    <div class="banque-section" *ngIf="activeSection === 'rapports'">
      <div class="releve-header">
        <h2>üìã Relev√© bancaire - Import</h2>
        <button class="btn-toggle-comment" (click)="toggleCommentColumn()" [class.active]="showCommentColumn" title="Afficher/Masquer la colonne commentaire">
          <i class="fas" [class.fa-comment]="!showCommentColumn" [class.fa-comment-slash]="showCommentColumn"></i>
          {{ showCommentColumn ? 'Masquer Commentaires' : 'Afficher Commentaires' }}
        </button>
        <div class="actions">
          <label class="file-btn">
            <input type="file" (change)="onReleveFileSelected($event)" accept=".xlsx,.xls,.csv" />
            <i class="fas fa-file-upload"></i> Choisir un fichier
          </label>
          <button class="btn-primary" [disabled]="releveUploading || !releveSelectedFile" (click)="uploadReleve()">
            <i class="fas fa-upload" [class.spin]="releveUploading"></i> Importer
          </button>
          <button class="btn-primary" (click)="downloadReleveTemplate()" title="T√©l√©charger le mod√®le">
            <i class="fas fa-file-excel"></i> Mod√®le
          </button>
          <button class="btn-primary" (click)="exportReleveCSV()" [disabled]="!(filteredReleveRowsForImport && filteredReleveRowsForImport.length)" title="Exporter le relev√© (CSV ;)">
            <i class="fas fa-file-export"></i> Export CSV
          </button>
          <button class="btn-success" (click)="openCreateOperation()" title="Cr√©er une nouvelle op√©ration bancaire">
            <i class="fas fa-plus"></i> Cr√©er Op√©ration
          </button>
          <div class="filter-group" style="margin-left:12px;">
            <label>Lot</label>
            <select [(ngModel)]="releveSelectedBatchId" (change)="relevePage = 1">
              <option value="ALL">Tous les lots</option>
              <option *ngFor="let b of releveBatchOptions" [value]="b.id">{{ b.label }}</option>
            </select>
          </div>
        </div>
      </div>

      <div class="batch-bar" *ngIf="releveBatchId">
        <span class="batch-badge"><i class="fas fa-hashtag"></i> {{ releveBatchId }}</span>
        <span class="muted">{{ releveRows.length }} ligne(s) import√©e(s)</span>
      </div>

      <div *ngIf="releveMessage" class="releve-alert" [ngClass]="releveMessageKind">
        <i class="fas" [ngClass]="{
          'fa-info-circle': releveMessageKind==='info',
          'fa-check-circle': releveMessageKind==='success',
          'fa-exclamation-triangle': releveMessageKind==='error'
        }"></i>
        <span>{{ releveMessage }}</span>
      </div>

      <div class="operations-table-container" *ngIf="releveRows.length">
        <div class="table-container" style="overflow-x: visible;">
          <table class="operations-table">
            <thead>
              <tr>
                <th>Num√©ro de compte</th>
                <th>Nom du compte</th>
                <th>BANQUE</th>
                <th>Date comptable</th>
                <th>Date de valeur</th>
                <th>Libell√© / Narration</th>
                <th class="right">D√©bit</th>
                <th class="right">Cr√©dit</th>
                <th class="right">Montant</th>
                <th>Ch√®que</th>
                <th>Devise</th>
                <th>Num√©ro de s√©rie</th>
                <th>Statut R√©conciliation</th>
                <th *ngIf="showCommentColumn">Commentaire</th>
                <th class="actions-col" *ngIf="showActionsColumn">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let r of filteredReleveRowsForImport | slice:(relevePage-1)*relevePageSize : (relevePage-1)*relevePageSize + relevePageSize">
                <td><code>{{ r.numeroCompte || '-' }}</code></td>
                <td>{{ r.nomCompte || '-' }}</td>
                <td>{{ r.banque || '-' }}</td>
                <td>{{ r.dateComptable ? (r.dateComptable | date:'dd/MM/yyyy') : '-' }}</td>
                <td>{{ r.dateValeur ? (r.dateValeur | date:'dd/MM/yyyy') : '-' }}</td>
                <td class="libelle-cell" [title]="r.libelle">{{ r.libelle || '-' }}</td>
                <td class="right"><span class="amount debit">{{ r.debit !== null && r.debit !== undefined ? (r.debit | number:'1.0-0') : '-' }}</span></td>
                <td class="right"><span class="amount credit">{{ r.credit !== null && r.credit !== undefined ? (r.credit | number:'1.0-0') : '-' }}</span></td>
                <td class="right"><span class="amount" [class.debit]="!!r.montant && r.montant < 0" [class.credit]="!!r.montant && r.montant > 0">{{ r.montant !== null && r.montant !== undefined ? (r.montant | number:'1.0-0') : '-' }}</span></td>
                <td>{{ r.numeroCheque || '-' }}</td>
              <td>{{ r.devise || '-' }}</td>
              <td>{{ r.numeroSerie || '-' }}</td>
              <td>
                <span class="badge status-ok" *ngIf="getReleveReconStatus(r)==='OK'">OK</span>
                <span class="badge status-ko" *ngIf="getReleveReconStatus(r)==='KO'">KO</span>
              </td>
              <td *ngIf="showCommentColumn" class="comment-cell">
                <div class="comment-display" [class.empty]="!r.commentaire">
                  <span *ngIf="r.commentaire; else noComment">{{ r.commentaire }}</span>
                  <ng-template #noComment>
                    <span class="no-comment">Aucun commentaire</span>
                  </ng-template>
                </div>
              </td>
                <td class="actions-col" *ngIf="showActionsColumn">
                  <button class="btn-icon" (click)="openReleveEdit(r)" [disabled]="!r.id" title="Modifier cette ligne">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn-icon btn-danger" (click)="deleteReleveRow(r)" [disabled]="!r.id" title="Supprimer cette ligne">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="pagination small">
          <div class="btn-group">
            <button (click)="relevePage = relevePage - 1" [disabled]="relevePage===1"><i class="fas fa-chevron-left"></i></button>
            <button (click)="relevePage = relevePage + 1" [disabled]="relevePage >= releveTotalPages"><i class="fas fa-chevron-right"></i></button>
          </div>
          <span class="muted">Page {{ relevePage }} / {{ releveTotalPages }}</span>
          <select [(ngModel)]="relevePageSize" (change)="relevePage = 1">
            <option [value]="10">10</option>
            <option [value]="20">20</option>
            <option [value]="50">50</option>
          </select>
          <div class="filter-group" style="margin-left: 8px;">
            <label>Statut R√©conciliation</label>
            <select [(ngModel)]="releveStatusFilter" (change)="relevePage = 1">
              <option value="">Tous</option>
              <option value="OK">OK</option>
              <option value="KO">KO</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Section R√©conciliation Banque -->
    <div class="banque-section" *ngIf="activeSection === 'securite'">
      <h2>üîÅ R√©conciliation Banque</h2>
      <div class="reconcile-toolbar">
        <div class="filter-group">
          <label>Pays</label>
          <select [(ngModel)]="reconPays" (change)="onReconPaysChange()">
            <option value="">Choisir un pays</option>
            <option *ngFor="let pays of reconPaysOptions" [value]="pays">{{ pays }}</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Date <span class="muted">(Optionnelle)</span></label>
          <input type="date" [(ngModel)]="reconDate">
        </div>
        <button class="btn-primary" (click)="reconcile()" [disabled]="reconciling || !reconPays">
          <i class="fas fa-link" [class.spin]="reconciling"></i>
          R√©concilier
        </button>
        
        <div class="filter-group" style="margin-left:auto;">
          <label>Vue</label>
          <select [(ngModel)]="reconView" (change)="updatePagedReconciliationResults()">
            <option value="operation">Suspens BO</option>
            <option value="releve">Suspens Banque</option>
            <option value="corr_operation">Correspondances (BO)</option>
            <option value="corr_releve">Correspondances (Banque)</option>
          </select>
        </div>
        <div class="filter-group" style="margin-left:12px;">
          <label>Inclure OK</label>
          <input type="checkbox" [(ngModel)]="showOkMarked" (change)="updatePagedReconciliationResults()" />
        </div>
      </div>

      <div class="table-container" *ngIf="reconDiffRows.length || (matchedPairs && matchedPairs.length)">
        <!-- Filtres R√©conciliation -->
        <div class="table-filters">
          <div class="filter-group" style="margin-right:12px; align-items:center; display:flex; gap:6px;">
            <label>OK d√©finitifs</label>
            <span class="badge status-ok">{{ totalOkDefinitifs }}</span>
          </div>
          <div class="filter-group" *ngIf="reconView==='operation' || reconView==='corr_operation'">
            <label>Type d'op√©ration</label>
            <select [(ngModel)]="reconFilters.typeOperation" (change)="applyReconFilters()">
              <option value="">Tous</option>
              <option *ngFor="let type of typesOperation" [value]="type">{{ type }}</option>
            </select>
          </div>
          <div class="filter-group" *ngIf="reconView==='operation' || reconView==='corr_operation'">
            <label>Statut</label>
            <select [(ngModel)]="reconFilters.statut" (change)="applyReconFilters()">
              <option value="">Tous</option>
              <option *ngFor="let s of statutsList" [value]="s">{{ s }}</option>
            </select>
          </div>
          <button class="btn-outline" *ngIf="reconView==='corr_operation' || reconView==='corr_releve'" (click)="openOkList()" title="Voir les OK d√©finitifs">
            <i class="fas fa-list-check"></i> OK d√©finitifs
          </button>
          <div class="filter-group">
            <label>Banque</label>
            <input type="text" [(ngModel)]="reconFilters.banque" (input)="applyReconFilters()" placeholder="Ex: BOA, SG...">
          </div>
          <div class="filter-group">
            <label>Recherche</label>
            <input type="text" [(ngModel)]="reconFilters.search" (input)="applyReconFilters()" placeholder="B√©n√©ficiaire / R√©f / Libell√© / Compte">
          </div>
          <div class="filter-group">
            <label>Montant min</label>
            <input type="number" [(ngModel)]="reconFilters.montantMin" (input)="applyReconFilters()">
          </div>
          <div class="filter-group">
            <label>Montant max</label>
            <input type="number" [(ngModel)]="reconFilters.montantMax" (input)="applyReconFilters()">
          </div>
          <button class="btn-clear-filters" (click)="clearReconFilters()">
            <i class="fas fa-times"></i>
            Effacer
          </button>
        </div>

        <div class="pagination-controls">
          <div class="page-size-selector">
            <label>Afficher</label>
            <select [(ngModel)]="reconPageSize" (change)="onReconPageSizeChange()">
              <option [value]="5">5 lignes</option>
              <option [value]="10">10 lignes</option>
              <option [value]="20">20 lignes</option>
              <option [value]="50">50 lignes</option>
              <option [value]="100">100 lignes</option>
            </select>
          </div>
          <div class="total-count">
            <i class="fas fa-list"></i>
            <span *ngIf="reconView==='operation'">{{ filteredLeftOps.length }} ligne(s) au total</span>
            <span *ngIf="reconView==='releve'">{{ filteredRightReleves.length }} ligne(s) au total</span>
            <span *ngIf="reconView==='corr_operation'">{{ filteredMatchedOps.length }} correspondance(s)</span>
            <span *ngIf="reconView==='corr_releve'">{{ filteredMatchedReleves.length }} correspondance(s)</span>
          </div>
          <div class="bulk-actions" *ngIf="reconView==='corr_operation' || reconView==='corr_releve'">
            <button class="btn-selection-toggle" (click)="toggleSelectAllCurrentPage()" title="S√©lectionner/D√©s√©lectionner la page">
              <i class="fas" [ngClass]="{ 'fa-square': !selectAllOnPage, 'fa-check-square': selectAllOnPage }"></i>
              {{ selectAllOnPage ? 'Tout d√©s√©lectionner' : 'S√©lectionner la page' }}
            </button>
            <button class="btn-bulk-action" (click)="bulkMarkOkDefinitif()" [disabled]="selectedReconKeys.size===0" title="Marquer OK d√©finitif (plusieurs)">
              <i class="fas fa-check-double"></i> OK d√©finitif ({{ selectedReconKeys.size }})
            </button>
            <button class="btn-bulk-cancel" (click)="bulkUnmarkOk()" [disabled]="selectedReconKeys.size===0" title="Annuler OK d√©finitif (plusieurs)">
              <i class="fas fa-undo"></i> Annuler ({{ selectedReconKeys.size }})
            </button>
          </div>
          <!-- Actions s√©lection pour vue op√©rations -->
          <div class="bulk-actions" *ngIf="reconView==='operation'">
            <button class="btn-selection-toggle" (click)="toggleSelectionModeOps()">
              <i class="fas fa-check-square"></i>
              {{ isSelectionModeOps ? 'Quitter la s√©lection' : 'S√©lection multiple' }}
              <span *ngIf="isSelectionModeOps && hasSelectedOps" class="badge" style="margin-left:6px;">{{ selectedOpIds.size }}</span>
            </button>
            <ng-container *ngIf="isSelectionModeOps">
              <button class="btn-selection-toggle" (click)="selectAllOpsCurrentPage()" [disabled]="selectAllOpsOnPage">
                <i class="fas fa-check-double"></i>
                S√©lectionner la page
              </button>
              <button class="btn-bulk-cancel" (click)="deselectAllOps()" [disabled]="!hasSelectedOps">
                <i class="fas fa-times"></i>
                D√©s√©lectionner tout
              </button>
              <select [(ngModel)]="selectedOpsTargetStatut" [disabled]="isBulkUpdatingOps" style="margin-left:8px;">
                <option value="" disabled selected>Choisir un statut</option>
                <option *ngFor="let s of statutsList" [value]="s">{{ s }}</option>
              </select>
              <button class="btn-bulk-action" (click)="bulkChangeSelectedOpsStatus()" [disabled]="isBulkUpdatingOps || !hasSelectedOps || !selectedOpsTargetStatut">
                <i class="fas fa-exchange-alt"></i>
                {{ isBulkUpdatingOps ? '‚è≥ Changement...' : 'Changer statut (' + selectedOpIds.size + ')' }}
              </button>
              <button class="btn-success" (click)="quickBulkOps('Valid√©e')" [disabled]="isBulkUpdatingOps || !hasSelectedOps">
                <i class="fas fa-check"></i> Valider
              </button>
              <button class="btn-warning" (click)="quickBulkOps('Rejet√©e')" [disabled]="isBulkUpdatingOps || !hasSelectedOps">
                <i class="fas fa-ban"></i> Rejeter
              </button>
            </ng-container>
          </div>
        </div>
        
        <table class="operations-table" *ngIf="reconView==='operation'">
          <thead>
            <tr>
              <th style="width:34px;" *ngIf="isSelectionModeOps">
                <input type="checkbox"
                       [checked]="selectAllOpsOnPage && (pagedLeftOps.length>0)"
                       [indeterminate]="hasSelectedOps && !selectAllOpsOnPage"
                       (change)="toggleSelectAllOpsHeader()"
                       title="S√©lectionner/D√©s√©lectionner la page">
              </th>
              <th>Pays</th>
              <th>Code Pays</th>
              <th>Mois</th>
              <th>Date Op√©ration</th>
              <th>Agence</th>
              <th>Type Op√©ration</th>
              <th>Nom du B√©n√©ficiaire</th>
              <th>Compte</th>
              <th>Montant</th>
              <th>Mode de Paiement</th>
              <th>R√©f√©rence</th>
              <th>ID GLPI</th>
              <th>Banque</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let op of pagedLeftOps" [class.selected]="isOpSelected(op)">
              <td *ngIf="isSelectionModeOps">
                <input type="checkbox" [checked]="isOpSelected(op)" (change)="toggleOpSelection(op)">
              </td>
              <td>{{ op.pays }}</td>
              <td>{{ op.codePays }}</td>
              <td>{{ op.mois }}</td>
              <td>{{ op.dateOperation | date:'dd/MM/yyyy' }}</td>
              <td>{{ op.agence }}</td>
              <td>{{ op.typeOperation }}</td>
              <td>{{ op.nomBeneficiaire }}</td>
              <td>{{ op.compteADebiter }}</td>
              <td>{{ op.montant | currency:'XAF':'symbol':'1.0-0' }}</td>
              <td>{{ op.modePaiement }}</td>
              <td>{{ op.reference }}</td>
              <td>{{ op.idGlpi || '-' }}</td>
              <td>{{ op.bo }}</td>
              <td>{{ op.statut }}</td>
              
            </tr>
          </tbody>
        </table>
        
        <table class="operations-table" *ngIf="reconView==='releve'">
          <thead>
            <tr>
              <th>Num√©ro de compte</th>
              <th>Nom du compte</th>
              <th>Banque</th>
              <th>Date comptable</th>
              <th>Date de valeur</th>
              <th>Libell√© / Narration</th>
              <th class="right">D√©bit</th>
              <th class="right">Cr√©dit</th>
              <th class="right">Montant</th>
              <th>Ch√®que</th>
              <th>Devise</th>
              <th>Num√©ro de s√©rie</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of pagedRightReleves">
              <td><code>{{ r.numeroCompte || '-' }}</code></td>
              <td>{{ r.nomCompte || '-' }}</td>
              <td>{{ r.banque || '-' }}</td>
              <td>{{ r.dateComptable ? (r.dateComptable | date:'dd/MM/yyyy') : '-' }}</td>
              <td>{{ r.dateValeur ? (r.dateValeur | date:'dd/MM/yyyy') : '-' }}</td>
              <td class="libelle-cell" [title]="r.libelle">{{ r.libelle || '-' }}</td>
              <td class="right">{{ r.debit !== null && r.debit !== undefined ? (r.debit | number:'1.0-0') : '-' }}</td>
              <td class="right">{{ r.credit !== null && r.credit !== undefined ? (r.credit | number:'1.0-0') : '-' }}</td>
              <td class="right">{{ r.montant !== null && r.montant !== undefined ? (r.montant | number:'1.0-0') : '-' }}</td>
              <td>{{ r.numeroCheque || '-' }}</td>
              <td>{{ r.devise || '-' }}</td>
              <td>{{ r.numeroSerie || '-' }}</td>
            </tr>
          </tbody>
        </table>

        <table class="operations-table" *ngIf="reconView==='corr_operation'">
          <thead>
            <tr>
              <th style="width:34px;"></th>
              <th>Pays</th>
              <th>Code Pays</th>
              <th>Mois</th>
              <th>Date Op√©ration</th>
              <th>Agence</th>
              <th>Type Op√©ration</th>
              <th>Nom du B√©n√©ficiaire</th>
              <th>Compte</th>
              <th>Montant</th>
              <th>Mode de Paiement</th>
              <th>R√©f√©rence</th>
              <th>ID GLPI</th>
              <th>Banque</th>
              <th>Statut</th>
              <th>Statut R√©conciliation</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let op of pagedMatchedOps">
              <td>
                <input type="checkbox" [checked]="isKeySelected(op.key)" (change)="toggleSelectKey(op.key)">
              </td>
              <td>{{ op.pays }}</td>
              <td>{{ op.codePays }}</td>
              <td>{{ op.mois }}</td>
              <td>{{ op.dateOperation | date:'dd/MM/yyyy' }}</td>
              <td>{{ op.agence }}</td>
              <td>{{ op.typeOperation }}</td>
              <td>{{ op.nomBeneficiaire }}</td>
              <td>{{ op.compteADebiter }}</td>
              <td>{{ op.montant | currency:'XAF':'symbol':'1.0-0' }}</td>
              <td>{{ op.modePaiement }}</td>
              <td>{{ op.reference }}</td>
              <td>{{ op.idGlpi || '-' }}</td>
              <td>{{ op.bo }}</td>
              <td>{{ op.statut }}</td>
              <td class="right">
                <span class="badge status-ok" *ngIf="getReconStatusByKey(op.key, 'OK')==='OK'">OK</span>
                <span class="badge status-ko" *ngIf="getReconStatusByKey(op.key, 'OK')==='KO'">KO</span>
                <button class="btn-icon" (click)="toggleReconStatusByKey(op.key, 'OK')" title="Basculer OK/KO"><i class="fas fa-exchange-alt"></i></button>
                <button class="btn-icon" (click)="markAsOkPermanentByKey(op.key)" title="Marquer d√©finitivement OK (ignorer)"><i class="fas fa-check-double"></i></button>
                <button class="btn-icon" (click)="unmarkOkByKey(op.key)" title="Annuler 'OK d√©finitif'"><i class="fas fa-undo"></i></button>
              </td>
            </tr>
          </tbody>
        </table>

        <table class="operations-table" *ngIf="reconView==='corr_releve'">
          <thead>
            <tr>
              <th style="width:34px;"></th>
              <th>Num√©ro de compte</th>
              <th>Nom du compte</th>
              <th>Banque</th>
              <th>Date comptable</th>
              <th>Date de valeur</th>
              <th>Libell√© / Narration</th>
              <th class="right">D√©bit</th>
              <th class="right">Cr√©dit</th>
              <th class="right">Montant</th>
              <th>Ch√®que</th>
              <th>Devise</th>
              <th>Num√©ro de s√©rie</th>
              <th>Statut R√©conciliation</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of pagedMatchedReleves">
              <td>
                <input type="checkbox" [checked]="isKeySelected(r.key)" (change)="toggleSelectKey(r.key)">
              </td>
              <td><code>{{ r.numeroCompte || '-' }}</code></td>
              <td>{{ r.nomCompte || '-' }}</td>
              <td>{{ r.banque || '-' }}</td>
              <td>{{ r.dateComptable ? (r.dateComptable | date:'dd/MM/yyyy') : '-' }}</td>
              <td>{{ r.dateValeur ? (r.dateValeur | date:'dd/MM/yyyy') : '-' }}</td>
              <td class="libelle-cell" [title]="r.libelle">{{ r.libelle || '-' }}</td>
              <td class="right">{{ r.debit !== null && r.debit !== undefined ? (r.debit | number:'1.0-0') : '-' }}</td>
              <td class="right">{{ r.credit !== null && r.credit !== undefined ? (r.credit | number:'1.0-0') : '-' }}</td>
              <td class="right">{{ r.montant !== null && r.montant !== undefined ? (r.montant | number:'1.0-0') : '-' }}</td>
              <td>{{ r.numeroCheque || '-' }}</td>
              <td>{{ r.devise || '-' }}</td>
              <td>{{ r.numeroSerie || '-' }}</td>
              <td class="right">
                <span class="badge status-ok" *ngIf="getReconStatusByKey(r.key, 'OK')==='OK'">OK</span>
                <span class="badge status-ko" *ngIf="getReconStatusByKey(r.key, 'OK')==='KO'">KO</span>
                <button class="btn-icon" (click)="toggleReconStatusByKey(r.key, 'OK')" title="Basculer OK/KO"><i class="fas fa-exchange-alt"></i></button>
                <button class="btn-icon" (click)="markAsOkPermanentByKey(r.key)" title="Marquer d√©finitivement OK (ignorer)"><i class="fas fa-check-double"></i></button>
                <button class="btn-icon" (click)="unmarkOkByKey(r.key)" title="Annuler 'OK d√©finitif'"><i class="fas fa-undo"></i></button>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Pagination am√©lior√©e pour la r√©conciliation -->
        <div class="pagination-enhanced" *ngIf="reconPays">
          <!-- Informations de pagination -->
          <div class="pagination-info">
            <i class="fas fa-info-circle"></i>
            <span>{{ getReconPaginationInfo() }}</span>
          </div>
          
          <!-- Navigation de pagination -->
          <div class="pagination-nav">
            <div class="btn-group">
              <!-- Premi√®re page -->
              <button (click)="reconGoToFirstPage()" 
                      [disabled]="(reconView==='operation' ? reconOpPage===1 : reconView==='releve' ? reconRevPage===1 : reconView==='corr_operation' ? reconCorrOpPage===1 : reconCorrRevPage===1)"
                      title="Premi√®re page">
                <i class="fas fa-angle-double-left"></i>
              </button>
              
              <!-- Page pr√©c√©dente -->
              <button (click)="reconPrevPage()" 
                      [disabled]="(reconView==='operation' ? reconOpPage===1 : reconView==='releve' ? reconRevPage===1 : reconView==='corr_operation' ? reconCorrOpPage===1 : reconCorrRevPage===1)"
                      title="Page pr√©c√©dente">
                <i class="fas fa-chevron-left"></i>
              </button>
            </div>
            
            <!-- Num√©ros de page -->
            <div class="page-numbers">
              <button *ngFor="let page of getReconPageNumbers()" 
                      (click)="reconGoToPage(page)"
                      [disabled]="(reconView==='operation' ? filteredLeftOps.length===0 : reconView==='releve' ? filteredRightReleves.length===0 : reconView==='corr_operation' ? filteredMatchedOps.length===0 : filteredMatchedReleves.length===0)"
                      [class.active]="page === (reconView==='operation' ? reconOpPage : (reconView==='releve' ? reconRevPage : (reconView==='corr_operation' ? reconCorrOpPage : reconCorrRevPage)))"
                      class="page-number">
                {{ page }}
              </button>
            </div>
            
            <div class="btn-group">
              <!-- Page suivante -->
              <button (click)="reconNextPage()" 
                      [disabled]="(reconView==='operation' ? reconOpPage===reconOpTotalPages : (reconView==='releve' ? reconRevPage===reconRevTotalPages : (reconView==='corr_operation' ? reconCorrOpPage===reconCorrOpTotalPages : reconCorrRevPage===reconCorrRevTotalPages)))"
                      title="Page suivante">
                <i class="fas fa-chevron-right"></i>
              </button>
              
              <!-- Derni√®re page -->
              <button (click)="reconGoToLastPage()" 
                      [disabled]="(reconView==='operation' ? reconOpPage===reconOpTotalPages : (reconView==='releve' ? reconRevPage===reconRevTotalPages : (reconView==='corr_operation' ? reconCorrOpPage===reconCorrOpTotalPages : reconCorrRevPage===reconCorrRevTotalPages)))"
                      title="Derni√®re page">
                <i class="fas fa-angle-double-right"></i>
              </button>
            </div>
          </div>
          
          <!-- S√©lecteur de taille de page -->
          <div class="page-size-selector">
            <label>Afficher</label>
            <select [(ngModel)]="reconPageSize" (change)="onReconPageSizeChange()">
              <option [value]="5">5 lignes</option>
              <option [value]="10">10 lignes</option>
              <option [value]="20">20 lignes</option>
              <option [value]="50">50 lignes</option>
              <option [value]="100">100 lignes</option>
            </select>
          </div>
        </div>
      </div>
      <div *ngIf="!reconDiffRows.length" class="empty-row">
        Aucune donn√©e. S√©lectionnez un pays et une date puis lancez la r√©conciliation.
      </div>
    </div>

    

    <div class="banque-section" *ngIf="!showOperations && activeSection === 'home'">
      <div class="section-header">
        <h2>üè¶ Comptes de Banque</h2>
        <div class="header-actions">
          <button class="btn-export" (click)="exportComptesBanque()" [disabled]="loadingComptesBanque || comptesBanqueDisplayed.length === 0" title="Exporter les comptes de banque (Excel)">
            <i class="fas fa-file-excel"></i>
            Exporter
          </button>
          <button class="btn-refresh" (click)="loadComptesBanque()" [disabled]="loadingComptesBanque">
            <i class="fas fa-sync-alt" [class.spin]="loadingComptesBanque"></i>
            Actualiser
          </button>
        </div>
      </div>

      <div *ngIf="comptesBanqueError" class="error-box">
        {{ comptesBanqueError }}
      </div>

      <div class="table-container small" *ngIf="!comptesBanqueError">
        <div class="comptes-toolbar">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" [(ngModel)]="comptesSearch" placeholder="Rechercher (compte, code, pays, type)...">
          </div>
          <div class="legend">
            <span class="badge badge-banque">Banque</span>
            <span class="dot"></span>
            <span class="muted">{{ comptesBanqueDisplayed.length }} compte(s)</span>
          </div>
        </div>

        <table class="fancy-table comptes-table">
          <thead>
            <tr>
              <th>Num√©ro de Compte</th>
              <th>Code Propri√©taire</th>
              <th>Pays</th>
              <th>Cat√©gorie</th>
              <th>Type</th>
              <th class="center">Solde</th>
              <th>Derni√®re MAJ</th>
              <th class="actions-col">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="loadingComptesBanque">
              <td colspan="8" class="loading-row">
                <i class="fas fa-spinner spin"></i> Chargement des comptes Banque...
              </td>
            </tr>
            <tr *ngIf="!loadingComptesBanque && comptesBanqueDisplayed.length === 0">
              <td colspan="8" class="empty-row">
                Aucun compte de cat√©gorie Banque trouv√©.
              </td>
            </tr>
            <tr *ngFor="let c of (comptesBanqueDisplayed | slice:(comptesListPage-1)*comptesListPageSize : (comptesListPage-1)*comptesListPageSize + comptesListPageSize)" [class.expanded]="selectedCompteNumero === c.numeroCompte">
              <td (click)="toggleCompte(c)" class="clickable">
                <div class="cell-main">
                  <code>{{ c.numeroCompte }}</code>
                  <button class="btn-copy" title="Copier" (click)="$event.stopPropagation(); copyToClipboard(c.numeroCompte)">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
                <div class="cell-sub" *ngIf="selectedCompteNumero === c.numeroCompte">{{ c.categorie || '-' }} ‚Ä¢ {{ c.type || '-' }}</div>
              </td>
              <td>
                <span class="chip chip-owner">{{ c.codeProprietaire || '-' }}</span>
              </td>
              <td>
                <span class="chip chip-country">
                  <i class="fas fa-globe-africa"></i> {{ c.pays }}
                </span>
              </td>
              <td>
                <span class="chip chip-category">{{ c.categorie || '-' }}</span>
              </td>
              <td>
                <span class="chip chip-type">{{ c.type || '-' }}</span>
              </td>
              <td class="center">
                <span class="amount" [class.negative]="c.solde < 0">{{ c.solde | number:'1.2-2' }}</span>
              </td>
              <td>
                <span class="date-badge">{{ c.dateDerniereMaj | date:'dd/MM/yyyy HH:mm' }}</span>
              </td>
              <td class="actions-col">
                <button class="btn-releve" (click)="openCompteRelevePopup(c)" title="Voir op√©rations du compte"><i class="fas fa-receipt"></i> Relev√©</button>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="pagination small" *ngIf="comptesBanqueDisplayed.length > 0">
          <div class="btn-group">
            <button (click)="comptesListFirstPage()" [disabled]="comptesListPage===1" title="Premi√®re page"><i class="fas fa-angle-double-left"></i></button>
            <button (click)="comptesListPrevPage()" [disabled]="comptesListPage===1" title="Page pr√©c√©dente"><i class="fas fa-chevron-left"></i></button>
            <button (click)="comptesListNextPage()" [disabled]="comptesListPage>=comptesListTotalPages" title="Page suivante"><i class="fas fa-chevron-right"></i></button>
            <button (click)="comptesListLastPage()" [disabled]="comptesListPage>=comptesListTotalPages" title="Derni√®re page"><i class="fas fa-angle-double-right"></i></button>
          </div>
          <span class="muted">
            Page {{ comptesListPage }} / {{ comptesListTotalPages }} 
            ({{ comptesListStartIndex }}-{{ comptesListEndIndex }} sur {{ comptesBanqueDisplayed.length }})
          </span>
          <select [(ngModel)]="comptesListPageSize" (change)="onComptesListPageSizeChange()">
            <option [value]="5">5</option>
            <option [value]="7">7</option>
            <option [value]="10">10</option>
            <option [value]="20">20</option>
            <option [value]="50">50</option>
            <option [value]="100">100</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup op√©rations par compte -->
  <div class="modern-popup-overlay" *ngIf="showCompteOpsPopup" (click)="closeCompteRelevePopup()">
    <div class="modern-popup detail-popup compte-releve-popup" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h2><i class="fas fa-receipt"></i> Op√©rations du compte <code>{{ compteOpsNumero }}</code></h2>
        <button class="close-btn" (click)="closeCompteRelevePopup()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="popup-content">
        <div class="operations-table-container">
          <div class="balances" style="margin: 8px 0; text-align: left;">
            <div class="balance-item">
              <strong>Solde d'ouverture:</strong>
              <span class="balance-highlight" style="background:#E7F3FF; padding:4px 8px; border-radius:6px; font-weight:bold;">{{ compteReleveSoldeOuverture !== null ? (compteReleveSoldeOuverture | number:'1.0-0') : '-' }}</span>
            </div>
          </div>
          <div class="table-filters">
            <div class="filter-group">
              <label>Date d√©but</label>
              <input type="date" [(ngModel)]="compteOpsDateFrom" (change)="applyCompteOpsFilters()">
            </div>
            <div class="filter-group">
              <label>Date fin</label>
              <input type="date" [(ngModel)]="compteOpsDateTo" (change)="applyCompteOpsFilters()">
            </div>
            <button class="btn-export" style="margin-left:auto;" (click)="exportCompteOps()" title="Exporter CSV">
              <i class="fas fa-file-export"></i> Exporter
            </button>
            <div class="page-size-selector">
              <label>Afficher</label>
              <select [(ngModel)]="compteOpsPageSize" (change)="onCompteOpsPageSizeChange()">
                <option [value]="5">5 lignes</option>
                <option [value]="10">10 lignes</option>
                <option [value]="20">20 lignes</option>
              </select>
            </div>
          </div>
          <div class="table-container">
            <table class="operations-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Agence</th>
                  <th>B√©n√©ficiaire</th>
                  <th class="right">D√©bit</th>
                  <th class="right">Cr√©dit</th>
                  <th>R√©f√©rence</th>
                  <th>Statut</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let op of compteOpsPaged">
                  <td>{{ op.dateOperation | date:'dd/MM/yyyy' }}</td>
                  <td>{{ op.typeOperation }}</td>
                  <td>{{ op.agence }}</td>
                  <td>{{ op.nomBeneficiaire || '-' }}</td>
                  <td class="right">
                    <span class="amount debit" *ngIf="getDebitForOperation(op) !== null">{{ getDebitForOperation(op) | number:'1.0-0' }}</span>
                    <span *ngIf="getDebitForOperation(op) === null">-</span>
                  </td>
                  <td class="right">
                    <span class="amount credit" *ngIf="getCreditForOperation(op) !== null">{{ getCreditForOperation(op) | number:'1.0-0' }}</span>
                    <span *ngIf="getCreditForOperation(op) === null">-</span>
                  </td>
                  <td>{{ op.reference || '-' }}</td>
                  <td>{{ op.statut || '-' }}</td>
                </tr>
                <tr *ngIf="!compteOpsPaged.length">
                  <td colspan="8" class="empty-row">Aucune op√©ration pour cette p√©riode.</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div *ngIf="compteReleveSoldeCloture !== null" style="margin: 8px 0; text-align: right;">
            <strong>Solde de cl√¥ture:</strong>
            <span class="balance-highlight" style="background:#FFF3CD; padding:4px 8px; border-radius:6px; font-weight:bold;">{{ compteReleveSoldeCloture !== null ? (compteReleveSoldeCloture | number:'1.0-0') : '-' }}</span>
          </div>
          <div class="pagination" *ngIf="compteOpsTotalPages > 1">
            <button (click)="compteOpsPrevPage()" [disabled]="compteOpsPage===1"><i class="fas fa-chevron-left"></i> Pr√©c√©dent</button>
            <div class="pagination-indicators">
              <span *ngFor="let page of getCompteOpsVisiblePages()" class="page-indicator" [class.active]="compteOpsPage === page" (click)="compteOpsGoToPage(page)">{{ page }}</span>
            </div>
            <button (click)="compteOpsNextPage()" [disabled]="compteOpsPage===compteOpsTotalPages">Suivant <i class="fas fa-chevron-right"></i></button>
          </div>
        </div>
      </div>
      <div class="popup-footer">
        <button class="btn-secondary btn-close" (click)="closeCompteRelevePopup()"><i class="fas fa-times"></i> Fermer</button>
      </div>
    </div>
  </div>

  <!-- Tableau des op√©rations bancaires -->
  <div class="banque-section operations-section" *ngIf="showOperations && activeSection === 'operations'">
    <div class="operations-header">
      <h2>üìã Op√©rations Bancaires</h2>
      <button class="btn-toggle-actions" (click)="toggleActionsColumn()" [class.active]="showActionsColumn" title="Afficher/Masquer les colonnes Actions">
        <i class="fas" [class.fa-eye]="!showActionsColumn" [class.fa-eye-slash]="showActionsColumn"></i>
        {{ showActionsColumn ? 'Masquer Actions' : 'Afficher Actions' }}
      </button>
    </div>

      <!-- Import / Mod√®le / Export -->
      <div class="releve-header" style="margin-bottom: 12px;">
        <h3>Gestion des op√©rations (Import/Export Excel/CSV)</h3>
        <div class="actions">
          <label class="file-btn">
            <input type="file" (change)="onOpbFileSelected($event)" accept=".xlsx,.xls,.csv" />
            <i class="fas fa-file-upload"></i> Choisir un fichier
          </label>
          <button class="btn-primary" [disabled]="opbUploading || !opbSelectedFile" (click)="uploadOpb()">
            <i class="fas fa-upload" [class.spin]="opbUploading"></i> Importer
          </button>
          <button class="btn-primary" (click)="downloadOpbTemplate()" title="T√©l√©charger le mod√®le">
            <i class="fas fa-file-excel"></i> Mod√®le
          </button>
          <button class="btn-success" (click)="exportOperations()" [disabled]="filteredOperations.length === 0" title="Exporter (Excel)">
            <i class="fas fa-file-excel"></i> Exporter
          </button>
        </div>
      </div>

      <div *ngIf="opbMessage" class="releve-alert" [ngClass]="opbMessageKind" style="margin-bottom: 12px;">
        <i class="fas" [ngClass]="{
          'fa-info-circle': opbMessageKind==='info',
          'fa-check-circle': opbMessageKind==='success',
          'fa-exclamation-triangle': opbMessageKind==='error'
        }"></i>
        <span>{{ opbMessage }}</span>
      </div>

    <div class="operations-table-container">
      <!-- Filtres -->
      <div class="table-filters">
        <div class="filter-group">
          <label>Pays</label>
          <select [(ngModel)]="filters.pays" (change)="applyFilters()">
            <option value="">Tous les pays</option>
            <option *ngFor="let pays of paysList" [value]="pays">{{ pays }}</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Type d'op√©ration</label>
          <select [(ngModel)]="filters.typeOperation" (change)="applyFilters()">
            <option value="">Tous les types</option>
            <option *ngFor="let type of typesOperation" [value]="type">{{ type }}</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Statut</label>
          <select [(ngModel)]="filters.statut" (change)="applyFilters()">
            <option value="">Tous les statuts</option>
            <option *ngFor="let statut of statutsList" [value]="statut">{{ statut }}</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Statut R√©conciliation</label>
          <select [(ngModel)]="operationsReconStatusFilter" (change)="applyFilters()">
            <option value="">Tous</option>
            <option value="OK">OK</option>
            <option value="KO">KO</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Date d√©but</label>
          <input type="date" [(ngModel)]="filters.dateDebut" (change)="applyFilters()">
        </div>
        <div class="filter-group">
          <label>Date fin</label>
          <input type="date" [(ngModel)]="filters.dateFin" (change)="applyFilters()">
        </div>
        <button class="btn-clear-filters" (click)="clearFilters()">
          <i class="fas fa-times"></i>
          Effacer
        </button>
      </div>

      <!-- Contr√¥les de pagination -->
      <div class="pagination-controls">
        <div class="page-size-selector">
          <label>Afficher</label>
          <select [(ngModel)]="pageSize" (change)="onPageSizeChange()">
            <option [value]="5">5 lignes</option>
            <option [value]="10">10 lignes</option>
            <option [value]="20">20 lignes</option>
            <option [value]="50">50 lignes</option>
            <option [value]="100">100 lignes</option>
          </select>
        </div>
        <div class="total-count">
          <i class="fas fa-list"></i>
          <span>{{ filteredOperations.length }} op√©ration(s) au total</span>
        </div>
        <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
          <button class="btn-selection-toggle" (click)="toggleSelectionModeMain()">
            <i class="fas fa-check-square"></i>
            {{ isSelectionModeMain ? 'Quitter la s√©lection' : 'S√©lection multiple' }}
            <span *ngIf="isSelectionModeMain && hasSelectedMainOps" class="badge" style="margin-left:6px;">{{ selectedMainOpIds.size }}</span>
          </button>
          <ng-container *ngIf="isSelectionModeMain">
            <select [(ngModel)]="selectedMainTargetStatut" [disabled]="isBulkUpdatingMain">
              <option value="" disabled selected>Choisir un statut</option>
              <option *ngFor="let s of statutsList" [value]="s">{{ s }}</option>
            </select>
            <button class="btn-bulk-action" (click)="bulkChangeSelectedMainStatus()" [disabled]="isBulkUpdatingMain || !hasSelectedMainOps || !selectedMainTargetStatut">
              <i class="fas fa-exchange-alt"></i>
              {{ isBulkUpdatingMain ? '‚è≥ Changement...' : 'Changer statut (' + selectedMainOpIds.size + ')' }}
            </button>
            <button class="btn-success" (click)="quickBulkMain('Valid√©e')" [disabled]="isBulkUpdatingMain || !hasSelectedMainOps">
              <i class="fas fa-check"></i> Valider
            </button>
            <button class="btn-warning" (click)="quickBulkMain('Rejet√©e')" [disabled]="isBulkUpdatingMain || !hasSelectedMainOps">
              <i class="fas fa-ban"></i> Rejeter
            </button>
          </ng-container>
        </div>
      </div>

      <!-- Tableau -->
      <div class="table-container">
        <table class="operations-table">
          <thead>
            <tr>
              <th style="width:34px;" *ngIf="isSelectionModeMain">
                <input type="checkbox"
                       [checked]="selectAllMainOnPage && (pagedOperations.length>0)"
                       [indeterminate]="hasSelectedMainOps && !selectAllMainOnPage"
                       (change)="toggleSelectAllMainHeader()"
                       title="S√©lectionner/D√©s√©lectionner la page">
              </th>
              <th>Pays</th>
              <th>Code Pays</th>
              <th>Mois</th>
              <th>Date Op√©ration</th>
              <th>Agence</th>
              <th>Type Op√©ration</th>
              <th>Nom du B√©n√©ficiaire</th>
              <th>Compte</th>
              <th>Montant</th>
              <th>Mode de Paiement</th>
              <th>R√©f√©rence</th>
              <th>ID GLPI</th>
              <th>Banque</th>
              <th>Statut</th>
              <th *ngIf="showActionsColumn">Actions</th>
              <th>Statut R√©conciliation</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let operation of pagedOperations" [class.selected]="isMainOpSelected(operation)">
              <td *ngIf="isSelectionModeMain">
                <input type="checkbox" [checked]="isMainOpSelected(operation)" (change)="toggleMainOpSelection(operation)">
              </td>
              <td>{{ getPaysDisplay(operation) }}</td>
              <td>{{ operation.codePays }}</td>
              <td>{{ operation.mois }}</td>
              <td>{{ operation.dateOperation | date:'dd/MM/yyyy' }}</td>
              <td>{{ operation.agence }}</td>
              <td>
                <span class="badge type-{{ operation.typeOperation.toLowerCase() }}">
                  {{ operation.typeOperation }}
                </span>
              </td>
              <td>{{ operation.nomBeneficiaire }}</td>
              <td>{{ operation.compteADebiter }}</td>
              <td>{{ operation.montant | currency:'XAF':'symbol':'1.0-0' }}</td>
              <td>{{ operation.modePaiement }}</td>
              <td>{{ operation.reference }}</td>
              <td class="glpi-cell">
                <button 
                  *ngIf="!operation.idGlpi || operation.idGlpi.trim() === ''" 
                  class="btn-glpi-create"
                  (click)="openGlpiCreate()"
                  title="Cr√©er un ticket GLPI">
                  <i class="fas fa-plus-circle"></i> Cr√©er
                </button>
                <a 
                  *ngIf="operation.idGlpi && operation.idGlpi.trim() !== ''"
                  [href]="getGlpiTicketUrl(operation.idGlpi)"
                  target="_blank"
                  class="glpi-link"
                  title="Ouvrir le ticket GLPI {{ operation.idGlpi }}">
                  <i class="fas fa-ticket-alt"></i> {{ operation.idGlpi }}
                </a>
              </td>
              <td>{{ operation.bo }}</td>
              <td>
                <span class="badge status-{{ operation.statut.toLowerCase() }}">
                  {{ operation.statut }}
                </span>
              </td>
              <td class="actions" *ngIf="showActionsColumn">
                <button class="btn-icon" (click)="viewOperation(operation)" title="Voir">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn-icon" (click)="editOperation(operation)" title="Modifier">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon btn-danger" (click)="deleteOperation(operation.id)" title="Supprimer">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
              <td>
                <span class="badge status-{{ getOperationReconStatus(operation).toLowerCase() }}">
                  {{ getOperationReconStatus(operation) }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination small" *ngIf="filteredOperations.length > 0">
        <div class="btn-group">
          <button (click)="goToPage(1)" [disabled]="currentPage === 1" title="Premi√®re page"><i class="fas fa-angle-double-left"></i></button>
          <button (click)="prevPage()" [disabled]="currentPage === 1" title="Page pr√©c√©dente"><i class="fas fa-chevron-left"></i></button>
          <button (click)="nextPage()" [disabled]="currentPage === totalPages" title="Page suivante"><i class="fas fa-chevron-right"></i></button>
          <button (click)="goToPage(totalPages)" [disabled]="currentPage === totalPages" title="Derni√®re page"><i class="fas fa-angle-double-right"></i></button>
        </div>
        
        <span class="muted">Page {{ currentPage }} / {{ totalPages }}</span>
        
        <select [(ngModel)]="pageSize" (change)="onPageSizeChange()">
          <option [value]="5">5</option>
          <option [value]="10">10</option>
          <option [value]="20">20</option>
          <option [value]="50">50</option>
          <option [value]="100">100</option>
        </select>
        
        <div class="filter-group" style="margin-left: 8px;">
          <label>Statut R√©conciliation</label>
          <select [(ngModel)]="operationsReconStatusFilter" (change)="onOperationsReconStatusFilterChange()">
            <option value="">Tous</option>
            <option value="OK">OK</option>
            <option value="KO">KO</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup D√©tails -->
  <div class="modern-popup-overlay" *ngIf="showDetailPopup" (click)="closeDetailPopup()">
    <div class="modern-popup detail-popup" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h2><i class="fas fa-info-circle"></i> D√©tails de l'op√©ration bancaire</h2>
        <button class="close-btn" (click)="closeDetailPopup()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="popup-content" *ngIf="selectedOperation">
        <div class="detail-grid">
          <div class="detail-item">
            <label><i class="fas fa-globe"></i> Pays</label>
            <span>{{ selectedOperation.pays || 'Non renseign√©' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-flag"></i> Code Pays</label>
            <span>{{ selectedOperation.codePays || 'Non renseign√©' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-calendar"></i> Mois</label>
            <span>{{ selectedOperation.mois || 'Non renseign√©' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-clock"></i> Date Op√©ration</label>
            <span>{{ selectedOperation.dateOperation | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-building"></i> Agence</label>
            <span>{{ selectedOperation.agence }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-tags"></i> Type Op√©ration</label>
            <span class="badge">{{ selectedOperation.typeOperation }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-user"></i> Nom B√©n√©ficiaire</label>
            <span>{{ selectedOperation.nomBeneficiaire || 'Non renseign√©' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-credit-card"></i> Compte</label>
            <span>{{ selectedOperation.compteADebiter || 'Non renseign√©' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-money-bill-wave"></i> Montant</label>
            <span class="montant">{{ selectedOperation.montant | currency:'XAF':'symbol':'1.0-0' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-wallet"></i> Mode de Paiement</label>
            <span>{{ selectedOperation.modePaiement || 'Non renseign√©' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-hashtag"></i> R√©f√©rence</label>
            <span>{{ selectedOperation.reference || 'Non renseign√©e' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-ticket-alt"></i> ID GLPI</label>
            <span>
              <a *ngIf="selectedOperation.idGlpi && selectedOperation.idGlpi.trim() !== ''" 
                 [href]="getGlpiTicketUrl(selectedOperation.idGlpi)"
                 target="_blank"
                 class="glpi-link-small">
                {{ selectedOperation.idGlpi }}
              </a>
              <span *ngIf="!selectedOperation.idGlpi || selectedOperation.idGlpi.trim() === ''">Non renseign√©</span>
            </span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-university"></i> Banque</label>
            <span>{{ selectedOperation.bo || 'Non renseign√©' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-info-circle"></i> Statut</label>
            <span class="badge status-{{ selectedOperation.statut?.toLowerCase() }}">
              {{ selectedOperation.statut }}
            </span>
          </div>
        </div>
      </div>

      <div class="popup-footer">
        <button class="btn-secondary" (click)="closeDetailPopup()">
          <i class="fas fa-times"></i> Fermer
        </button>
        <button class="btn-primary" (click)="closeDetailPopup(); editOperation(selectedOperation!)">
          <i class="fas fa-edit"></i> Modifier
        </button>
      </div>
    </div>
  </div>

  <!-- Popup Liste OK d√©finitifs -->
  <div class="modern-popup-overlay" *ngIf="showOkListPopup" (click)="closeOkList()">
    <div class="modern-popup detail-popup" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h2><i class="fas fa-list-check"></i> Cl√©s OK d√©finitifs</h2>
        <button class="close-btn" (click)="closeOkList()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="popup-content">
        <div *ngIf="okListLoading" class="empty-row"><i class="fas fa-spinner spin"></i> Chargement...</div>
        <div *ngIf="!okListLoading && okKeysList.length===0" class="empty-row">Aucune cl√© OK d√©finitive.</div>
        <table class="operations-table" *ngIf="!okListLoading && okKeysList.length">
          <thead>
            <tr>
              <th>Cl√©</th>
              <th class="actions-col">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let k of okKeysList">
              <td><code>{{ k }}</code></td>
              <td class="actions">
                <button class="btn-icon" (click)="unmarkOkFromList(k)" title="Annuler 'OK d√©finitif'"><i class="fas fa-undo"></i></button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="popup-footer">
        <button class="btn-secondary" (click)="closeOkList()"><i class="fas fa-times"></i> Fermer</button>
      </div>
    </div>
  </div>

  <!-- Popup √âdition Relev√© -->
  <div class="modern-popup-overlay" *ngIf="showReleveEditPopup" (click)="closeReleveEdit()">
    <div class="modern-popup edit-popup" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h2><i class="fas fa-edit"></i> Modifier la ligne de relev√©</h2>
        <button class="close-btn" (click)="closeReleveEdit()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="popup-content">
        <form class="edit-form">
          <div class="form-row">
            <div class="form-group">
              <label>Num√©ro de compte</label>
              <input type="text" [(ngModel)]="releveEditForm.numeroCompte" name="rv_numeroCompte">
            </div>
            <div class="form-group">
              <label>Nom du compte</label>
              <input type="text" [(ngModel)]="releveEditForm.nomCompte" name="rv_nomCompte">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Banque</label>
              <input type="text" [(ngModel)]="releveEditForm.banque" name="rv_banque">
            </div>
            <div class="form-group">
              <label>Ch√®que</label>
              <input type="text" [(ngModel)]="releveEditForm.numeroCheque" name="rv_numeroCheque">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Date comptable</label>
              <input type="date" [(ngModel)]="releveEditForm.dateComptable" name="rv_dateComptable">
            </div>
            <div class="form-group">
              <label>Date de valeur</label>
              <input type="date" [(ngModel)]="releveEditForm.dateValeur" name="rv_dateValeur">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>D√©bit</label>
              <input type="number" [(ngModel)]="releveEditForm.debit" name="rv_debit">
            </div>
            <div class="form-group">
              <label>Cr√©dit</label>
              <input type="number" [(ngModel)]="releveEditForm.credit" name="rv_credit">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Montant</label>
              <input type="number" [(ngModel)]="releveEditForm.montant" name="rv_montant">
            </div>
            <div class="form-group">
              <label>Devise</label>
              <input type="text" [(ngModel)]="releveEditForm.devise" name="rv_devise">
            </div>
            <div class="form-group">
              <label>Num√©ro de s√©rie</label>
              <input type="text" [(ngModel)]="releveEditForm.numeroSerie" name="rv_numero_serie">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Libell√© / Narration</label>
              <input type="text" [(ngModel)]="releveEditForm.libelle" name="rv_libelle">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Commentaire</label>
              <textarea 
                [(ngModel)]="releveEditForm.commentaire" 
                name="rv_commentaire"
                placeholder="Ajouter un commentaire..."
                rows="3"
                maxlength="500"
                class="comment-textarea">
              </textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="popup-footer">
        <button class="btn-secondary" (click)="closeReleveEdit()"><i class="fas fa-times"></i> Annuler</button>
        <button class="btn-primary" (click)="saveReleveEdit()"><i class="fas fa-save"></i> Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Popup Cr√©ation Op√©ration Bancaire -->
  <div class="modern-popup-overlay" *ngIf="showCreateOperationPopup" (click)="closeCreateOperationPopup()">
    <div class="modern-popup create-operation-popup" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h3><i class="fas fa-plus"></i> Cr√©er une Op√©ration Bancaire</h3>
        <button class="btn-close" (click)="closeCreateOperationPopup()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="popup-body">
        <form class="create-operation-form">
          <div class="form-row">
            <div class="form-group">
              <label>Num√©ro de compte *</label>
              <input type="text" [(ngModel)]="createOperationForm.numeroCompte" name="co_numeroCompte" required>
            </div>
            <div class="form-group">
              <label>Nom du compte *</label>
              <input type="text" [(ngModel)]="createOperationForm.nomCompte" name="co_nomCompte" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Banque *</label>
              <input type="text" [(ngModel)]="createOperationForm.banque" name="co_banque" required>
            </div>
            <div class="form-group">
              <label>Devise</label>
              <select [(ngModel)]="createOperationForm.devise" name="co_devise">
                <option value="XAF">XAF</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="CFA">CFA</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Date comptable *</label>
              <input type="date" [(ngModel)]="createOperationForm.dateComptable" name="co_dateComptable" required>
            </div>
            <div class="form-group">
              <label>Date de valeur</label>
              <input type="date" [(ngModel)]="createOperationForm.dateValeur" name="co_dateValeur">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Type d'op√©ration *</label>
              <select [(ngModel)]="createOperationForm.typeOperation" name="co_typeOperation" required>
                <option value="">Choisir un type</option>
                <option value="VIREMENT">Virement</option>
                <option value="RETRAIT">Retrait</option>
                <option value="DEPOT">D√©p√¥t</option>
                <option value="FRAIS">Frais</option>
                <option value="COMMISSION">Commission</option>
                <option value="AUTRE">Autre</option>
              </select>
            </div>
            <div class="form-group">
              <label>Montant *</label>
              <input type="number" [(ngModel)]="createOperationForm.montant" name="co_montant" step="0.01" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Libell√© / Description *</label>
              <input type="text" [(ngModel)]="createOperationForm.libelle" name="co_libelle" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Commentaire</label>
              <textarea 
                [(ngModel)]="createOperationForm.commentaire" 
                name="co_commentaire"
                placeholder="Ajouter un commentaire (optionnel)..."
                rows="3"
                maxlength="500"
                class="comment-textarea">
              </textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="popup-footer">
        <button class="btn-secondary" (click)="closeCreateOperationPopup()">
          <i class="fas fa-times"></i> Annuler
        </button>
        <button class="btn-primary" (click)="saveCreateOperation()" [disabled]="!isCreateOperationFormValid() || creatingOperation">
          <i class="fas" [class.fa-save]="!creatingOperation" [class.fa-spinner]="creatingOperation" [class.fa-spin]="creatingOperation"></i>
          {{ creatingOperation ? 'Cr√©ation en cours...' : 'Cr√©er l\'Op√©ration' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Popup √âdition -->
  <div class="modern-popup-overlay" *ngIf="showEditPopup" (click)="closeEditPopup()">
    <div class="modern-popup edit-popup" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h2><i class="fas fa-edit"></i> Modifier l'op√©ration bancaire</h2>
        <button class="close-btn" (click)="closeEditPopup()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="popup-content">
        <form class="edit-form">
          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-globe"></i> Pays *</label>
              <select [(ngModel)]="editForm.pays" name="pays" required>
                <option value="">S√©lectionnez un pays</option>
                <option *ngFor="let pays of paysList" [value]="pays">{{ pays }}</option>
              </select>
            </div>
            <div class="form-group">
              <label><i class="fas fa-flag"></i> Code Pays</label>
              <input type="text" [(ngModel)]="editForm.codePays" name="codePays" placeholder="CI, ML, BF...">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-calendar"></i> Mois</label>
              <input type="text" [(ngModel)]="editForm.mois" name="mois" placeholder="Octobre 2024">
            </div>
            <div class="form-group">
              <label><i class="fas fa-clock"></i> Date Op√©ration *</label>
              <input type="date" [(ngModel)]="editForm.dateOperation" name="dateOperation" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-building"></i> Agence *</label>
              <input type="text" [(ngModel)]="editForm.agence" name="agence" required placeholder="Code agence">
            </div>
            <div class="form-group">
              <label><i class="fas fa-tags"></i> Type Op√©ration *</label>
              <select [(ngModel)]="editForm.typeOperation" name="typeOperation" required>
                <option value="">S√©lectionnez un type</option>
                <option *ngFor="let type of typesOperation" [value]="type">{{ type }}</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-user"></i> Nom B√©n√©ficiaire</label>
              <input type="text" [(ngModel)]="editForm.nomBeneficiaire" name="nomBeneficiaire" placeholder="Nom du b√©n√©ficiaire">
            </div>
            <div class="form-group">
              <label><i class="fas fa-credit-card"></i> Compte</label>
              <input type="text" [(ngModel)]="editForm.compteADebiter" name="compteADebiter" placeholder="Num√©ro de compte">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-money-bill-wave"></i> Montant *</label>
              <input type="number" [(ngModel)]="editForm.montant" name="montant" required placeholder="0">
            </div>
            <div class="form-group">
              <label><i class="fas fa-wallet"></i> Mode de Paiement</label>
              <select [(ngModel)]="editForm.modePaiement" name="modePaiement">
                <option value="">S√©lectionnez un mode</option>
                <option *ngFor="let mode of modesPaiement" [value]="mode">{{ mode }}</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-hashtag"></i> R√©f√©rence</label>
              <input type="text" [(ngModel)]="editForm.reference" name="reference" placeholder="R√©f√©rence de l'op√©ration">
            </div>
            <div class="form-group">
              <label><i class="fas fa-ticket-alt"></i> ID GLPI</label>
              <input type="text" [(ngModel)]="editForm.idGlpi" name="idGlpi" placeholder="ID du ticket GLPI">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-university"></i> Banque</label>
              <input type="text" [(ngModel)]="editForm.bo" name="bo" placeholder="Nom de la banque">
            </div>
            <div class="form-group">
              <label><i class="fas fa-info-circle"></i> Statut *</label>
              <select [(ngModel)]="editForm.statut" name="statut" required>
                <option *ngFor="let statut of statutsList" [value]="statut">{{ statut }}</option>
              </select>
            </div>
          </div>
        </form>
      </div>

      <div class="popup-footer">
        <button class="btn-secondary" (click)="closeEditPopup()">
          <i class="fas fa-times"></i> Annuler
        </button>
        <button class="btn-primary" (click)="saveOperation()">
          <i class="fas fa-save"></i> Enregistrer
        </button>
      </div>
    </div>
  </div>
</div> 