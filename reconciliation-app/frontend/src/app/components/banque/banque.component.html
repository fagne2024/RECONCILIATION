<div class="banque-container">
  <div class="banque-header">
    <h1>üè¶ Module BANQUE</h1>
    <p class="banque-description">Gestion des op√©rations bancaires et des comptes</p>
  </div>

  <div class="banque-content">
    <div class="banque-section">
      <h2>üìä Tableau de Bord Bancaire</h2>
      <div class="banque-stats">
        <div class="stat-card">
          <div class="stat-icon">üí∞</div>
          <div class="stat-info">
            <h3>Solde Total</h3>
            <p class="stat-value">{{ totalSoldeComptes | number:'1.0-0' }} FCFA</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìà</div>
          <div class="stat-info">
            <h3>Op√©rations bancaires</h3>
            <p class="stat-value">{{ totalOperations }}</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üèõÔ∏è</div>
          <div class="stat-info">
            <h3>Comptes</h3>
            <p class="stat-value">{{ totalComptes }}</p>
          </div>
        </div>
        <div class="stat-card warning">
          <div class="stat-icon">‚è≥</div>
          <div class="stat-info">
            <h3>En attente / En cours</h3>
            <p class="stat-value">{{ totalEnAttente }}</p>
          </div>
        </div>
        <div class="stat-card danger">
          <div class="stat-icon">üé´</div>
          <div class="stat-info">
            <h3>Tickets √† cr√©er</h3>
            <p class="stat-value">{{ totalTicketsACreer }}</p>
          </div>
        </div>
      </div>
    </div>

    <div class="banque-section">
      <h2>üîß Fonctionnalit√©s</h2>
      <div class="banque-features">
        <div class="feature-card" (click)="highlightBankAccounts()" (dblclick)="goToComptes()" title="Cliquez pour voir les comptes Banque ici, double-cliquez pour ouvrir la page Comptes">
          <div class="feature-icon">üí≥</div>
          <h3>Gestion des Comptes</h3>
          <p>Cr√©er et g√©rer les comptes bancaires</p>
        </div>
        <div class="feature-card" (click)="showOperationsTable()">
          <div class="feature-icon">üí∏</div>
          <h3>Op√©rations</h3>
          <p>Effectuer des virements et paiements</p>
        </div>
        <div class="feature-card" (click)="openRapports()">
          <div class="feature-icon">üìã</div>
          <h3>Relev√© bancaire</h3>
          <p>G√©n√©rer un relev√© bancaire</p>
        </div>
        <div class="feature-card" (click)="openSecurite()">
          <div class="feature-icon">üîÅ</div>
          <h3>R√©conciliation banque</h3>
          <p>Lancer la r√©conciliation bancaire</p>
        </div>
      </div>
    </div>

    <div class="banque-section" *ngIf="activeSection === 'rapports'">
      <div class="releve-header">
        <h2>üìã Relev√© bancaire - Import</h2>
        <div class="actions">
          <label class="file-btn">
            <input type="file" (change)="onReleveFileSelected($event)" accept=".xlsx,.xls,.csv" />
            <i class="fas fa-file-upload"></i> Choisir un fichier
          </label>
          <button class="btn-primary" [disabled]="releveUploading || !releveSelectedFile" (click)="uploadReleve()">
            <i class="fas fa-upload" [class.spin]="releveUploading"></i> Importer
          </button>
        </div>
      </div>

      <div class="batch-bar" *ngIf="releveBatchId">
        <span class="batch-badge"><i class="fas fa-hashtag"></i> {{ releveBatchId }}</span>
        <span class="muted">{{ releveRows.length }} ligne(s) import√©e(s)</span>
      </div>

      <div *ngIf="releveMessage" class="releve-alert" [ngClass]="releveMessageKind">
        <i class="fas" [ngClass]="{
          'fa-info-circle': releveMessageKind==='info',
          'fa-check-circle': releveMessageKind==='success',
          'fa-exclamation-triangle': releveMessageKind==='error'
        }"></i>
        <span>{{ releveMessage }}</span>
      </div>

      <div class="operations-table-container" *ngIf="releveRows.length">
        <div class="table-container" style="overflow-x: visible;">
          <table class="operations-table">
            <thead>
              <tr>
                <th>Num√©ro de compte</th>
                <th>Nom du compte</th>
                <th>BANQUE</th>
                <th>Date comptable</th>
                <th>Date de valeur</th>
                <th>Libell√© / Narration</th>
                <th class="right">D√©bit</th>
                <th class="right">Cr√©dit</th>
                <th class="right">Montant</th>
                <th>Ch√®que</th>
                <th>Devise</th>
                <th class="actions-col">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let r of releveRows | slice:(relevePage-1)*relevePageSize : (relevePage-1)*relevePageSize + relevePageSize">
                <td><code>{{ r.numeroCompte || '-' }}</code></td>
                <td>{{ r.nomCompte || '-' }}</td>
                <td>{{ r.banque || '-' }}</td>
                <td>{{ r.dateComptable ? (r.dateComptable | date:'dd/MM/yyyy') : '-' }}</td>
                <td>{{ r.dateValeur ? (r.dateValeur | date:'dd/MM/yyyy') : '-' }}</td>
                <td class="libelle-cell" [title]="r.libelle">{{ r.libelle || '-' }}</td>
                <td class="right"><span class="amount debit">{{ r.debit !== null && r.debit !== undefined ? (r.debit | number:'1.0-0') : '-' }}</span></td>
                <td class="right"><span class="amount credit">{{ r.credit !== null && r.credit !== undefined ? (r.credit | number:'1.0-0') : '-' }}</span></td>
                <td class="right"><span class="amount" [class.debit]="!!r.montant && r.montant < 0" [class.credit]="!!r.montant && r.montant > 0">{{ r.montant !== null && r.montant !== undefined ? (r.montant | number:'1.0-0') : '-' }}</span></td>
                <td>{{ r.numeroCheque || '-' }}</td>
                <td>{{ r.devise || '-' }}</td>
                <td class="actions-col">
                  <button class="btn-outline" (click)="openReleveEdit(r)" [disabled]="!r.id" title="Modifier cette ligne">
                    <i class="fas fa-edit"></i> Modifier
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="pagination small">
          <button (click)="relevePage = relevePage - 1" [disabled]="relevePage===1"><i class="fas fa-chevron-left"></i></button>
          <span>Page {{ relevePage }} / {{ releveTotalPages }}</span>
          <button (click)="relevePage = relevePage + 1" [disabled]="relevePage >= releveTotalPages"><i class="fas fa-chevron-right"></i></button>
          <select [(ngModel)]="relevePageSize" (change)="relevePage = 1">
            <option [value]="10">10</option>
            <option [value]="20">20</option>
            <option [value]="50">50</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Section R√©conciliation Banque -->
    <div class="banque-section" *ngIf="activeSection === 'securite'">
      <h2>üîÅ R√©conciliation Banque</h2>
      <div class="reconcile-toolbar">
        <div class="filter-group">
          <label>Pays</label>
          <select [(ngModel)]="reconPays">
            <option value="">Choisir un pays</option>
            <option *ngFor="let pays of reconPaysOptions" [value]="pays">{{ pays }}</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Date</label>
          <input type="date" [(ngModel)]="reconDate">
          <small class="muted">Optionnelle</small>
        </div>
        <button class="btn-primary" (click)="reconcile()" [disabled]="reconciling || !reconPays">
          <i class="fas fa-link" [class.spin]="reconciling"></i>
          R√©concilier
        </button>
        
        <div class="filter-group" style="margin-left:auto;">
          <label>Vue</label>
          <select [(ngModel)]="reconView" (change)="updatePagedReconciliationResults()">
            <option value="operation">√âcarts Op√©ration (BO)</option>
            <option value="releve">√âcarts Banque (Relev√©)</option>
            <option value="corr_operation">Correspondances (Op√©rations)</option>
            <option value="corr_releve">Correspondances (Relev√©)</option>
          </select>
        </div>
      </div>

      <div class="table-container" *ngIf="reconDiffRows.length">
        <!-- Filtres R√©conciliation -->
        <div class="table-filters">
          <div class="filter-group" *ngIf="reconView==='operation' || reconView==='corr_operation'">
            <label>Type d'op√©ration</label>
            <select [(ngModel)]="reconFilters.typeOperation" (change)="applyReconFilters()">
              <option value="">Tous</option>
              <option *ngFor="let type of typesOperation" [value]="type">{{ type }}</option>
            </select>
          </div>
          <div class="filter-group" *ngIf="reconView==='operation' || reconView==='corr_operation'">
            <label>Statut</label>
            <select [(ngModel)]="reconFilters.statut" (change)="applyReconFilters()">
              <option value="">Tous</option>
              <option *ngFor="let s of statutsList" [value]="s">{{ s }}</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Banque</label>
            <input type="text" [(ngModel)]="reconFilters.banque" (input)="applyReconFilters()" placeholder="Ex: BOA, SG...">
          </div>
          <div class="filter-group">
            <label>Recherche</label>
            <input type="text" [(ngModel)]="reconFilters.search" (input)="applyReconFilters()" placeholder="B√©n√©ficiaire / R√©f / Libell√© / Compte">
          </div>
          <div class="filter-group">
            <label>Montant min</label>
            <input type="number" [(ngModel)]="reconFilters.montantMin" (input)="applyReconFilters()">
          </div>
          <div class="filter-group">
            <label>Montant max</label>
            <input type="number" [(ngModel)]="reconFilters.montantMax" (input)="applyReconFilters()">
          </div>
          <button class="btn-clear-filters" (click)="clearReconFilters()">
            <i class="fas fa-times"></i>
            Effacer
          </button>
        </div>

        <div class="pagination-controls">
          <div class="page-size-selector">
            <label>Afficher</label>
            <select [(ngModel)]="reconPageSize" (change)="onReconPageSizeChange()">
              <option [value]="5">5 lignes</option>
              <option [value]="10">10 lignes</option>
              <option [value]="20">20 lignes</option>
              <option [value]="50">50 lignes</option>
              <option [value]="100">100 lignes</option>
            </select>
          </div>
          <div class="total-count">
            <i class="fas fa-list"></i>
            <span *ngIf="reconView==='operation'">{{ filteredLeftOps.length }} ligne(s) au total</span>
            <span *ngIf="reconView==='releve'">{{ filteredRightReleves.length }} ligne(s) au total</span>
            <span *ngIf="reconView==='corr_operation'">{{ filteredMatchedOps.length }} correspondance(s)</span>
            <span *ngIf="reconView==='corr_releve'">{{ filteredMatchedReleves.length }} correspondance(s)</span>
          </div>
        </div>
        
        <table class="operations-table" *ngIf="reconView==='operation'">
          <thead>
            <tr>
              <th>Pays</th>
              <th>Code Pays</th>
              <th>Mois</th>
              <th>Date Op√©ration</th>
              <th>Agence</th>
              <th>Type Op√©ration</th>
              <th>Nom du B√©n√©ficiaire</th>
              <th>Compte</th>
              <th>Montant</th>
              <th>Mode de Paiement</th>
              <th>R√©f√©rence</th>
              <th>ID GLPI</th>
              <th>Banque</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let op of pagedLeftOps">
              <td>{{ op.pays }}</td>
              <td>{{ op.codePays }}</td>
              <td>{{ op.mois }}</td>
              <td>{{ op.dateOperation | date:'dd/MM/yyyy' }}</td>
              <td>{{ op.agence }}</td>
              <td>{{ op.typeOperation }}</td>
              <td>{{ op.nomBeneficiaire }}</td>
              <td>{{ op.compteADebiter }}</td>
              <td>{{ op.montant | currency:'XAF':'symbol':'1.0-0' }}</td>
              <td>{{ op.modePaiement }}</td>
              <td>{{ op.reference }}</td>
              <td>{{ op.idGlpi || '-' }}</td>
              <td>{{ op.bo }}</td>
              <td>{{ op.statut }}</td>
            </tr>
          </tbody>
        </table>
        
        <table class="operations-table" *ngIf="reconView==='releve'">
          <thead>
            <tr>
              <th>Num√©ro de compte</th>
              <th>Nom du compte</th>
              <th>Banque</th>
              <th>Date comptable</th>
              <th>Date de valeur</th>
              <th>Libell√© / Narration</th>
              <th class="right">D√©bit</th>
              <th class="right">Cr√©dit</th>
              <th class="right">Montant</th>
              <th>Ch√®que</th>
              <th>Devise</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of pagedRightReleves">
              <td><code>{{ r.numeroCompte || '-' }}</code></td>
              <td>{{ r.nomCompte || '-' }}</td>
              <td>{{ r.banque || '-' }}</td>
              <td>{{ r.dateComptable ? (r.dateComptable | date:'dd/MM/yyyy') : '-' }}</td>
              <td>{{ r.dateValeur ? (r.dateValeur | date:'dd/MM/yyyy') : '-' }}</td>
              <td class="libelle-cell" [title]="r.libelle">{{ r.libelle || '-' }}</td>
              <td class="right">{{ r.debit !== null && r.debit !== undefined ? (r.debit | number:'1.0-0') : '-' }}</td>
              <td class="right">{{ r.credit !== null && r.credit !== undefined ? (r.credit | number:'1.0-0') : '-' }}</td>
              <td class="right">{{ r.montant !== null && r.montant !== undefined ? (r.montant | number:'1.0-0') : '-' }}</td>
              <td>{{ r.numeroCheque || '-' }}</td>
              <td>{{ r.devise || '-' }}</td>
            </tr>
          </tbody>
        </table>

        <table class="operations-table" *ngIf="reconView==='corr_operation'">
          <thead>
            <tr>
              <th>Pays</th>
              <th>Code Pays</th>
              <th>Mois</th>
              <th>Date Op√©ration</th>
              <th>Agence</th>
              <th>Type Op√©ration</th>
              <th>Nom du B√©n√©ficiaire</th>
              <th>Compte</th>
              <th>Montant</th>
              <th>Mode de Paiement</th>
              <th>R√©f√©rence</th>
              <th>ID GLPI</th>
              <th>Banque</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let op of pagedMatchedOps">
              <td>{{ op.pays }}</td>
              <td>{{ op.codePays }}</td>
              <td>{{ op.mois }}</td>
              <td>{{ op.dateOperation | date:'dd/MM/yyyy' }}</td>
              <td>{{ op.agence }}</td>
              <td>{{ op.typeOperation }}</td>
              <td>{{ op.nomBeneficiaire }}</td>
              <td>{{ op.compteADebiter }}</td>
              <td>{{ op.montant | currency:'XAF':'symbol':'1.0-0' }}</td>
              <td>{{ op.modePaiement }}</td>
              <td>{{ op.reference }}</td>
              <td>{{ op.idGlpi || '-' }}</td>
              <td>{{ op.bo }}</td>
              <td>{{ op.statut }}</td>
            </tr>
          </tbody>
        </table>

        <table class="operations-table" *ngIf="reconView==='corr_releve'">
          <thead>
            <tr>
              <th>Num√©ro de compte</th>
              <th>Nom du compte</th>
              <th>Banque</th>
              <th>Date comptable</th>
              <th>Date de valeur</th>
              <th>Libell√© / Narration</th>
              <th class="right">D√©bit</th>
              <th class="right">Cr√©dit</th>
              <th class="right">Montant</th>
              <th>Ch√®que</th>
              <th>Devise</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of pagedMatchedReleves">
              <td><code>{{ r.numeroCompte || '-' }}</code></td>
              <td>{{ r.nomCompte || '-' }}</td>
              <td>{{ r.banque || '-' }}</td>
              <td>{{ r.dateComptable ? (r.dateComptable | date:'dd/MM/yyyy') : '-' }}</td>
              <td>{{ r.dateValeur ? (r.dateValeur | date:'dd/MM/yyyy') : '-' }}</td>
              <td class="libelle-cell" [title]="r.libelle">{{ r.libelle || '-' }}</td>
              <td class="right">{{ r.debit !== null && r.debit !== undefined ? (r.debit | number:'1.0-0') : '-' }}</td>
              <td class="right">{{ r.credit !== null && r.credit !== undefined ? (r.credit | number:'1.0-0') : '-' }}</td>
              <td class="right">{{ r.montant !== null && r.montant !== undefined ? (r.montant | number:'1.0-0') : '-' }}</td>
              <td>{{ r.numeroCheque || '-' }}</td>
              <td>{{ r.devise || '-' }}</td>
            </tr>
          </tbody>
        </table>

        <div class="pagination" *ngIf="(reconView==='operation' ? reconOpTotalPages : reconRevTotalPages) > 1">
          <button (click)="reconPrevPage()" [disabled]="(reconView==='operation' ? reconOpPage===1 : reconRevPage===1)">
            <i class="fas fa-chevron-left"></i> Pr√©c√©dent
          </button>
          <div class="pagination-indicators">
            <span *ngFor="let page of getReconVisiblePages()" class="page-indicator" [class.active]="reconPage === page" (click)="reconGoToPage(page)">{{ page }}</span>
          </div>
          <button (click)="reconNextPage()" [disabled]="(
            reconView==='operation' ? reconOpPage===reconOpTotalPages : (
            reconView==='releve' ? reconRevPage===reconRevTotalPages : (
            reconView==='corr_operation' ? reconCorrOpPage===reconCorrOpTotalPages : reconCorrRevPage===reconCorrRevTotalPages)))">
            Suivant <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
      <div *ngIf="!reconDiffRows.length" class="empty-row">
        Aucune donn√©e. S√©lectionnez un pays et une date puis lancez la r√©conciliation.
      </div>
    </div>

    

    <div class="banque-section" *ngIf="!showOperations && activeSection === 'home'">
      <div class="section-header">
        <h2>üè¶ Comptes de Banque</h2>
        <button class="btn-refresh" (click)="loadComptesBanque()" [disabled]="loadingComptesBanque">
          <i class="fas fa-sync-alt" [class.spin]="loadingComptesBanque"></i>
          Actualiser
        </button>
      </div>

      <div *ngIf="comptesBanqueError" class="error-box">
        {{ comptesBanqueError }}
      </div>

      <div class="table-container small" *ngIf="!comptesBanqueError">
        <div class="comptes-toolbar">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" [(ngModel)]="comptesSearch" placeholder="Rechercher (compte, code, pays, type)...">
          </div>
          <div class="legend">
            <span class="badge badge-banque">Banque</span>
            <span class="dot"></span>
            <span class="muted">{{ comptesBanqueDisplayed.length }} compte(s)</span>
          </div>
        </div>

        <table class="fancy-table comptes-table">
          <thead>
            <tr>
              <th>Num√©ro de Compte</th>
              <th>Code Propri√©taire</th>
              <th>Pays</th>
              <th>Cat√©gorie</th>
              <th>Type</th>
              <th class="right">Solde</th>
              <th>Derni√®re MAJ</th>
              <th class="actions-col">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="loadingComptesBanque">
              <td colspan="8" class="loading-row">
                <i class="fas fa-spinner spin"></i> Chargement des comptes Banque...
              </td>
            </tr>
            <tr *ngIf="!loadingComptesBanque && comptesBanqueDisplayed.length === 0">
              <td colspan="8" class="empty-row">
                Aucun compte de cat√©gorie Banque trouv√©.
              </td>
            </tr>
            <tr *ngFor="let c of comptesBanqueDisplayed" [class.expanded]="selectedCompteNumero === c.numeroCompte">
              <td (click)="toggleCompte(c)" class="clickable">
                <div class="cell-main">
                  <code>{{ c.numeroCompte }}</code>
                  <button class="btn-copy" title="Copier" (click)="$event.stopPropagation(); copyToClipboard(c.numeroCompte)">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
                <div class="cell-sub" *ngIf="selectedCompteNumero === c.numeroCompte">{{ c.categorie || '-' }} ‚Ä¢ {{ c.type || '-' }}</div>
              </td>
              <td *ngIf="selectedCompteNumero === c.numeroCompte">
                <span class="chip chip-owner">{{ c.codeProprietaire || '-' }}</span>
              </td>
              <td *ngIf="selectedCompteNumero === c.numeroCompte">
                <span class="chip chip-country">
                  <i class="fas fa-globe-africa"></i> {{ c.pays }}
                </span>
              </td>
              <td *ngIf="selectedCompteNumero === c.numeroCompte">{{ c.categorie || '-' }}</td>
              <td *ngIf="selectedCompteNumero === c.numeroCompte">{{ c.type || '-' }}</td>
              <td class="right" *ngIf="selectedCompteNumero === c.numeroCompte">
                <span class="amount" [class.negative]="c.solde < 0">{{ c.solde | number:'1.2-2' }}</span>
              </td>
              <td *ngIf="selectedCompteNumero === c.numeroCompte">{{ c.dateDerniereMaj | date:'dd/MM/yyyy HH:mm' }}</td>
              <td class="actions-col" *ngIf="selectedCompteNumero === c.numeroCompte">
                <button class="btn-outline" (click)="openCompteRelevePopup(c)" title="Voir op√©rations du compte"><i class="fas fa-receipt"></i> Relev√©</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Popup op√©rations par compte -->
  <div class="modern-popup-overlay" *ngIf="showCompteOpsPopup" (click)="closeCompteRelevePopup()">
    <div class="modern-popup detail-popup" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h2><i class="fas fa-receipt"></i> Op√©rations du compte <code>{{ compteOpsNumero }}</code></h2>
        <button class="close-btn" (click)="closeCompteRelevePopup()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="popup-content">
        <div class="operations-table-container">
          <div class="table-filters">
            <div class="filter-group">
              <label>Date d√©but</label>
              <input type="date" [(ngModel)]="compteOpsDateFrom" (change)="applyCompteOpsFilters()">
            </div>
            <div class="filter-group">
              <label>Date fin</label>
              <input type="date" [(ngModel)]="compteOpsDateTo" (change)="applyCompteOpsFilters()">
            </div>
            <button class="btn-outline" style="margin-left:auto;" (click)="exportCompteOps()" title="Exporter CSV">
              <i class="fas fa-file-export"></i> Exporter
            </button>
            <div class="page-size-selector">
              <label>Afficher</label>
              <select [(ngModel)]="compteOpsPageSize" (change)="onCompteOpsPageSizeChange()">
                <option [value]="5">5 lignes</option>
                <option [value]="10">10 lignes</option>
                <option [value]="20">20 lignes</option>
              </select>
            </div>
          </div>
          <div class="table-container">
            <table class="operations-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Agence</th>
                  <th>B√©n√©ficiaire</th>
                  <th class="right">D√©bit</th>
                  <th class="right">Cr√©dit</th>
                  <th>R√©f√©rence</th>
                  <th>Statut</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let op of compteOpsPaged">
                  <td>{{ op.dateOperation | date:'dd/MM/yyyy' }}</td>
                  <td>{{ op.typeOperation }}</td>
                  <td>{{ op.agence }}</td>
                  <td>{{ op.nomBeneficiaire || '-' }}</td>
                  <td class="right">
                    <span class="amount debit" *ngIf="getDebitForOperation(op) !== null">{{ getDebitForOperation(op) | number:'1.0-0' }}</span>
                    <span *ngIf="getDebitForOperation(op) === null">-</span>
                  </td>
                  <td class="right">
                    <span class="amount credit" *ngIf="getCreditForOperation(op) !== null">{{ getCreditForOperation(op) | number:'1.0-0' }}</span>
                    <span *ngIf="getCreditForOperation(op) === null">-</span>
                  </td>
                  <td>{{ op.reference || '-' }}</td>
                  <td>{{ op.statut || '-' }}</td>
                </tr>
                <tr *ngIf="!compteOpsPaged.length">
                  <td colspan="8" class="empty-row">Aucune op√©ration pour cette p√©riode.</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="pagination" *ngIf="compteOpsTotalPages > 1">
            <button (click)="compteOpsPrevPage()" [disabled]="compteOpsPage===1"><i class="fas fa-chevron-left"></i> Pr√©c√©dent</button>
            <div class="pagination-indicators">
              <span *ngFor="let page of getCompteOpsVisiblePages()" class="page-indicator" [class.active]="compteOpsPage === page" (click)="compteOpsGoToPage(page)">{{ page }}</span>
            </div>
            <button (click)="compteOpsNextPage()" [disabled]="compteOpsPage===compteOpsTotalPages">Suivant <i class="fas fa-chevron-right"></i></button>
          </div>
        </div>
      </div>
      <div class="popup-footer">
        <button class="btn-secondary" (click)="closeCompteRelevePopup()"><i class="fas fa-times"></i> Fermer</button>
      </div>
    </div>
  </div>

  <!-- Tableau des op√©rations bancaires -->
  <div class="banque-section operations-section" *ngIf="showOperations">
    <div class="operations-header">
      <h2>üìã Op√©rations Bancaires</h2>
      <button class="btn-back" (click)="hideOperationsTable()">
        <i class="fas fa-arrow-left"></i>
        Retour
      </button>
    </div>

    <div class="operations-table-container">
      <!-- Filtres -->
      <div class="table-filters">
        <div class="filter-group">
          <label>Pays</label>
          <select [(ngModel)]="filters.pays" (change)="applyFilters()">
            <option value="">Tous les pays</option>
            <option *ngFor="let pays of paysList" [value]="pays">{{ pays }}</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Type d'op√©ration</label>
          <select [(ngModel)]="filters.typeOperation" (change)="applyFilters()">
            <option value="">Tous les types</option>
            <option *ngFor="let type of typesOperation" [value]="type">{{ type }}</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Statut</label>
          <select [(ngModel)]="filters.statut" (change)="applyFilters()">
            <option value="">Tous les statuts</option>
            <option *ngFor="let statut of statutsList" [value]="statut">{{ statut }}</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Date d√©but</label>
          <input type="date" [(ngModel)]="filters.dateDebut" (change)="applyFilters()">
        </div>
        <div class="filter-group">
          <label>Date fin</label>
          <input type="date" [(ngModel)]="filters.dateFin" (change)="applyFilters()">
        </div>
        <button class="btn-clear-filters" (click)="clearFilters()">
          <i class="fas fa-times"></i>
          Effacer
        </button>
      </div>

      <!-- Contr√¥les de pagination -->
      <div class="pagination-controls">
        <div class="page-size-selector">
          <label>Afficher</label>
          <select [(ngModel)]="pageSize" (change)="onPageSizeChange()">
            <option [value]="5">5 lignes</option>
            <option [value]="10">10 lignes</option>
            <option [value]="20">20 lignes</option>
            <option [value]="50">50 lignes</option>
            <option [value]="100">100 lignes</option>
          </select>
        </div>
        <div class="total-count">
          <i class="fas fa-list"></i>
          <span>{{ filteredOperations.length }} op√©ration(s) au total</span>
        </div>
      </div>

      <!-- Tableau -->
      <div class="table-container">
        <table class="operations-table">
          <thead>
            <tr>
              <th>Pays</th>
              <th>Code Pays</th>
              <th>Mois</th>
              <th>Date Op√©ration</th>
              <th>Agence</th>
              <th>Type Op√©ration</th>
              <th>Nom du B√©n√©ficiaire</th>
              <th>Compte</th>
              <th>Montant</th>
              <th>Mode de Paiement</th>
              <th>R√©f√©rence</th>
              <th>ID GLPI</th>
              <th>Banque</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let operation of pagedOperations">
              <td>{{ operation.pays }}</td>
              <td>{{ operation.codePays }}</td>
              <td>{{ operation.mois }}</td>
              <td>{{ operation.dateOperation | date:'dd/MM/yyyy' }}</td>
              <td>{{ operation.agence }}</td>
              <td>
                <span class="badge type-{{ operation.typeOperation.toLowerCase() }}">
                  {{ operation.typeOperation }}
                </span>
              </td>
              <td>{{ operation.nomBeneficiaire }}</td>
              <td>{{ operation.compteADebiter }}</td>
              <td>{{ operation.montant | currency:'XAF':'symbol':'1.0-0' }}</td>
              <td>{{ operation.modePaiement }}</td>
              <td>{{ operation.reference }}</td>
              <td class="glpi-cell">
                <button 
                  *ngIf="!operation.idGlpi || operation.idGlpi.trim() === ''" 
                  class="btn-glpi-create"
                  (click)="openGlpiCreate()"
                  title="Cr√©er un ticket GLPI">
                  <i class="fas fa-plus-circle"></i> Cr√©er
                </button>
                <a 
                  *ngIf="operation.idGlpi && operation.idGlpi.trim() !== ''"
                  [href]="getGlpiTicketUrl(operation.idGlpi)"
                  target="_blank"
                  class="glpi-link"
                  title="Ouvrir le ticket GLPI {{ operation.idGlpi }}">
                  <i class="fas fa-ticket-alt"></i> {{ operation.idGlpi }}
                </a>
              </td>
              <td>{{ operation.bo }}</td>
              <td>
                <span class="badge status-{{ operation.statut.toLowerCase() }}">
                  {{ operation.statut }}
                </span>
              </td>
              <td class="actions">
                <button class="btn-icon" (click)="viewOperation(operation)" title="Voir">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn-icon" (click)="editOperation(operation)" title="Modifier">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon btn-danger" (click)="deleteOperation(operation.id)" title="Supprimer">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination" *ngIf="totalPages > 1">
        <button (click)="prevPage()" [disabled]="currentPage === 1">
          <i class="fas fa-chevron-left"></i> Pr√©c√©dent
        </button>
        
        <div class="pagination-indicators">
          <span *ngFor="let page of getVisiblePages()" 
                class="page-indicator"
                [class.active]="currentPage === page"
                (click)="goToPage(page)">
            {{ page }}
          </span>
        </div>
        
        <button (click)="nextPage()" [disabled]="currentPage === totalPages">
          Suivant <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Popup D√©tails -->
  <div class="modern-popup-overlay" *ngIf="showDetailPopup" (click)="closeDetailPopup()">
    <div class="modern-popup detail-popup" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h2><i class="fas fa-info-circle"></i> D√©tails de l'op√©ration bancaire</h2>
        <button class="close-btn" (click)="closeDetailPopup()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="popup-content" *ngIf="selectedOperation">
        <div class="detail-grid">
          <div class="detail-item">
            <label><i class="fas fa-globe"></i> Pays</label>
            <span>{{ selectedOperation.pays || 'Non renseign√©' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-flag"></i> Code Pays</label>
            <span>{{ selectedOperation.codePays || 'Non renseign√©' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-calendar"></i> Mois</label>
            <span>{{ selectedOperation.mois || 'Non renseign√©' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-clock"></i> Date Op√©ration</label>
            <span>{{ selectedOperation.dateOperation | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-building"></i> Agence</label>
            <span>{{ selectedOperation.agence }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-tags"></i> Type Op√©ration</label>
            <span class="badge">{{ selectedOperation.typeOperation }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-user"></i> Nom B√©n√©ficiaire</label>
            <span>{{ selectedOperation.nomBeneficiaire || 'Non renseign√©' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-credit-card"></i> Compte</label>
            <span>{{ selectedOperation.compteADebiter || 'Non renseign√©' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-money-bill-wave"></i> Montant</label>
            <span class="montant">{{ selectedOperation.montant | currency:'XAF':'symbol':'1.0-0' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-wallet"></i> Mode de Paiement</label>
            <span>{{ selectedOperation.modePaiement || 'Non renseign√©' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-hashtag"></i> R√©f√©rence</label>
            <span>{{ selectedOperation.reference || 'Non renseign√©e' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-ticket-alt"></i> ID GLPI</label>
            <span>
              <a *ngIf="selectedOperation.idGlpi && selectedOperation.idGlpi.trim() !== ''" 
                 [href]="getGlpiTicketUrl(selectedOperation.idGlpi)"
                 target="_blank"
                 class="glpi-link-small">
                {{ selectedOperation.idGlpi }}
              </a>
              <span *ngIf="!selectedOperation.idGlpi || selectedOperation.idGlpi.trim() === ''">Non renseign√©</span>
            </span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-university"></i> Banque</label>
            <span>{{ selectedOperation.bo || 'Non renseign√©' }}</span>
          </div>
          <div class="detail-item">
            <label><i class="fas fa-info-circle"></i> Statut</label>
            <span class="badge status-{{ selectedOperation.statut?.toLowerCase() }}">
              {{ selectedOperation.statut }}
            </span>
          </div>
        </div>
      </div>

      <div class="popup-footer">
        <button class="btn-secondary" (click)="closeDetailPopup()">
          <i class="fas fa-times"></i> Fermer
        </button>
        <button class="btn-primary" (click)="closeDetailPopup(); editOperation(selectedOperation!)">
          <i class="fas fa-edit"></i> Modifier
        </button>
      </div>
    </div>
  </div>

  <!-- Popup √âdition Relev√© -->
  <div class="modern-popup-overlay" *ngIf="showReleveEditPopup" (click)="closeReleveEdit()">
    <div class="modern-popup edit-popup" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h2><i class="fas fa-edit"></i> Modifier la ligne de relev√©</h2>
        <button class="close-btn" (click)="closeReleveEdit()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="popup-content">
        <form class="edit-form">
          <div class="form-row">
            <div class="form-group">
              <label>Num√©ro de compte</label>
              <input type="text" [(ngModel)]="releveEditForm.numeroCompte" name="rv_numeroCompte">
            </div>
            <div class="form-group">
              <label>Nom du compte</label>
              <input type="text" [(ngModel)]="releveEditForm.nomCompte" name="rv_nomCompte">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Banque</label>
              <input type="text" [(ngModel)]="releveEditForm.banque" name="rv_banque">
            </div>
            <div class="form-group">
              <label>Ch√®que</label>
              <input type="text" [(ngModel)]="releveEditForm.numeroCheque" name="rv_numeroCheque">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Date comptable</label>
              <input type="date" [(ngModel)]="releveEditForm.dateComptable" name="rv_dateComptable">
            </div>
            <div class="form-group">
              <label>Date de valeur</label>
              <input type="date" [(ngModel)]="releveEditForm.dateValeur" name="rv_dateValeur">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>D√©bit</label>
              <input type="number" [(ngModel)]="releveEditForm.debit" name="rv_debit">
            </div>
            <div class="form-group">
              <label>Cr√©dit</label>
              <input type="number" [(ngModel)]="releveEditForm.credit" name="rv_credit">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Montant</label>
              <input type="number" [(ngModel)]="releveEditForm.montant" name="rv_montant">
            </div>
            <div class="form-group">
              <label>Devise</label>
              <input type="text" [(ngModel)]="releveEditForm.devise" name="rv_devise">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Libell√© / Narration</label>
              <input type="text" [(ngModel)]="releveEditForm.libelle" name="rv_libelle">
            </div>
          </div>
        </form>
      </div>
      <div class="popup-footer">
        <button class="btn-secondary" (click)="closeReleveEdit()"><i class="fas fa-times"></i> Annuler</button>
        <button class="btn-primary" (click)="saveReleveEdit()"><i class="fas fa-save"></i> Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Popup √âdition -->
  <div class="modern-popup-overlay" *ngIf="showEditPopup" (click)="closeEditPopup()">
    <div class="modern-popup edit-popup" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h2><i class="fas fa-edit"></i> Modifier l'op√©ration bancaire</h2>
        <button class="close-btn" (click)="closeEditPopup()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="popup-content">
        <form class="edit-form">
          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-globe"></i> Pays *</label>
              <select [(ngModel)]="editForm.pays" name="pays" required>
                <option value="">S√©lectionnez un pays</option>
                <option *ngFor="let pays of paysList" [value]="pays">{{ pays }}</option>
              </select>
            </div>
            <div class="form-group">
              <label><i class="fas fa-flag"></i> Code Pays</label>
              <input type="text" [(ngModel)]="editForm.codePays" name="codePays" placeholder="CI, ML, BF...">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-calendar"></i> Mois</label>
              <input type="text" [(ngModel)]="editForm.mois" name="mois" placeholder="Octobre 2024">
            </div>
            <div class="form-group">
              <label><i class="fas fa-clock"></i> Date Op√©ration *</label>
              <input type="date" [(ngModel)]="editForm.dateOperation" name="dateOperation" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-building"></i> Agence *</label>
              <input type="text" [(ngModel)]="editForm.agence" name="agence" required placeholder="Code agence">
            </div>
            <div class="form-group">
              <label><i class="fas fa-tags"></i> Type Op√©ration *</label>
              <select [(ngModel)]="editForm.typeOperation" name="typeOperation" required>
                <option value="">S√©lectionnez un type</option>
                <option *ngFor="let type of typesOperation" [value]="type">{{ type }}</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-user"></i> Nom B√©n√©ficiaire</label>
              <input type="text" [(ngModel)]="editForm.nomBeneficiaire" name="nomBeneficiaire" placeholder="Nom du b√©n√©ficiaire">
            </div>
            <div class="form-group">
              <label><i class="fas fa-credit-card"></i> Compte</label>
              <input type="text" [(ngModel)]="editForm.compteADebiter" name="compteADebiter" placeholder="Num√©ro de compte">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-money-bill-wave"></i> Montant *</label>
              <input type="number" [(ngModel)]="editForm.montant" name="montant" required placeholder="0">
            </div>
            <div class="form-group">
              <label><i class="fas fa-wallet"></i> Mode de Paiement</label>
              <select [(ngModel)]="editForm.modePaiement" name="modePaiement">
                <option value="">S√©lectionnez un mode</option>
                <option *ngFor="let mode of modesPaiement" [value]="mode">{{ mode }}</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-hashtag"></i> R√©f√©rence</label>
              <input type="text" [(ngModel)]="editForm.reference" name="reference" placeholder="R√©f√©rence de l'op√©ration">
            </div>
            <div class="form-group">
              <label><i class="fas fa-ticket-alt"></i> ID GLPI</label>
              <input type="text" [(ngModel)]="editForm.idGlpi" name="idGlpi" placeholder="ID du ticket GLPI">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-university"></i> Banque</label>
              <input type="text" [(ngModel)]="editForm.bo" name="bo" placeholder="Nom de la banque">
            </div>
            <div class="form-group">
              <label><i class="fas fa-info-circle"></i> Statut *</label>
              <select [(ngModel)]="editForm.statut" name="statut" required>
                <option *ngFor="let statut of statutsList" [value]="statut">{{ statut }}</option>
              </select>
            </div>
          </div>
        </form>
      </div>

      <div class="popup-footer">
        <button class="btn-secondary" (click)="closeEditPopup()">
          <i class="fas fa-times"></i> Annuler
        </button>
        <button class="btn-primary" (click)="saveOperation()">
          <i class="fas fa-save"></i> Enregistrer
        </button>
      </div>
    </div>
  </div>
</div> 