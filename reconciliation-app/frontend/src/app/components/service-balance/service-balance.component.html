<div class="service-balance-container">
    <!-- En-tête -->
    <div class="header">
        <div class="header-content">
            <h1><i class="fas fa-balance-scale"></i> Regroupement des Comptes Service</h1>
            <p class="subtitle">Créez un compte consolidé à partir de plusieurs comptes service par pays</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" (click)="loadServiceComptes()" [disabled]="isLoading">
                <i class="fas fa-sync-alt" [class.fa-spin]="isLoading"></i>
                Actualiser
            </button>
            <button class="btn btn-info" (click)="loadAllComptes()" [disabled]="isLoading">
                <i class="fas fa-list" [class.fa-spin]="isLoading"></i>
                Voir Tous les Comptes
            </button>
        </div>
    </div>

    <!-- Statistiques globales -->
    <div class="stats-section" *ngIf="!isLoading">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ serviceComptes.length }}</div>
                <div class="stat-label">Comptes Service</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-globe"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ getCountries().length }}</div>
                <div class="stat-label">Pays</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ getSelectedComptesCount() }}</div>
                <div class="stat-label">Sélectionnés</div>
            </div>
        </div>
        <div class="stat-card" *ngIf="getSelectedComptesCount() > 0">
            <div class="stat-icon">
                <i class="fas fa-coins"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ getTotalSelectedSolde() | currency:'XAF':'symbol':'1.0-0' }}</div>
                <div class="stat-label">Solde Total</div>
            </div>
        </div>
    </div>

    <!-- Sélection du pays -->
    <div class="country-selection" *ngIf="!isLoading && getCountries().length > 0">
        <h3><i class="fas fa-map-marker-alt"></i> Sélectionner un pays</h3>
        <div class="country-grid">
            <div 
                *ngFor="let country of getCountries()" 
                class="country-card"
                [class.selected]="selectedCountry === country"
                (click)="onCountryChange(country)">
                <div class="country-name">{{ country }}</div>
                <div class="country-stats">
                    <span class="compte-count">{{ getComptesForCountry(country).length }} comptes</span>
                    <span class="total-solde">{{ getTotalSoldeForCountry(country) | currency:'XAF':'symbol':'1.0-0' }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des comptes service -->
    <div class="comptes-section" *ngIf="!isLoading && selectedCountry && filteredServiceComptes.length > 0">
        <div class="section-header">
            <h3><i class="fas fa-list"></i> Comptes Service - {{ selectedCountry }}</h3>
            <button 
                class="btn btn-primary" 
                (click)="showMergeDialog()"
                [disabled]="getSelectedComptesCount() < 2">
                <i class="fas fa-layer-group"></i>
                Regrouper les comptes sélectionnés ({{ getSelectedComptesCount() }})
            </button>
        </div>

        <!-- Barre de filtres et recherche -->
        <div class="filters-section">
            <div class="filters-row">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input 
                        type="text" 
                        [(ngModel)]="searchTerm" 
                        (input)="onSearchChange()"
                        placeholder="Rechercher par nom de compte ou agence..."
                        class="search-input">
                </div>
                
                <div class="filter-controls">
                    <select 
                        [(ngModel)]="filterBySolde" 
                        (change)="onFilterChange()"
                        class="filter-select">
                        <option value="all">Tous les soldes</option>
                        <option value="positive">Soldes positifs</option>
                        <option value="negative">Soldes négatifs</option>
                        <option value="zero">Soldes à zéro</option>
                    </select>
                    
                    <select 
                        [(ngModel)]="sortBy" 
                        (change)="onSortChange()"
                        class="filter-select">
                        <option value="numeroCompte">Trier par nom</option>
                        <option value="solde">Trier par solde</option>
                        <option value="dateDerniereMaj">Trier par date</option>
                    </select>
                    
                    <button 
                        (click)="sortOrder = sortOrder === 'asc' ? 'desc' : 'asc'; onSortChange()"
                        class="btn btn-secondary sort-btn">
                        <i class="fas" [class.fa-sort-amount-up]="sortOrder === 'asc'" [class.fa-sort-amount-down]="sortOrder === 'desc'"></i>
                        {{ sortOrder === 'asc' ? 'Croissant' : 'Décroissant' }}
                    </button>
                    
                    <button 
                        (click)="clearFilters()"
                        class="btn btn-warning clear-btn">
                        <i class="fas fa-times"></i>
                        Effacer les filtres
                    </button>
                </div>
            </div>
            
            <div class="results-info">
                <span class="results-count">
                    {{ getTotalFilteredCount() }} compte(s) trouvé(s)
                    <span *ngIf="searchTerm || filterBySolde !== 'all'" class="filtered-indicator">
                        (filtré sur {{ filteredServiceComptes.length }} compte(s) au total)
                    </span>
                </span>
            </div>
        </div>

        <!-- Grille des comptes -->
        <div class="comptes-grid">
            <div 
                *ngFor="let compte of paginatedComptes" 
                class="compte-card"
                [class.selected]="isCompteSelected(compte)"
                (click)="toggleCompteSelection(compte)">
                <div class="compte-header">
                    <div class="compte-checkbox">
                        <i class="fas fa-check" *ngIf="isCompteSelected(compte)"></i>
                    </div>
                    <div class="compte-info">
                        <div class="compte-name">{{ compte.numeroCompte }}</div>
                        <div class="compte-details">
                            <span class="compte-agence" *ngIf="compte.agence">
                                <i class="fas fa-building"></i> {{ compte.agence }}
                            </span>
                            <span class="compte-date">
                                <i class="fas fa-calendar"></i> {{ compte.dateDerniereMaj | date:'dd/MM/yyyy HH:mm' }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="compte-solde">
                    <div class="solde-amount" [class.positive]="compte.solde >= 0" [class.negative]="compte.solde < 0">
                        {{ compte.solde | currency:'XAF':'symbol':'1.0-0' }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination-section" *ngIf="totalPages > 1">
            <div class="pagination-info">
                Page {{ currentPage }} sur {{ totalPages }} 
                ({{ (currentPage - 1) * itemsPerPage + 1 }} - {{ Math.min(currentPage * itemsPerPage, getTotalFilteredCount()) }} sur {{ getTotalFilteredCount() }} comptes)
            </div>
            
            <div class="pagination-controls">
                <button 
                    (click)="previousPage()"
                    [disabled]="currentPage === 1"
                    class="btn btn-secondary pagination-btn">
                    <i class="fas fa-chevron-left"></i>
                    Précédent
                </button>
                
                <div class="page-numbers">
                    <button 
                        *ngFor="let page of getPageNumbers()"
                        (click)="goToPage(page)"
                        [class.active]="page === currentPage"
                        class="btn page-btn">
                        {{ page }}
                    </button>
                </div>
                
                <button 
                    (click)="nextPage()"
                    [disabled]="currentPage === totalPages"
                    class="btn btn-secondary pagination-btn">
                    Suivant
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Message si aucun compte service -->
    <div class="no-data" *ngIf="!isLoading && serviceComptes.length === 0">
        <i class="fas fa-info-circle"></i>
        <h3>Aucun compte service trouvé</h3>
        <p>Il n'y a actuellement aucun compte service dans le système.</p>
    </div>

    <!-- Message si aucun pays sélectionné -->
    <div class="no-data" *ngIf="!isLoading && serviceComptes.length > 0 && !selectedCountry">
        <i class="fas fa-globe"></i>
        <h3>Sélectionnez un pays</h3>
        <p>Choisissez un pays pour voir les comptes service disponibles.</p>
    </div>

    <!-- Message si aucun compte pour le pays sélectionné -->
    <div class="no-data" *ngIf="!isLoading && selectedCountry && filteredServiceComptes.length === 0">
        <i class="fas fa-building"></i>
        <h3>Aucun compte service pour {{ selectedCountry }}</h3>
        <p>Il n'y a aucun compte service pour le pays sélectionné.</p>
    </div>

    <!-- Loading -->
    <div class="loading" *ngIf="isLoading">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Chargement des comptes service...</p>
    </div>
</div>

<!-- Modal de fusion -->
<div *ngIf="showMergeForm" class="modal-overlay" (click)="cancelMerge()">
    <div class="modal-container" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3><i class="fas fa-layer-group"></i> Regrouper les comptes service</h3>
            <button type="button" class="modal-close" (click)="cancelMerge()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <form [formGroup]="mergeForm" (ngSubmit)="mergeComptes()">
                <!-- Résumé du regroupement -->
                <div class="merge-summary">
                    <h4><i class="fas fa-info-circle"></i> Résumé du regroupement</h4>
                    <div class="summary-details">
                        <div class="summary-item">
                            <span class="label">Nombre de comptes :</span>
                            <span class="value">{{ getSelectedComptesCount() }}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Solde total :</span>
                            <span class="value">{{ getTotalSelectedSolde() | currency:'XAF':'symbol':'1.0-0' }}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Pays :</span>
                            <span class="value">{{ selectedCountry }}</span>
                        </div>
                    </div>
                </div>

                <!-- Formulaire de fusion -->
                <div class="form-section">
                    <h4><i class="fas fa-edit"></i> Détails du nouveau compte</h4>
                    
                    <div class="form-group">
                        <label>Nom du nouveau compte *</label>
                        <input 
                            type="text" 
                            formControlName="newCompteName" 
                            placeholder="Ex: SERVICE_FUSION_CM_2025"
                            class="text-input">
                        <div *ngIf="mergeForm.get('newCompteName')?.invalid && mergeForm.get('newCompteName')?.touched" 
                             class="error-message">
                            Le nom du compte est requis (minimum 3 caractères)
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Pays *</label>
                        <input 
                            type="text" 
                            formControlName="selectedCountry" 
                            [value]="selectedCountry"
                            readonly
                            class="text-input readonly">
                    </div>
                </div>

                <!-- Liste des comptes à regrouper -->
                <div class="comptes-to-merge">
                    <h4><i class="fas fa-list"></i> Comptes à regrouper</h4>
                    <div class="comptes-list">
                        <div *ngFor="let compte of selectedComptes" class="compte-item">
                            <div class="compte-name">{{ compte.numeroCompte }}</div>
                            <div class="compte-solde">{{ compte.solde | currency:'XAF':'symbol':'1.0-0' }}</div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" (click)="cancelMerge()">
                        <i class="fas fa-times"></i>
                        Annuler
                    </button>
                    <button 
                        type="submit" 
                        class="btn btn-primary" 
                        [disabled]="!mergeForm.valid || isMerging">
                        <i class="fas fa-layer-group" [class.fa-spin]="isMerging"></i>
                        {{ isMerging ? 'Regroupement en cours...' : 'Regrouper les comptes' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
