<div class="sop-operation-container">
  <div class="sop-header">
    <h1 class="sop-title">Visualisation des SOP</h1>
  </div>

  <div class="mind-map-container">
    <div class="mind-map" *ngIf="sopStructure">
      <!-- Nœud racine -->
      <div class="root-node" (click)="onNodeClick(sopStructure, $event)">
        <div class="node-content root">
          <i class="fas fa-sitemap"></i>
          <span>{{ sopStructure.label }}</span>
        </div>
        <div class="node-actions" (click)="$event.stopPropagation()">
          <button class="action-btn add-btn" (click)="openAddModal(sopStructure, $event)" title="Ajouter un sous-titre">
            <i class="fas fa-plus"></i>
          </button>
          <button class="action-btn edit-btn" (click)="openEditModal(sopStructure, $event)" title="Modifier">
            <i class="fas fa-edit"></i>
          </button>
        </div>
      </div>

      <!-- Container pour les deux branches principales -->
      <div class="branches-container">
        <!-- Branche Back office -->
        <div class="branch branch-back-office">
        <div class="branch-node level-1" (click)="onNodeClick(sopStructure.children![0], $event)">
          <div class="node-content level-1-content">
            <i class="fas fa-building"></i>
            <span>{{ sopStructure.children![0].label }}</span>
          </div>
          <div class="node-actions" (click)="$event.stopPropagation()">
            <button class="action-btn add-btn" (click)="openAddModal(sopStructure.children![0], $event)" title="Ajouter un sous-titre">
              <i class="fas fa-plus"></i>
            </button>
            <button class="action-btn edit-btn" (click)="openEditModal(sopStructure.children![0], $event)" title="Modifier">
              <i class="fas fa-edit"></i>
            </button>
            <button class="action-btn delete-btn" (click)="openDeleteModal(sopStructure.children![0], $event)" title="Supprimer">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <!-- Sous-branches Back office -->
        <div class="sub-branches">
          <!-- Métier (GU3) -->
          <div class="sub-branch">
            <div class="branch-node level-2" (click)="onNodeClick(sopStructure.children![0].children![0], $event)">
              <div class="node-content level-2-content">
                <i class="fas fa-briefcase"></i>
                <span>{{ sopStructure.children![0].children![0].label }}</span>
              </div>
              <div class="node-actions" (click)="$event.stopPropagation()">
                <button class="action-btn add-btn" (click)="openAddModal(sopStructure.children![0].children![0], $event)" title="Ajouter un sous-titre">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="action-btn edit-btn" (click)="openEditModal(sopStructure.children![0].children![0], $event)" title="Modifier">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete-btn" (click)="openDeleteModal(sopStructure.children![0].children![0], $event)" title="Supprimer">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="leaf-nodes">
              <div 
                *ngFor="let child of sopStructure.children![0].children![0].children" 
                class="leaf-node"
                (click)="onNodeClick(child, $event)">
                <div class="node-content leaf-content">
                  <i class="fas fa-circle"></i>
                  <span>{{ child.label }}</span>
                </div>
                <div class="node-actions" (click)="$event.stopPropagation()">
                  <button class="action-btn add-btn" (click)="openAddModal(child, $event)" title="Ajouter un sous-titre">
                    <i class="fas fa-plus"></i>
                  </button>
                  <button class="action-btn edit-btn" (click)="openEditModal(child, $event)" title="Modifier">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="action-btn delete-btn" (click)="openDeleteModal(child, $event)" title="Supprimer">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Classique -->
          <div class="sub-branch">
            <div class="branch-node level-2" (click)="onNodeClick(sopStructure.children![0].children![1], $event)">
              <div class="node-content level-2-content">
                <i class="fas fa-file-alt"></i>
                <span>{{ sopStructure.children![0].children![1].label }}</span>
              </div>
              <div class="node-actions" (click)="$event.stopPropagation()">
                <button class="action-btn add-btn" (click)="openAddModal(sopStructure.children![0].children![1], $event)" title="Ajouter un sous-titre">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="action-btn edit-btn" (click)="openEditModal(sopStructure.children![0].children![1], $event)" title="Modifier">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete-btn" (click)="openDeleteModal(sopStructure.children![0].children![1], $event)" title="Supprimer">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="leaf-nodes">
              <div 
                *ngFor="let child of sopStructure.children![0].children![1].children" 
                class="leaf-node"
                (click)="onNodeClick(child, $event)">
                <div class="node-content leaf-content">
                  <i class="fas fa-circle"></i>
                  <span>{{ child.label }}</span>
                </div>
                <div class="node-actions" (click)="$event.stopPropagation()">
                  <button class="action-btn add-btn" (click)="openAddModal(child, $event)" title="Ajouter un sous-titre">
                    <i class="fas fa-plus"></i>
                  </button>
                  <button class="action-btn edit-btn" (click)="openEditModal(child, $event)" title="Modifier">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="action-btn delete-btn" (click)="openDeleteModal(child, $event)" title="Supprimer">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- GU2 -->
          <div class="sub-branch">
            <div class="branch-node level-2" (click)="onNodeClick(sopStructure.children![0].children![2], $event)">
              <div class="node-content level-2-content">
                <i class="fas fa-cogs"></i>
                <span>{{ sopStructure.children![0].children![2].label }}</span>
              </div>
              <div class="node-actions" (click)="$event.stopPropagation()">
                <button class="action-btn add-btn" (click)="openAddModal(sopStructure.children![0].children![2], $event)" title="Ajouter un sous-titre">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="action-btn edit-btn" (click)="openEditModal(sopStructure.children![0].children![2], $event)" title="Modifier">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete-btn" (click)="openDeleteModal(sopStructure.children![0].children![2], $event)" title="Supprimer">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="leaf-nodes">
              <div 
                *ngFor="let child of sopStructure.children![0].children![2].children" 
                class="leaf-node"
                (click)="onNodeClick(child, $event)">
                <div class="node-content leaf-content">
                  <i class="fas fa-circle"></i>
                  <span>{{ child.label }}</span>
                </div>
                <div class="node-actions" (click)="$event.stopPropagation()">
                  <button class="action-btn add-btn" (click)="openAddModal(child, $event)" title="Ajouter un sous-titre">
                    <i class="fas fa-plus"></i>
                  </button>
                  <button class="action-btn edit-btn" (click)="openEditModal(child, $event)" title="Modifier">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="action-btn delete-btn" (click)="openDeleteModal(child, $event)" title="Supprimer">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        </div>

        <!-- Branche Autres -->
        <div class="branch branch-autres">
        <div class="branch-node level-1" (click)="onNodeClick(sopStructure.children![1], $event)">
          <div class="node-content level-1-content">
            <i class="fas fa-folder-open"></i>
            <span>{{ sopStructure.children![1].label }}</span>
          </div>
          <div class="node-actions" (click)="$event.stopPropagation()">
            <button class="action-btn add-btn" (click)="openAddModal(sopStructure.children![1], $event)" title="Ajouter un sous-titre">
              <i class="fas fa-plus"></i>
            </button>
            <button class="action-btn edit-btn" (click)="openEditModal(sopStructure.children![1], $event)" title="Modifier">
              <i class="fas fa-edit"></i>
            </button>
            <button class="action-btn delete-btn" (click)="openDeleteModal(sopStructure.children![1], $event)" title="Supprimer">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <!-- Sous-branches Autres -->
        <div class="sub-branches">
          <!-- Annulation -->
          <div class="sub-branch">
            <div class="branch-node level-2" (click)="onNodeClick(sopStructure.children![1].children![0], $event)">
              <div class="node-content level-2-content">
                <i class="fas fa-times-circle"></i>
                <span>{{ sopStructure.children![1].children![0].label }}</span>
              </div>
              <div class="node-actions" (click)="$event.stopPropagation()">
                <button class="action-btn add-btn" (click)="openAddModal(sopStructure.children![1].children![0], $event)" title="Ajouter un sous-titre">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="action-btn edit-btn" (click)="openEditModal(sopStructure.children![1].children![0], $event)" title="Modifier">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete-btn" (click)="openDeleteModal(sopStructure.children![1].children![0], $event)" title="Supprimer">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="leaf-nodes">
              <div 
                *ngFor="let child of sopStructure.children![1].children![0].children" 
                class="leaf-node"
                (click)="onNodeClick(child, $event)">
                <div class="node-content leaf-content">
                  <i class="fas fa-circle"></i>
                  <span>{{ child.label }}</span>
                </div>
                <div class="node-actions" (click)="$event.stopPropagation()">
                  <button class="action-btn add-btn" (click)="openAddModal(child, $event)" title="Ajouter un sous-titre">
                    <i class="fas fa-plus"></i>
                  </button>
                  <button class="action-btn edit-btn" (click)="openEditModal(child, $event)" title="Modifier">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="action-btn delete-btn" (click)="openDeleteModal(child, $event)" title="Supprimer">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Transfert d'UV inter filiale -->
          <div class="sub-branch">
            <div class="branch-node level-2" (click)="onNodeClick(sopStructure.children![1].children![1], $event)">
              <div class="node-content level-2-content">
                <i class="fas fa-exchange-alt"></i>
                <span>{{ sopStructure.children![1].children![1].label }}</span>
              </div>
              <div class="node-actions" (click)="$event.stopPropagation()">
                <button class="action-btn add-btn" (click)="openAddModal(sopStructure.children![1].children![1], $event)" title="Ajouter un sous-titre">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="action-btn edit-btn" (click)="openEditModal(sopStructure.children![1].children![1], $event)" title="Modifier">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete-btn" (click)="openDeleteModal(sopStructure.children![1].children![1], $event)" title="Supprimer">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="leaf-nodes">
              <div 
                *ngFor="let child of sopStructure.children![1].children![1].children" 
                class="leaf-node"
                (click)="onNodeClick(child, $event)">
                <div class="node-content leaf-content">
                  <i class="fas fa-circle"></i>
                  <span>{{ child.label }}</span>
                </div>
                <div class="node-actions" (click)="$event.stopPropagation()">
                  <button class="action-btn add-btn" (click)="openAddModal(child, $event)" title="Ajouter un sous-titre">
                    <i class="fas fa-plus"></i>
                  </button>
                  <button class="action-btn edit-btn" (click)="openEditModal(child, $event)" title="Modifier">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="action-btn delete-btn" (click)="openDeleteModal(child, $event)" title="Supprimer">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Ajustement et Memo -->
          <div class="sub-branch">
            <div class="branch-node level-2" (click)="onNodeClick(sopStructure.children![1].children![2], $event)">
              <div class="node-content level-2-content">
                <i class="fas fa-balance-scale"></i>
                <span>{{ sopStructure.children![1].children![2].label }}</span>
              </div>
              <div class="node-actions" (click)="$event.stopPropagation()">
                <button class="action-btn add-btn" (click)="openAddModal(sopStructure.children![1].children![2], $event)" title="Ajouter un sous-titre">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="action-btn edit-btn" (click)="openEditModal(sopStructure.children![1].children![2], $event)" title="Modifier">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete-btn" (click)="openDeleteModal(sopStructure.children![1].children![2], $event)" title="Supprimer">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="leaf-nodes">
              <div 
                *ngFor="let child of sopStructure.children![1].children![2].children" 
                class="leaf-node"
                (click)="onNodeClick(child, $event)">
                <div class="node-content leaf-content">
                  <i class="fas fa-circle"></i>
                  <span>{{ child.label }}</span>
                </div>
                <div class="node-actions" (click)="$event.stopPropagation()">
                  <button class="action-btn add-btn" (click)="openAddModal(child, $event)" title="Ajouter un sous-titre">
                    <i class="fas fa-plus"></i>
                  </button>
                  <button class="action-btn edit-btn" (click)="openEditModal(child, $event)" title="Modifier">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="action-btn delete-btn" (click)="openDeleteModal(child, $event)" title="Supprimer">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Problème technique -->
          <div class="sub-branch">
            <div class="branch-node level-2" (click)="onNodeClick(sopStructure.children![1].children![3], $event)">
              <div class="node-content level-2-content">
                <i class="fas fa-exclamation-triangle"></i>
                <span>{{ sopStructure.children![1].children![3].label }}</span>
              </div>
              <div class="node-actions" (click)="$event.stopPropagation()">
                <button class="action-btn add-btn" (click)="openAddModal(sopStructure.children![1].children![3], $event)" title="Ajouter un sous-titre">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="action-btn edit-btn" (click)="openEditModal(sopStructure.children![1].children![3], $event)" title="Modifier">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete-btn" (click)="openDeleteModal(sopStructure.children![1].children![3], $event)" title="Supprimer">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="leaf-nodes">
              <div 
                *ngFor="let child of sopStructure.children![1].children![3].children" 
                class="leaf-node"
                (click)="onNodeClick(child, $event)">
                <div class="node-content leaf-content">
                  <i class="fas fa-circle"></i>
                  <span>{{ child.label }}</span>
                </div>
                <div class="node-actions" (click)="$event.stopPropagation()">
                  <button class="action-btn add-btn" (click)="openAddModal(child, $event)" title="Ajouter un sous-titre">
                    <i class="fas fa-plus"></i>
                  </button>
                  <button class="action-btn edit-btn" (click)="openEditModal(child, $event)" title="Modifier">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="action-btn delete-btn" (click)="openDeleteModal(child, $event)" title="Supprimer">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup pour les options -->
  <div class="popup-overlay" *ngIf="showPopup && popupNode" (click)="closePopup()">
    <div class="popup-content" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h3>{{ popupNode.label }}</h3>
        <button class="btn-close-popup" (click)="closePopup()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="popup-body">
        <p class="popup-description">Choisissez une option pour consulter les informations :</p>
        <div class="popup-options">
          <button class="popup-option-btn" (click)="onOptionClick('grandes-lignes')">
            <i class="fas fa-list-ul"></i>
            <span>Les grandes lignes</span>
          </button>
          <button class="popup-option-btn" (click)="onOptionClick('document-complet')">
            <i class="fas fa-file-alt"></i>
            <span>Document complet</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal d'ajout -->
  <div class="modal-overlay" *ngIf="showAddModal" (click)="closeAddModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Ajouter un titre/sous-titre</h3>
        <button class="btn-close-modal" (click)="closeAddModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="newLabel">Libellé :</label>
          <input 
            type="text" 
            id="newLabel" 
            [(ngModel)]="newLabel" 
            class="form-input"
            placeholder="Entrez le libellé du titre/sous-titre"
            (keyup.enter)="addNode()"
            autofocus>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeAddModal()">Annuler</button>
        <button class="btn btn-primary" (click)="addNode()" [disabled]="!newLabel.trim()">Ajouter</button>
      </div>
    </div>
  </div>

  <!-- Modal de modification -->
  <div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Modifier le titre/sous-titre</h3>
        <button class="btn-close-modal" (click)="closeEditModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="editLabel">Libellé :</label>
          <input 
            type="text" 
            id="editLabel" 
            [(ngModel)]="editLabel" 
            class="form-input"
            placeholder="Entrez le nouveau libellé"
            (keyup.enter)="editNode()"
            autofocus>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeEditModal()">Annuler</button>
        <button class="btn btn-primary" (click)="editNode()" [disabled]="!editLabel.trim()">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Modal de suppression -->
  <div class="modal-overlay" *ngIf="showDeleteModal" (click)="closeDeleteModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Supprimer le titre/sous-titre</h3>
        <button class="btn-close-modal" (click)="closeDeleteModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <p class="delete-confirmation">
          Êtes-vous sûr de vouloir supprimer <strong>{{ nodeToDelete?.label }}</strong> ?
        </p>
        <p class="delete-warning" *ngIf="nodeToDelete?.children && nodeToDelete.children.length > 0">
          <i class="fas fa-exclamation-triangle"></i>
          Attention : Ce nœud contient {{ nodeToDelete.children.length }} sous-élément(s) qui seront également supprimés.
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDeleteModal()">Annuler</button>
        <button class="btn btn-danger" (click)="deleteNode()">Supprimer</button>
      </div>
    </div>
  </div>
</div>

