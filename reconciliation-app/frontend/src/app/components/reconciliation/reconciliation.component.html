<!-- Popup de performance -->
<div *ngIf="showPerformancePopup" class="performance-popup-overlay">
    <div class="performance-popup">
        <div class="performance-header">
            <h3>üìä Performance de la r√©conciliation</h3>
        </div>
        <div class="performance-details">
            <div class="performance-item">
                <i class="fas fa-clock"></i>
                <span>Temps d'ex√©cution: {{ formatTime(executionTime) }}</span>
            </div>
            <div class="performance-item">
                <i class="fas fa-database"></i>
                <span>Enregistrements trait√©s: {{ processedRecords | number }}</span>
            </div>
            <div class="performance-item">
                <i class="fas fa-tachometer-alt"></i>
                <span>Vitesse: {{ (processedRecords / (executionTime / 1000)) | number:'1.0-0' }} enregistrements/seconde</span>
            </div>
        </div>
        <button class="close-popup-btn" (click)="closePerformancePopup()">Fermer</button>
    </div>
</div>

<div class="reconciliation-container">
    <!-- Section de s√©lection des modes -->
    <div *ngIf="!isLoading && !showProgress && !reconciliationResponse && !error" class="mode-selection-container">
        <div class="mode-selection-header">
            <h2>üîÑ R√©conciliation de Donn√©es</h2>
            <p>Choisissez votre mode de r√©conciliation pr√©f√©r√©</p>
        </div>
        
        <div class="mode-cards-container">
            <!-- Carte pour le Mode Assist√© -->
            <div class="mode-card assisted-mode">
                <div class="mode-header">
                    <i class="fas fa-magic"></i>
                    <h3>Mode Assist√©</h3>
                </div>
                <div class="mode-description">
                    <p>Le syst√®me analyse vos fichiers et sugg√®re les meilleures cl√©s de r√©conciliation.</p>
                </div>
                <div class="mode-features">
                    <ul>
                        <li>Analyse automatique des correspondances</li>
                        <li>Suggestions intelligentes</li>
                        <li>Validation avant ex√©cution</li>
                    </ul>
                </div>
                <button class="mode-button assisted-button" (click)="startAssistedMode()">
                    <i class="fas fa-play"></i>
                    Lancer l'analyse
                </button>
            </div>
            
            <!-- Carte pour le Mode Magique -->
            <div class="mode-card magic-mode">
                <div class="mode-header">
                    <i class="fas fa-wand-magic-sparkles"></i>
                    <h3>Mode Magique</h3>
                </div>
                <div class="mode-description">
                    <p>R√©conciliation en un clic ! Le syst√®me trouve automatiquement les meilleures cl√©s et lance la r√©conciliation.</p>
                </div>
                <div class="mode-features">
                    <ul>
                        <li>Configuration automatique</li>
                        <li>Lancement imm√©diat</li>
                        <li>R√©sultats rapides</li>
                    </ul>
                </div>
                <button class="mode-button magic-button" (click)="startMagicMode()">
                    <i class="fas fa-rocket"></i>
                    Lancer la r√©conciliation magique
                </button>
            </div>
        </div>
    </div>

    <!-- Contenu par d√©faut pour le mode magique (quand on arrive via URL avec param√®tres) -->
    <div *ngIf="!showProgress && !reconciliationResponse && !error && isLoading" class="default-content">
        <div class="magic-reconciliation-header">
            <h2>ü™Ñ R√©conciliation Magique</h2>
            <p>Votre r√©conciliation magique est en cours de pr√©paration...</p>
        </div>
        
        <div class="magic-status">
            <div class="status-card">
                <i class="fas fa-magic"></i>
                <h3>Mode Magique Activ√©</h3>
                <p>Le syst√®me analyse automatiquement vos fichiers et trouve les meilleures cl√©s de r√©conciliation.</p>
            </div>
            
            <div class="status-card">
                <i class="fas fa-cogs"></i>
                <h3>Configuration Automatique</h3>
                <p>D√©couverte intelligente des colonnes de correspondance en cours...</p>
            </div>
            
            <div class="status-card">
                <i class="fas fa-rocket"></i>
                <h3>Lancement Imm√©diat</h3>
                <p>La r√©conciliation sera lanc√©e automatiquement d√®s que la configuration sera optimale.</p>
            </div>
        </div>
        
        <div class="loading-indicator">
            <div class="spinner"></div>
            <p>Initialisation de la r√©conciliation magique...</p>
        </div>
    </div>

    <!-- Affichage de la progression avec le composant g√©n√©rique -->
    <app-progress-popup
      *ngIf="showProgress"
      [title]="'R√©conciliation en cours...'"
      [progress]="progressPercentage"
      [step]="progressStep"
      [currentFile]="progressCurrentFile"
      [totalFiles]="progressTotalFiles"
      [message]="'Veuillez patienter, la r√©conciliation est en cours...'">
    </app-progress-popup>

    <!-- Affichage des r√©sultats -->
    <div *ngIf="reconciliationResponse && !isLoading" class="results-container">
        
        <!-- Section sp√©ciale pour le mode magique -->
        <div *ngIf="isMagicMode && magicResults" class="magic-results-section">
            <div class="magic-header">
                <h2>ü™Ñ R√©conciliation Magique Termin√©e</h2>
                <div class="magic-confidence">
                    <span class="confidence-label">Confiance globale:</span>
                    <span class="confidence-value" [class]="getConfidenceClass(magicConfidence)">
                        {{ (magicConfidence * 100) | number:'1.0-0' }}%
                    </span>
                </div>
            </div>

            <!-- Cl√© s√©lectionn√©e automatiquement -->
            <div *ngIf="magicResults?.selectedKey" class="selected-key-section">
                <h3>üéØ Cl√© S√©lectionn√©e Automatiquement</h3>
                <div class="selected-key-card">
                    <div class="selected-key-header">
                        <i class="fas fa-star"></i>
                        <span>Meilleure correspondance d√©tect√©e</span>
                        <span class="selected-confidence" [class]="getConfidenceClass(magicResults.selectedKey.confidence)">
                            {{ (magicResults.selectedKey.confidence * 100) | number:'1.0-0' }}%
                        </span>
                    </div>
                    <div class="selected-key-pair">
                        <span class="bo-column">{{ magicResults.selectedKey.boColumn }}</span>
                        <span class="arrow">‚Üî</span>
                        <span class="partner-column">{{ magicResults.selectedKey.partnerColumn }}</span>
                    </div>
                    <div class="selected-key-reason">
                        <small>{{ magicResults.selectedKey.reason }}</small>
                    </div>
                </div>
            </div>

            <!-- R√©sum√© de l'analyse -->
            <div *ngIf="magicResults?.analysisSummary" class="analysis-summary-section">
                <h3>üìä R√©sum√© de l'Analyse</h3>
                <div class="analysis-summary-grid">
                    <div class="summary-item">
                        <i class="fas fa-columns"></i>
                        <span>Colonnes analys√©es: {{ magicResults.analysisSummary.totalColumnsAnalyzed }}</span>
                    </div>
                    <div class="summary-item">
                        <i class="fas fa-handshake"></i>
                        <span>Meilleure correspondance: {{ magicResults.analysisSummary.bestMatchFound }}</span>
                    </div>
                    <div class="summary-item">
                        <i class="fas fa-shield-alt"></i>
                        <span>Niveau de confiance: {{ magicResults.analysisSummary.confidenceLevel }}</span>
                    </div>
                    <div class="summary-item">
                        <i class="fas fa-magic"></i>
                        <span>Transformations appliqu√©es: {{ magicResults.analysisSummary.transformationApplied ? 'Oui' : 'Non' }}</span>
                    </div>
                </div>
            </div>

            <!-- Cl√©s d√©tect√©es -->
            <div *ngIf="detectedKeys.length > 0" class="detected-keys-section">
                <h3>üîë Cl√©s D√©tect√©es Automatiquement</h3>
                <div class="keys-grid">
                    <div *ngFor="let key of detectedKeys; let i = index" class="key-card">
                        <div class="key-header">
                            <span class="key-rank">#{{ i + 1 }}</span>
                            <span class="key-confidence" [class]="getConfidenceClass(key.confidence)">
                                {{ (key.confidence * 100) | number:'1.0-0' }}%
                            </span>
                        </div>
                        <div class="key-pair">
                            <span class="bo-column">{{ key.boColumn }}</span>
                            <span class="arrow">‚Üî</span>
                            <span class="partner-column">{{ key.partnerColumn }}</span>
                        </div>
                        <div class="key-details">
                            <div class="detail-item">
                                <span class="label">Similarit√© des noms:</span>
                                <span class="value">{{ (key.nameSimilarity * 100) | number:'1.0-0' }}%</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Confiance contenu:</span>
                                <span class="value">{{ (key.contentConfidence * 100) | number:'1.0-0' }}%</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Qualit√© des donn√©es:</span>
                                <span class="value">{{ (key.dataQuality * 100) | number:'1.0-0' }}%</span>
                            </div>
                        </div>
                        <div *ngIf="key.reason" class="key-reason">
                            <small>{{ key.reason }}</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transformations appliqu√©es -->
            <div *ngIf="appliedTransformations.length > 0" class="transformations-section">
                <h3>üîß Transformations Appliqu√©es</h3>
                <div class="transformations-grid">
                    <div *ngFor="let transform of appliedTransformations" class="transformation-card">
                        <div class="transformation-header">
                            <i class="fas fa-magic"></i>
                            <span>Transformation d√©tect√©e</span>
                        </div>
                        <div class="transformation-pair">
                            <span class="bo-column">{{ transform.boColumn }}</span>
                            <span class="arrow">‚Üî</span>
                            <span class="partner-column">{{ transform.partnerColumn }}</span>
                        </div>
                        <div class="transformation-details">
                            <div class="treatments-list">
                                <span *ngFor="let treatment of transform.treatments" class="treatment-badge">
                                    {{ treatment }}
                                </span>
                            </div>
                            <div *ngIf="transform.reason" class="transformation-reason">
                                <small>{{ transform.reason }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="results-header">
            <h2>R√©conciliation termin√©e</h2>
            <div class="execution-summary">
                <div class="summary-item">
                    <i class="fas fa-clock"></i>
                    <span>Temps d'ex√©cution: {{ formatTime(executionTime) }}</span>
                </div>
                <div class="summary-item">
                    <i class="fas fa-database"></i>
                    <span>Enregistrements trait√©s: {{ processedRecords | number }}</span>
                </div>
            </div>
        </div>
        
        <div class="results-grid">
            <div class="result-card matches">
                <div class="card-header">
                    <i class="fas fa-check-circle"></i>
                    <h3>Correspondances</h3>
                </div>
                <div class="card-value">{{ getSafeValue(reconciliationResponse.totalMatches) | number }}</div>
            </div>
            
            <div class="result-card mismatches">
                <div class="card-header">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Diff√©rences</h3>
                </div>
                <div class="card-value">{{ getSafeValue(reconciliationResponse.totalMismatches) | number }}</div>
            </div>
            
            <div class="result-card bo-only">
                <div class="card-header">
                    <i class="fas fa-file-alt"></i>
                    <h3>Uniquement BO</h3>
                </div>
                <div class="card-value">{{ getSafeValue(reconciliationResponse.totalBoOnly) | number }}</div>
            </div>
            
            <div class="result-card partner-only">
                <div class="card-header">
                    <i class="fas fa-file-alt"></i>
                    <h3>Uniquement Partenaire</h3>
                </div>
                <div class="card-value">{{ getSafeValue(reconciliationResponse.totalPartnerOnly) | number }}</div>
            </div>
        </div>
    </div>

    <!-- Affichage des erreurs -->
    <div *ngIf="error" class="error-container">
        <div class="error-card">
            <i class="fas fa-exclamation-circle"></i>
            <h3>R√©conciliation magique non possible</h3>
            <p>{{ error }}</p>
            <div class="error-actions">
                <button class="btn btn-primary" (click)="goToAssistedMode()">
                    <i class="fas fa-magic"></i>
                    Utiliser le mode Assist√©
                </button>
                <button class="btn btn-secondary" (click)="goToManualMode()">
                    <i class="fas fa-cogs"></i>
                    Utiliser le mode Manuel
                </button>
            </div>
        </div>
    </div>
</div> 