<div class="ecart-solde-container">
  <div class="header">
    <h2>Gestion des Écarts de Solde (TSOP)</h2>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="loadEcartSoldes()" [disabled]="isLoading">
        <i class="fas fa-sync-alt"></i> Actualiser
      </button>
      <button class="btn btn-success" (click)="exportEcartSoldes()" [disabled]="filteredEcartSoldes.length === 0 || isLoading">
        <i class="fas fa-file-excel"></i> Exporter
      </button>
    </div>
  </div>

  <!-- Section Statistiques -->
  <div class="stats-section">
    <div class="stats-header">
      <h3>Statistiques (Filtres appliqués)</h3>
      <div class="stats-info">
        <i class="fas fa-info-circle"></i>
        <span>Les statistiques ci-dessous reflètent les filtres appliqués</span>
      </div>
    </div>
    <div class="stats-grid">
      <div class="stat-card stat-total">
        <div class="stat-icon"><i class="fas fa-list"></i></div>
        <div class="stat-value">{{ filteredEcartSoldes.length }}</div>
        <div class="stat-label">NOMBRE DE LIGNES</div>
      </div>
      <div class="stat-card stat-en-attente">
        <div class="stat-icon"><i class="fas fa-clock"></i></div>
        <div class="stat-value">{{ getStatutCount('EN_ATTENTE') }}</div>
        <div class="stat-label">EN ATTENTE</div>
      </div>
      <div class="stat-card stat-traite">
        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
        <div class="stat-value">{{ getStatutCount('TRAITE') }}</div>
        <div class="stat-label">TRAITÉ</div>
      </div>
      <div class="stat-card stat-erreur">
        <div class="stat-icon"><i class="fas fa-exclamation-circle"></i></div>
        <div class="stat-value">{{ getStatutCount('ERREUR') }}</div>
        <div class="stat-label">ERREUR</div>
      </div>
      <div class="stat-card stat-montant">
        <div class="stat-icon"><i class="fas fa-coins"></i></div>
        <div class="stat-value">{{ formatMontantTotal() }}</div>
        <div class="stat-label">VOLUME TOTAL</div>
      </div>
    </div>
  </div>

  <!-- Section Upload -->
  <div class="upload-section">
    <h3>Import de fichier (CSV, XLS, XLSX)</h3>
    <div class="upload-form">
      <div class="file-input-group">
        <input 
          type="file" 
          class="file-input" 
          (change)="onFileSelected($event)"
          accept=".csv,.xlsx,.xls"
          #fileInput>
        <button 
          type="button" 
          class="btn btn-info" 
          (click)="downloadTemplate()"
          title="Télécharger le modèle de fichier">
          <i class="fas fa-download"></i> Télécharger Modèle
        </button>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="validateFile()"
          [disabled]="!selectedFile || isUploading">
          <i class="fas fa-check"></i> Valider
        </button>
        <button 
          type="button" 
          class="btn btn-success" 
          (click)="uploadFile()"
          [disabled]="!selectedFile || isUploading">
          <i class="fas fa-upload"></i> 
          {{ isUploading ? 'Upload en cours...' : 'Uploader' }}
        </button>
      </div>
      
      <div class="upload-messages" *ngIf="uploadMessage">
        <div class="alert" [ngClass]="uploadMessage.type === 'success' ? 'alert-success' : 'alert-danger'">
          {{ uploadMessage.text }}
        </div>
      </div>
      
      <div class="validation-info" *ngIf="validationResult">
        <div class="alert" [ngClass]="validationResult.hasErrors ? 'alert-warning' : 'alert-info'">
          <h6>Résultat de la validation :</h6>
          <ul>
            <li>Lignes valides : {{ validationResult.validLines }}</li>
            <li>Lignes avec erreurs : {{ validationResult.errorLines }}</li>
            <li>Doublons détectés : {{ validationResult.duplicates }}</li>
            <li>Nouveaux enregistrements : {{ validationResult.newRecords }}</li>
          </ul>
        </div>
      </div>
      
      <div class="upload-info">
        <small class="text-muted">
          Formats acceptés : CSV, XLS, XLSX. La première ligne doit contenir les en-têtes.
        </small>
      </div>
    </div>
  </div>

  <!-- Filtres -->
  <div class="filters-section">
    <h3>Filtres</h3>
    <form [formGroup]="filterForm" class="filter-form">
      <div class="filter-row">
        <div class="filter-group">
          <label>Agence:</label>
          <select formControlName="agence" class="form-control">
            <option value="">Toutes les agences</option>
            <option *ngFor="let agence of agences" [value]="agence">{{ agence }}</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>Service:</label>
          <select formControlName="service" class="form-control">
            <option value="">Tous les services</option>
            <option *ngFor="let service of services" [value]="service">{{ service }}</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>Pays:</label>
          <select formControlName="pays" class="form-control">
            <option value="">Tous les pays</option>
            <option *ngFor="let pays of pays" [value]="pays">{{ pays }}</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>Numéro Trans GU:</label>
          <input type="text" formControlName="numeroTransGu" class="form-control" placeholder="Tapez un numéro Trans GU...">
        </div>
        
        <div class="filter-group">
          <label>Statut:</label>
          <select formControlName="statut" class="form-control">
            <option value="">Tous les statuts</option>
            <option *ngFor="let statut of statuts" [value]="statut">{{ statut }}</option>
          </select>
        </div>
      </div>
      
      <div class="filter-row">
        <div class="filter-group">
          <label>Date début:</label>
          <input type="date" formControlName="dateDebut" class="form-control" (change)="onDateChange('dateDebut')">
        </div>
        
        <div class="filter-group">
          <label>Date fin:</label>
          <input type="date" formControlName="dateFin" class="form-control" (change)="onDateChange('dateFin')">
        </div>
        
        <div class="filter-actions">
          <button type="button" class="btn btn-secondary" (click)="clearFilters()">
            <i class="fas fa-times"></i> Effacer
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Tableau des données -->
  <div class="table-section">
    <div class="table-header">
      <div class="table-header-left">
        <h3>Écarts de Solde</h3>
        <div class="table-summary">
          <span class="summary-item">
            <i class="fas fa-list"></i>
            <strong>{{ filteredEcartSoldes.length }}</strong> ligne(s)
          </span>
          <span class="summary-separator">•</span>
          <span class="summary-item">
            <i class="fas fa-coins"></i>
            <strong>{{ formatMontantTotal() }}</strong>
          </span>
        </div>
      </div>
      <div class="table-info">
        {{ ecartSoldes.length === filteredEcartSoldes.length ? 'Tous les enregistrements' : 'Résultats filtrés' }}
      </div>
      
      <!-- Contrôles de sélection multiple -->
      <div class="selection-controls" *ngIf="isSelectionMode">
        <div class="selection-info">
          <span class="selected-count">{{ getSelectedCount() }} sélectionné(s)</span>
        </div>
        <div class="selection-actions">
          <select [(ngModel)]="selectedStatut" class="form-control status-select">
            <option value="EN_ATTENTE">⏳ En attente</option>
            <option value="TRAITE">✅ Traité</option>
            <option value="ERREUR">❌ Erreur</option>
          </select>
          <button class="btn btn-primary" 
                  (click)="updateMultipleStatuts()" 
                  [disabled]="getSelectedCount() === 0 || isUpdatingMultipleStatuts">
            <i class="fas fa-save"></i>
            {{ isUpdatingMultipleStatuts ? 'Mise à jour...' : 'Mettre à jour' }}
          </button>
        </div>
      </div>
      
      <div class="table-actions">
        <button class="btn" 
                [class.active]="isSelectionMode"
                (click)="toggleSelectionMode()">
          <i class="fas fa-check-square"></i>
          {{ isSelectionMode ? 'Mode sélection' : 'Sélection multiple' }}
        </button>
      </div>
    </div>

    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th *ngIf="isSelectionMode" class="checkbox-header">
              <input type="checkbox" 
                     [checked]="isSelectAll" 
                     (change)="toggleSelectAll()"
                     class="select-all-checkbox">
            </th>
            <th>ID Transaction</th>
            <th>Téléphone Client</th>
            <th>Montant</th>
            <th>Service</th>
            <th>Agence</th>
            <th>Date Transaction</th>
            <th>Numéro Trans GU</th>
            <th>Pays</th>
            <th>Statut</th>
            <th>Frais</th>
            <th>Commentaire</th>
            <th>Date Import</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let ecart of pagedEcartSoldes" class="data-row" [class.selected]="isItemSelected(ecart)">
            <td *ngIf="isSelectionMode" class="checkbox-cell">
              <input type="checkbox" 
                     [checked]="isItemSelected(ecart)" 
                     (change)="toggleItemSelection(ecart)"
                     class="item-checkbox">
            </td>
            <td>{{ ecart.idTransaction }}</td>
            <td>{{ ecart.telephoneClient || '-' }}</td>
            <td class="amount">{{ formatMontant(ecart.montant) }}</td>
            <td>{{ ecart.service || '-' }}</td>
            <td>{{ ecart.agence || '-' }}</td>
            <td>{{ formatDate(ecart.dateTransaction) }}</td>
            <td>{{ ecart.numeroTransGu || '-' }}</td>
            <td>{{ ecart.pays || '-' }}</td>
            <td>
              <span class="status-badge" [ngClass]="getStatutClass(ecart.statut || '')">
                {{ ecart.statut || 'EN_ATTENTE' }}
              </span>
            </td>
            <td class="frais-cell">
              <div *ngIf="ecart.fraisAssocie" class="frais-info">
                <span class="frais-amount">{{ formatMontantFrais(ecart.fraisAssocie.montant) }}</span>
                <span class="frais-type" [ngClass]="getFraisTypeClass(ecart.fraisAssocie.typeCalcul)">
                  {{ getFraisTypeLabel(ecart.fraisAssocie.typeCalcul) }}
                </span>
                <span *ngIf="ecart.fraisAssocie.pourcentage" class="frais-percentage">
                  ({{ ecart.fraisAssocie.pourcentage }}%)
                </span>
              </div>
              <div *ngIf="!ecart.fraisAssocie" class="no-frais">
                <span class="no-frais-text">Aucun frais</span>
              </div>
            </td>
            <td class="commentaire-cell">
              <div *ngIf="ecart.commentaire" class="commentaire-content">
                <span class="commentaire-text">{{ ecart.commentaire }}</span>
              </div>
              <div *ngIf="!ecart.commentaire" class="no-commentaire">
                <span class="no-commentaire-text">Aucun commentaire</span>
              </div>
            </td>
            <td>{{ formatDate(ecart.dateImport || '') }}</td>
            <td class="actions">
              <div class="action-buttons">
                <div class="status-change-container">
                  <label class="status-label">Statut:</label>
                  <select (change)="onStatutChange(ecart, $event)" 
                          [value]="ecart.statut || 'EN_ATTENTE'"
                          class="status-select"
                          [ngClass]="getStatutClass(ecart.statut || '')">
                    <option value="EN_ATTENTE">⏳ En attente</option>
                    <option value="TRAITE">✅ Traité</option>
                    <option value="ERREUR">❌ Erreur</option>
                  </select>
                </div>
                
                <button class="btn btn-danger btn-sm" 
                        (click)="deleteEcartSolde(ecart.id!)"
                        title="Supprimer">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button class="pagination-btn" 
              (click)="prevPage()" 
              [disabled]="currentPage === 1">
        <i class="fas fa-chevron-left"></i> Précédent
      </button>
      
      <div class="pagination-indicators">
        <span class="page-indicator" 
              *ngFor="let page of getVisiblePages()" 
              [ngClass]="{'active': page === currentPage}"
              (click)="goToPage(page)">
          {{ page }}
        </span>
      </div>
      
      <button class="pagination-btn" 
              (click)="nextPage()" 
              [disabled]="currentPage === totalPages">
        Suivant <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>
</div>

<!-- Modal de commentaire -->
<div class="modal-overlay" *ngIf="showCommentModal">
  <div class="modal-content">
    <div class="modal-header">
      <h4>Modifier le statut</h4>
      <button class="close-btn" (click)="closeCommentModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <form [formGroup]="commentForm">
        <div class="form-group">
          <label>Nouveau statut:</label>
          <div class="statut-display" [ngClass]="getStatutClass(newStatut)">
            {{ newStatut === 'EN_ATTENTE' ? 'En attente' : newStatut === 'TRAITE' ? 'Traité' : 'Erreur' }}
          </div>
        </div>
        
        <div class="form-group">
          <label for="commentaire">Commentaire (obligatoire):</label>
          <textarea 
            id="commentaire"
            formControlName="commentaire" 
            class="form-control" 
            rows="4"
            placeholder="Veuillez saisir un commentaire...">
          </textarea>
        </div>
      </form>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeCommentModal()">
        Annuler
      </button>
      <button 
        class="btn btn-primary" 
        (click)="confirmStatutChange()"
        [disabled]="!commentForm.valid">
        Confirmer
      </button>
    </div>
  </div>
</div>

 